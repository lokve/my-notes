<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lokve.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="参考了的文章以文章提供的思路自己过一遍代码 ————-咯咯咯———- 开始以下实例 1234567891011121314151617181920&lt;div id&#x3D;&quot;app&quot;&gt;  &lt;p&gt;&amp;#123;&amp;#123;message&amp;#125;&amp;#125;&lt;&#x2F;p&gt;&lt;&#x2F;div&gt;&lt;script type&amp;#x">
<meta property="og:type" content="article">
<meta property="og:title" content="Vue源码阅读笔记（2）(Vue的生命周期)">
<meta property="og:url" content="https://lokve.github.io/my-notes/2018/01/23/vue/2/index.html">
<meta property="og:site_name" content="学习笔记">
<meta property="og:description" content="参考了的文章以文章提供的思路自己过一遍代码 ————-咯咯咯———- 开始以下实例 1234567891011121314151617181920&lt;div id&#x3D;&quot;app&quot;&gt;  &lt;p&gt;&amp;#123;&amp;#123;message&amp;#125;&amp;#125;&lt;&#x2F;p&gt;&lt;&#x2F;div&gt;&lt;script type&amp;#x">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-01-23T06:30:00.000Z">
<meta property="article:modified_time" content="2020-09-15T06:06:00.469Z">
<meta property="article:author" content="lokve">
<meta property="article:tag" content="Vue笔记">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://lokve.github.io/my-notes/2018/01/23/vue/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Vue源码阅读笔记（2）(Vue的生命周期) | 学习笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">学习笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lokve.github.io/my-notes/2018/01/23/vue/2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Vue源码阅读笔记（2）(Vue的生命周期)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-23 14:30:00" itemprop="dateCreated datePublished" datetime="2018-01-23T14:30:00+08:00">2018-01-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 14:06:00" itemprop="dateModified" datetime="2020-09-15T14:06:00+08:00">2020-09-15</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><a target="_blank" rel="noopener" href="https://github.com/liutao/vue2.0-source/blob/master/%E4%BB%8E%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%A0%97%E5%AD%90%E6%9F%A5%E7%9C%8BVue%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.md">参考了的文章</a><br>以文章提供的思路自己过一遍代码</p>
<p>————-咯咯咯———-</p>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>以下实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">  &lt;p&gt;&#123;&#123;message&#125;&#125;&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">  var vm &#x3D; new Vue(&#123;</span><br><span class="line">    el: &#39;#app&#39;,</span><br><span class="line">    data: &#123;</span><br><span class="line">      message: &#39;第一个vue实例&#39;</span><br><span class="line">    &#125;,</span><br><span class="line">    components: &#123;</span><br><span class="line">      child: &#123;</span><br><span class="line">        template: &quot;&lt;div&gt;&#123;&#123;a&#125;&#125;&lt;&#x2F;div&gt;&quot;,</span><br><span class="line">        inject: [&#39;a&#39;]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    provide: &#123;</span><br><span class="line">      a: &#39;a&#39;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>以<code>new Vue</code>开始，让我们来看一下 vue 都做了哪些工作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function Vue (options) &#123; &#x2F;&#x2F; vue定义的地方</span><br><span class="line">  if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp;</span><br><span class="line">    !(this instanceof Vue)) &#123; &#x2F;&#x2F; 是不是new Vue()</span><br><span class="line">    warn(&#39;Vue is a constructor and should be called with the &#96;new&#96; keyword&#39;)</span><br><span class="line">  &#125;</span><br><span class="line">  this._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initMixin(Vue) &#x2F;&#x2F; _init</span><br></pre></td></tr></table></figure>

<h2 id="init"><a href="#init" class="headerlink" title="init"></a>init</h2><p>这里 vue 只触发了一个方法<code>this._init(options)</code><br>跟进<code>_init</code>方法 src/core/instance/init.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._init &#x3D; function (options?: Object) &#123;</span><br><span class="line">  const vm: Component &#x3D; this</span><br><span class="line">  &#x2F;&#x2F; a uid</span><br><span class="line">  vm._uid &#x3D; uid++</span><br><span class="line"></span><br><span class="line">  let startTag, endTag</span><br><span class="line">  &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">  if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">    startTag &#x3D; &#96;vue-perf-init:$&#123;vm._uid&#125;&#96;</span><br><span class="line">    endTag &#x3D; &#96;vue-perf-end:$&#123;vm._uid&#125;&#96;</span><br><span class="line">    mark(startTag)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; a flag to avoid this being observed</span><br><span class="line">  vm._isVue &#x3D; true</span><br><span class="line">  &#x2F;&#x2F; merge options options是传进来的,options._isComponent是什么，貌似没有手动传这个参数？？</span><br><span class="line">  if (options &amp;&amp; options._isComponent) &#123; &#x2F;&#x2F; _isComponent是内部创建子组件时才会添加为true的属性</span><br><span class="line">    &#x2F;&#x2F; optimize internal component instantiation</span><br><span class="line">    &#x2F;&#x2F; since dynamic options merging is pretty slow, and none of the</span><br><span class="line">    &#x2F;&#x2F; internal component options needs special treatment.</span><br><span class="line">    initInternalComponent(vm, options)</span><br><span class="line">  &#125; else &#123; &#x2F;&#x2F; 在这个案例下走的是else</span><br><span class="line">    vm.$options &#x3D; mergeOptions(</span><br><span class="line">      resolveConstructorOptions(vm.constructor),</span><br><span class="line">      options || &#123;&#125;,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;* istanbul ignore else *&#x2F;</span><br><span class="line">  if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">    initProxy(vm)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    vm._renderProxy &#x3D; vm</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; expose real self</span><br><span class="line">  vm._self &#x3D; vm</span><br><span class="line">  initLifecycle(vm)</span><br><span class="line">  initEvents(vm)</span><br><span class="line">  initRender(vm)</span><br><span class="line">  callHook(vm, &#39;beforeCreate&#39;)</span><br><span class="line">  initInjections(vm) &#x2F;&#x2F; resolve injections before data&#x2F;props</span><br><span class="line">  initState(vm)</span><br><span class="line">  initProvide(vm) &#x2F;&#x2F; resolve provide after data&#x2F;props</span><br><span class="line">  callHook(vm, &#39;created&#39;)</span><br><span class="line"></span><br><span class="line">  &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">  if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">    vm._name &#x3D; formatComponentName(vm, false)</span><br><span class="line">    mark(endTag)</span><br><span class="line">    measure(&#96;$&#123;vm._name&#125; init&#96;, startTag, endTag)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (vm.$options.el) &#123;</span><br><span class="line">    vm.$mount(vm.$options.el)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个例子没有内部子组件，所以走 else 路线，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vm.$options &#x3D; mergeOptions(</span><br><span class="line">  resolveConstructorOptions(vm.constructor),</span><br><span class="line">  options || &#123;&#125;,</span><br><span class="line">  vm</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="resolveConstructorOptions"><a href="#resolveConstructorOptions" class="headerlink" title="resolveConstructorOptions"></a>resolveConstructorOptions</h3><p>这里的<code>mergeOptions</code>应该是一个类似 Object.assign 的方法，<code>resolveConstructorOptions</code>猜不出意思,不过根据参考文章和具体代码，我知道了这个方法是在<code>Vue.extend</code>上才会被完全使用,在目前的情况下，这里原封不动的返回了 options</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export function resolveConstructorOptions (Ctor: Class&lt;Component&gt;) &#123;</span><br><span class="line">  let options &#x3D; Ctor.options</span><br><span class="line">  &#x2F;&#x2F; 有super属性，说明Ctor是通过Vue.extend()方法创建的子类</span><br><span class="line">  if (Ctor.super) &#123;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line">  return options &#x2F;&#x2F; 在这里options没有经过任何处理就直接返回了</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mergeOptions"><a href="#mergeOptions" class="headerlink" title="mergeOptions"></a>mergeOptions</h3><p>现在来看<code>mergeOptions</code>，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Merge two option objects into a new one. 合并两个boject</span><br><span class="line"> * Core utility used in both instantiation and inheritance.</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function mergeOptions (</span><br><span class="line">  parent: Object,</span><br><span class="line">  child: Object,</span><br><span class="line">  vm?: Component</span><br><span class="line">): Object &#123; &#x2F;&#x2F; ts语法，必要返回一个object</span><br><span class="line">  if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">    checkComponents(child) &#x2F;&#x2F; 判断组件名是否合法</span><br><span class="line">  &#125;</span><br><span class="line">  normalizeProps(child) &#x2F;&#x2F; 格式化prop，暂不深究？</span><br><span class="line">  normalizeDirectives(child) &#x2F;&#x2F; 格式化directive，暂不深究？</span><br><span class="line">  const extendsFrom &#x3D; child.extends &#x2F;&#x2F; options.extends</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * var CompA &#x3D; &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 在没有调用 &#96;Vue.extend&#96; 时候继承 CompA</span><br><span class="line">    var CompB &#x3D; &#123;</span><br><span class="line">      extends: CompA,</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    在这种情况下才会有extends</span><br><span class="line">   *&#x2F;</span><br><span class="line">  if (extendsFrom) &#123;</span><br><span class="line">    parent &#x3D; typeof extendsFrom &#x3D;&#x3D;&#x3D; &#39;function&#39;</span><br><span class="line">      ? mergeOptions(parent, extendsFrom.options, vm)</span><br><span class="line">      : mergeOptions(parent, extendsFrom, vm)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * var mixin &#x3D; &#123;</span><br><span class="line">      created: function () &#123; console.log(1) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    var vm &#x3D; new Vue(&#123;</span><br><span class="line">      created: function () &#123; console.log(2) &#125;,</span><br><span class="line">      mixins: [mixin]</span><br><span class="line">    &#125;)</span><br><span class="line">    &#x2F;&#x2F; &#x3D;&gt; 1</span><br><span class="line">    &#x2F;&#x2F; &#x3D;&gt; 2</span><br><span class="line">    这里也是</span><br><span class="line">   *&#x2F;</span><br><span class="line">  if (child.mixins) &#123;</span><br><span class="line">    for (let i &#x3D; 0, l &#x3D; child.mixins.length; i &lt; l; i++) &#123;</span><br><span class="line">      let mixin &#x3D; child.mixins[i]</span><br><span class="line">      if (mixin.prototype instanceof Vue) &#123;</span><br><span class="line">        mixin &#x3D; mixin.options</span><br><span class="line">      &#125;</span><br><span class="line">      parent &#x3D; mergeOptions(parent, mixin, vm)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const options &#x3D; &#123;&#125;</span><br><span class="line">  let key</span><br><span class="line">  for (key in parent) &#123; &#x2F;&#x2F; components,directives,filters,_base</span><br><span class="line">    mergeField(key) &#x2F;&#x2F; strats[key] &#x3D; mergeAssets</span><br><span class="line">  &#125;</span><br><span class="line">  for (key in child) &#123; &#x2F;&#x2F; el、data</span><br><span class="line">    if (!hasOwn(parent, key)) &#123;</span><br><span class="line">      mergeField(key) &#x2F;&#x2F; strats.el &#x3D; defaultStrat strats.data</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  function mergeField (key) &#123;</span><br><span class="line">    const strat &#x3D; strats[key] || defaultStrat</span><br><span class="line">    options[key] &#x3D; strat(parent[key], child[key], vm, key)</span><br><span class="line">  &#125;</span><br><span class="line">  console.log(options)</span><br><span class="line">  &#x2F;*</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;components&quot;:&#123;&#125;,</span><br><span class="line">    &quot;directives&quot;:&#123;&#125;,</span><br><span class="line">    &quot;filters&quot;:&#123;&#125;,</span><br><span class="line">    &quot;el&quot;:&quot;#app&quot;,</span><br><span class="line">    data:funcion mergedInstanceDataFn,</span><br><span class="line">    _base: Vue</span><br><span class="line">  &#125;</span><br><span class="line">   *&#x2F;</span><br><span class="line">  return options &#x2F;&#x2F; components,directives,filters,_base,el,data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给 options 添加了 components,directives,filters,_base,el,data 属性</p>
<h3 id="initProxy"><a href="#initProxy" class="headerlink" title="initProxy"></a>initProxy</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">initProxy &#x3D; function initProxy (vm) &#123;</span><br><span class="line">    if (hasProxy) &#123;</span><br><span class="line">      &#x2F;&#x2F; determine which proxy handler to use</span><br><span class="line">      const options &#x3D; vm.$options</span><br><span class="line">      console.log(options)</span><br><span class="line">      const handlers &#x3D; options.render &amp;&amp; options.render._withStripped</span><br><span class="line">        ? getHandler</span><br><span class="line">        : hasHandler</span><br><span class="line">      vm._renderProxy &#x3D; new Proxy(vm, handlers)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      vm._renderProxy &#x3D; vm</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在开发环境中，如果支持 es6 的 proxy 语法，vm._renderProxy 等于一个 proxy 对象,<del>具体有什么用还未知，所以暂不深究</del><br>在下面的解读中，我已经知道最终的 render 生成函数就是在 vm._renderProxy 的环境下执行的。</p>
<h3 id="initLifecycle"><a href="#initLifecycle" class="headerlink" title="initLifecycle"></a>initLifecycle</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">export function initLifecycle (vm: Component) &#123;</span><br><span class="line">  const options &#x3D; vm.$options</span><br><span class="line">  console.log(options)</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; locate first non-abstract parent</span><br><span class="line">  let parent &#x3D; options.parent</span><br><span class="line">  if (parent &amp;&amp; !options.abstract) &#123; &#x2F;&#x2F; 抽象节点相关？abstract暂不清楚在哪里用到</span><br><span class="line">    while (parent.$options.abstract &amp;&amp; parent.$parent) &#123;</span><br><span class="line">      parent &#x3D; parent.$parent</span><br><span class="line">    &#125;</span><br><span class="line">    parent.$children.push(vm)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vm.$parent &#x3D; parent &#x2F;&#x2F; 在这里是undefined</span><br><span class="line">  vm.$root &#x3D; parent ? parent.$root : vm &#x2F;&#x2F; 在这里是vm</span><br><span class="line"></span><br><span class="line">  vm.$children &#x3D; []</span><br><span class="line">  vm.$refs &#x3D; &#123;&#125;</span><br><span class="line"></span><br><span class="line">  vm._watcher &#x3D; null</span><br><span class="line">  vm._inactive &#x3D; null</span><br><span class="line">  vm._directInactive &#x3D; false</span><br><span class="line">  vm._isMounted &#x3D; false</span><br><span class="line">  vm._isDestroyed &#x3D; false</span><br><span class="line">  vm._isBeingDestroyed &#x3D; false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化生命周期相关的标识</p>
<p>options.abstract 用于判断是否是抽象组件，组件的父子关系建立会跳过抽象组件，抽象组件比如 keep-alive、transition 等。所有的子组件$root 都指向顶级组件。</p>
<h3 id="initEvents"><a href="#initEvents" class="headerlink" title="initEvents"></a>initEvents</h3><p>初始化 event 相关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">export function initEvents (vm: Component) &#123;</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Object.create(null)没有继承任何原型方法，也就是说它的原型链没有上一层。</span><br><span class="line">    console.log(Object.create(&#123;&#125;).toString);   &#x2F;&#x2F; function toString() &#123; [native code] &#125;</span><br><span class="line">    console.log(Object.create(null).toString); &#x2F;&#x2F; undefined</span><br><span class="line">    之前看到的也同理，只怪当初没baidu</span><br><span class="line">  *&#x2F;</span><br><span class="line">  vm._events &#x3D; Object.create(null) &#x2F;&#x2F; 比&#123;&#125;更干净</span><br><span class="line">  vm._hasHookEvent &#x3D; false</span><br><span class="line">  &#x2F;&#x2F; init parent attached events</span><br><span class="line">  const listeners &#x3D; vm.$options._parentListeners</span><br><span class="line">  if (listeners) &#123; &#x2F;&#x2F; 在这里是undefined</span><br><span class="line">    updateComponentListeners(vm, listeners)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>_parentListeners 是父组件中绑定在自定义标签上的事件，供子组件处理。</p>
<h3 id="initRender"><a href="#initRender" class="headerlink" title="initRender"></a>initRender</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">export function initRender (vm: Component) &#123;</span><br><span class="line">  vm.$vnode &#x3D; null &#x2F;&#x2F; the placeholder node in parent tree</span><br><span class="line">  vm._vnode &#x3D; null &#x2F;&#x2F; the root of the child tree</span><br><span class="line">  vm._staticTrees &#x3D; null</span><br><span class="line">  const parentVnode &#x3D; vm.$options._parentVnode</span><br><span class="line">  const renderContext &#x3D; parentVnode &amp;&amp; parentVnode.context &#x2F;&#x2F; undefined</span><br><span class="line">  vm.$slots &#x3D; resolveSlots(vm.$options._renderChildren, renderContext) &#x2F;&#x2F; 都是undefined，具体使用到的时候再细看</span><br><span class="line">  vm.$scopedSlots &#x3D; emptyObject &#x2F;&#x2F; Object.freeze(&#123;&#125;)</span><br><span class="line">  &#x2F;&#x2F; bind the createElement fn to this instance</span><br><span class="line">  &#x2F;&#x2F; so that we get proper render context inside it.</span><br><span class="line">  &#x2F;&#x2F; args order: tag, data, children, normalizationType, alwaysNormalize</span><br><span class="line">  &#x2F;&#x2F; internal version is used by render functions compiled from templates</span><br><span class="line">  vm._c &#x3D; (a, b, c, d) &#x3D;&gt; createElement(vm, a, b, c, d, false) &#x2F;&#x2F; 等具体调用到的时候再来细看</span><br><span class="line">  &#x2F;&#x2F; normalization is always applied for the public version, used in</span><br><span class="line">  &#x2F;&#x2F; user-written render functions.</span><br><span class="line">  vm.$createElement &#x3D; (a, b, c, d) &#x3D;&gt; createElement(vm, a, b, c, d, true)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>$slots、$scopedSlots、$createElement 相关</p>
<h3 id="callHook"><a href="#callHook" class="headerlink" title="callHook"></a>callHook</h3><h3 id="initInjections"><a href="#initInjections" class="headerlink" title="initInjections"></a>initInjections</h3><h3 id="initState"><a href="#initState" class="headerlink" title="initState"></a>initState</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">export function initState (vm: Component) &#123;</span><br><span class="line">  vm._watchers &#x3D; []</span><br><span class="line">  const opts &#x3D; vm.$options</span><br><span class="line">  if (opts.props) initProps(vm, opts.props)</span><br><span class="line">  if (opts.methods) initMethods(vm, opts.methods)</span><br><span class="line">  if (opts.data) &#123;</span><br><span class="line">    initData(vm)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    observe(vm._data &#x3D; &#123;&#125;, true &#x2F;* asRootData *&#x2F;)</span><br><span class="line">  &#125;</span><br><span class="line">  if (opts.computed) initComputed(vm, opts.computed)</span><br><span class="line">  if (opts.watch) initWatch(vm, opts.watch)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显这里是 props、methods、data、computed、watch 相关操作</p>
<h4 id="initProps"><a href="#initProps" class="headerlink" title="initProps"></a>initProps</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export function initProvide (vm: Component) &#123;</span><br><span class="line">  const provide &#x3D; vm.$options.provide</span><br><span class="line">  console.log(provide)</span><br><span class="line">  if (provide) &#123;</span><br><span class="line">    vm._provided &#x3D; typeof provide &#x3D;&#x3D;&#x3D; &#39;function&#39;</span><br><span class="line">      ? provide.call(vm)</span><br><span class="line">      : provide</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="initMethods"><a href="#initMethods" class="headerlink" title="initMethods"></a>initMethods</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function initMethods (vm: Component, methods: Object) &#123;</span><br><span class="line">  const props &#x3D; vm.$options.props</span><br><span class="line">  for (const key in methods) &#123;</span><br><span class="line">    vm[key] &#x3D; methods[key] &#x3D;&#x3D; null ? noop : bind(methods[key], vm) &#x2F;&#x2F; 给函数绑定环境</span><br><span class="line">    if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">      if (methods[key] &#x3D;&#x3D; null) &#123; &#x2F;&#x2F; 不空</span><br><span class="line">        warn(</span><br><span class="line">          &#96;method &quot;$&#123;key&#125;&quot; has an undefined value in the component definition. &#96; +</span><br><span class="line">          &#96;Did you reference the function correctly?&#96;,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      if (props &amp;&amp; hasOwn(props, key)) &#123; &#x2F;&#x2F; 判断props里面的变量和methods的方法命名不同</span><br><span class="line">        warn(</span><br><span class="line">          &#96;method &quot;$&#123;key&#125;&quot; has already been defined as a prop.&#96;,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="initData"><a href="#initData" class="headerlink" title="initData"></a>initData</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">function initData (vm: Component) &#123;</span><br><span class="line">  let data &#x3D; vm.$options.data</span><br><span class="line">  data &#x3D; vm._data &#x3D; typeof data &#x3D;&#x3D;&#x3D; &#39;function&#39;</span><br><span class="line">    ? getData(data, vm) &#x2F;&#x2F; data.call(vm)</span><br><span class="line">    : data || &#123;&#125;</span><br><span class="line">  if (!isPlainObject(data)) &#123; &#x2F;&#x2F; typeof is &#39;object&#39; ?</span><br><span class="line">    data &#x3D; &#123;&#125;</span><br><span class="line">    process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; warn(</span><br><span class="line">      &#39;data functions should return an object:\n&#39; +</span><br><span class="line">      &#39;https:&#x2F;&#x2F;vuejs.org&#x2F;v2&#x2F;guide&#x2F;components.html#data-Must-Be-a-Function&#39;,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; proxy data on instance</span><br><span class="line">  const keys &#x3D; Object.keys(data)</span><br><span class="line">  const props &#x3D; vm.$options.props</span><br><span class="line">  let i &#x3D; keys.length</span><br><span class="line">  while (i--) &#123;</span><br><span class="line">    if (props &amp;&amp; hasOwn(props, keys[i])) &#123; &#x2F;&#x2F; 判断props是否已有key</span><br><span class="line">      process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; warn(</span><br><span class="line">        &#96;The data property &quot;$&#123;keys[i]&#125;&quot; is already declared as a prop. &#96; +</span><br><span class="line">        &#96;Use prop default value instead.&#96;,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; else if (!isReserved(keys[i])) &#123; &#x2F;&#x2F; 不以$ _ 开头</span><br><span class="line">      proxy(vm, &#96;_data&#96;, keys[i]) &#x2F;&#x2F; 设置了vm[key], vm._data[key]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; observe data</span><br><span class="line">  observe(data, true &#x2F;* asRootData *&#x2F;) &#x2F;&#x2F; 监听数据 data.__ob__ &#x3D; new Observer(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先得到一个至少是{}的 object 类型的 data 数据，遍历 data，设置了 vm[key], vm._data[key]，最后给 data 设置了监听,具体什么用暂时未知</p>
<h3 id="initComputed"><a href="#initComputed" class="headerlink" title="initComputed"></a>initComputed</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">function initComputed (vm: Component, computed: Object) &#123;</span><br><span class="line">  const watchers &#x3D; vm._computedWatchers &#x3D; Object.create(null)</span><br><span class="line"></span><br><span class="line">  for (const key in computed) &#123;</span><br><span class="line">    const userDef &#x3D; computed[key]</span><br><span class="line">    let getter &#x3D; typeof userDef &#x3D;&#x3D;&#x3D; &#39;function&#39; ? userDef : userDef.get</span><br><span class="line">    if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">      if (getter &#x3D;&#x3D;&#x3D; undefined) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          &#96;No getter function has been defined for computed property &quot;$&#123;key&#125;&quot;.&#96;,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">        getter &#x3D; noop</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; create internal watcher for the computed property.</span><br><span class="line">    &#x2F;&#x2F; 为computed属性添加watcher</span><br><span class="line">    watchers[key] &#x3D; new Watcher(vm, getter, noop, computedWatcherOptions)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; component-defined computed properties are already defined on the</span><br><span class="line">    &#x2F;&#x2F; component prototype. We only need to define computed properties defined</span><br><span class="line">    &#x2F;&#x2F; at instantiation here.</span><br><span class="line">    if (!(key in vm)) &#123; &#x2F;&#x2F; computed属性只能定义在computed，不能和data，props等属性重复</span><br><span class="line">      defineComputed(vm, key, userDef) &#x2F;&#x2F; watcher.evaluate()看到这一步，下面再来细看</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="initWatch"><a href="#initWatch" class="headerlink" title="initWatch"></a>initWatch</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">function initWatch (vm: Component, watch: Object) &#123;</span><br><span class="line">  for (const key in watch) &#123;</span><br><span class="line">    const handler &#x3D; watch[key]</span><br><span class="line">    if (Array.isArray(handler)) &#123;</span><br><span class="line">      for (let i &#x3D; 0; i &lt; handler.length; i++) &#123;</span><br><span class="line">        createWatcher(vm, key, handler[i])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      createWatcher(vm, key, handler)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function createWatcher (vm: Component, key: string, handler: any) &#123;</span><br><span class="line">  let options</span><br><span class="line">  if (isPlainObject(handler)) &#123;</span><br><span class="line">    options &#x3D; handler</span><br><span class="line">    handler &#x3D; handler.handler</span><br><span class="line">  &#125;</span><br><span class="line">  if (typeof handler &#x3D;&#x3D;&#x3D; &#39;string&#39;) &#123;</span><br><span class="line">    handler &#x3D; vm[handler]</span><br><span class="line">  &#125;</span><br><span class="line">  vm.$watch(key, handler, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了 vm.$watch</p>
<h3 id="initProvide"><a href="#initProvide" class="headerlink" title="initProvide"></a>initProvide</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export function initProvide (vm: Component) &#123;</span><br><span class="line">  const provide &#x3D; vm.$options.provide</span><br><span class="line">  if (provide) &#123;</span><br><span class="line">    vm._provided &#x3D; typeof provide &#x3D;&#x3D;&#x3D; &#39;function&#39;</span><br><span class="line">      ? provide.call(vm)</span><br><span class="line">      : provide</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="mount"><a href="#mount" class="headerlink" title="$mount"></a>$mount</h2><p>vm.$mount(vm.$options.el)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$mount &#x3D; function (</span><br><span class="line">  el?: string | Element,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): Component &#123;</span><br><span class="line">  el &#x3D; el &amp;&amp; query(el) &#x2F;&#x2F; query基本等于doucment.querySelecter</span><br><span class="line"></span><br><span class="line">  &#x2F;* istanbul ignore if || Do not mount Vue to &lt;html&gt; or &lt;body&gt;  *&#x2F;</span><br><span class="line">  if (el &#x3D;&#x3D;&#x3D; document.body || el &#x3D;&#x3D;&#x3D; document.documentElement) &#123;</span><br><span class="line">    process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; warn(</span><br><span class="line">      &#96;Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.&#96;</span><br><span class="line">    )</span><br><span class="line">    return this</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const options &#x3D; this.$options</span><br><span class="line">  console.log(options.render) &#x2F;&#x2F; 在这里是undefined</span><br><span class="line">  &#x2F;&#x2F; resolve template&#x2F;el and convert to render function</span><br><span class="line">  if (!options.render) &#123;</span><br><span class="line">    let template &#x3D; options.template</span><br><span class="line">    console.log(template) &#x2F;&#x2F; undefined</span><br><span class="line">    if (template) &#123;</span><br><span class="line">      if (typeof template &#x3D;&#x3D;&#x3D; &#39;string&#39;) &#123;</span><br><span class="line">        if (template.charAt(0) &#x3D;&#x3D;&#x3D; &#39;#&#39;) &#123;</span><br><span class="line">          template &#x3D; idToTemplate(template)</span><br><span class="line">          &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">          if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; !template) &#123;</span><br><span class="line">            warn(</span><br><span class="line">              &#96;Template element not found or is empty: $&#123;options.template&#125;&#96;,</span><br><span class="line">              this</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else if (template.nodeType) &#123;</span><br><span class="line">        template &#x3D; template.innerHTML</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">          warn(&#39;invalid template option:&#39; + template, this)</span><br><span class="line">        &#125;</span><br><span class="line">        return this</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (el) &#123;</span><br><span class="line">      template &#x3D; getOuterHTML(el) &#x2F;&#x2F; el.outerHTML</span><br><span class="line">    &#125;</span><br><span class="line">    if (template) &#123;</span><br><span class="line">      &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">      if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">        mark(&#39;compile&#39;)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      const &#123; render, staticRenderFns &#125; &#x3D; compileToFunctions(template, &#123;</span><br><span class="line">        shouldDecodeNewlines,</span><br><span class="line">        delimiters: options.delimiters</span><br><span class="line">      &#125;, this)</span><br><span class="line">      options.render &#x3D; render</span><br><span class="line">      options.staticRenderFns &#x3D; staticRenderFns</span><br><span class="line"></span><br><span class="line">      &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">      if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">        mark(&#39;compile end&#39;)</span><br><span class="line">        measure(&#96;$&#123;this._name&#125; compile&#96;, &#39;compile&#39;, &#39;compile end&#39;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return mount.call(this, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="compileToFunctions"><a href="#compileToFunctions" class="headerlink" title="compileToFunctions"></a>compileToFunctions</h3><p>一步套一步，最重要的是 Convert HTML string to AST(转换 ast)的过程，先是 parse 方法，这里面调用了 parseHTML 的方法<br>注： /src/platforms/web/compiler/index.js options 里的基本属性在这个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Convert HTML string to AST.</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function parse (</span><br><span class="line">  template: string,</span><br><span class="line">  options: CompilerOptions</span><br><span class="line">): ASTElement | void &#123;</span><br><span class="line">  warn &#x3D; options.warn || baseWarn</span><br><span class="line">  platformGetTagNamespace &#x3D; options.getTagNamespace || no</span><br><span class="line">  platformMustUseProp &#x3D; options.mustUseProp || no</span><br><span class="line">  platformIsPreTag &#x3D; options.isPreTag || no</span><br><span class="line">  preTransforms &#x3D; pluckModuleFunction(options.modules, &#39;preTransformNode&#39;)</span><br><span class="line">  transforms &#x3D; pluckModuleFunction(options.modules, &#39;transformNode&#39;)</span><br><span class="line">  postTransforms &#x3D; pluckModuleFunction(options.modules, &#39;postTransformNode&#39;)</span><br><span class="line">  delimiters &#x3D; options.delimiters</span><br><span class="line">  console.log(options.modules)</span><br><span class="line">  const stack &#x3D; []</span><br><span class="line">  const preserveWhitespace &#x3D; options.preserveWhitespace !&#x3D;&#x3D; false</span><br><span class="line">  let root</span><br><span class="line">  let currentParent</span><br><span class="line">  let inVPre &#x3D; false</span><br><span class="line">  let inPre &#x3D; false</span><br><span class="line">  let warned &#x3D; false</span><br><span class="line"></span><br><span class="line">  function warnOnce (msg) &#123;</span><br><span class="line">    if (!warned) &#123;</span><br><span class="line">      warned &#x3D; true</span><br><span class="line">      warn(msg)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function endPre (element) &#123;</span><br><span class="line">    &#x2F;&#x2F; check pre state</span><br><span class="line">    if (element.pre) &#123;</span><br><span class="line">      inVPre &#x3D; false</span><br><span class="line">    &#125;</span><br><span class="line">    if (platformIsPreTag(element.tag)) &#123;</span><br><span class="line">      inPre &#x3D; false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  parseHTML(template, &#123;</span><br><span class="line">    warn,</span><br><span class="line">    expectHTML: options.expectHTML,</span><br><span class="line">    isUnaryTag: options.isUnaryTag,</span><br><span class="line">    canBeLeftOpenTag: options.canBeLeftOpenTag,</span><br><span class="line">    shouldDecodeNewlines: options.shouldDecodeNewlines,</span><br><span class="line">    start (tag, attrs, unary) &#123;</span><br><span class="line">      &#x2F;&#x2F; check namespace.</span><br><span class="line">      &#x2F;&#x2F; inherit parent ns if there is one</span><br><span class="line">      const ns &#x3D; (currentParent &amp;&amp; currentParent.ns) || platformGetTagNamespace(tag)</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; handle IE svg bug</span><br><span class="line">      &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">      if (isIE &amp;&amp; ns &#x3D;&#x3D;&#x3D; &#39;svg&#39;) &#123;</span><br><span class="line">        attrs &#x3D; guardIESVGBug(attrs)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      const element: ASTElement &#x3D; &#123;</span><br><span class="line">        type: 1,</span><br><span class="line">        tag,</span><br><span class="line">        attrsList: attrs,</span><br><span class="line">        attrsMap: makeAttrsMap(attrs),</span><br><span class="line">        parent: currentParent,</span><br><span class="line">        children: []</span><br><span class="line">      &#125;</span><br><span class="line">      if (ns) &#123;</span><br><span class="line">        element.ns &#x3D; ns</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 判断是不是style或者script</span><br><span class="line">      if (isForbiddenTag(element) &amp;&amp; !isServerRendering()) &#123;</span><br><span class="line">        element.forbidden &#x3D; true</span><br><span class="line">        process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; warn(</span><br><span class="line">          &#39;Templates should only be responsible for mapping the state to the &#39; +</span><br><span class="line">          &#39;UI. Avoid placing tags with side-effects in your templates, such as &#39; +</span><br><span class="line">          &#96;&lt;$&#123;tag&#125;&gt;&#96; + &#39;, as they will not be parsed.&#39;</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; apply pre-transforms</span><br><span class="line">      for (let i &#x3D; 0; i &lt; preTransforms.length; i++) &#123;</span><br><span class="line">        preTransforms[i](element, options)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (!inVPre) &#123; &#x2F;&#x2F; 是不是v-pre?</span><br><span class="line">        processPre(element)</span><br><span class="line">        if (element.pre) &#123;</span><br><span class="line">          inVPre &#x3D; true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (platformIsPreTag(element.tag)) &#123; &#x2F;&#x2F; 是不是pre标签</span><br><span class="line">        inPre &#x3D; true</span><br><span class="line">      &#125;</span><br><span class="line">      if (inVPre) &#123;</span><br><span class="line">        processRawAttrs(element)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; debugger</span><br><span class="line">        processFor(element) &#x2F;&#x2F; 检测v-for 详细阅读等到单独再看，下同</span><br><span class="line">        processIf(element) &#x2F;&#x2F; 检测v-if</span><br><span class="line">        processOnce(element) &#x2F;&#x2F; 检测v-once</span><br><span class="line">        processKey(element) &#x2F;&#x2F; 检测key属性</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; determine whether this is a plain element after</span><br><span class="line">        &#x2F;&#x2F; removing structural attributes</span><br><span class="line">        element.plain &#x3D; !element.key &amp;&amp; !attrs.length</span><br><span class="line"></span><br><span class="line">        processRef(element) &#x2F;&#x2F; 检测ref属性</span><br><span class="line">        processSlot(element) &#x2F;&#x2F; 检测slot属性</span><br><span class="line">        processComponent(element) &#x2F;&#x2F; 检测is属性</span><br><span class="line">        for (let i &#x3D; 0; i &lt; transforms.length; i++) &#123;</span><br><span class="line">          transforms[i](element, options) &#x2F;&#x2F; 检测class和style</span><br><span class="line">        &#125;</span><br><span class="line">        processAttrs(element) &#x2F;&#x2F; 检测attr</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      function checkRootConstraints (el) &#123;</span><br><span class="line">        if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">          if (el.tag &#x3D;&#x3D;&#x3D; &#39;slot&#39; || el.tag &#x3D;&#x3D;&#x3D; &#39;template&#39;) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              &#96;Cannot use &lt;$&#123;el.tag&#125;&gt; as component root element because it may &#96; +</span><br><span class="line">              &#39;contain multiple nodes.&#39;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          if (el.attrsMap.hasOwnProperty(&#39;v-for&#39;)) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              &#39;Cannot use v-for on stateful component root element because &#39; +</span><br><span class="line">              &#39;it renders multiple elements.&#39;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; tree management</span><br><span class="line">      if (!root) &#123;</span><br><span class="line">        root &#x3D; element</span><br><span class="line">        checkRootConstraints(root) &#x2F;&#x2F; 检测根节点的合法性</span><br><span class="line">      &#125; else if (!stack.length) &#123;</span><br><span class="line">        &#x2F;&#x2F; allow root elements with v-if, v-else-if and v-else</span><br><span class="line">        if (root.if &amp;&amp; (element.elseif || element.else)) &#123;</span><br><span class="line">          checkRootConstraints(element)</span><br><span class="line">          addIfCondition(root, &#123;</span><br><span class="line">            exp: element.elseif,</span><br><span class="line">            block: element</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; else if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">          warnOnce(</span><br><span class="line">            &#96;Component template should contain exactly one root element. &#96; +</span><br><span class="line">            &#96;If you are using v-if on multiple elements, &#96; +</span><br><span class="line">            &#96;use v-else-if to chain them instead.&#96;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (currentParent &amp;&amp; !element.forbidden) &#123;</span><br><span class="line">        if (element.elseif || element.else) &#123;</span><br><span class="line">          processIfConditions(element, currentParent)</span><br><span class="line">        &#125; else if (element.slotScope) &#123; &#x2F;&#x2F; scoped slot</span><br><span class="line">          currentParent.plain &#x3D; false</span><br><span class="line">          const name &#x3D; element.slotTarget || &#39;&quot;default&quot;&#39;</span><br><span class="line">          ;(currentParent.scopedSlots || (currentParent.scopedSlots &#x3D; &#123;&#125;))[name] &#x3D; element</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          currentParent.children.push(element) &#x2F;&#x2F; 添加子节点</span><br><span class="line">          element.parent &#x3D; currentParent &#x2F;&#x2F; 指向父节点</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (!unary) &#123;</span><br><span class="line">        currentParent &#x3D; element</span><br><span class="line">        stack.push(element)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        endPre(element)</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; apply post-transforms</span><br><span class="line">      for (let i &#x3D; 0; i &lt; postTransforms.length; i++) &#123;</span><br><span class="line">        postTransforms[i](element, options)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    end () &#123;</span><br><span class="line">      &#x2F;&#x2F; remove trailing whitespace</span><br><span class="line">      const element &#x3D; stack[stack.length - 1]</span><br><span class="line">      const lastNode &#x3D; element.children[element.children.length - 1]</span><br><span class="line">      if (lastNode &amp;&amp; lastNode.type &#x3D;&#x3D;&#x3D; 3 &amp;&amp; lastNode.text &#x3D;&#x3D;&#x3D; &#39; &#39; &amp;&amp; !inPre) &#123;</span><br><span class="line">        element.children.pop()</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; pop stack</span><br><span class="line">      stack.length -&#x3D; 1</span><br><span class="line">      currentParent &#x3D; stack[stack.length - 1]</span><br><span class="line">      endPre(element) &#x2F;&#x2F; 如果有pre指令，做相关操作</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    chars (text: string) &#123;</span><br><span class="line">      if (!currentParent) &#123; &#x2F;&#x2F; 没有currentParent表示text在前面，类似于xxx&lt;xxx&gt;&lt;&#x2F;xxx&gt;这样的</span><br><span class="line">        if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">          if (text &#x3D;&#x3D;&#x3D; template) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              &#39;Component template requires a root element, rather than just text.&#39;</span><br><span class="line">            )</span><br><span class="line">          &#125; else if ((text &#x3D; text.trim())) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              &#96;text &quot;$&#123;text&#125;&quot; outside root element will be ignored.&#96;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; IE textarea placeholder bug</span><br><span class="line">      &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">      if (isIE &amp;&amp;</span><br><span class="line">          currentParent.tag &#x3D;&#x3D;&#x3D; &#39;textarea&#39; &amp;&amp;</span><br><span class="line">          currentParent.attrsMap.placeholder &#x3D;&#x3D;&#x3D; text) &#123;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      const children &#x3D; currentParent.children</span><br><span class="line">      text &#x3D; inPre || text.trim()</span><br><span class="line">        ? decodeHTMLCached(text)</span><br><span class="line">        &#x2F;&#x2F; only preserve whitespace if its not right after a starting tag</span><br><span class="line">        : preserveWhitespace &amp;&amp; children.length ? &#39; &#39; : &#39;&#39;</span><br><span class="line">      if (text) &#123;</span><br><span class="line">        let expression</span><br><span class="line">        if (!inVPre &amp;&amp; text !&#x3D;&#x3D; &#39; &#39; &amp;&amp; (expression &#x3D; parseText(text, delimiters))) &#123; &#x2F;&#x2F; 表达式解析</span><br><span class="line">          children.push(&#123;</span><br><span class="line">            type: 2,</span><br><span class="line">            expression,</span><br><span class="line">            text</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; else if (text !&#x3D;&#x3D; &#39; &#39; || !children.length || children[children.length - 1].text !&#x3D;&#x3D; &#39; &#39;) &#123;</span><br><span class="line">          children.push(&#123;</span><br><span class="line">            type: 3,</span><br><span class="line">            text</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  return root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">export function parseHTML (html, options) &#123;</span><br><span class="line">  const stack &#x3D; []</span><br><span class="line">  const expectHTML &#x3D; options.expectHTML</span><br><span class="line">  const isUnaryTag &#x3D; options.isUnaryTag || no</span><br><span class="line">  const canBeLeftOpenTag &#x3D; options.canBeLeftOpenTag || no</span><br><span class="line">  let index &#x3D; 0</span><br><span class="line">  let last, lastTag</span><br><span class="line">  while (html) &#123; &#x2F;&#x2F; html是&#39;&lt;xxx&gt;xxxx&lt;&#x2F;xxx&gt;&#39;</span><br><span class="line">    debugger</span><br><span class="line">    last &#x3D; html</span><br><span class="line">    &#x2F;&#x2F; Make sure we&#39;re not in a plaintext content element like script&#x2F;style</span><br><span class="line">    if (!lastTag || !isPlainTextElement(lastTag)) &#123;</span><br><span class="line">      let textEnd &#x3D; html.indexOf(&#39;&lt;&#39;) &#x2F;&#x2F; 以&lt;开头</span><br><span class="line">      if (textEnd &#x3D;&#x3D;&#x3D; 0) &#123; &#x2F;&#x2F; 起始位</span><br><span class="line">        &#x2F;&#x2F; Comment:</span><br><span class="line">        if (comment.test(html)) &#123; &#x2F;&#x2F; 注释</span><br><span class="line">          const commentEnd &#x3D; html.indexOf(&#39;--&gt;&#39;)</span><br><span class="line"></span><br><span class="line">          if (commentEnd &gt;&#x3D; 0) &#123;</span><br><span class="line">            advance(commentEnd + 3)</span><br><span class="line">            continue</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; http:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Conditional_comment#Downlevel-revealed_conditional_comment</span><br><span class="line">        if (conditionalComment.test(html)) &#123; &#x2F;&#x2F; xml?</span><br><span class="line">          const conditionalEnd &#x3D; html.indexOf(&#39;]&gt;&#39;)</span><br><span class="line"></span><br><span class="line">          if (conditionalEnd &gt;&#x3D; 0) &#123;</span><br><span class="line">            advance(conditionalEnd + 2)</span><br><span class="line">            continue</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Doctype:</span><br><span class="line">        const doctypeMatch &#x3D; html.match(doctype)</span><br><span class="line">        if (doctypeMatch) &#123;</span><br><span class="line">          advance(doctypeMatch[0].length)</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; End tag:</span><br><span class="line">        const endTagMatch &#x3D; html.match(endTag) &#x2F;&#x2F; 结束标签&lt;&#x2F;xxx&gt;</span><br><span class="line">        if (endTagMatch) &#123;</span><br><span class="line">          const curIndex &#x3D; index</span><br><span class="line">          advance(endTagMatch[0].length)</span><br><span class="line">          parseEndTag(endTagMatch[1], curIndex, index)</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Start tag:</span><br><span class="line">        const startTagMatch &#x3D; parseStartTag() &#x2F;&#x2F; 开始标签&lt;xxx&gt;</span><br><span class="line">        if (startTagMatch) &#123;</span><br><span class="line">          handleStartTag(startTagMatch)</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; html不以&lt;开头</span><br><span class="line">      let text, rest, next</span><br><span class="line">      if (textEnd &gt;&#x3D; 0) &#123; &#x2F;&#x2F; html中还存在&lt;</span><br><span class="line">        rest &#x3D; html.slice(textEnd)</span><br><span class="line">        while (</span><br><span class="line">          !endTag.test(rest) &amp;&amp;</span><br><span class="line">          !startTagOpen.test(rest) &amp;&amp;</span><br><span class="line">          !comment.test(rest) &amp;&amp;</span><br><span class="line">          !conditionalComment.test(rest)</span><br><span class="line">        ) &#123;</span><br><span class="line">          &#x2F;&#x2F; &lt; in plain text, be forgiving and treat it as text</span><br><span class="line">          next &#x3D; rest.indexOf(&#39;&lt;&#39;, 1)</span><br><span class="line">          if (next &lt; 0) break</span><br><span class="line">          textEnd +&#x3D; next</span><br><span class="line">          rest &#x3D; html.slice(textEnd)</span><br><span class="line">        &#125;</span><br><span class="line">        text &#x3D; html.substring(0, textEnd) &#x2F;&#x2F; 截取到&lt;前的部分</span><br><span class="line">        advance(textEnd)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (textEnd &lt; 0) &#123;</span><br><span class="line">        text &#x3D; html</span><br><span class="line">        html &#x3D; &#39;&#39;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (options.chars &amp;&amp; text) &#123;</span><br><span class="line">        options.chars(text)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      var stackedTag &#x3D; lastTag.toLowerCase()</span><br><span class="line">      var reStackedTag &#x3D; reCache[stackedTag] || (reCache[stackedTag] &#x3D; new RegExp(&#39;([\\s\\S]*?)(&lt;&#x2F;&#39; + stackedTag + &#39;[^&gt;]*&gt;)&#39;, &#39;i&#39;))</span><br><span class="line">      var endTagLength &#x3D; 0</span><br><span class="line">      var rest &#x3D; html.replace(reStackedTag, function (all, text, endTag) &#123;</span><br><span class="line">        endTagLength &#x3D; endTag.length</span><br><span class="line">        if (!isPlainTextElement(stackedTag) &amp;&amp; stackedTag !&#x3D;&#x3D; &#39;noscript&#39;) &#123;</span><br><span class="line">          text &#x3D; text</span><br><span class="line">            .replace(&#x2F;&lt;!--([\s\S]*?)--&gt;&#x2F;g, &#39;$1&#39;)</span><br><span class="line">            .replace(&#x2F;&lt;!\[CDATA\[([\s\S]*?)]]&gt;&#x2F;g, &#39;$1&#39;)</span><br><span class="line">        &#125;</span><br><span class="line">        if (options.chars) &#123;</span><br><span class="line">          options.chars(text)</span><br><span class="line">        &#125;</span><br><span class="line">        return &#39;&#39;</span><br><span class="line">      &#125;)</span><br><span class="line">      index +&#x3D; html.length - rest.length</span><br><span class="line">      html &#x3D; rest</span><br><span class="line">      parseEndTag(stackedTag, index - endTagLength, index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (html &#x3D;&#x3D;&#x3D; last) &#123;</span><br><span class="line">      options.chars &amp;&amp; options.chars(html)</span><br><span class="line">      if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; !stack.length &amp;&amp; options.warn) &#123;</span><br><span class="line">        options.warn(&#96;Mal-formatted tag at end of template: &quot;$&#123;html&#125;&quot;&#96;)</span><br><span class="line">      &#125;</span><br><span class="line">      break</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Clean up any remaining tags 清除剩余的标签，这里因该是清除了不合法的标签，如只有单个的p标签之类的</span><br><span class="line">  parseEndTag()</span><br><span class="line"></span><br><span class="line">  function advance (n) &#123;</span><br><span class="line">    index +&#x3D; n</span><br><span class="line">    html &#x3D; html.substring(n) &#x2F;&#x2F; html截取</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function parseStartTag () &#123;</span><br><span class="line">    const start &#x3D; html.match(startTagOpen)</span><br><span class="line">    console.log(start)</span><br><span class="line">    if (start) &#123;</span><br><span class="line">      const match &#x3D; &#123;</span><br><span class="line">        tagName: start[1], &#x2F;&#x2F; 标签名</span><br><span class="line">        attrs: [],</span><br><span class="line">        start: index &#x2F;&#x2F; 起始位置</span><br><span class="line">      &#125;</span><br><span class="line">      advance(start[0].length)</span><br><span class="line">      let end, attr</span><br><span class="line">      while (!(end &#x3D; html.match(startTagClose)) &amp;&amp; (attr &#x3D; html.match(attribute))) &#123;</span><br><span class="line">        &#x2F;&#x2F; end匹配标签末尾&gt; attr匹配该标签的属性</span><br><span class="line">        advance(attr[0].length)</span><br><span class="line">        match.attrs.push(attr) &#x2F;&#x2F; 添加属性</span><br><span class="line">      &#125;</span><br><span class="line">      if (end) &#123;</span><br><span class="line">        match.unarySlash &#x3D; end[1]</span><br><span class="line">        advance(end[0].length)</span><br><span class="line">        match.end &#x3D; index &#x2F;&#x2F; 标签末尾的位置</span><br><span class="line">        return match</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function handleStartTag (match) &#123;</span><br><span class="line">    const tagName &#x3D; match.tagName &#x2F;&#x2F; 标签名</span><br><span class="line">    const unarySlash &#x3D; match.unarySlash</span><br><span class="line"></span><br><span class="line">    if (expectHTML) &#123;</span><br><span class="line">      if (lastTag &#x3D;&#x3D;&#x3D; &#39;p&#39; &amp;&amp; isNonPhrasingTag(tagName)) &#123; &#x2F;&#x2F; isNonPhrasingTag：判断标签是不是集合(这个集合代表什么暂时不清楚)内的标签</span><br><span class="line">        parseEndTag(lastTag)</span><br><span class="line">      &#125;</span><br><span class="line">      if (canBeLeftOpenTag(tagName) &amp;&amp; lastTag &#x3D;&#x3D;&#x3D; tagName) &#123;</span><br><span class="line">        parseEndTag(tagName)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const unary &#x3D; isUnaryTag(tagName) || tagName &#x3D;&#x3D;&#x3D; &#39;html&#39; &amp;&amp; lastTag &#x3D;&#x3D;&#x3D; &#39;head&#39; || !!unarySlash</span><br><span class="line"></span><br><span class="line">    const l &#x3D; match.attrs.length</span><br><span class="line">    const attrs &#x3D; new Array(l)</span><br><span class="line">    for (let i &#x3D; 0; i &lt; l; i++) &#123;</span><br><span class="line">      const args &#x3D; match.attrs[i]</span><br><span class="line">      &#x2F;&#x2F; hackish work around FF bug https:&#x2F;&#x2F;bugzilla.mozilla.org&#x2F;show_bug.cgi?id&#x3D;369778</span><br><span class="line">      if (IS_REGEX_CAPTURING_BROKEN &amp;&amp; args[0].indexOf(&#39;&quot;&quot;&#39;) &#x3D;&#x3D;&#x3D; -1) &#123;</span><br><span class="line">        if (args[3] &#x3D;&#x3D;&#x3D; &#39;&#39;) &#123; delete args[3] &#125;</span><br><span class="line">        if (args[4] &#x3D;&#x3D;&#x3D; &#39;&#39;) &#123; delete args[4] &#125;</span><br><span class="line">        if (args[5] &#x3D;&#x3D;&#x3D; &#39;&#39;) &#123; delete args[5] &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      const value &#x3D; args[3] || args[4] || args[5] || &#39;&#39;</span><br><span class="line">      attrs[i] &#x3D; &#123;</span><br><span class="line">        name: args[1],</span><br><span class="line">        value: decodeAttr(</span><br><span class="line">          value,</span><br><span class="line">          options.shouldDecodeNewlines</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!unary) &#123;</span><br><span class="line">      stack.push(&#123; tag: tagName, lowerCasedTag: tagName.toLowerCase(), attrs: attrs &#125;)</span><br><span class="line">      lastTag &#x3D; tagName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (options.start) &#123;</span><br><span class="line">      options.start(tagName, attrs, unary, match.start, match.end)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function parseEndTag (tagName, start, end) &#123;</span><br><span class="line">    let pos, lowerCasedTagName</span><br><span class="line">    if (start &#x3D;&#x3D; null) start &#x3D; index</span><br><span class="line">    if (end &#x3D;&#x3D; null) end &#x3D; index</span><br><span class="line"></span><br><span class="line">    if (tagName) &#123;</span><br><span class="line">      lowerCasedTagName &#x3D; tagName.toLowerCase()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Find the closest opened tag of the same type</span><br><span class="line">    if (tagName) &#123; &#x2F;&#x2F; 找到和闭合标签对应的开始标签 &lt;&#x2F;p&gt; --&gt; &lt;p&gt;</span><br><span class="line">      for (pos &#x3D; stack.length - 1; pos &gt;&#x3D; 0; pos--) &#123;</span><br><span class="line">        if (stack[pos].lowerCasedTag &#x3D;&#x3D;&#x3D; lowerCasedTagName) &#123;</span><br><span class="line">          break</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; If no tag name is provided, clean shop</span><br><span class="line">      pos &#x3D; 0</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (pos &gt;&#x3D; 0) &#123;</span><br><span class="line">      &#x2F;&#x2F; Close all the open elements, up the stack</span><br><span class="line">      for (let i &#x3D; stack.length - 1; i &gt;&#x3D; pos; i--) &#123;</span><br><span class="line">        if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp;</span><br><span class="line">            (i &gt; pos || !tagName) &amp;&amp;</span><br><span class="line">            options.warn) &#123;</span><br><span class="line">          options.warn(</span><br><span class="line">            &#96;tag &lt;$&#123;stack[i].tag&#125;&gt; has no matching end tag.&#96;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        if (options.end) &#123;</span><br><span class="line">          options.end(stack[i].tag, start, end)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; Remove the open elements from the stack</span><br><span class="line">      stack.length &#x3D; pos</span><br><span class="line">      lastTag &#x3D; pos &amp;&amp; stack[pos - 1].tag</span><br><span class="line">    &#125; else if (lowerCasedTagName &#x3D;&#x3D;&#x3D; &#39;br&#39;) &#123;</span><br><span class="line">      if (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], true, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (lowerCasedTagName &#x3D;&#x3D;&#x3D; &#39;p&#39;) &#123;</span><br><span class="line">      if (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], false, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">      if (options.end) &#123;</span><br><span class="line">        options.end(tagName, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一层一层的解析 html，从<div><p></p></div> –&gt; <p></p></div> –&gt; … –&gt; </div>, 把每一个标签所含的属性、指令等提取出来，放在一个对象中，最终返回下面结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: 1,</span><br><span class="line">  tag: &#39;div&#39;,</span><br><span class="line">  plain: false,</span><br><span class="line">  parent: undefined,</span><br><span class="line">  attrs: [&#123;name:&#39;id&#39;, value: &#39;&quot;app&quot;&#39;&#125;],</span><br><span class="line">  attrsList: [&#123;name:&#39;id&#39;, value: &#39;app&#39;&#125;],</span><br><span class="line">  attrsMap: &#123;id: &#39;app&#39;&#125;,</span><br><span class="line">  children: [&#123;</span><br><span class="line">    type: 1,</span><br><span class="line">    tag: &#39;p&#39;,</span><br><span class="line">    plain: true,</span><br><span class="line">    parent: ast,</span><br><span class="line">    attrs: [],</span><br><span class="line">    attrsList: [],</span><br><span class="line">    attrsMap: &#123;&#125;,</span><br><span class="line">    children: [&#123;</span><br><span class="line">      expression: &quot;_s(message)&quot;,</span><br><span class="line">      text: &quot;&#123;&#123;message&#125;&#125;&quot;,</span><br><span class="line">      type: 2</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是静态节点的判断</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Goal of the optimizer: walk the generated template AST tree</span><br><span class="line"> * and detect sub-trees that are purely static, i.e. parts of</span><br><span class="line"> * the DOM that never needs to change.</span><br><span class="line"> * 删除ast中的静态（永远不会改变的）节点？</span><br><span class="line"> * Once we detect these sub-trees, we can: 优点</span><br><span class="line"> *</span><br><span class="line"> * 1. Hoist them into constants, so that we no longer need to</span><br><span class="line"> *    create fresh nodes for them on each re-render;</span><br><span class="line"> *    在重新渲染的时候不用再去管这些节点</span><br><span class="line"> * 2. Completely skip them in the patching process.在修补的时候无视他们？</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function optimize (root: ?ASTElement, options: CompilerOptions) &#123;</span><br><span class="line">  &#x2F;&#x2F; debugger</span><br><span class="line">  if (!root) return</span><br><span class="line">  isStaticKey &#x3D; genStaticKeysCached(options.staticKeys || &#39;&#39;)</span><br><span class="line">  isPlatformReservedTag &#x3D; options.isReservedTag || no</span><br><span class="line">  &#x2F;&#x2F; first pass: mark all non-static nodes.</span><br><span class="line">  markStatic(root)</span><br><span class="line">  &#x2F;&#x2F; second pass: mark static roots.</span><br><span class="line">  markStaticRoots(root, false)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 得到结果</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  type: 1,</span><br><span class="line">  tag: &#39;div&#39;,</span><br><span class="line">  plain: false,</span><br><span class="line">  parent: undefined,</span><br><span class="line">  attrs: [&#123;name:&#39;id&#39;, value: &#39;&quot;app&quot;&#39;&#125;],</span><br><span class="line">  attrsList: [&#123;name:&#39;id&#39;, value: &#39;app&#39;&#125;],</span><br><span class="line">  attrsMap: &#123;id: &#39;app&#39;&#125;,</span><br><span class="line">  static: false,</span><br><span class="line">  staticRoot: false,</span><br><span class="line">  children: [&#123;</span><br><span class="line">    type: 1,</span><br><span class="line">    tag: &#39;p&#39;,</span><br><span class="line">    plain: true,</span><br><span class="line">    parent: ast,</span><br><span class="line">    attrs: [],</span><br><span class="line">    attrsList: [],</span><br><span class="line">    attrsMap: &#123;&#125;,</span><br><span class="line">    static: false,</span><br><span class="line">    staticRoot: false,</span><br><span class="line">    children: [&#123;</span><br><span class="line">      expression: &quot;_s(message)&quot;,</span><br><span class="line">      text: &quot;&#123;&#123;message&#125;&#125;&quot;,</span><br><span class="line">      type: 2,</span><br><span class="line">      static: false</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; ps:按照例子其实children里有更多项的，但我不知道怎么复制打印出来的对象，就用了别人的输出</span><br></pre></td></tr></table></figure>

<p>optimize 通过遍历 ast，主要判断了节点是不是 static(markStatic 方法)，staticRoot(markStaticRoots 方法)，<br>接下去是进行 generate 处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">export function generate (</span><br><span class="line">  ast: ASTElement | void,</span><br><span class="line">  options: CompilerOptions</span><br><span class="line">): &#123;</span><br><span class="line">  render: string,</span><br><span class="line">  staticRenderFns: Array&lt;string&gt;</span><br><span class="line">&#125; &#123;</span><br><span class="line">  &#x2F;&#x2F; save previous staticRenderFns so generate calls can be nested</span><br><span class="line">  const prevStaticRenderFns: Array&lt;string&gt; &#x3D; staticRenderFns</span><br><span class="line">  const currentStaticRenderFns: Array&lt;string&gt; &#x3D; staticRenderFns &#x3D; []</span><br><span class="line">  const prevOnceCount &#x3D; onceCount</span><br><span class="line">  onceCount &#x3D; 0</span><br><span class="line">  currentOptions &#x3D; options</span><br><span class="line">  warn &#x3D; options.warn || baseWarn</span><br><span class="line">  transforms &#x3D; pluckModuleFunction(options.modules, &#39;transformCode&#39;)</span><br><span class="line">  dataGenFns &#x3D; pluckModuleFunction(options.modules, &#39;genData&#39;)</span><br><span class="line">  platformDirectives &#x3D; options.directives || &#123;&#125;</span><br><span class="line">  isPlatformReservedTag &#x3D; options.isReservedTag || no</span><br><span class="line">  const code &#x3D; ast ? genElement(ast) : &#39;_c(&quot;div&quot;)&#39; &#x2F;&#x2F; 生成render函数</span><br><span class="line">  staticRenderFns &#x3D; prevStaticRenderFns</span><br><span class="line">  onceCount &#x3D; prevOnceCount</span><br><span class="line">  return &#123;</span><br><span class="line">    render: &#96;with(this)&#123;return $&#123;code&#125;&#125;&#96;,</span><br><span class="line">    staticRenderFns: currentStaticRenderFns</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function genElement (el: ASTElement): string &#123;</span><br><span class="line">  if (el.staticRoot &amp;&amp; !el.staticProcessed) &#123;</span><br><span class="line">    return genStatic(el) &#x2F;&#x2F; static render</span><br><span class="line">  &#125; else if (el.once &amp;&amp; !el.onceProcessed) &#123;</span><br><span class="line">    return genOnce(el) &#x2F;&#x2F; once render</span><br><span class="line">  &#125; else if (el.for &amp;&amp; !el.forProcessed) &#123;</span><br><span class="line">    return genFor(el) &#x2F;&#x2F; for render</span><br><span class="line">  &#125; else if (el.if &amp;&amp; !el.ifProcessed) &#123;</span><br><span class="line">    return genIf(el) &#x2F;&#x2F; if render</span><br><span class="line">  &#125; else if (el.tag &#x3D;&#x3D;&#x3D; &#39;template&#39; &amp;&amp; !el.slotTarget) &#123;</span><br><span class="line">    return genChildren(el) || &#39;void 0&#39; &#x2F;&#x2F; template render</span><br><span class="line">  &#125; else if (el.tag &#x3D;&#x3D;&#x3D; &#39;slot&#39;) &#123;</span><br><span class="line">    return genSlot(el) &#x2F;&#x2F; slot render</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; component or element</span><br><span class="line">    let code</span><br><span class="line">    if (el.component) &#123; &#x2F;&#x2F; component render</span><br><span class="line">      code &#x3D; genComponent(el.component, el)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      const data &#x3D; el.plain ? undefined : genData(el) &#x2F;&#x2F; 拼接属性 生成头结点render</span><br><span class="line"></span><br><span class="line">      const children &#x3D; el.inlineTemplate ? null : genChildren(el, true) &#x2F;&#x2F; 遍历生成子节点render</span><br><span class="line">      code &#x3D; &#96;_c(&#39;$&#123;el.tag&#125;&#39;$&#123;</span><br><span class="line">        data ? &#96;,$&#123;data&#125;&#96; : &#39;&#39; &#x2F;&#x2F; data</span><br><span class="line">      &#125;$&#123;</span><br><span class="line">        children ? &#96;,$&#123;children&#125;&#96; : &#39;&#39; &#x2F;&#x2F; children</span><br><span class="line">      &#125;)&#96;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; module transforms</span><br><span class="line">    for (let i &#x3D; 0; i &lt; transforms.length; i++) &#123;</span><br><span class="line">      code &#x3D; transforms[i](el, code)</span><br><span class="line">    &#125;</span><br><span class="line">    return code</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function genChildren (el: ASTElement, checkSkip?: boolean): string | void &#123;</span><br><span class="line">  const children &#x3D; el.children</span><br><span class="line">  if (children.length) &#123;</span><br><span class="line">    const el: any &#x3D; children[0]</span><br><span class="line">    &#x2F;&#x2F; optimize single v-for</span><br><span class="line">    if (children.length &#x3D;&#x3D;&#x3D; 1 &amp;&amp;</span><br><span class="line">        el.for &amp;&amp;</span><br><span class="line">        el.tag !&#x3D;&#x3D; &#39;template&#39; &amp;&amp;</span><br><span class="line">        el.tag !&#x3D;&#x3D; &#39;slot&#39;) &#123;</span><br><span class="line">      return genElement(el)</span><br><span class="line">    &#125;</span><br><span class="line">    const normalizationType &#x3D; checkSkip ? getNormalizationType(children) : 0</span><br><span class="line">    return &#96;[$&#123;children.map(genNode).join(&#39;,&#39;)&#125;]$&#123;</span><br><span class="line">      normalizationType ? &#96;,$&#123;normalizationType&#125;&#96; : &#39;&#39;</span><br><span class="line">    &#125;&#96;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function genNode (node: ASTNode): string &#123;</span><br><span class="line">  if (node.type &#x3D;&#x3D;&#x3D; 1) &#123;</span><br><span class="line">    return genElement(node)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return genText(node)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>generate –&gt; genElement –&gt; {<br>直接 render<br>children –&gt; 遍历判断+render<br>}</p>
<p>最终返回了一个静态节点的 render 和动态节点的 render。</p>
<p>然后进行错误和建议的判断和提示</p>
<p>然后是把 render 字符串通过 new Function 生成 render 函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; turn code into functions 生成render函数</span><br><span class="line">    const res &#x3D; &#123;&#125;</span><br><span class="line">    const fnGenErrors &#x3D; []</span><br><span class="line">    res.render &#x3D; makeFunction(compiled.render, fnGenErrors)</span><br><span class="line">    const l &#x3D; compiled.staticRenderFns.length</span><br><span class="line">    res.staticRenderFns &#x3D; new Array(l)</span><br><span class="line">    for (let i &#x3D; 0; i &lt; l; i++) &#123;</span><br><span class="line">      res.staticRenderFns[i] &#x3D; makeFunction(compiled.staticRenderFns[i], fnGenErrors)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    。。。。。。</span><br><span class="line"></span><br><span class="line">    return (functionCompileCache[key] &#x3D; res)</span><br><span class="line"></span><br><span class="line">    。。。。。。</span><br><span class="line"></span><br><span class="line">    render &#x3D; function () &#123;</span><br><span class="line">      with(this)&#123;return _c(&#39;div&#39;,&#123;attrs:&#123;&quot;id&quot;:&quot;app&quot;&#125;&#125;,[_c(&#39;p&#39;,[_v(_s(message))])])&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>顺便一提，render 里面的_c,_v 之类的方法在 src/core/instance/render.js 中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._o &#x3D; markOnce</span><br><span class="line">Vue.prototype._n &#x3D; toNumber</span><br><span class="line">Vue.prototype._s &#x3D; _toString</span><br><span class="line">Vue.prototype._l &#x3D; renderList</span><br><span class="line">Vue.prototype._t &#x3D; renderSlot</span><br><span class="line">Vue.prototype._q &#x3D; looseEqual</span><br><span class="line">Vue.prototype._i &#x3D; looseIndexOf</span><br><span class="line">Vue.prototype._m &#x3D; renderStatic</span><br><span class="line">Vue.prototype._f &#x3D; resolveFilter</span><br><span class="line">Vue.prototype._k &#x3D; checkKeyCodes</span><br><span class="line">Vue.prototype._b &#x3D; bindObjectProps</span><br><span class="line">Vue.prototype._v &#x3D; createTextVNode</span><br><span class="line">Vue.prototype._e &#x3D; createEmptyVNode</span><br><span class="line">Vue.prototype._u &#x3D; resolveScopedSlots</span><br></pre></td></tr></table></figure>

<p>又回到$mount 方法</p>
<p>return mount.call(this, el, hydrating)</p>
<h3 id="mountComponent-src-core-instance-lifecycle-js"><a href="#mountComponent-src-core-instance-lifecycle-js" class="headerlink" title="mountComponent /src/core/instance/lifecycle.js"></a>mountComponent /src/core/instance/lifecycle.js</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; public mount method</span><br><span class="line">Vue.prototype.$mount &#x3D; function (</span><br><span class="line">  el?: string | Element,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): Component &#123;</span><br><span class="line">  el &#x3D; el &amp;&amp; inBrowser ? query(el) : undefined</span><br><span class="line">  return mountComponent(this, el, hydrating)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function mountComponent (</span><br><span class="line">  vm: Component,</span><br><span class="line">  el: ?Element,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): Component &#123;</span><br><span class="line">  vm.$el &#x3D; el</span><br><span class="line">  if (!vm.$options.render) &#123;</span><br><span class="line">    vm.$options.render &#x3D; createEmptyVNode</span><br><span class="line">    if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">      &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">      if ((vm.$options.template &amp;&amp; vm.$options.template.charAt(0) !&#x3D;&#x3D; &#39;#&#39;) ||</span><br><span class="line">        vm.$options.el || el) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          &#39;You are using the runtime-only build of Vue where the template &#39; +</span><br><span class="line">          &#39;compiler is not available. Either pre-compile the templates into &#39; +</span><br><span class="line">          &#39;render functions, or use the compiler-included build.&#39;,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        warn(</span><br><span class="line">          &#39;Failed to mount component: template or render function not defined.&#39;,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  callHook(vm, &#39;beforeMount&#39;) &#x2F;&#x2F; beforeMount处理</span><br><span class="line">  debugger</span><br><span class="line"></span><br><span class="line">  let updateComponent</span><br><span class="line">  &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">  if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">    updateComponent &#x3D; () &#x3D;&gt; &#123;</span><br><span class="line">      const name &#x3D; vm._name</span><br><span class="line">      const id &#x3D; vm._uid</span><br><span class="line">      const startTag &#x3D; &#96;vue-perf-start:$&#123;id&#125;&#96;</span><br><span class="line">      const endTag &#x3D; &#96;vue-perf-end:$&#123;id&#125;&#96;</span><br><span class="line"></span><br><span class="line">      mark(startTag)</span><br><span class="line">      const vnode &#x3D; vm._render()</span><br><span class="line">      mark(endTag)</span><br><span class="line">      measure(&#96;$&#123;name&#125; render&#96;, startTag, endTag)</span><br><span class="line"></span><br><span class="line">      mark(startTag)</span><br><span class="line">      vm._update(vnode, hydrating)</span><br><span class="line">      mark(endTag)</span><br><span class="line">      measure(&#96;$&#123;name&#125; patch&#96;, startTag, endTag)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    updateComponent &#x3D; () &#x3D;&gt; &#123;</span><br><span class="line">      vm._update(vm._render(), hydrating)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vm._watcher &#x3D; new Watcher(vm, updateComponent, noop)</span><br><span class="line">  hydrating &#x3D; false</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; manually mounted instance, call mounted on self</span><br><span class="line">  &#x2F;&#x2F; mounted is called for render-created child components in its inserted hook</span><br><span class="line">  if (vm.$vnode &#x3D;&#x3D; null) &#123;</span><br><span class="line">    vm._isMounted &#x3D; true</span><br><span class="line">    callHook(vm, &#39;mounted&#39;)</span><br><span class="line">  &#125;</span><br><span class="line">  return vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mountComponent 方法定义了 updateComponent，并设置了监听，最后又到了 Wathcer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">constructor (</span><br><span class="line">    vm: Component,</span><br><span class="line">    expOrFn: string | Function,</span><br><span class="line">    cb: Function,</span><br><span class="line">    options?: Object</span><br><span class="line">  ) &#123;</span><br><span class="line">    this.vm &#x3D; vm</span><br><span class="line">    vm._watchers.push(this)</span><br><span class="line">    &#x2F;&#x2F; options</span><br><span class="line">    if (options) &#123;</span><br><span class="line">      this.deep &#x3D; !!options.deep</span><br><span class="line">      this.user &#x3D; !!options.user</span><br><span class="line">      this.lazy &#x3D; !!options.lazy</span><br><span class="line">      this.sync &#x3D; !!options.sync</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      this.deep &#x3D; this.user &#x3D; this.lazy &#x3D; this.sync &#x3D; false</span><br><span class="line">    &#125;</span><br><span class="line">    this.cb &#x3D; cb</span><br><span class="line">    this.id &#x3D; ++uid &#x2F;&#x2F; uid for batching</span><br><span class="line">    this.active &#x3D; true</span><br><span class="line">    this.dirty &#x3D; this.lazy &#x2F;&#x2F; for lazy watchers</span><br><span class="line">    this.deps &#x3D; []</span><br><span class="line">    this.newDeps &#x3D; []</span><br><span class="line">    this.depIds &#x3D; new Set()</span><br><span class="line">    this.newDepIds &#x3D; new Set()</span><br><span class="line">    this.expression &#x3D; process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;</span><br><span class="line">      ? expOrFn.toString()</span><br><span class="line">      : &#39;&#39;</span><br><span class="line">    &#x2F;&#x2F; parse expression for getter</span><br><span class="line">    if (typeof expOrFn &#x3D;&#x3D;&#x3D; &#39;function&#39;) &#123;</span><br><span class="line">      this.getter &#x3D; expOrFn</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      this.getter &#x3D; parsePath(expOrFn)</span><br><span class="line">      if (!this.getter) &#123;</span><br><span class="line">        this.getter &#x3D; function () &#123;&#125;</span><br><span class="line">        process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; warn(</span><br><span class="line">          &#96;Failed watching path: &quot;$&#123;expOrFn&#125;&quot; &#96; +</span><br><span class="line">          &#39;Watcher only accepts simple dot-delimited paths. &#39; +</span><br><span class="line">          &#39;For full control, use a function instead.&#39;,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    this.value &#x3D; this.lazy</span><br><span class="line">      ? undefined</span><br><span class="line">      : this.get()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Evaluate the getter, and re-collect dependencies.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  get () &#123;</span><br><span class="line">    pushTarget(this)</span><br><span class="line">    let value</span><br><span class="line">    const vm &#x3D; this.vm</span><br><span class="line">    if (this.user) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        value &#x3D; this.getter.call(vm, vm)</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        handleError(e, vm, &#96;getter for watcher &quot;$&#123;this.expression&#125;&quot;&#96;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      value &#x3D; this.getter.call(vm, vm)</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; &quot;touch&quot; every property so they are all tracked as</span><br><span class="line">    &#x2F;&#x2F; dependencies for deep watching</span><br><span class="line">    if (this.deep) &#123;</span><br><span class="line">      traverse(value)</span><br><span class="line">    &#125;</span><br><span class="line">    popTarget()</span><br><span class="line">    this.cleanupDeps()</span><br><span class="line">    return value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Watcher 里面定义了 getter，又在最后调用了 get()方法，然后在 get 里面，又使用了 getter 方法，其实就是 updateComponent 方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm._update(vm._render(), hydrating)</span><br></pre></td></tr></table></figure>

<p>updateComponent 里面，显示执行了 vm._render()，然后执行 vm._update()</p>
<h3 id="vm-render"><a href="#vm-render" class="headerlink" title="vm._render()"></a>vm._render()</h3><p>vm._render()在 src/core/instance/render.js 中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._render &#x3D; function (): VNode &#123;</span><br><span class="line">    const vm: Component &#x3D; this</span><br><span class="line">    const &#123;</span><br><span class="line">      render,</span><br><span class="line">      staticRenderFns,</span><br><span class="line">      _parentVnode</span><br><span class="line">    &#125; &#x3D; vm.$options</span><br><span class="line"></span><br><span class="line">    if (vm._isMounted) &#123;</span><br><span class="line">      &#x2F;&#x2F; clone slot nodes on re-renders</span><br><span class="line">      for (const key in vm.$slots) &#123;</span><br><span class="line">        vm.$slots[key] &#x3D; cloneVNodes(vm.$slots[key])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vm.$scopedSlots &#x3D; (_parentVnode &amp;&amp; _parentVnode.data.scopedSlots) || emptyObject</span><br><span class="line"></span><br><span class="line">    if (staticRenderFns &amp;&amp; !vm._staticTrees) &#123;</span><br><span class="line">      vm._staticTrees &#x3D; []</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; set parent vnode. this allows render functions to have access</span><br><span class="line">    &#x2F;&#x2F; to the data on the placeholder node.</span><br><span class="line">    vm.$vnode &#x3D; _parentVnode</span><br><span class="line">    &#x2F;&#x2F; render self</span><br><span class="line">    let vnode</span><br><span class="line">    try &#123;</span><br><span class="line">      vnode &#x3D; render.call(vm._renderProxy, vm.$createElement)</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      handleError(e, vm, &#96;render function&#96;)</span><br><span class="line">      &#x2F;&#x2F; return error render result,</span><br><span class="line">      &#x2F;&#x2F; or previous vnode to prevent render error causing blank component</span><br><span class="line">      &#x2F;* istanbul ignore else *&#x2F;</span><br><span class="line">      if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">        vnode &#x3D; vm.$options.renderError</span><br><span class="line">          ? vm.$options.renderError.call(vm._renderProxy, vm.$createElement, e)</span><br><span class="line">          : vm._vnode</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        vnode &#x3D; vm._vnode</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; return empty vnode in case the render function errored out</span><br><span class="line">    if (!(vnode instanceof VNode)) &#123;</span><br><span class="line">      if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; Array.isArray(vnode)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          &#39;Multiple root nodes returned from render function. Render function &#39; +</span><br><span class="line">          &#39;should return a single root node.&#39;,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      vnode &#x3D; createEmptyVNode()</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; set parent</span><br><span class="line">    vnode.parent &#x3D; _parentVnode</span><br><span class="line">    return vnode</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，_render 返回了 vnode，而 vnode 是通过 render 函数产生的，这里的 render 函数，就是上面非静态节点的那个 render 函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(function anonymous(</span><br><span class="line">) &#123;</span><br><span class="line">with(this)&#123;return _c(&#39;div&#39;,&#123;attrs:&#123;&quot;id&quot;:&quot;app&quot;&#125;&#125;,[_c(&#39;p&#39;,[_v(_s(message))]),_v(&quot; &quot;),_m(0)])&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在这里，调用了_c,_v，_m 等<br>vm._c = (a, b, c, d) =&gt; createElement(vm, a, b, c, d, false)<br>Vue.prototype._v = createTextVNode<br>Vue.prototype._m = renderStatic<br>Vue.prototype._s = _toString</p>
<p>触发上面函数，先是被 proxy 的 has 捕捉到了，然后是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sharedPropertyDefinition.get &#x3D; function proxyGetter () &#123;</span><br><span class="line">    return this[sourceKey][key] &#x2F;&#x2F; this[&#39;_data&#39;][&#39;message&#39;]</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>得到了 message 的值</p>
<h4 id="createTextVNode"><a href="#createTextVNode" class="headerlink" title="createTextVNode"></a>createTextVNode</h4><p>src/core/vdom/vnode.js<br>message 就是 vm._data.message, _toString 就是把 message 转成 string，然后是 createTextVNode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">class VNode &#123;</span><br><span class="line">  constructor (</span><br><span class="line">    tag?: string,</span><br><span class="line">    data?: VNodeData,</span><br><span class="line">    children?: ?Array&lt;VNode&gt;,</span><br><span class="line">    text?: string,</span><br><span class="line">    elm?: Node,</span><br><span class="line">    context?: Component,</span><br><span class="line">    componentOptions?: VNodeComponentOptions</span><br><span class="line">  ) &#123;</span><br><span class="line">    this.tag &#x3D; tag</span><br><span class="line">    this.data &#x3D; data</span><br><span class="line">    this.children &#x3D; children</span><br><span class="line">    this.text &#x3D; text</span><br><span class="line">    this.elm &#x3D; elm</span><br><span class="line">    this.ns &#x3D; undefined</span><br><span class="line">    this.context &#x3D; context</span><br><span class="line">    this.functionalContext &#x3D; undefined</span><br><span class="line">    this.key &#x3D; data &amp;&amp; data.key</span><br><span class="line">    this.componentOptions &#x3D; componentOptions</span><br><span class="line">    this.componentInstance &#x3D; undefined</span><br><span class="line">    this.parent &#x3D; undefined</span><br><span class="line">    this.raw &#x3D; false</span><br><span class="line">    this.isStatic &#x3D; false</span><br><span class="line">    this.isRootInsert &#x3D; true</span><br><span class="line">    this.isComment &#x3D; false</span><br><span class="line">    this.isCloned &#x3D; false</span><br><span class="line">    this.isOnce &#x3D; false</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  export function createTextVNode (val: string | number) &#123;</span><br><span class="line">    return new VNode(undefined, undefined, undefined, String(val)) &#x2F;&#x2F; 返回vnode</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的 VNode 仅仅是初始化了一些值</p>
<p>然后是 createElement</p>
<h4 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement</h4><p>src/core/vdom/create-element.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; wrapper function for providing a more flexible interface</span><br><span class="line">&#x2F;&#x2F; 翻译：包装函数为了提供一个更灵活的接口</span><br><span class="line">&#x2F;&#x2F; without getting yelled at by flow</span><br><span class="line">export function createElement (</span><br><span class="line">  context: Component,</span><br><span class="line">  tag: any,</span><br><span class="line">  data: any,</span><br><span class="line">  children: any,</span><br><span class="line">  normalizationType: any,</span><br><span class="line">  alwaysNormalize: boolean</span><br><span class="line">): VNode &#123;</span><br><span class="line">  if (Array.isArray(data) || isPrimitive(data)) &#123;</span><br><span class="line">    normalizationType &#x3D; children</span><br><span class="line">    children &#x3D; data</span><br><span class="line">    data &#x3D; undefined</span><br><span class="line">  &#125;</span><br><span class="line">  if (alwaysNormalize) normalizationType &#x3D; ALWAYS_NORMALIZE</span><br><span class="line">  return _createElement(context, tag, data, children, normalizationType)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function _createElement (</span><br><span class="line">  context: Component,</span><br><span class="line">  tag?: string | Class&lt;Component&gt; | Function | Object,</span><br><span class="line">  data?: VNodeData,</span><br><span class="line">  children?: any,</span><br><span class="line">  normalizationType?: number</span><br><span class="line">): VNode &#123;</span><br><span class="line">  debugger</span><br><span class="line">  if (data &amp;&amp; data.__ob__) &#123;</span><br><span class="line">    process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; warn(</span><br><span class="line">      &#96;Avoid using observed data object as vnode data: $&#123;JSON.stringify(data)&#125;\n&#96; +</span><br><span class="line">      &#39;Always create fresh vnode data objects in each render!&#39;,</span><br><span class="line">      context</span><br><span class="line">    )</span><br><span class="line">    return createEmptyVNode()</span><br><span class="line">  &#125;</span><br><span class="line">  if (!tag) &#123;</span><br><span class="line">    &#x2F;&#x2F; in case of component :is set to falsy value</span><br><span class="line">    return createEmptyVNode()</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; support single function children as default scoped slot</span><br><span class="line">  if (Array.isArray(children) &amp;&amp;</span><br><span class="line">      typeof children[0] &#x3D;&#x3D;&#x3D; &#39;function&#39;) &#123;</span><br><span class="line">    data &#x3D; data || &#123;&#125;</span><br><span class="line">    data.scopedSlots &#x3D; &#123; default: children[0] &#125;</span><br><span class="line">    children.length &#x3D; 0</span><br><span class="line">  &#125;</span><br><span class="line">  if (normalizationType &#x3D;&#x3D;&#x3D; ALWAYS_NORMALIZE) &#123;</span><br><span class="line">    children &#x3D; normalizeChildren(children)</span><br><span class="line">  &#125; else if (normalizationType &#x3D;&#x3D;&#x3D; SIMPLE_NORMALIZE) &#123;</span><br><span class="line">    children &#x3D; simpleNormalizeChildren(children)</span><br><span class="line">  &#125;</span><br><span class="line">  let vnode, ns</span><br><span class="line">  if (typeof tag &#x3D;&#x3D;&#x3D; &#39;string&#39;) &#123;</span><br><span class="line">    let Ctor</span><br><span class="line">    ns &#x3D; config.getTagNamespace(tag)</span><br><span class="line">    if (config.isReservedTag(tag)) &#123;</span><br><span class="line">      &#x2F;&#x2F; platform built-in elements</span><br><span class="line">      vnode &#x3D; new VNode(</span><br><span class="line">        config.parsePlatformTagName(tag), data, children,</span><br><span class="line">        undefined, undefined, context</span><br><span class="line">      )</span><br><span class="line">    &#125; else if ((Ctor &#x3D; resolveAsset(context.$options, &#39;components&#39;, tag))) &#123;</span><br><span class="line">      &#x2F;&#x2F; component</span><br><span class="line">      vnode &#x3D; createComponent(Ctor, data, context, children, tag)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; unknown or unlisted namespaced elements</span><br><span class="line">      &#x2F;&#x2F; check at runtime because it may get assigned a namespace when its</span><br><span class="line">      &#x2F;&#x2F; parent normalizes children</span><br><span class="line">      vnode &#x3D; new VNode(</span><br><span class="line">        tag, data, children,</span><br><span class="line">        undefined, undefined, context</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; direct component options &#x2F; constructor</span><br><span class="line">    vnode &#x3D; createComponent(tag, data, context, children)</span><br><span class="line">  &#125;</span><br><span class="line">  if (vnode) &#123;</span><br><span class="line">    if (ns) applyNS(vnode, ns)</span><br><span class="line">    return vnode</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return createEmptyVNode()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把数据的 VNode 放在了标签的 VNode 里，形成了父子关系（在某些情况下会返回一个空的 VNode）</p>
<h4 id="renderStatic"><a href="#renderStatic" class="headerlink" title="renderStatic"></a>renderStatic</h4><p>src/core/instance/render-helpers/render-static.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Runtime helper for rendering static trees.</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function renderStatic (</span><br><span class="line">  index: number,</span><br><span class="line">  isInFor?: boolean</span><br><span class="line">): VNode | Array&lt;VNode&gt; &#123;</span><br><span class="line">  let tree &#x3D; this._staticTrees[index]</span><br><span class="line">  &#x2F;&#x2F; if has already-rendered static tree and not inside v-for,</span><br><span class="line">  &#x2F;&#x2F; we can reuse the same tree by doing a shallow clone.</span><br><span class="line">  &#x2F;&#x2F; 翻译：如果已存在渲染好的静态树并不在v-for之内，我们可以通过浅拷贝重用它</span><br><span class="line">  if (tree &amp;&amp; !isInFor) &#123;</span><br><span class="line">    return Array.isArray(tree)</span><br><span class="line">      ? cloneVNodes(tree)</span><br><span class="line">      : cloneVNode(tree)</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; otherwise, render a fresh tree. 否则，渲染一颗新树</span><br><span class="line">  tree &#x3D; this._staticTrees[index] &#x3D;</span><br><span class="line">    this.$options.staticRenderFns[index].call(this._renderProxy)</span><br><span class="line">  markStatic(tree, &#96;__static__$&#123;index&#125;&#96;, false)</span><br><span class="line">  return tree</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里，tree 就是上面的静态渲染 render 函数所运行的结果—-一个 VNode 对象，然后 markStatic 给 tree 添加了一些标识符</p>
<p>看到这里我们已经可以得出 vm._render()最终返回了一个 VNode 树</p>
<p>然后就是 vm._update 了</p>
<h3 id="vm-update"><a href="#vm-update" class="headerlink" title="vm._update"></a>vm._update</h3><p>该方法在 src/core/instance/lifecycle.js 里</p>
<p>vm._update 里面先是调用了 patch 方法，给 vnode 添加了一个属性 elm，vnode 的 children 也是同样道理，这个 elm 其实就是经过处理后的 html 模板了。<br>然后在父节点插入了这个 elm，就是我们最终看到的页面 dom，最后通过 removeVnodes()删除了旧的 html 和 vnode.data 里的一些东西(这里没看懂)<br>然后进行了一些赋值操作 update 就结束了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._update &#x3D; function (vnode: VNode, hydrating?: boolean) &#123;</span><br><span class="line">    const vm: Component &#x3D; this</span><br><span class="line">    if (vm._isMounted) &#123;</span><br><span class="line">      callHook(vm, &#39;beforeUpdate&#39;)</span><br><span class="line">    &#125;</span><br><span class="line">    const prevEl &#x3D; vm.$el</span><br><span class="line">    const prevVnode &#x3D; vm._vnode</span><br><span class="line">    const prevActiveInstance &#x3D; activeInstance</span><br><span class="line">    activeInstance &#x3D; vm</span><br><span class="line">    vm._vnode &#x3D; vnode</span><br><span class="line">    &#x2F;&#x2F; Vue.prototype.__patch__ is injected in entry points</span><br><span class="line">    &#x2F;&#x2F; based on the rendering backend used.</span><br><span class="line">    if (!prevVnode) &#123;</span><br><span class="line">      &#x2F;&#x2F; initial render</span><br><span class="line">      debugger</span><br><span class="line">      vm.$el &#x3D; vm.__patch__(</span><br><span class="line">        vm.$el, vnode, hydrating, false &#x2F;* removeOnly *&#x2F;,</span><br><span class="line">        vm.$options._parentElm,</span><br><span class="line">        vm.$options._refElm</span><br><span class="line">      )</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; updates</span><br><span class="line">      vm.$el &#x3D; vm.__patch__(prevVnode, vnode)</span><br><span class="line">    &#125;</span><br><span class="line">    activeInstance &#x3D; prevActiveInstance</span><br><span class="line">    &#x2F;&#x2F; update __vue__ reference</span><br><span class="line">    if (prevEl) &#123;</span><br><span class="line">      prevEl.__vue__ &#x3D; null</span><br><span class="line">    &#125;</span><br><span class="line">    if (vm.$el) &#123;</span><br><span class="line">      vm.$el.__vue__ &#x3D; vm</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; if parent is an HOC, update its $el as well</span><br><span class="line">    if (vm.$vnode &amp;&amp; vm.$parent &amp;&amp; vm.$vnode &#x3D;&#x3D;&#x3D; vm.$parent._vnode) &#123;</span><br><span class="line">      vm.$parent.$el &#x3D; vm.$el</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; updated hook is called by the scheduler to ensure that children are</span><br><span class="line">    &#x2F;&#x2F; updated in a parent&#39;s updated hook.</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>后面其实还有一些关于生命周期标识的操作等，不过在这里我先不做过多的研究了</p>
<p>到了这里，一个基本的流程就应经完成了，文章就先到这了，以后应该会进行整理修改（一定）</p>
<p>因面试碰到相关问题，最后对 vue 生命周期钩子做下面记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">initLifecycle(vm)</span><br><span class="line">initEvents(vm)</span><br><span class="line">initRender(vm)</span><br><span class="line">callHook(vm, &#39;beforeCreate&#39;)</span><br><span class="line">initInjections(vm) &#x2F;&#x2F; resolve injections before data&#x2F;props</span><br><span class="line">initState(vm)</span><br><span class="line">initProvide(vm) &#x2F;&#x2F; resolve provide after data&#x2F;props</span><br><span class="line">callHook(vm, &#39;created&#39;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 转换ast</span><br><span class="line">&#x2F;&#x2F; ast处理(静态节点相关)</span><br><span class="line">&#x2F;&#x2F; 生成render函数</span><br><span class="line">callHook(vm, &#39;beforeMount&#39;) &#x2F;&#x2F; beforeMount处理</span><br><span class="line">&#x2F;&#x2F; 生成vnode树</span><br><span class="line">&#x2F;&#x2F; 替换真正的dom</span><br><span class="line">callHook(vm, &#39;mounted&#39;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; data改变</span><br><span class="line">callHook(vm, &#39;beforeUpdate&#39;)</span><br><span class="line">&#x2F;&#x2F; vdom重构并patch</span><br><span class="line">callHook(vm, &#39;updated&#39;)</span><br><span class="line"></span><br><span class="line">Vue.prototype.$destroy</span><br><span class="line">callHook(vm, &#39;beforeDestroy&#39;)</span><br><span class="line">vm._watcher.teardown()</span><br><span class="line">vm.__patch__(vm._vnode, null)</span><br><span class="line">callHook(vm, &#39;destroyed&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Vue%E7%AC%94%E8%AE%B0/" rel="tag"># Vue笔记</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/01/22/vue/1/" rel="prev" title="Vue源码阅读笔记（1）(从入口文件开始)">
      <i class="fa fa-chevron-left"></i> Vue源码阅读笔记（1）(从入口文件开始)
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/01/23/vue/3/" rel="next" title="Vue源码阅读笔记（3）(Vue的双向数据绑定)">
      Vue源码阅读笔记（3）(Vue的双向数据绑定) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B"><span class="nav-number">1.</span> <span class="nav-text">开始</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#init"><span class="nav-number">2.</span> <span class="nav-text">init</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#resolveConstructorOptions"><span class="nav-number">2.1.</span> <span class="nav-text">resolveConstructorOptions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mergeOptions"><span class="nav-number">2.2.</span> <span class="nav-text">mergeOptions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initProxy"><span class="nav-number">2.3.</span> <span class="nav-text">initProxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initLifecycle"><span class="nav-number">2.4.</span> <span class="nav-text">initLifecycle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initEvents"><span class="nav-number">2.5.</span> <span class="nav-text">initEvents</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initRender"><span class="nav-number">2.6.</span> <span class="nav-text">initRender</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#callHook"><span class="nav-number">2.7.</span> <span class="nav-text">callHook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initInjections"><span class="nav-number">2.8.</span> <span class="nav-text">initInjections</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initState"><span class="nav-number">2.9.</span> <span class="nav-text">initState</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#initProps"><span class="nav-number">2.9.1.</span> <span class="nav-text">initProps</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#initMethods"><span class="nav-number">2.9.2.</span> <span class="nav-text">initMethods</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initData"><span class="nav-number">2.10.</span> <span class="nav-text">initData</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initComputed"><span class="nav-number">2.11.</span> <span class="nav-text">initComputed</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initWatch"><span class="nav-number">2.12.</span> <span class="nav-text">initWatch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initProvide"><span class="nav-number">2.13.</span> <span class="nav-text">initProvide</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mount"><span class="nav-number">3.</span> <span class="nav-text">$mount</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#compileToFunctions"><span class="nav-number">3.1.</span> <span class="nav-text">compileToFunctions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mountComponent-src-core-instance-lifecycle-js"><span class="nav-number">3.2.</span> <span class="nav-text">mountComponent &#x2F;src&#x2F;core&#x2F;instance&#x2F;lifecycle.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vm-render"><span class="nav-number">3.3.</span> <span class="nav-text">vm._render()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#createTextVNode"><span class="nav-number">3.3.1.</span> <span class="nav-text">createTextVNode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#createElement"><span class="nav-number">3.3.2.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#renderStatic"><span class="nav-number">3.3.3.</span> <span class="nav-text">renderStatic</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vm-update"><span class="nav-number">3.4.</span> <span class="nav-text">vm._update</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E5%90%8E"><span class="nav-number">4.</span> <span class="nav-text">最后</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">lokve</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lokve</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
