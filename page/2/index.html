<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/my-notes/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/my-notes/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/my-notes/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/my-notes/images/logo.svg" color="#222">

<link rel="stylesheet" href="/my-notes/css/main.css">


<link rel="stylesheet" href="/my-notes/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/my-notes/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="学习笔记">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="学习笔记">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="lokve">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>学习笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/my-notes/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">学习笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/my-notes/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/my-notes/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/my-notes/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/my-notes/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/10/react/createElement(react%20element)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2020/09/10/react/createElement(react%20element)/" class="post-title-link" itemprop="url">createElement(react element)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-10 14:00:00" itemprop="dateCreated datePublished" datetime="2020-09-10T14:00:00+08:00">2020-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create and return a new ReactElement of the given type.</span></span><br><span class="line"><span class="comment"> * See https://reactjs.org/docs/react-api.html#createelement</span></span><br><span class="line"><span class="comment"> * type: 标签类型，如div,p等</span></span><br><span class="line"><span class="comment"> * config[object]: 属性，如className,onClick等，必带__self和__source</span></span><br><span class="line"><span class="comment"> * children:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, children</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> propName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reserved names are extracted</span></span><br><span class="line">    <span class="keyword">const</span> props = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> key = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> ref = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> self = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> source = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasValidRef(config)) &#123;</span><br><span class="line">            ref = config.ref;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (hasValidKey(config)) &#123;</span><br><span class="line">            key = <span class="string">&#x27;&#x27;</span> + config.key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        self = config.__self === <span class="literal">undefined</span> ? <span class="literal">null</span> : config.__self;</span><br><span class="line">        source = config.__source === <span class="literal">undefined</span> ? <span class="literal">null</span> : config.__source;</span><br><span class="line">        <span class="comment">// Remaining properties are added to a new props object</span></span><br><span class="line">        <span class="comment">// 解析props</span></span><br><span class="line">        <span class="keyword">for</span> (propName <span class="keyword">in</span> config) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasOwnProperty.call(config, propName) &amp;&amp; !RESERVED_PROPS.hasOwnProperty(propName)) &#123;</span><br><span class="line">                props[propName] = config[propName];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Children can be more than one argument, and those are transferred onto</span></span><br><span class="line">    <span class="comment">// the newly allocated props object.</span></span><br><span class="line">    <span class="comment">// 解析children</span></span><br><span class="line">    <span class="keyword">const</span> childrenLength = <span class="built_in">arguments</span>.length - <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (childrenLength === <span class="number">1</span>) &#123;</span><br><span class="line">        props.children = children;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childrenLength &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> childArray = <span class="built_in">Array</span>(childrenLength);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; childrenLength; i++) &#123;</span><br><span class="line">            childArray[i] = <span class="built_in">arguments</span>[i + <span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        props.children = childArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resolve default props</span></span><br><span class="line">    <span class="keyword">if</span> (type &amp;&amp; type.defaultProps) &#123;</span><br><span class="line">        <span class="keyword">const</span> defaultProps = type.defaultProps;</span><br><span class="line">        <span class="keyword">for</span> (propName <span class="keyword">in</span> defaultProps) &#123;</span><br><span class="line">            <span class="keyword">if</span> (props[propName] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">                props[propName] = defaultProps[propName];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key || ref) &#123;</span><br><span class="line">            <span class="keyword">const</span> displayName =</span><br><span class="line">                <span class="keyword">typeof</span> type === <span class="string">&#x27;function&#x27;</span> ? type.displayName || type.name || <span class="string">&#x27;Unknown&#x27;</span> : type;</span><br><span class="line">            <span class="keyword">if</span> (key) &#123;</span><br><span class="line">                defineKeyPropWarningGetter(props, displayName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ref) &#123;</span><br><span class="line">                defineRefPropWarningGetter(props, displayName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReactElement(type, key, ref, self, source, ReactCurrentOwner.current, props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ReactElement"><a href="#ReactElement" class="headerlink" title="ReactElement"></a>ReactElement</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Factory method to create a new React element. This no longer adheres to</span></span><br><span class="line"><span class="comment"> * the class pattern, so do not use new to call it. Also, no instanceof check</span></span><br><span class="line"><span class="comment"> * will work. Instead test $$typeof field against Symbol.for(&#x27;react.element&#x27;) to check</span></span><br><span class="line"><span class="comment"> * if something is a React Element.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> <span class="variable">type</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> <span class="variable">props</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> <span class="variable">key</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string|object&#125;</span> <span class="variable">ref</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> <span class="variable">owner</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>self A *temporary* helper to detect places where `this` is</span></span><br><span class="line"><span class="comment"> * different from the `owner` when React.createElement is called, so that we</span></span><br><span class="line"><span class="comment"> * can warn. We want to get rid of owner and replace string `ref`s with arrow</span></span><br><span class="line"><span class="comment"> * functions, and as long as `this` and owner are the same, there will be no</span></span><br><span class="line"><span class="comment"> * change in behavior.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>source An annotation object (added by a transpiler or otherwise)</span></span><br><span class="line"><span class="comment"> * indicating filename, line number, and/or other information.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> ReactElement = <span class="function"><span class="keyword">function</span> (<span class="params">type, key, ref, self, source, owner, props</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> element = &#123;</span><br><span class="line">        <span class="comment">// This tag allows us to uniquely identify this as a React Element</span></span><br><span class="line">        $$typeof: REACT_ELEMENT_TYPE,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Built-in properties that belong on the element</span></span><br><span class="line">        type: type,</span><br><span class="line">        key: key,</span><br><span class="line">        ref: ref,</span><br><span class="line">        props: props,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Record the component responsible for creating this element.</span></span><br><span class="line">        _owner: owner,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/10/react/schedule/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2020/09/10/react/schedule/" class="post-title-link" itemprop="url">reconcileChildFibers</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-10 14:00:00" itemprop="dateCreated datePublished" datetime="2020-09-10T14:00:00+08:00">2020-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="scheduleWork"><a href="#scheduleWork" class="headerlink" title="scheduleWork"></a>scheduleWork</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scheduleUpdateOnFiber</span>(<span class="params">fiber: Fiber, expirationTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">    checkForNestedUpdates(); <span class="comment">// 判断是否超出更新限制 50条，否则报错</span></span><br><span class="line">    <span class="comment">// 根节点：更新了fiber.stateNode的时间，返回fiber.stateNode，即FiberRoot</span></span><br><span class="line">    <span class="comment">// 子节点： 返回根节点</span></span><br><span class="line">    <span class="keyword">const</span> root = markUpdateTimeFromFiberToRoot(fiber, expirationTime);</span><br><span class="line">    <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    root.pingTime = NoWork;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回优先级,见常量 ReactPriorityLevel</span></span><br><span class="line">    <span class="comment">// 已知第一次渲染是97，setState是98，useState是98</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span>currentPriorityLevel仅在flushTask李改变，目前还没找到什么时候调用过</span></span><br><span class="line">    <span class="keyword">const</span> priorityLevel = getCurrentPriorityLevel();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (expirationTime === Sync) &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="comment">// Check if we&#x27;re inside unbatchedUpdates 8 &amp; 8 = 8 !== 0</span></span><br><span class="line">            (executionContext &amp; LegacyUnbatchedContext) !== NoContext &amp;&amp;</span><br><span class="line">            <span class="comment">// Check if we&#x27;re not already rendering 8 &amp; (16 | 32) = 0</span></span><br><span class="line">            (executionContext &amp; (RenderContext | CommitContext)) === NoContext</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// This is a legacy edge case. The initial mount of a ReactDOM.render-ed</span></span><br><span class="line">            <span class="comment">// root inside of batchedUpdates should be synchronous, but layout updates</span></span><br><span class="line">            <span class="comment">// should be deferred until the end of the batch.</span></span><br><span class="line">            <span class="keyword">let</span> callback = renderRoot(root, Sync, <span class="literal">true</span>); <span class="comment">// 返回commitRoot</span></span><br><span class="line">            <span class="comment">// 前景：react完成了fiber树的构建并已经执行了渲染前的状态合并(getDerivedStateFromProps等生命周期已执行)</span></span><br><span class="line">            <span class="comment">// fiber树里已经构建好了真实的dom节点，放在stateNode里，就差一步插入了</span></span><br><span class="line">            <span class="comment">// debugger</span></span><br><span class="line">            <span class="keyword">while</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">                callback = callback(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// setState, useState进这里</span></span><br><span class="line">            scheduleCallbackForRoot(root, ImmediatePriority, Sync);</span><br><span class="line">            <span class="keyword">if</span> (executionContext === NoContext) &#123;</span><br><span class="line">                <span class="comment">// Flush the synchronous work now, wnless we&#x27;re already working or inside</span></span><br><span class="line">                <span class="comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span></span><br><span class="line">                <span class="comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span></span><br><span class="line">                <span class="comment">// without immediately flushing it. We only do this for user-initated</span></span><br><span class="line">                <span class="comment">// updates, to preserve historical behavior of sync mode.</span></span><br><span class="line">                flushSyncCallbackQueue();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        scheduleCallbackForRoot(root, priorityLevel, expirationTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        (executionContext &amp; DiscreteEventContext) !== NoContext &amp;&amp;</span><br><span class="line">        <span class="comment">// Only updates at user-blocking priority or greater are considered</span></span><br><span class="line">        <span class="comment">// discrete, even inside a discrete event.</span></span><br><span class="line">        (priorityLevel === UserBlockingPriority || priorityLevel === ImmediatePriority)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// This is the result of a discrete event. Track the lowest priority</span></span><br><span class="line">        <span class="comment">// discrete update per root so we can flush them early, if needed.</span></span><br><span class="line">        <span class="keyword">if</span> (rootsWithPendingDiscreteUpdates === <span class="literal">null</span>) &#123;</span><br><span class="line">            rootsWithPendingDiscreteUpdates = <span class="keyword">new</span> <span class="built_in">Map</span>([[root, expirationTime]]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> lastDiscreteTime = rootsWithPendingDiscreteUpdates.get(root);</span><br><span class="line">            <span class="keyword">if</span> (lastDiscreteTime === <span class="literal">undefined</span> || lastDiscreteTime &gt; expirationTime) &#123;</span><br><span class="line">                rootsWithPendingDiscreteUpdates.set(root, expirationTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> scheduleWork = scheduleUpdateOnFiber;</span><br></pre></td></tr></table></figure>

<h3 id="markUpdateTimeFromFiberToRoot"><a href="#markUpdateTimeFromFiberToRoot" class="headerlink" title="markUpdateTimeFromFiberToRoot"></a>markUpdateTimeFromFiberToRoot</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">markUpdateTimeFromFiberToRoot</span>(<span class="params">fiber, expirationTime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Update the source fiber&#x27;s expiration time</span></span><br><span class="line">    <span class="comment">// fiber.expirationTime默认是0</span></span><br><span class="line">    <span class="keyword">if</span> (fiber.expirationTime &lt; expirationTime) &#123;</span><br><span class="line">        fiber.expirationTime = expirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> alternate = fiber.alternate;</span><br><span class="line">    <span class="keyword">if</span> (alternate !== <span class="literal">null</span> &amp;&amp; alternate.expirationTime &lt; expirationTime) &#123;</span><br><span class="line">        alternate.expirationTime = expirationTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Walk the parent path to the root and update the child expiration time.</span></span><br><span class="line">    <span class="keyword">let</span> node = fiber.return;</span><br><span class="line">    <span class="keyword">let</span> root = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (node === <span class="literal">null</span> &amp;&amp; fiber.tag === HostRoot) &#123;</span><br><span class="line">        <span class="comment">// 3 === 3</span></span><br><span class="line">        root = fiber.stateNode;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (node !== <span class="literal">null</span>) &#123;</span><br><span class="line">            alternate = node.alternate;</span><br><span class="line">            <span class="comment">// 跟新childExpirationTime</span></span><br><span class="line">            <span class="keyword">if</span> (node.childExpirationTime &lt; expirationTime) &#123;</span><br><span class="line">                node.childExpirationTime = expirationTime;</span><br><span class="line">                <span class="keyword">if</span> (alternate !== <span class="literal">null</span> &amp;&amp; alternate.childExpirationTime &lt; expirationTime) &#123;</span><br><span class="line">                    alternate.childExpirationTime = expirationTime;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (alternate !== <span class="literal">null</span> &amp;&amp; alternate.childExpirationTime &lt; expirationTime) &#123;</span><br><span class="line">                alternate.childExpirationTime = expirationTime;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (node.return === <span class="literal">null</span> &amp;&amp; node.tag === HostRoot) &#123;</span><br><span class="line">                root = node.stateNode;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            node = node.return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 注释：跟新根节点的firstPendingTime和lastPendingTime</span></span><br><span class="line">        <span class="comment">// Update the first and last pending expiration times in this root</span></span><br><span class="line">        <span class="keyword">const</span> firstPendingTime = root.firstPendingTime;</span><br><span class="line">        <span class="keyword">if</span> (expirationTime &gt; firstPendingTime) &#123;</span><br><span class="line">            root.firstPendingTime = expirationTime;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> lastPendingTime = root.lastPendingTime;</span><br><span class="line">        <span class="keyword">if</span> (lastPendingTime === NoWork || expirationTime &lt; lastPendingTime) &#123;</span><br><span class="line">            root.lastPendingTime = expirationTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="scheduleCallbackForRoot"><a href="#scheduleCallbackForRoot" class="headerlink" title="scheduleCallbackForRoot"></a>scheduleCallbackForRoot</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use this function, along with runRootCallback, to ensure that only a single</span></span><br><span class="line"><span class="comment">// callback per root is scheduled. It&#x27;s still possible to call renderRoot</span></span><br><span class="line"><span class="comment">// directly, but scheduling via this function helps avoid excessive callbacks.</span></span><br><span class="line"><span class="comment">// It works by storing the callback node and expiration time on the root. When a</span></span><br><span class="line"><span class="comment">// new callback comes in, it compares the expiration time to determine if it</span></span><br><span class="line"><span class="comment">// should cancel the previous one. It also relies on commitRoot scheduling a</span></span><br><span class="line"><span class="comment">// callback to render the next level, because that means we don&#x27;t need a</span></span><br><span class="line"><span class="comment">// separate callback per expiration time.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleCallbackForRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">    priorityLevel: ReactPriorityLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> existingCallbackExpirationTime = root.callbackExpirationTime;</span><br><span class="line">    <span class="keyword">if</span> (existingCallbackExpirationTime &lt; expirationTime) &#123;</span><br><span class="line">        <span class="comment">// New callback has higher priority than the existing one.</span></span><br><span class="line">        <span class="keyword">const</span> existingCallbackNode = root.callbackNode;</span><br><span class="line">        <span class="keyword">if</span> (existingCallbackNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">            cancelCallback(existingCallbackNode);</span><br><span class="line">        &#125;</span><br><span class="line">        root.callbackExpirationTime = expirationTime;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (expirationTime === Sync) &#123;</span><br><span class="line">            <span class="comment">// Sync React callbacks are scheduled on a special internal queue</span></span><br><span class="line">            <span class="comment">// 同步的放在一个队列中</span></span><br><span class="line">            root.callbackNode = scheduleSyncCallback(</span><br><span class="line">                runRootCallback.bind(<span class="literal">null</span>, root, renderRoot.bind(<span class="literal">null</span>, root, expirationTime)),</span><br><span class="line">            );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> options = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (expirationTime !== Never) &#123;</span><br><span class="line">                <span class="keyword">let</span> timeout = expirationTimeToMs(expirationTime) - now();</span><br><span class="line">                options = &#123;timeout&#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            root.callbackNode = scheduleCallback(</span><br><span class="line">                priorityLevel,</span><br><span class="line">                runRootCallback.bind(<span class="literal">null</span>, root, renderRoot.bind(<span class="literal">null</span>, root, expirationTime)),</span><br><span class="line">                options,</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                enableUserTimingAPI &amp;&amp;</span><br><span class="line">                expirationTime !== Sync &amp;&amp;</span><br><span class="line">                (executionContext &amp; (RenderContext | CommitContext)) === NoContext</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// Scheduled an async callback, and we&#x27;re not already working. Add an</span></span><br><span class="line">                <span class="comment">// entry to the flamegraph that shows we&#x27;re waiting for a callback</span></span><br><span class="line">                <span class="comment">// to fire.</span></span><br><span class="line">                startRequestCallbackTimer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Associate the current interactions with this new root+priority.</span></span><br><span class="line">    schedulePendingInteractions(root, expirationTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="scheduleSyncCallback"><a href="#scheduleSyncCallback" class="headerlink" title="scheduleSyncCallback"></a>scheduleSyncCallback</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> syncQueue: <span class="built_in">Array</span>&lt;SchedulerCallback&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scheduleSyncCallback</span>(<span class="params">callback: SchedulerCallback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Push this callback into an internal queue. We&#x27;ll flush these either in</span></span><br><span class="line">    <span class="comment">// the next tick, or earlier if something calls `flushSyncCallbackQueue`.</span></span><br><span class="line">    <span class="keyword">if</span> (syncQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">        syncQueue = [callback];</span><br><span class="line">        <span class="comment">// Flush the queue in the next tick, at the earliest.</span></span><br><span class="line">        immediateQueueCallbackNode = Scheduler_scheduleCallback(</span><br><span class="line">            Scheduler_ImmediatePriority, <span class="comment">// 立即优先级 1</span></span><br><span class="line">            flushSyncCallbackQueueImpl, <span class="comment">// 回调方法 执行syncQueue里的方法</span></span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Push onto existing queue. Don&#x27;t need to schedule a callback because</span></span><br><span class="line">        <span class="comment">// we already scheduled one when we created the queue.</span></span><br><span class="line">        syncQueue.push(callback);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fakeCallbackNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scheduler-scheduleCallback"><a href="#Scheduler-scheduleCallback" class="headerlink" title="Scheduler_scheduleCallback"></a>Scheduler_scheduleCallback</h3><p>即<code>unstable_scheduleCallback</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_scheduleCallback</span>(<span class="params">priorityLevel, callback, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentTime = getCurrentTime(); <span class="comment">// 获取当前时间</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> startTime;</span><br><span class="line">    <span class="keyword">var</span> timeout;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">&#x27;object&#x27;</span> &amp;&amp; options !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> delay = options.delay;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> delay === <span class="string">&#x27;number&#x27;</span> &amp;&amp; delay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            startTime = currentTime + delay;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            startTime = currentTime;</span><br><span class="line">        &#125;</span><br><span class="line">        timeout =</span><br><span class="line">            <span class="keyword">typeof</span> options.timeout === <span class="string">&#x27;number&#x27;</span></span><br><span class="line">                ? options.timeout</span><br><span class="line">                : timeoutForPriorityLevel(priorityLevel);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        timeout = timeoutForPriorityLevel(priorityLevel);</span><br><span class="line">        startTime = currentTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expirationTime = startTime + timeout;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> newTask = &#123;</span><br><span class="line">        callback,</span><br><span class="line">        priorityLevel,</span><br><span class="line">        startTime,</span><br><span class="line">        expirationTime,</span><br><span class="line">        next: <span class="literal">null</span>,</span><br><span class="line">        previous: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (startTime &gt; currentTime) &#123;</span><br><span class="line">        <span class="comment">// This is a delayed task.</span></span><br><span class="line">        insertDelayedTask(newTask, startTime);</span><br><span class="line">        <span class="keyword">if</span> (firstTask === <span class="literal">null</span> &amp;&amp; firstDelayedTask === newTask) &#123;</span><br><span class="line">            <span class="comment">// All tasks are delayed, and this is the task with the earliest delay.</span></span><br><span class="line">            <span class="keyword">if</span> (isHostTimeoutScheduled) &#123;</span><br><span class="line">                <span class="comment">// Cancel an existing timeout.</span></span><br><span class="line">                cancelHostTimeout();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                isHostTimeoutScheduled = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Schedule a timeout.</span></span><br><span class="line">            requestHostTimeout(handleTimeout, startTime - currentTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        insertScheduledTask(newTask, expirationTime);</span><br><span class="line">        <span class="comment">// Schedule a host callback, if needed. If we&#x27;re already performing work,</span></span><br><span class="line">        <span class="comment">// wait until the next time we yield.</span></span><br><span class="line">        <span class="keyword">if</span> (!isHostCallbackScheduled &amp;&amp; !isPerformingWork) &#123;</span><br><span class="line">            isHostCallbackScheduled = <span class="literal">true</span>;</span><br><span class="line">            requestHostCallback(flushWork);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="timeoutForPriorityLevel"><a href="#timeoutForPriorityLevel" class="headerlink" title="timeoutForPriorityLevel"></a>timeoutForPriorityLevel</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">固定参数见 <span class="string">`常量.md`</span>-&gt;<span class="string">`优先级`</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">timeoutForPriorityLevel</span>(<span class="params">priorityLevel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (priorityLevel) &#123;</span><br><span class="line">    <span class="keyword">case</span> ImmediatePriority:</span><br><span class="line">      <span class="keyword">return</span> IMMEDIATE_PRIORITY_TIMEOUT;</span><br><span class="line">    <span class="keyword">case</span> UserBlockingPriority:</span><br><span class="line">      <span class="keyword">return</span> USER_BLOCKING_PRIORITY;</span><br><span class="line">    <span class="keyword">case</span> IdlePriority:</span><br><span class="line">      <span class="keyword">return</span> IDLE_PRIORITY;</span><br><span class="line">    <span class="keyword">case</span> LowPriority:</span><br><span class="line">      <span class="keyword">return</span> LOW_PRIORITY_TIMEOUT;</span><br><span class="line">    <span class="keyword">case</span> NormalPriority:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> NORMAL_PRIORITY_TIMEOUT;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="insertScheduledTask"><a href="#insertScheduledTask" class="headerlink" title="insertScheduledTask"></a>insertScheduledTask</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertScheduledTask</span>(<span class="params">newTask, expirationTime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Insert the new task into the list, ordered first by its timeout, then by</span></span><br><span class="line">    <span class="comment">// insertion. So the new task is inserted after any other task the</span></span><br><span class="line">    <span class="comment">// same timeout</span></span><br><span class="line">    <span class="keyword">if</span> (firstTask === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 第一个任务</span></span><br><span class="line">        <span class="comment">// This is the first task in the list.</span></span><br><span class="line">        firstTask = newTask.next = newTask.previous = newTask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> next = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">var</span> task = firstTask;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (expirationTime &lt; task.expirationTime) &#123;</span><br><span class="line">                <span class="comment">// The new task times out before this one.</span></span><br><span class="line">                next = task;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            task = task.next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (task !== firstTask);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No task with a later timeout was found, which means the new task has</span></span><br><span class="line">            <span class="comment">// the latest timeout in the list.</span></span><br><span class="line">            next = firstTask;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next === firstTask) &#123;</span><br><span class="line">            <span class="comment">// The new task has the earliest expiration in the entire list.</span></span><br><span class="line">            firstTask = newTask;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> previous = next.previous;</span><br><span class="line">        previous.next = next.previous = newTask;</span><br><span class="line">        newTask.next = next;</span><br><span class="line">        newTask.previous = previous;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="requestHostCallback"><a href="#requestHostCallback" class="headerlink" title="requestHostCallback"></a>requestHostCallback</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">requestHostCallback = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (scheduledHostCallback === <span class="literal">null</span>) &#123;</span><br><span class="line">        scheduledHostCallback = callback;</span><br><span class="line">        <span class="keyword">if</span> (!isAnimationFrameScheduled) &#123;</span><br><span class="line">            <span class="comment">// If rAF didn&#x27;t already schedule one, we need to schedule a frame.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> If this rAF doesn&#x27;t materialize because the browser throttles,</span></span><br><span class="line">            <span class="comment">// we might want to still have setTimeout trigger rIC as a backup to</span></span><br><span class="line">            <span class="comment">// ensure that we keep performing work.</span></span><br><span class="line">            isAnimationFrameScheduled = <span class="literal">true</span>;</span><br><span class="line">            requestAnimationFrameWithTimeout(animationTick);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="requestAnimationFrameWithTimeout"><a href="#requestAnimationFrameWithTimeout" class="headerlink" title="requestAnimationFrameWithTimeout"></a>requestAnimationFrameWithTimeout</h3><p><code>equestAnimationFrame</code>在后台时会停止工作，所以需要<code>localSetTimeout</code>辅助</p>
<p>把渲染流程放在了<code>requestAnimationFrame</code>或<code>setTimeOut</code>里面</p>
<p><code>requestAnimationFrame</code>使得在一次同步事件中的所有更改都一起处理</p>
<p>最后的处理就是<code>callback</code>了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// requestAnimationFrame does not run when the tab is in the background. If</span></span><br><span class="line"><span class="comment">// we&#x27;re backgrounded we prefer for that work to happen so that the page</span></span><br><span class="line"><span class="comment">// continues to load in the background. So we also schedule a &#x27;setTimeout&#x27; as</span></span><br><span class="line"><span class="comment">// a fallback.</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Need a better heuristic for backgrounded work.</span></span><br><span class="line"><span class="keyword">const</span> ANIMATION_FRAME_TIMEOUT = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">let</span> rAFID;</span><br><span class="line"><span class="keyword">let</span> rAFTimeoutID;</span><br><span class="line"><span class="keyword">const</span> requestAnimationFrameWithTimeout = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// schedule rAF and also a setTimeout</span></span><br><span class="line">    rAFID = localRequestAnimationFrame(<span class="function"><span class="keyword">function</span> (<span class="params">timestamp</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// cancel the setTimeout</span></span><br><span class="line">        localClearTimeout(rAFTimeoutID);</span><br><span class="line">        callback(timestamp);</span><br><span class="line">    &#125;);</span><br><span class="line">    rAFTimeoutID = localSetTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// cancel the requestAnimationFrame</span></span><br><span class="line">        localCancelAnimationFrame(rAFID);</span><br><span class="line">        callback(getCurrentTime());</span><br><span class="line">    &#125;, ANIMATION_FRAME_TIMEOUT);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="animationTick"><a href="#animationTick" class="headerlink" title="animationTick"></a>animationTick</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> animationTick = <span class="function"><span class="keyword">function</span> (<span class="params">rafTime</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (scheduledHostCallback !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Eagerly schedule the next animation callback at the beginning of the</span></span><br><span class="line">        <span class="comment">// frame. If the scheduler queue is not empty at the end of the frame, it</span></span><br><span class="line">        <span class="comment">// will continue flushing inside that callback. If the queue *is* empty,</span></span><br><span class="line">        <span class="comment">// then it will exit immediately. Posting the callback at the start of the</span></span><br><span class="line">        <span class="comment">// frame ensures it&#x27;s fired within the earliest possible frame. If we</span></span><br><span class="line">        <span class="comment">// waited until the end of the frame to post the callback, we risk the</span></span><br><span class="line">        <span class="comment">// browser skipping a frame and not firing the callback until the frame</span></span><br><span class="line">        <span class="comment">// after that.</span></span><br><span class="line">        requestAnimationFrameWithTimeout(animationTick);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No pending work. Exit.</span></span><br><span class="line">        isAnimationFrameScheduled = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> nextFrameTime = rafTime - frameDeadline + activeFrameTime;</span><br><span class="line">    <span class="keyword">if</span> (nextFrameTime &lt; activeFrameTime &amp;&amp; previousFrameTime &lt; activeFrameTime &amp;&amp; !fpsLocked) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextFrameTime &lt; <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="comment">// Defensive coding. We don&#x27;t support higher frame rates than 120hz.</span></span><br><span class="line">            <span class="comment">// If the calculated frame time gets lower than 8, it is probably a bug.</span></span><br><span class="line">            nextFrameTime = <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If one frame goes long, then the next one can be short to catch up.</span></span><br><span class="line">        <span class="comment">// If two frames are short in a row, then that&#x27;s an indication that we</span></span><br><span class="line">        <span class="comment">// actually have a higher frame rate than what we&#x27;re currently optimizing.</span></span><br><span class="line">        <span class="comment">// We adjust our heuristic dynamically accordingly. For example, if we&#x27;re</span></span><br><span class="line">        <span class="comment">// running on 120hz display or 90hz VR display.</span></span><br><span class="line">        <span class="comment">// Take the max of the two in case one of them was an anomaly due to</span></span><br><span class="line">        <span class="comment">// missed frame deadlines.</span></span><br><span class="line">        activeFrameTime = nextFrameTime &lt; previousFrameTime ? previousFrameTime : nextFrameTime;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        previousFrameTime = nextFrameTime;</span><br><span class="line">    &#125;</span><br><span class="line">    frameDeadline = rafTime + activeFrameTime;</span><br><span class="line">    <span class="keyword">if</span> (!isMessageEventScheduled) &#123;</span><br><span class="line">        isMessageEventScheduled = <span class="literal">true</span>;</span><br><span class="line">        port.postMessage(<span class="literal">undefined</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="flushSyncCallbackQueue"><a href="#flushSyncCallbackQueue" class="headerlink" title="flushSyncCallbackQueue"></a>flushSyncCallbackQueue</h3><p><code>callback</code>看上方<code>scheduleCallbackForRoot</code>里面</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">flushSyncCallbackQueue</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (immediateQueueCallbackNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">        Scheduler_cancelCallback(immediateQueueCallbackNode);</span><br><span class="line">    &#125;</span><br><span class="line">    flushSyncCallbackQueueImpl();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushSyncCallbackQueueImpl</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isFlushingSyncQueue &amp;&amp; syncQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Prevent re-entrancy.</span></span><br><span class="line">        isFlushingSyncQueue = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> isSync = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (; i &lt; syncQueue.length; i++) &#123;</span><br><span class="line">                <span class="keyword">let</span> callback = syncQueue[i];</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    callback = callback(isSync);</span><br><span class="line">                &#125; <span class="keyword">while</span> (callback !== <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            syncQueue = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="comment">// If something throws, leave the remaining callbacks on the queue.</span></span><br><span class="line">            <span class="keyword">if</span> (syncQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">                syncQueue = syncQueue.slice(i + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Resume flushing in the next tick</span></span><br><span class="line">            Scheduler_scheduleCallback(Scheduler_ImmediatePriority, flushSyncCallbackQueue);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            isFlushingSyncQueue = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runRootCallback"><a href="#runRootCallback" class="headerlink" title="runRootCallback"></a>runRootCallback</h3><p><code>runRootCallback</code>里面又执行了<code>renderRoot</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runRootCallback</span>(<span class="params">root, callback, isSync</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">debugger</span>;</span><br><span class="line">    <span class="keyword">const</span> prevCallbackNode = root.callbackNode;</span><br><span class="line">    <span class="keyword">let</span> continuation = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        continuation = callback(isSync);</span><br><span class="line">        <span class="keyword">if</span> (continuation !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> runRootCallback.bind(<span class="literal">null</span>, root, continuation);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// If the callback exits without returning a continuation, remove the</span></span><br><span class="line">        <span class="comment">// corresponding callback node from the root. Unless the callback node</span></span><br><span class="line">        <span class="comment">// has changed, which implies that it was already cancelled by a high</span></span><br><span class="line">        <span class="comment">// priority update.</span></span><br><span class="line">        <span class="keyword">if</span> (continuation === <span class="literal">null</span> &amp;&amp; prevCallbackNode === root.callbackNode) &#123;</span><br><span class="line">            root.callbackNode = <span class="literal">null</span>;</span><br><span class="line">            root.callbackExpirationTime = NoWork;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="renderRoot"><a href="#renderRoot" class="headerlink" title="renderRoot"></a>renderRoot</h3><p>见 renderRoot.md</p>
<p>之后就是渲染那一套</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/10/react/%E4%BA%8B%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2020/09/10/react/%E4%BA%8B%E4%BB%B6/" class="post-title-link" itemprop="url">事件系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-10 11:00:00" itemprop="dateCreated datePublished" datetime="2020-09-10T11:00:00+08:00">2020-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上接<code>completeWork.md</code> 搜索 <code>setInitialDOMProperties</code></p>
<h2 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h2><h3 id="setInitialDOMProperties"><a href="#setInitialDOMProperties" class="headerlink" title="setInitialDOMProperties"></a>setInitialDOMProperties</h3><p>给 dom 设置属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setInitialDOMProperties</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    tag: string,</span></span></span><br><span class="line"><span class="function"><span class="params">    domElement: Element,</span></span></span><br><span class="line"><span class="function"><span class="params">    rootContainerElement: Element | Document,</span></span></span><br><span class="line"><span class="function"><span class="params">    nextProps: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">    isCustomComponentTag: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> propKey <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!nextProps.hasOwnProperty(propKey)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> nextProp = nextProps[propKey];</span><br><span class="line">        <span class="keyword">if</span> (propKey === STYLE) &#123;</span><br><span class="line">            <span class="comment">// style</span></span><br><span class="line">            <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nextProp) &#123;</span><br><span class="line">                    <span class="comment">// Freeze the next style object so that we can assume it won&#x27;t be</span></span><br><span class="line">                    <span class="comment">// mutated. We have already warned for this in the past.</span></span><br><span class="line">                    <span class="built_in">Object</span>.freeze(nextProp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Relies on `updateStylesByID` not mutating `styleUpdates`.</span></span><br><span class="line">            setValueForStyles(domElement, nextProp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === DANGEROUSLY_SET_INNER_HTML) &#123;</span><br><span class="line">            <span class="comment">// dangerouslySetInnerHTML</span></span><br><span class="line">            <span class="keyword">const</span> nextHtml = nextProp ? nextProp[HTML] : <span class="literal">undefined</span>;</span><br><span class="line">            <span class="keyword">if</span> (nextHtml != <span class="literal">null</span>) &#123;</span><br><span class="line">                setInnerHTML(domElement, nextHtml);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === CHILDREN) &#123;</span><br><span class="line">            <span class="comment">// children</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> nextProp === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// Avoid setting initial textContent when the text is empty. In IE11 setting</span></span><br><span class="line">                <span class="comment">// textContent on a &lt;textarea&gt; will cause the placeholder to not</span></span><br><span class="line">                <span class="comment">// show within the &lt;textarea&gt; until it has been focused and blurred again.</span></span><br><span class="line">                <span class="comment">// https://github.com/facebook/react/issues/6731#issuecomment-254874553</span></span><br><span class="line">                <span class="keyword">const</span> canSetTextContent = tag !== <span class="string">&#x27;textarea&#x27;</span> || nextProp !== <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                <span class="keyword">if</span> (canSetTextContent) &#123;</span><br><span class="line">                    setTextContent(domElement, nextProp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> nextProp === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">                setTextContent(domElement, <span class="string">&#x27;&#x27;</span> + nextProp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">            propKey === SUPPRESS_CONTENT_EDITABLE_WARNING ||</span><br><span class="line">            propKey === SUPPRESS_HYDRATION_WARNING</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// Noop</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === AUTOFOCUS) &#123;</span><br><span class="line">            <span class="comment">// We polyfill it separately on the client during commit.</span></span><br><span class="line">            <span class="comment">// We could have excluded it in the property list instead of</span></span><br><span class="line">            <span class="comment">// adding a special case here, but then it wouldn&#x27;t be emitted</span></span><br><span class="line">            <span class="comment">// on server rendering (but we *do* want to emit it in SSR).</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (registrationNameModules.hasOwnProperty(propKey)) &#123;</span><br><span class="line">            <span class="comment">// registrationNameModules包含了所有支持的事件名，如onClick、onChange等</span></span><br><span class="line">            <span class="comment">// 判断是否存在事件绑定</span></span><br><span class="line">            <span class="keyword">if</span> (nextProp != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (__DEV__ &amp;&amp; <span class="keyword">typeof</span> nextProp !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                    warnForInvalidEventListener(propKey, nextProp);</span><br><span class="line">                &#125;</span><br><span class="line">                ensureListeningTo(rootContainerElement, propKey); <span class="comment">// 事件绑定</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextProp != <span class="literal">null</span>) &#123;</span><br><span class="line">            setValueForProperty(domElement, propKey, nextProp, isCustomComponentTag);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ensureListeningTo"><a href="#ensureListeningTo" class="headerlink" title="ensureListeningTo"></a>ensureListeningTo</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ensureListeningTo</span>(<span class="params">rootContainerElement: Element | Node, registrationName: string</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="comment">// debugger</span></span><br><span class="line">    <span class="comment">// DOCUMENT的type，顾名思义</span></span><br><span class="line">    <span class="keyword">const</span> isDocumentOrFragment =</span><br><span class="line">        rootContainerElement.nodeType === DOCUMENT_NODE ||</span><br><span class="line">        rootContainerElement.nodeType === DOCUMENT_FRAGMENT_NODE;</span><br><span class="line">    <span class="comment">// doc就是document</span></span><br><span class="line">    <span class="keyword">const</span> doc = isDocumentOrFragment ? rootContainerElement : rootContainerElement.ownerDocument;</span><br><span class="line">    listenTo(registrationName, doc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="listenTo"><a href="#listenTo" class="headerlink" title="listenTo"></a>listenTo</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * We listen for bubbled touch events on the document object.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Firefox v8.01 (and possibly others) exhibited strange behavior when</span></span><br><span class="line"><span class="comment"> * mounting `onmousemove` events at some node that was not the document</span></span><br><span class="line"><span class="comment"> * element. The symptoms were that if your mouse is not moving over something</span></span><br><span class="line"><span class="comment"> * contained within that mount point (for example on the background) the</span></span><br><span class="line"><span class="comment"> * top-level listeners for `onmousemove` won&#x27;t be called. However, if you</span></span><br><span class="line"><span class="comment"> * register the `mousemove` on the document object, then it will of course</span></span><br><span class="line"><span class="comment"> * catch all `mousemove`s. This along with iOS quirks, justifies restricting</span></span><br><span class="line"><span class="comment"> * top-level listeners to the document object only, at least for these</span></span><br><span class="line"><span class="comment"> * movement types of events and possibly all events.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see </span>http://www.quirksmode.org/blog/archives/2010/09/click_event_del.html</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Also, `keyup`/`keypress`/`keydown` do not bubble to the window on IE, but</span></span><br><span class="line"><span class="comment"> * they bubble to document.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>registrationName Name of listener (e.g. `onClick`).</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;object&#125;</span> </span>mountAt Container where to mount the listener</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">listenTo</span>(<span class="params">registrationName: string, mountAt: Document | Element | Node</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> listeningSet = getListeningSetForElement(mountAt);</span><br><span class="line">    <span class="comment">// 获取事件依赖事件，有些事件可能会被多个事件触发，所以要给这些事件也监听</span></span><br><span class="line">    <span class="comment">// 如onChange会被blur、input等等其他事件触发</span></span><br><span class="line">    <span class="keyword">const</span> dependencies = registrationNameDependencies[registrationName];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dependencies.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> dependency = dependencies[i];</span><br><span class="line">        <span class="comment">// 过滤已存在的相同事件</span></span><br><span class="line">        <span class="keyword">if</span> (!listeningSet.has(dependency)) &#123;</span><br><span class="line">            <span class="comment">// 把TOP_去掉在取小写就是他们的值</span></span><br><span class="line">            <span class="keyword">switch</span> (dependency) &#123;</span><br><span class="line">                <span class="keyword">case</span> TOP_SCROLL:</span><br><span class="line">                    trapCapturedEvent(TOP_SCROLL, mountAt);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> TOP_FOCUS:</span><br><span class="line">                <span class="keyword">case</span> TOP_BLUR:</span><br><span class="line">                    trapCapturedEvent(TOP_FOCUS, mountAt);</span><br><span class="line">                    trapCapturedEvent(TOP_BLUR, mountAt);</span><br><span class="line">                    <span class="comment">// We set the flag for a single dependency later in this function,</span></span><br><span class="line">                    <span class="comment">// but this ensures we mark both as attached rather than just one.</span></span><br><span class="line">                    listeningSet.add(TOP_BLUR);</span><br><span class="line">                    listeningSet.add(TOP_FOCUS);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> TOP_CANCEL:</span><br><span class="line">                <span class="keyword">case</span> TOP_CLOSE:</span><br><span class="line">                    <span class="keyword">if</span> (isEventSupported(getRawEventName(dependency))) &#123;</span><br><span class="line">                        trapCapturedEvent(dependency, mountAt);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> TOP_INVALID:</span><br><span class="line">                <span class="keyword">case</span> TOP_SUBMIT:</span><br><span class="line">                <span class="keyword">case</span> TOP_RESET:</span><br><span class="line">                    <span class="comment">// We listen to them on the target DOM elements.</span></span><br><span class="line">                    <span class="comment">// Some of them bubble so we don&#x27;t want them to fire twice.</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="comment">// By default, listen on the top level to all non-media events.</span></span><br><span class="line">                    <span class="comment">// Media events don&#x27;t bubble so adding the listener wouldn&#x27;t do anything.</span></span><br><span class="line">                    <span class="comment">// 媒体事件不冒泡</span></span><br><span class="line">                    <span class="keyword">const</span> isMediaEvent = mediaEventTypes.indexOf(dependency) !== <span class="number">-1</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!isMediaEvent) &#123;</span><br><span class="line">                        trapBubbledEvent(dependency, mountAt); <span class="comment">// 添加冒泡事件</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            listeningSet.add(dependency);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getListeningSetForElement"><a href="#getListeningSetForElement" class="headerlink" title="getListeningSetForElement"></a>getListeningSetForElement</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Summary of `ReactBrowserEventEmitter` event handling:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  - Top-level delegation is used to trap most native browser events. This</span></span><br><span class="line"><span class="comment"> *    may only occur in the main thread and is the responsibility of</span></span><br><span class="line"><span class="comment"> *    ReactDOMEventListener, which is injected and can therefore support</span></span><br><span class="line"><span class="comment"> *    pluggable event sources. This is the only work that occurs in the main</span></span><br><span class="line"><span class="comment"> *    thread.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  - We normalize and de-duplicate events to account for browser quirks. This</span></span><br><span class="line"><span class="comment"> *    may be done in the worker thread.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  - Forward these native events (with the associated top-level type used to</span></span><br><span class="line"><span class="comment"> *    trap it) to `EventPluginHub`, which in turn will ask plugins if they want</span></span><br><span class="line"><span class="comment"> *    to extract any synthetic events.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  - The `EventPluginHub` will then process each event by annotating them with</span></span><br><span class="line"><span class="comment"> *    &quot;dispatches&quot;, a sequence of listeners and IDs that care about that event.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  - The `EventPluginHub` then dispatches the events.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Overview of React and the event system:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * +------------+    .</span></span><br><span class="line"><span class="comment"> * |    DOM     |    .</span></span><br><span class="line"><span class="comment"> * +------------+    .</span></span><br><span class="line"><span class="comment"> *       |           .</span></span><br><span class="line"><span class="comment"> *       v           .</span></span><br><span class="line"><span class="comment"> * +------------+    .</span></span><br><span class="line"><span class="comment"> * | ReactEvent |    .</span></span><br><span class="line"><span class="comment"> * |  Listener  |    .</span></span><br><span class="line"><span class="comment"> * +------------+    .                         +-----------+</span></span><br><span class="line"><span class="comment"> *       |           .               +--------+|SimpleEvent|</span></span><br><span class="line"><span class="comment"> *       |           .               |         |Plugin     |</span></span><br><span class="line"><span class="comment"> * +-----|------+    .               v         +-----------+</span></span><br><span class="line"><span class="comment"> * |     |      |    .    +--------------+                    +------------+</span></span><br><span class="line"><span class="comment"> * |     +-----------.---&gt;|EventPluginHub|                    |    Event   |</span></span><br><span class="line"><span class="comment"> * |            |    .    |              |     +-----------+  | Propagators|</span></span><br><span class="line"><span class="comment"> * | ReactEvent |    .    |              |     |TapEvent   |  |------------|</span></span><br><span class="line"><span class="comment"> * |  Emitter   |    .    |              |&lt;---+|Plugin     |  |other plugin|</span></span><br><span class="line"><span class="comment"> * |            |    .    |              |     +-----------+  |  utilities |</span></span><br><span class="line"><span class="comment"> * |     +-----------.---&gt;|              |                    +------------+</span></span><br><span class="line"><span class="comment"> * |     |      |    .    +--------------+</span></span><br><span class="line"><span class="comment"> * +-----|------+    .                ^        +-----------+</span></span><br><span class="line"><span class="comment"> *       |           .                |        |Enter/Leave|</span></span><br><span class="line"><span class="comment"> *       +           .                +-------+|Plugin     |</span></span><br><span class="line"><span class="comment"> * +-------------+   .                         +-----------+</span></span><br><span class="line"><span class="comment"> * | application |   .</span></span><br><span class="line"><span class="comment"> * |-------------|   .</span></span><br><span class="line"><span class="comment"> * |             |   .</span></span><br><span class="line"><span class="comment"> * |             |   .</span></span><br><span class="line"><span class="comment"> * +-------------+   .</span></span><br><span class="line"><span class="comment"> *                   .</span></span><br><span class="line"><span class="comment"> *    React Core     .  General Purpose Event Plugin System</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PossiblyWeakMap = <span class="keyword">typeof</span> <span class="built_in">WeakMap</span> === <span class="string">&#x27;function&#x27;</span> ? <span class="built_in">WeakMap</span> : <span class="built_in">Map</span>;</span><br><span class="line"><span class="keyword">const</span> elementListeningSets:</span><br><span class="line">    | <span class="built_in">WeakMap</span></span><br><span class="line">    | <span class="built_in">Map</span>&lt;Document | Element | Node, <span class="built_in">Set</span>&lt;DOMTopLevelEventType | string&gt;&gt; = <span class="keyword">new</span> PossiblyWeakMap();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getListeningSetForElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    element: Document | Element | Node,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Set</span>&lt;<span class="title">DOMTopLevelEventType</span> | <span class="title">string</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> listeningSet = elementListeningSets.get(element);</span><br><span class="line">    <span class="keyword">if</span> (listeningSet === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        listeningSet = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">        elementListeningSets.set(element, listeningSet);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> listeningSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="trapBubbledEvent"><a href="#trapBubbledEvent" class="headerlink" title="trapBubbledEvent"></a>trapBubbledEvent</h3><p>绑定冒泡事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">trapBubbledEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    topLevelType: DOMTopLevelEventType,</span></span></span><br><span class="line"><span class="function"><span class="params">    element: Document | Element | Node,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    trapEventForPluginEventSystem(element, topLevelType, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="trapEventForPluginEventSystem"><a href="#trapEventForPluginEventSystem" class="headerlink" title="trapEventForPluginEventSystem"></a>trapEventForPluginEventSystem</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trapEventForPluginEventSystem</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    element: Document | Element | Node,</span></span></span><br><span class="line"><span class="function"><span class="params">    topLevelType: DOMTopLevelEventType,</span></span></span><br><span class="line"><span class="function"><span class="params">    capture: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> listener;</span><br><span class="line">    <span class="comment">// 事件优先级</span></span><br><span class="line">    <span class="keyword">switch</span> (getEventPriority(topLevelType)) &#123;</span><br><span class="line">        <span class="keyword">case</span> DiscreteEvent:</span><br><span class="line">            listener = dispatchDiscreteEvent.bind(<span class="literal">null</span>, topLevelType, PLUGIN_EVENT_SYSTEM);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> UserBlockingEvent:</span><br><span class="line">            listener = dispatchUserBlockingUpdate.bind(<span class="literal">null</span>, topLevelType, PLUGIN_EVENT_SYSTEM);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ContinuousEvent:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            listener = dispatchEvent.bind(<span class="literal">null</span>, topLevelType, PLUGIN_EVENT_SYSTEM);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> rawEventName = getRawEventName(topLevelType); <span class="comment">// 获取原始事件名称</span></span><br><span class="line">    <span class="comment">// 在document监听事件事件</span></span><br><span class="line">    <span class="keyword">if</span> (capture) &#123;</span><br><span class="line">        addEventCaptureListener(element, rawEventName, listener);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addEventBubbleListener(element, rawEventName, listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="触发"><a href="#触发" class="headerlink" title="触发"></a>触发</h2><p>从<code>dispatchDiscreteEvent</code>开始，见上<code>trapEventForPluginEventSystem</code></p>
<h3 id="dispatchDiscreteEvent"><a href="#dispatchDiscreteEvent" class="headerlink" title="dispatchDiscreteEvent"></a>dispatchDiscreteEvent</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 事件的执行开始</span></span><br><span class="line"><span class="comment">// dispatchEvent是最终要执行的事件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchDiscreteEvent</span>(<span class="params">topLevelType, eventSystemFlags, nativeEvent</span>) </span>&#123;</span><br><span class="line">    flushDiscreteUpdatesIfNeeded(nativeEvent.timeStamp);</span><br><span class="line">    discreteUpdates(dispatchEvent, topLevelType, eventSystemFlags, nativeEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="flushDiscreteUpdatesIfNeeded"><a href="#flushDiscreteUpdatesIfNeeded" class="headerlink" title="flushDiscreteUpdatesIfNeeded"></a>flushDiscreteUpdatesIfNeeded</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> lastFlushedEventTimeStamp = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">flushDiscreteUpdatesIfNeeded</span>(<span class="params">timeStamp: number</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// event.timeStamp isn&#x27;t overly reliable due to inconsistencies in</span></span><br><span class="line">    <span class="comment">// how different browsers have historically provided the time stamp.</span></span><br><span class="line">    <span class="comment">// Some browsers provide high-resolution time stamps for all events,</span></span><br><span class="line">    <span class="comment">// some provide low-resoltion time stamps for all events. FF &lt; 52</span></span><br><span class="line">    <span class="comment">// even mixes both time stamps together. Some browsers even report</span></span><br><span class="line">    <span class="comment">// negative time stamps or time stamps that are 0 (iOS9) in some cases.</span></span><br><span class="line">    <span class="comment">// Given we are only comparing two time stamps with equality (!==),</span></span><br><span class="line">    <span class="comment">// we are safe from the resolution differences. If the time stamp is 0</span></span><br><span class="line">    <span class="comment">// we bail-out of preventing the flush, which can affect semantics,</span></span><br><span class="line">    <span class="comment">// such as if an earlier flush removes or adds event listeners that</span></span><br><span class="line">    <span class="comment">// are fired in the subsequent flush. However, this is the same</span></span><br><span class="line">    <span class="comment">// behaviour as we had before this change, so the risks are low.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        !isInsideEventHandler &amp;&amp;</span><br><span class="line">        (!enableEventAPI || timeStamp === <span class="number">0</span> || lastFlushedEventTimeStamp !== timeStamp)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// 记录时间戳</span></span><br><span class="line">        lastFlushedEventTimeStamp = timeStamp;</span><br><span class="line">        flushDiscreteUpdatesImpl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="flushDiscreteUpdatesImpl"><a href="#flushDiscreteUpdatesImpl" class="headerlink" title="flushDiscreteUpdatesImpl"></a>flushDiscreteUpdatesImpl</h3><p>flushDiscreteUpdatesImpl 在不同环境下引用不同</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在ReactDom.js直接执行</span></span><br><span class="line">setBatchingImplementation(</span><br><span class="line">    batchedUpdates,</span><br><span class="line">    discreteUpdates,</span><br><span class="line">    flushDiscreteUpdates,</span><br><span class="line">    batchedEventUpdates,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> flushDiscreteUpdatesImpl = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">setBatchingImplementation</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    _batchedUpdatesImpl,</span></span></span><br><span class="line"><span class="function"><span class="params">    _discreteUpdatesImpl,</span></span></span><br><span class="line"><span class="function"><span class="params">    _flushDiscreteUpdatesImpl,</span></span></span><br><span class="line"><span class="function"><span class="params">    _batchedEventUpdatesImpl,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    batchedUpdatesImpl = _batchedUpdatesImpl;</span><br><span class="line">    discreteUpdatesImpl = _discreteUpdatesImpl;</span><br><span class="line">    flushDiscreteUpdatesImpl = _flushDiscreteUpdatesImpl;</span><br><span class="line">    batchedEventUpdatesImpl = _batchedEventUpdatesImpl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在浏览器环境就是<code>flushDiscreteUpdates</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">flushDiscreteUpdates</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should be able to flush inside batchedUpdates, but not inside `act`.</span></span><br><span class="line">    <span class="comment">// However, `act` uses `batchedUpdates`, so there&#x27;s no way to distinguish</span></span><br><span class="line">    <span class="comment">// those two cases. Need to fix this before exposing flushDiscreteUpdates</span></span><br><span class="line">    <span class="comment">// as a public API.</span></span><br><span class="line">    <span class="keyword">if</span> ((executionContext &amp; (BatchedContext | RenderContext | CommitContext)) !== NoContext) &#123;</span><br><span class="line">        <span class="comment">// We&#x27;re already rendering, so we can&#x27;t synchronously flush pending work.</span></span><br><span class="line">        <span class="comment">// This is probably a nested event dispatch triggered by a lifecycle/effect,</span></span><br><span class="line">        <span class="comment">// like `el.focus()`. Exit.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 刷新待处理？</span></span><br><span class="line">    flushPendingDiscreteUpdates();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!revertPassiveEffectsChange) &#123;</span><br><span class="line">        <span class="comment">// If the discrete updates scheduled passive effects, flush them now so that</span></span><br><span class="line">        <span class="comment">// they fire before the next serial event.</span></span><br><span class="line">        flushPassiveEffects();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="flushPassiveEffects"><a href="#flushPassiveEffects" class="headerlink" title="flushPassiveEffects"></a>flushPassiveEffects</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">flushPassiveEffects</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rootWithPendingPassiveEffects === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> root = rootWithPendingPassiveEffects;</span><br><span class="line">    <span class="keyword">const</span> expirationTime = pendingPassiveEffectsExpirationTime;</span><br><span class="line">    rootWithPendingPassiveEffects = <span class="literal">null</span>;</span><br><span class="line">    pendingPassiveEffectsExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> prevInteractions: <span class="built_in">Set</span>&lt;Interaction&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">        prevInteractions = __interactionsRef.current;</span><br><span class="line">        __interactionsRef.current = root.memoizedInteractions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= CommitContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note: This currently assumes there are no passive effects on the root</span></span><br><span class="line">    <span class="comment">// fiber, because the root is not part of its own effect list. This could</span></span><br><span class="line">    <span class="comment">// change in the future.</span></span><br><span class="line">    <span class="keyword">let</span> effect = root.current.firstEffect;</span><br><span class="line">    <span class="keyword">while</span> (effect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                commitPassiveHookEffects(effect);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                invariant(effect !== <span class="literal">null</span>, <span class="string">&#x27;Should be working on an effect.&#x27;</span>);</span><br><span class="line">                captureCommitPhaseError(effect, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        effect = effect.nextEffect;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">        __interactionsRef.current = ((prevInteractions: any): <span class="built_in">Set</span>&lt;Interaction&gt;);</span><br><span class="line">        finishPendingInteractions(root, expirationTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line">    flushSyncCallbackQueue();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If additional passive effects were scheduled, increment a counter. If this</span></span><br><span class="line">    <span class="comment">// exceeds the limit, we&#x27;ll fire a warning.</span></span><br><span class="line">    nestedPassiveUpdateCount =</span><br><span class="line">        rootWithPendingPassiveEffects === <span class="literal">null</span> ? <span class="number">0</span> : nestedPassiveUpdateCount + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="discreteUpdates"><a href="#discreteUpdates" class="headerlink" title="discreteUpdates"></a>discreteUpdates</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">discreteUpdates</span>(<span class="params">fn, a, b, c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> prevIsInsideEventHandler = isInsideEventHandler;</span><br><span class="line">    isInsideEventHandler = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> discreteUpdatesImpl(fn, a, b, c);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        isInsideEventHandler = prevIsInsideEventHandler;</span><br><span class="line">        <span class="keyword">if</span> (!isInsideEventHandler) &#123;</span><br><span class="line">            finishEventHandler();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="discreteUpdatesImpl"><a href="#discreteUpdatesImpl" class="headerlink" title="discreteUpdatesImpl"></a>discreteUpdatesImpl</h3><p>即 <code>discreteUpdates</code>，理由见<code>flushDiscreteUpdatesImpl</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">discreteUpdates</span>&lt;<span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>, <span class="title">R</span>&gt;(<span class="params">fn: (A, B, C) =&gt; R, a: A, b: B, c: C</span>): <span class="title">R</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">    <span class="comment">// 添加执行content</span></span><br><span class="line">    executionContext |= DiscreteEventContext;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Should this</span></span><br><span class="line">        <span class="keyword">return</span> runWithPriority(UserBlockingPriority, fn.bind(<span class="literal">null</span>, a, b, c));</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        executionContext = prevExecutionContext;</span><br><span class="line">        <span class="keyword">if</span> (executionContext === NoContext) &#123;</span><br><span class="line">            <span class="comment">// Flush the immediate callbacks that were scheduled during this batch</span></span><br><span class="line">            <span class="comment">// 事件结束后运行同步队列</span></span><br><span class="line">            flushSyncCallbackQueue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runWithPriority"><a href="#runWithPriority" class="headerlink" title="runWithPriority"></a>runWithPriority</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runWithPriority</span>&lt;<span class="title">T</span>&gt;(<span class="params">reactPriorityLevel: ReactPriorityLevel, fn: () =&gt; T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 转换优先级？ 99 -&gt; 1</span></span><br><span class="line">    <span class="keyword">const</span> priorityLevel = reactPriorityToSchedulerPriority(reactPriorityLevel);</span><br><span class="line">    <span class="keyword">return</span> Scheduler_runWithPriority(priorityLevel, fn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scheduler-runWithPriority"><a href="#Scheduler-runWithPriority" class="headerlink" title="Scheduler_runWithPriority"></a>Scheduler_runWithPriority</h3><p>最终执行<code>eventHandler</code> 即 <code>dispatchEvent</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_runWithPriority</span>(<span class="params">priorityLevel, eventHandler</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (priorityLevel) &#123;</span><br><span class="line">        <span class="keyword">case</span> ImmediatePriority:</span><br><span class="line">        <span class="keyword">case</span> UserBlockingPriority:</span><br><span class="line">        <span class="keyword">case</span> NormalPriority:</span><br><span class="line">        <span class="keyword">case</span> LowPriority:</span><br><span class="line">        <span class="keyword">case</span> IdlePriority:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            priorityLevel = NormalPriority;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> previousPriorityLevel = currentPriorityLevel; <span class="comment">// 3</span></span><br><span class="line">    currentPriorityLevel = priorityLevel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> eventHandler(); <span class="comment">// 运行react事件</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        currentPriorityLevel = previousPriorityLevel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dispatchEvent"><a href="#dispatchEvent" class="headerlink" title="dispatchEvent"></a>dispatchEvent</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    topLevelType: DOMTopLevelEventType,</span></span></span><br><span class="line"><span class="function"><span class="params">    eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">    nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!_enabled) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> nativeEventTarget = getEventTarget(nativeEvent); <span class="comment">// 获得事件发出的目标dom</span></span><br><span class="line">    <span class="keyword">let</span> targetInst = getClosestInstanceFromNode(nativeEventTarget); <span class="comment">// 获得dom对应的fiber</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        targetInst !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> targetInst.tag === <span class="string">&#x27;number&#x27;</span> &amp;&amp;</span><br><span class="line">        !isFiberMounted(targetInst) <span class="comment">// 是否mounted状态？</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// If we get an event (ex: img onload) before committing that</span></span><br><span class="line">        <span class="comment">// component&#x27;s mount, ignore it for now (that is, treat it as if it was an</span></span><br><span class="line">        <span class="comment">// event on a non-React tree). We might also consider queueing events and</span></span><br><span class="line">        <span class="comment">// dispatching them after the mount.</span></span><br><span class="line">        targetInst = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableEventAPI) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dispatchEventForPluginEventSystem(topLevelType, eventSystemFlags, nativeEvent, targetInst);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dispatchEventForPluginEventSystem"><a href="#dispatchEventForPluginEventSystem" class="headerlink" title="dispatchEventForPluginEventSystem"></a>dispatchEventForPluginEventSystem</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchEventForPluginEventSystem</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    topLevelType: DOMTopLevelEventType,</span></span></span><br><span class="line"><span class="function"><span class="params">    eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">    nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">    targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span>意义不明,先不管</span></span><br><span class="line">    <span class="keyword">const</span> bookKeeping = getTopLevelCallbackBookKeeping(topLevelType, nativeEvent, targetInst);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Event queue being processed in the same cycle allows</span></span><br><span class="line">        <span class="comment">// `preventDefault`.</span></span><br><span class="line">        batchedEventUpdates(handleTopLevel, bookKeeping);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        releaseTopLevelCallbackBookKeeping(bookKeeping);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="batchedEventUpdates"><a href="#batchedEventUpdates" class="headerlink" title="batchedEventUpdates"></a>batchedEventUpdates</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">batchedEventUpdates</span>(<span class="params">fn, bookkeeping</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isInsideEventHandler) &#123;</span><br><span class="line">        <span class="comment">// If we are currently inside another batch, we need to wait until it</span></span><br><span class="line">        <span class="comment">// fully completes before restoring state.</span></span><br><span class="line">        <span class="keyword">return</span> fn(bookkeeping);</span><br><span class="line">    &#125;</span><br><span class="line">    isInsideEventHandler = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> batchedEventUpdatesImpl(fn, bookkeeping);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        isInsideEventHandler = <span class="literal">false</span>;</span><br><span class="line">        finishEventHandler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="handleTopLevel"><a href="#handleTopLevel" class="headerlink" title="handleTopLevel"></a>handleTopLevel</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleTopLevel</span>(<span class="params">bookKeeping: BookKeepingInstance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> targetInst = bookKeeping.targetInst;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Loop through the hierarchy, in case there&#x27;s any nested components.</span></span><br><span class="line">    <span class="comment">// It&#x27;s important that we build the array of ancestors before calling any</span></span><br><span class="line">    <span class="comment">// event handlers, because event handlers can modify the DOM, leading to</span></span><br><span class="line">    <span class="comment">// inconsistencies with ReactMount&#x27;s node cache. See #1105.</span></span><br><span class="line">    <span class="keyword">let</span> ancestor = targetInst;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ancestor) &#123;</span><br><span class="line">            <span class="keyword">const</span> ancestors = bookKeeping.ancestors;</span><br><span class="line">            ((ancestors: any): <span class="built_in">Array</span>&lt;Fiber | <span class="literal">null</span>&gt;).push(ancestor);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> root = findRootContainerNode(ancestor); <span class="comment">// 根据fiber获得fiber根节点的dom div#app</span></span><br><span class="line">        <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bookKeeping.ancestors.push(ancestor);</span><br><span class="line">        ancestor = getClosestInstanceFromNode(root);</span><br><span class="line">    &#125; <span class="keyword">while</span> (ancestor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; bookKeeping.ancestors.length; i++) &#123;</span><br><span class="line">        targetInst = bookKeeping.ancestors[i];</span><br><span class="line">        <span class="keyword">const</span> eventTarget = getEventTarget(bookKeeping.nativeEvent);</span><br><span class="line">        <span class="keyword">const</span> topLevelType = ((bookKeeping.topLevelType: any): DOMTopLevelEventType);</span><br><span class="line">        <span class="keyword">const</span> nativeEvent = ((bookKeeping.nativeEvent: any): AnyNativeEvent);</span><br><span class="line"></span><br><span class="line">        runExtractedPluginEventsInBatch(topLevelType, targetInst, nativeEvent, eventTarget);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runExtractedPluginEventsInBatch"><a href="#runExtractedPluginEventsInBatch" class="headerlink" title="runExtractedPluginEventsInBatch"></a>runExtractedPluginEventsInBatch</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runExtractedPluginEventsInBatch</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    topLevelType: TopLevelType,</span></span></span><br><span class="line"><span class="function"><span class="params">    targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">    nativeEventTarget: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 返回当前点击event(react event),</span></span><br><span class="line">    <span class="comment">// 添加了_dispatchListeners属性存放事件(包括父节点的)</span></span><br><span class="line">    <span class="comment">// events可能是个数组</span></span><br><span class="line">    <span class="keyword">const</span> events = extractPluginEvents(topLevelType, targetInst, nativeEvent, nativeEventTarget);</span><br><span class="line">    runEventsInBatch(events); <span class="comment">// 运行事件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="extractPluginEvents"><a href="#extractPluginEvents" class="headerlink" title="extractPluginEvents"></a>extractPluginEvents</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allows registered plugins an opportunity to extract events from top-level</span></span><br><span class="line"><span class="comment"> * native browser events.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;*&#125;</span> </span>An accumulation of synthetic events.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractPluginEvents</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    topLevelType: TopLevelType,</span></span></span><br><span class="line"><span class="function"><span class="params">    targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">    nativeEventTarget: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Array</span>&lt;<span class="title">ReactSyntheticEvent</span>&gt; | <span class="title">ReactSyntheticEvent</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> events = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; plugins.length; i++) &#123;</span><br><span class="line">        <span class="comment">// empty, 一般事件、鼠标事件、onChange、select、输入事件</span></span><br><span class="line">        <span class="comment">// 这些不同的事件可能会同时触发</span></span><br><span class="line">        <span class="comment">// Not every plugin in the ordering may be loaded at runtime.</span></span><br><span class="line">        <span class="keyword">const</span> possiblePlugin: PluginModule&lt;AnyNativeEvent&gt; = plugins[i];</span><br><span class="line">        <span class="keyword">if</span> (possiblePlugin) &#123;</span><br><span class="line">            <span class="comment">// 返回react事件的event</span></span><br><span class="line">            <span class="keyword">const</span> extractedEvents = possiblePlugin.extractEvents(</span><br><span class="line">                topLevelType,</span><br><span class="line">                targetInst,</span><br><span class="line">                nativeEvent,</span><br><span class="line">                nativeEventTarget,</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (extractedEvents) &#123;</span><br><span class="line">                events = accumulateInto(events, extractedEvents);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> events;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>possiblePlugin.extractEvents = SimpleEventPlugin.extractEvents</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> SimpleEventPlugin: PluginModule&lt;MouseEvent&gt; &amp; &#123;</span><br><span class="line">    getEventPriority: <span class="function">(<span class="params">topLevelType: TopLevelType</span>) =&gt;</span> EventPriority,</span><br><span class="line">&#125; = &#123;</span><br><span class="line">    eventTypes: eventTypes,</span><br><span class="line"></span><br><span class="line">    getEventPriority(topLevelType: TopLevelType): EventPriority &#123;</span><br><span class="line">        <span class="keyword">const</span> config = topLevelEventsToDispatchConfig[topLevelType];</span><br><span class="line">        <span class="keyword">return</span> config !== <span class="literal">undefined</span> ? config.eventPriority : ContinuousEvent;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    extractEvents: <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        topLevelType: TopLevelType,</span></span></span><br><span class="line"><span class="function"><span class="params">        targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">        nativeEvent: MouseEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">        nativeEventTarget: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>): <span class="title">null</span> | <span class="title">ReactSyntheticEvent</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> dispatchConfig = topLevelEventsToDispatchConfig[topLevelType];</span><br><span class="line">        <span class="keyword">if</span> (!dispatchConfig) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> EventConstructor;</span><br><span class="line">        <span class="keyword">switch</span> (topLevelType) &#123;</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_KEY_PRESS:</span><br><span class="line">                <span class="comment">// Firefox creates a keypress event for function keys too. This removes</span></span><br><span class="line">                <span class="comment">// the unwanted keypress events. Enter is however both printable and</span></span><br><span class="line">                <span class="comment">// non-printable. One would expect Tab to be as well (but it isn&#x27;t).</span></span><br><span class="line">                <span class="keyword">if</span> (getEventCharCode(nativeEvent) === <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">/* falls through */</span></span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_KEY_DOWN:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_KEY_UP:</span><br><span class="line">                EventConstructor = SyntheticKeyboardEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_BLUR:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_FOCUS:</span><br><span class="line">                EventConstructor = SyntheticFocusEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_CLICK:</span><br><span class="line">                <span class="comment">// Firefox creates a click event on right mouse clicks. This removes the</span></span><br><span class="line">                <span class="comment">// unwanted click events.</span></span><br><span class="line">                <span class="keyword">if</span> (nativeEvent.button === <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">/* falls through */</span></span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_AUX_CLICK:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_DOUBLE_CLICK:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_MOUSE_DOWN:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_MOUSE_MOVE:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_MOUSE_UP:</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Disabled elements should not respond to mouse events</span></span><br><span class="line">            <span class="comment">/* falls through */</span></span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_MOUSE_OUT:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_MOUSE_OVER:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_CONTEXT_MENU:</span><br><span class="line">                EventConstructor = SyntheticMouseEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_DRAG:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_DRAG_END:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_DRAG_ENTER:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_DRAG_EXIT:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_DRAG_LEAVE:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_DRAG_OVER:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_DRAG_START:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_DROP:</span><br><span class="line">                EventConstructor = SyntheticDragEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_TOUCH_CANCEL:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_TOUCH_END:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_TOUCH_MOVE:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_TOUCH_START:</span><br><span class="line">                EventConstructor = SyntheticTouchEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_ANIMATION_END:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_ANIMATION_ITERATION:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_ANIMATION_START:</span><br><span class="line">                EventConstructor = SyntheticAnimationEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_TRANSITION_END:</span><br><span class="line">                EventConstructor = SyntheticTransitionEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_SCROLL:</span><br><span class="line">                EventConstructor = SyntheticUIEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_WHEEL:</span><br><span class="line">                EventConstructor = SyntheticWheelEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_COPY:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_CUT:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_PASTE:</span><br><span class="line">                EventConstructor = SyntheticClipboardEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_GOT_POINTER_CAPTURE:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_LOST_POINTER_CAPTURE:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_POINTER_CANCEL:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_POINTER_DOWN:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_POINTER_MOVE:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_POINTER_OUT:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_POINTER_OVER:</span><br><span class="line">            <span class="keyword">case</span> DOMTopLevelEventTypes.TOP_POINTER_UP:</span><br><span class="line">                EventConstructor = SyntheticPointerEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (knownHTMLTopLevelTypes.indexOf(topLevelType) === <span class="number">-1</span>) &#123;</span><br><span class="line">                        warningWithoutStack(</span><br><span class="line">                            <span class="literal">false</span>,</span><br><span class="line">                            <span class="string">&#x27;SimpleEventPlugin: Unhandled event type, `%s`. This warning &#x27;</span> +</span><br><span class="line">                                <span class="string">&#x27;is likely caused by a bug in React. Please file an issue.&#x27;</span>,</span><br><span class="line">                            topLevelType,</span><br><span class="line">                        );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// HTML Events</span></span><br><span class="line">                <span class="comment">// @see http://www.w3.org/TR/html5/index.html#events-0</span></span><br><span class="line">                EventConstructor = SyntheticEvent;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据原始event构建react的event</span></span><br><span class="line">        <span class="keyword">const</span> event = EventConstructor.getPooled(</span><br><span class="line">            dispatchConfig,</span><br><span class="line">            targetInst,</span><br><span class="line">            nativeEvent,</span><br><span class="line">            nativeEventTarget,</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// 先捕获后冒泡</span></span><br><span class="line">        accumulateTwoPhaseDispatches(event);</span><br><span class="line">        <span class="keyword">return</span> event;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="accumulateTwoPhaseDispatches"><a href="#accumulateTwoPhaseDispatches" class="headerlink" title="accumulateTwoPhaseDispatches"></a>accumulateTwoPhaseDispatches</h3><p>传进去的<code>event</code>能拿到对应<code>fiber</code>，根据<code>fiber</code>能拿到所有的父<code>fiber</code>，然后把所有符合的<code>fiber</code>放在一个数组中；</p>
<p>先按捕获的方式从父-&gt;子遍历得到是否有 capture 事件,在得到冒泡事件(特定标签会验证<code>disabled</code>)</p>
<p>然后所有合法的事件都放在了<code>event._dispatchListeners</code>中(一个是 function，多个是[function,function])</p>
<p>和他们的 <code>fiber</code> 放在<code>event._dispatchInstances</code>(一个是 fiber，多个是[fiber,fiber])</p>
<p>最后返回了这个<code>event</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">traverseTwoPhase</span>(<span class="params">inst, fn, arg</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> path = [];</span><br><span class="line">    <span class="keyword">while</span> (inst) &#123;</span><br><span class="line">        path.push(inst);</span><br><span class="line">        inst = getParent(inst);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = path.length; i-- &gt; <span class="number">0</span>; ) &#123;</span><br><span class="line">        fn(path[i], <span class="string">&#x27;captured&#x27;</span>, arg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; path.length; i++) &#123;</span><br><span class="line">        fn(path[i], <span class="string">&#x27;bubbled&#x27;</span>, arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runEventsInBatch"><a href="#runEventsInBatch" class="headerlink" title="runEventsInBatch"></a>runEventsInBatch</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runEventsInBatch</span>(<span class="params">events: Array&lt;ReactSyntheticEvent&gt; | ReactSyntheticEvent | null</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 批量运行事件</span></span><br><span class="line">    <span class="keyword">if</span> (events !== <span class="literal">null</span>) &#123;</span><br><span class="line">        eventQueue = accumulateInto(eventQueue, events);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set `eventQueue` to null before processing it so that we can tell if more</span></span><br><span class="line">    <span class="comment">// events get enqueued while processing.</span></span><br><span class="line">    <span class="keyword">const</span> processingEventQueue = eventQueue;</span><br><span class="line">    eventQueue = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!processingEventQueue) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (多个不同事件就循环)执行executeDispatchesAndReleaseTopLevel(processingEventQueue)</span></span><br><span class="line">    forEachAccumulated(processingEventQueue, executeDispatchesAndReleaseTopLevel);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This would be a good time to rethrow if any of the event handlers threw.</span></span><br><span class="line">    rethrowCaughtError();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="executeDispatchesAndReleaseTopLevel"><a href="#executeDispatchesAndReleaseTopLevel" class="headerlink" title="executeDispatchesAndReleaseTopLevel"></a>executeDispatchesAndReleaseTopLevel</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Dispatches an event and releases it back into the pool, unless persistent.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;?object&#125;</span> </span>event Synthetic event to be dispatched.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> executeDispatchesAndRelease = <span class="function"><span class="keyword">function</span> (<span class="params">event: ReactSyntheticEvent</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (event) &#123;</span><br><span class="line">        executeDispatchesInOrder(event);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!event.isPersistent()) &#123;</span><br><span class="line">            event.constructor.release(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> executeDispatchesAndReleaseTopLevel = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> executeDispatchesAndRelease(e);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="executeDispatchesInOrder"><a href="#executeDispatchesInOrder" class="headerlink" title="executeDispatchesInOrder"></a>executeDispatchesInOrder</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Standard/simple iteration through an event&#x27;s collected dispatches.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">executeDispatchesInOrder</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> dispatchListeners = event._dispatchListeners;</span><br><span class="line">    <span class="keyword">const</span> dispatchInstances = event._dispatchInstances;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(dispatchListeners)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dispatchListeners.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.isPropagationStopped()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Listeners and Instances are two parallel arrays that are always in sync.</span></span><br><span class="line">            executeDispatch(event, dispatchListeners[i], dispatchInstances[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dispatchListeners) &#123;</span><br><span class="line">        executeDispatch(event, dispatchListeners, dispatchInstances);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行完后清空</span></span><br><span class="line">    event._dispatchListeners = <span class="literal">null</span>;</span><br><span class="line">    event._dispatchInstances = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="executeDispatch"><a href="#executeDispatch" class="headerlink" title="executeDispatch"></a>executeDispatch</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Dispatch the event to the listener.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;SyntheticEvent&#125;</span> </span>event SyntheticEvent to handle</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;function&#125;</span> </span>listener Application-level callback</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>inst Internal component instance</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">executeDispatch</span>(<span class="params">event, listener, inst</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> type = event.type || <span class="string">&#x27;unknown-event&#x27;</span>;</span><br><span class="line">    event.currentTarget = getNodeFromInstance(inst);</span><br><span class="line">    <span class="comment">// 这里执行了用户写的事件</span></span><br><span class="line">    invokeGuardedCallbackAndCatchFirstError(type, listener, <span class="literal">undefined</span>, event);</span><br><span class="line">    event.currentTarget = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Same as invokeGuardedCallback, but instead of returning an error, it stores</span></span><br><span class="line"><span class="comment"> * it in a global so it can be rethrown by `rethrowCaughtError` later.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">TODO:</span> See if caughtError and rethrowError can be unified.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>name of the guard to use for logging or debugging</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> </span>func The function to invoke</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>context The context to use when calling the function</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;...*&#125;</span> </span>args Arguments for function</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeGuardedCallbackAndCatchFirstError</span>&lt;<span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>, <span class="title">D</span>, <span class="title">E</span>, <span class="title">F</span>, <span class="title">Context</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    name: string | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    func: (a: A, b: B, c: C, d: D, e: E, f: F) =&gt; void,</span></span></span><br><span class="line"><span class="function"><span class="params">    context: Context,</span></span></span><br><span class="line"><span class="function"><span class="params">    a: A,</span></span></span><br><span class="line"><span class="function"><span class="params">    b: B,</span></span></span><br><span class="line"><span class="function"><span class="params">    c: C,</span></span></span><br><span class="line"><span class="function"><span class="params">    d: D,</span></span></span><br><span class="line"><span class="function"><span class="params">    e: E,</span></span></span><br><span class="line"><span class="function"><span class="params">    f: F,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    invokeGuardedCallback.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">if</span> (hasError) &#123;</span><br><span class="line">        <span class="keyword">const</span> error = clearCaughtError();</span><br><span class="line">        <span class="keyword">if</span> (!hasRethrowError) &#123;</span><br><span class="line">            hasRethrowError = <span class="literal">true</span>;</span><br><span class="line">            rethrowError = error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Call a function while guarding against errors that happens within it.</span></span><br><span class="line"><span class="comment"> * Returns an error if it throws, otherwise null.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * In production, this is implemented using a try-catch. The reason we don&#x27;t</span></span><br><span class="line"><span class="comment"> * use a try-catch directly is so that we can swap out a different</span></span><br><span class="line"><span class="comment"> * implementation in DEV mode.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>name of the guard to use for logging or debugging</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> </span>func The function to invoke</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>context The context to use when calling the function</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;...*&#125;</span> </span>args Arguments for function</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeGuardedCallback</span>&lt;<span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>, <span class="title">D</span>, <span class="title">E</span>, <span class="title">F</span>, <span class="title">Context</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    name: string | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    func: (a: A, b: B, c: C, d: D, e: E, f: F) =&gt; mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">    context: Context,</span></span></span><br><span class="line"><span class="function"><span class="params">    a: A,</span></span></span><br><span class="line"><span class="function"><span class="params">    b: B,</span></span></span><br><span class="line"><span class="function"><span class="params">    c: C,</span></span></span><br><span class="line"><span class="function"><span class="params">    d: D,</span></span></span><br><span class="line"><span class="function"><span class="params">    e: E,</span></span></span><br><span class="line"><span class="function"><span class="params">    f: F,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    hasError = <span class="literal">false</span>;</span><br><span class="line">    caughtError = <span class="literal">null</span>;</span><br><span class="line">    invokeGuardedCallbackImpl.apply(reporter, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> invokeGuardedCallbackImpl = <span class="function"><span class="keyword">function</span> &lt;<span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>, <span class="title">D</span>, <span class="title">E</span>, <span class="title">F</span>, <span class="title">Context</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    name: string | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    func: (a: A, b: B, c: C, d: D, e: E, f: F) =&gt; mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">    context: Context,</span></span></span><br><span class="line"><span class="function"><span class="params">    a: A,</span></span></span><br><span class="line"><span class="function"><span class="params">    b: B,</span></span></span><br><span class="line"><span class="function"><span class="params">    c: C,</span></span></span><br><span class="line"><span class="function"><span class="params">    d: D,</span></span></span><br><span class="line"><span class="function"><span class="params">    e: E,</span></span></span><br><span class="line"><span class="function"><span class="params">    f: F,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> funcArgs = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// func就是用户写的方法</span></span><br><span class="line">        func.apply(context, funcArgs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="built_in">this</span>.onError(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>运行完后就是各种变量的释放和运行参数的重置或回归，然后执行同步队列</p>
<p>见 <code>schedule.md</code> -&gt; <code>flushSyncCallbackQueue</code></p>
<p>根据跟新重新构建<code>fiber</code>,然后渲染(<code>renderRoot</code>-&gt;<code>commitRoot</code>)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/09/react/function%E7%BB%84%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2020/09/09/react/function%E7%BB%84%E4%BB%B6/" class="post-title-link" itemprop="url">function组件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-09 14:00:00" itemprop="dateCreated datePublished" datetime="2020-09-09T14:00:00+08:00">2020-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="从-beginWork-开始"><a href="#从-beginWork-开始" class="headerlink" title="从 beginWork 开始"></a>从 beginWork 开始</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> IndeterminateComponent: &#123;</span><br><span class="line">        <span class="comment">// 2 function类型组件是这个tag</span></span><br><span class="line">        <span class="keyword">return</span> mountIndeterminateComponent(</span><br><span class="line">            current,</span><br><span class="line">            workInProgress,</span><br><span class="line">            workInProgress.type,</span><br><span class="line">            renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mountIndeterminateComponent"><a href="#mountIndeterminateComponent" class="headerlink" title="mountIndeterminateComponent"></a>mountIndeterminateComponent</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountIndeterminateComponent</span>(<span class="params">_current, workInProgress, Component, renderExpirationTime</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_current !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// An indeterminate component only mounts if it suspended inside a non-</span></span><br><span class="line">        <span class="comment">// concurrent tree, in an inconsistent state. We want to treat it like</span></span><br><span class="line">        <span class="comment">// a new mount, even though an empty version of it already committed.</span></span><br><span class="line">        <span class="comment">// Disconnect the alternate pointers.</span></span><br><span class="line">        _current.alternate = <span class="literal">null</span>;</span><br><span class="line">        workInProgress.alternate = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">        workInProgress.effectTag |= Placement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> props = workInProgress.pendingProps;</span><br><span class="line">    <span class="keyword">const</span> unmaskedContext = getUnmaskedContext(workInProgress, Component, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">const</span> context = getMaskedContext(workInProgress, unmaskedContext);</span><br><span class="line"></span><br><span class="line">    prepareToReadContext(workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="comment">// 以上都是和contetxt有关的处理</span></span><br><span class="line">    <span class="keyword">let</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        value = renderWithHooks(</span><br><span class="line">            <span class="comment">// 返回reactnode对象</span></span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            workInProgress,</span><br><span class="line">            Component,</span><br><span class="line">            props,</span><br><span class="line">            context,</span><br><span class="line">            renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// React DevTools reads this flag.</span></span><br><span class="line">    workInProgress.effectTag |= PerformedWork;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// class 或 function组件</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="keyword">typeof</span> value === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">        value !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> value.render === <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">        value.$$typeof === <span class="literal">undefined</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// Proceed under the assumption that this is a class instance</span></span><br><span class="line">        workInProgress.tag = ClassComponent;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Throw out any hooks that were used.</span></span><br><span class="line">        resetHooks();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Push context providers early to prevent context stack mismatches.</span></span><br><span class="line">        <span class="comment">// During mounting we don&#x27;t know the child context yet as the instance doesn&#x27;t exist.</span></span><br><span class="line">        <span class="comment">// We will invalidate the child context in finishClassComponent() right after rendering.</span></span><br><span class="line">        <span class="keyword">let</span> hasContext = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">            hasContext = <span class="literal">true</span>;</span><br><span class="line">            pushLegacyContextProvider(workInProgress);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            hasContext = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        workInProgress.memoizedState =</span><br><span class="line">            value.state !== <span class="literal">null</span> &amp;&amp; value.state !== <span class="literal">undefined</span> ? value.state : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> getDerivedStateFromProps = Component.getDerivedStateFromProps;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            applyDerivedStateFromProps(workInProgress, Component, getDerivedStateFromProps, props);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        adoptClassInstance(workInProgress, value);</span><br><span class="line">        mountClassInstance(workInProgress, Component, props, renderExpirationTime);</span><br><span class="line">        <span class="keyword">return</span> finishClassComponent(</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            workInProgress,</span><br><span class="line">            Component,</span><br><span class="line">            <span class="literal">true</span>,</span><br><span class="line">            hasContext,</span><br><span class="line">            renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Proceed under the assumption that this is a function component</span></span><br><span class="line">        workInProgress.tag = FunctionComponent;</span><br><span class="line">        reconcileChildren(<span class="literal">null</span>, workInProgress, value, renderExpirationTime);</span><br><span class="line">        <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="renderWithHooks"><a href="#renderWithHooks" class="headerlink" title="renderWithHooks"></a>renderWithHooks</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">renderWithHooks</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    Component: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    props: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    refOrContext: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    nextRenderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">    renderExpirationTime = nextRenderExpirationTime;</span><br><span class="line">    currentlyRenderingFiber = workInProgress;</span><br><span class="line">    nextCurrentHook = current !== <span class="literal">null</span> ? current.memoizedState : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The following should have already been reset</span></span><br><span class="line">    <span class="comment">// currentHook = null;</span></span><br><span class="line">    <span class="comment">// workInProgressHook = null;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// remainingExpirationTime = NoWork;</span></span><br><span class="line">    <span class="comment">// componentUpdateQueue = null;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// didScheduleRenderPhaseUpdate = false;</span></span><br><span class="line">    <span class="comment">// renderPhaseUpdates = null;</span></span><br><span class="line">    <span class="comment">// numberOfReRenders = 0;</span></span><br><span class="line">    <span class="comment">// sideEffectTag = 0;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO Warn if no hooks are used at all during mount, then some are used during update.</span></span><br><span class="line">    <span class="comment">// Currently we will identify the update render as a mount because nextCurrentHook === null.</span></span><br><span class="line">    <span class="comment">// This is tricky because it&#x27;s valid for certain types of components (e.g. React.lazy)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Using nextCurrentHook to differentiate between mount/update only works if at least one stateful hook is used.</span></span><br><span class="line">    <span class="comment">// Non-stateful hooks (e.g. context) don&#x27;t get added to memoizedState,</span></span><br><span class="line">    <span class="comment">// so nextCurrentHook would be null during updates and mounts.</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ReactCurrentDispatcher.current =</span><br><span class="line">            nextCurrentHook === <span class="literal">null</span> ? HooksDispatcherOnMount : HooksDispatcherOnUpdate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行函数，得到children</span></span><br><span class="line">    <span class="keyword">let</span> children = Component(props, refOrContext);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (didScheduleRenderPhaseUpdate) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            didScheduleRenderPhaseUpdate = <span class="literal">false</span>;</span><br><span class="line">            numberOfReRenders += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start over from the beginning of the list</span></span><br><span class="line">            nextCurrentHook = current !== <span class="literal">null</span> ? current.memoizedState : <span class="literal">null</span>;</span><br><span class="line">            nextWorkInProgressHook = firstWorkInProgressHook;</span><br><span class="line"></span><br><span class="line">            currentHook = <span class="literal">null</span>;</span><br><span class="line">            workInProgressHook = <span class="literal">null</span>;</span><br><span class="line">            componentUpdateQueue = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">                <span class="comment">// Also validate hook order for cascading updates.</span></span><br><span class="line">                hookTypesUpdateIndexDev = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ReactCurrentDispatcher.current = __DEV__</span><br><span class="line">                ? HooksDispatcherOnUpdateInDEV</span><br><span class="line">                : HooksDispatcherOnUpdate;</span><br><span class="line"></span><br><span class="line">            children = Component(props, refOrContext);</span><br><span class="line">        &#125; <span class="keyword">while</span> (didScheduleRenderPhaseUpdate);</span><br><span class="line"></span><br><span class="line">        renderPhaseUpdates = <span class="literal">null</span>;</span><br><span class="line">        numberOfReRenders = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We can assume the previous dispatcher is always this one, since we set it</span></span><br><span class="line">    <span class="comment">// at the beginning of the render phase and there&#x27;s no re-entrancy.</span></span><br><span class="line">    ReactCurrentDispatcher.current = ContextOnlyDispatcher;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> renderedWork: Fiber = (currentlyRenderingFiber: any);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存放了所有用到的hooks，能用next找到下一个</span></span><br><span class="line">    renderedWork.memoizedState = firstWorkInProgressHook;</span><br><span class="line">    renderedWork.expirationTime = remainingExpirationTime;</span><br><span class="line">    renderedWork.updateQueue = (componentUpdateQueue: any);</span><br><span class="line">    renderedWork.effectTag |= sideEffectTag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This check uses currentHook so that it works the same in DEV and prod bundles.</span></span><br><span class="line">    <span class="comment">// hookTypesDev could catch more cases (e.g. context) but only in DEV bundles.</span></span><br><span class="line">    <span class="keyword">const</span> didRenderTooFewHooks = currentHook !== <span class="literal">null</span> &amp;&amp; currentHook.next !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    renderExpirationTime = NoWork;</span><br><span class="line">    currentlyRenderingFiber = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    currentHook = <span class="literal">null</span>;</span><br><span class="line">    nextCurrentHook = <span class="literal">null</span>;</span><br><span class="line">    firstWorkInProgressHook = <span class="literal">null</span>;</span><br><span class="line">    workInProgressHook = <span class="literal">null</span>;</span><br><span class="line">    nextWorkInProgressHook = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    remainingExpirationTime = NoWork;</span><br><span class="line">    componentUpdateQueue = <span class="literal">null</span>;</span><br><span class="line">    sideEffectTag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// These were reset above</span></span><br><span class="line">    <span class="comment">// didScheduleRenderPhaseUpdate = false;</span></span><br><span class="line">    <span class="comment">// renderPhaseUpdates = null;</span></span><br><span class="line">    <span class="comment">// numberOfReRenders = 0;</span></span><br><span class="line"></span><br><span class="line">    invariant(</span><br><span class="line">        !didRenderTooFewHooks,</span><br><span class="line">        <span class="string">&#x27;Rendered fewer hooks than expected. This may be caused by an accidental &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;early return statement.&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> children;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/09/react/reconcileChildFibers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2020/09/09/react/reconcileChildFibers/" class="post-title-link" itemprop="url">reconcileChildFibers</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-09 14:00:00" itemprop="dateCreated datePublished" datetime="2020-09-09T14:00:00+08:00">2020-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>根据实例构建 fiber</p>
<h3 id="reconcileChildFibers"><a href="#reconcileChildFibers" class="headerlink" title="reconcileChildFibers"></a>reconcileChildFibers</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function is not recursive.</span></span><br><span class="line">    <span class="comment">// If the top level item is an array, we treat it as a set of children,</span></span><br><span class="line">    <span class="comment">// not as a fragment. Nested arrays on the other hand will be treated as</span></span><br><span class="line">    <span class="comment">// fragment nodes. Recursion happens at the normal flow.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle top level unkeyed fragments as if they were arrays.</span></span><br><span class="line">    <span class="comment">// This leads to an ambiguity between &lt;&gt;&#123;[...]&#125;&lt;/&gt; and &lt;&gt;...&lt;/&gt;.</span></span><br><span class="line">    <span class="comment">// We treat the ambiguous cases above the same.</span></span><br><span class="line">    <span class="keyword">const</span> isUnkeyedTopLevelFragment = <span class="comment">// 是否fragment</span></span><br><span class="line">        <span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">        newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">        newChild.key === <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">        newChild = newChild.props.children; <span class="comment">// 如果是fragment取他的子节点</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle object types</span></span><br><span class="line">    <span class="comment">// newChild可能是一个children</span></span><br><span class="line">    <span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (</span><br><span class="line">            newChild.$$typeof <span class="comment">// 子节点是单一的</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">                <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">                    reconcileSingleElement(</span><br><span class="line">                        returnFiber,</span><br><span class="line">                        currentFirstChild,</span><br><span class="line">                        newChild,</span><br><span class="line">                        expirationTime,</span><br><span class="line">                    ),</span><br><span class="line">                );</span><br><span class="line">            <span class="keyword">case</span> REACT_PORTAL_TYPE:</span><br><span class="line">                <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">                    reconcileSinglePortal(returnFiber, currentFirstChild, newChild, expirationTime),</span><br><span class="line">                );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> newChild === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">            reconcileSingleTextNode(returnFiber, currentFirstChild, <span class="string">&#x27;&#x27;</span> + newChild, expirationTime),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isArray(newChild)) &#123;</span><br><span class="line">        <span class="comment">// newChild是数组，多个子节点</span></span><br><span class="line">        <span class="keyword">return</span> reconcileChildrenArray(returnFiber, currentFirstChild, newChild, expirationTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getIteratorFn(newChild)) &#123;</span><br><span class="line">        <span class="keyword">return</span> reconcileChildrenIterator(returnFiber, currentFirstChild, newChild, expirationTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">        throwOnInvalidObjectType(returnFiber, newChild);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; !isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">        <span class="comment">// If the new child is undefined, and the return fiber is a composite</span></span><br><span class="line">        <span class="comment">// component, throw an error. If Fiber return types are disabled,</span></span><br><span class="line">        <span class="comment">// we already threw above.</span></span><br><span class="line">        <span class="keyword">switch</span> (returnFiber.tag) &#123;</span><br><span class="line">            <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Intentionally fall through to the next case, which handles both</span></span><br><span class="line">            <span class="comment">// functions and classes</span></span><br><span class="line">            <span class="comment">// eslint-disable-next-lined no-fallthrough</span></span><br><span class="line">            <span class="keyword">case</span> FunctionComponent: &#123;</span><br><span class="line">                <span class="keyword">const</span> Component = returnFiber.type;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remaining cases are all treated as empty.</span></span><br><span class="line">    <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reconcileChildrenArray"><a href="#reconcileChildrenArray" class="headerlink" title="reconcileChildrenArray"></a>reconcileChildrenArray</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildrenArray</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChildren: Array&lt;*&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This algorithm can&#x27;t optimize by searching from both ends since we</span></span><br><span class="line">    <span class="comment">// don&#x27;t have backpointers on fibers. I&#x27;m trying to see how far we can get</span></span><br><span class="line">    <span class="comment">// with that model. If it ends up not being worth the tradeoffs, we can</span></span><br><span class="line">    <span class="comment">// add it later.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Even with a two ended optimization, we&#x27;d want to optimize for the case</span></span><br><span class="line">    <span class="comment">// where there are few changes and brute force the comparison instead of</span></span><br><span class="line">    <span class="comment">// going for the Map. It&#x27;d like to explore hitting that path first in</span></span><br><span class="line">    <span class="comment">// forward-only mode and only go for the Map once we notice that we need</span></span><br><span class="line">    <span class="comment">// lots of look ahead. This doesn&#x27;t handle reversal as well as two ended</span></span><br><span class="line">    <span class="comment">// search but that&#x27;s unusual. Besides, for the two ended optimization to</span></span><br><span class="line">    <span class="comment">// work on Iterables, we&#x27;d need to copy the whole set.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// In this first iteration, we&#x27;ll just live with hitting the bad case</span></span><br><span class="line">    <span class="comment">// (adding everything to a Map) in for every insert/move.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// If you change this code, also update reconcileChildrenIterator() which</span></span><br><span class="line">    <span class="comment">// uses the same algorithm.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> resultingFirstChild: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> previousNewFiber: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> oldFiber = currentFirstChild;</span><br><span class="line">    <span class="keyword">let</span> lastPlacedIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> newIdx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> nextOldFiber = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// debugger</span></span><br><span class="line">    <span class="comment">// 第一轮遍历条件：存在原先的子节点且未遍历完需要更新的子节点</span></span><br><span class="line">    <span class="keyword">for</span> (; oldFiber !== <span class="literal">null</span> &amp;&amp; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldFiber.index &gt; newIdx) &#123;</span><br><span class="line">            nextOldFiber = oldFiber;</span><br><span class="line">            oldFiber = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nextOldFiber = oldFiber.sibling;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> newFiber = updateSlot(</span><br><span class="line">            <span class="comment">// 老的和新的没对应上返回null</span></span><br><span class="line">            returnFiber,</span><br><span class="line">            oldFiber,</span><br><span class="line">            newChildren[newIdx],</span><br><span class="line">            expirationTime,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 走出循环</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> This breaks on empty slots like null children. That&#x27;s</span></span><br><span class="line">            <span class="comment">// unfortunate because it triggers the slow path all the time. We need</span></span><br><span class="line">            <span class="comment">// a better way to communicate whether this was a miss or null,</span></span><br><span class="line">            <span class="comment">// boolean, undefined, etc.</span></span><br><span class="line">            <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">                oldFiber = nextOldFiber;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">            <span class="keyword">if</span> (oldFiber &amp;&amp; newFiber.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 没有复用，删除老的</span></span><br><span class="line">                <span class="comment">// We matched the slot, but we didn&#x27;t reuse the existing fiber, so we</span></span><br><span class="line">                <span class="comment">// need to delete the existing child.</span></span><br><span class="line">                deleteChild(returnFiber, oldFiber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">        <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">            resultingFirstChild = newFiber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Defer siblings if we&#x27;re not at the right index for this slot.</span></span><br><span class="line">            <span class="comment">// I.e. if we had null values before, then we want to defer this</span></span><br><span class="line">            <span class="comment">// for each null value. However, we also don&#x27;t want to call updateSlot</span></span><br><span class="line">            <span class="comment">// with the previous one.</span></span><br><span class="line">            previousNewFiber.sibling = newFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        previousNewFiber = newFiber;</span><br><span class="line">        oldFiber = nextOldFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newIdx === newChildren.length) &#123;</span><br><span class="line">        <span class="comment">// 新节点已被遍历完全，删除剩下的节点（如果有），然后退出</span></span><br><span class="line">        <span class="comment">// We&#x27;ve reached the end of the new children. We can delete the rest.</span></span><br><span class="line">        deleteRemainingChildren(returnFiber, oldFiber);</span><br><span class="line">        <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 没有oldFiber，全部插入</span></span><br><span class="line">        <span class="comment">// If we don&#x27;t have any more existing children we can choose a fast path</span></span><br><span class="line">        <span class="comment">// since the rest will all be insertions.</span></span><br><span class="line">        <span class="keyword">for</span> (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">            <span class="keyword">const</span> newFiber = createChild(returnFiber, newChildren[newIdx], expirationTime); <span class="comment">// 更具element创建fiber</span></span><br><span class="line">            <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">            <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">                resultingFirstChild = newFiber;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                previousNewFiber.sibling = newFiber; <span class="comment">// 建立兄弟节点，单向sibling</span></span><br><span class="line">            &#125;</span><br><span class="line">            previousNewFiber = newFiber; <span class="comment">// 记录上一个</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add all children to a key map for quick lookups.</span></span><br><span class="line">    <span class="comment">// 把老的fiber以key或index转为map 1 =&gt; one fiber ...</span></span><br><span class="line">    <span class="keyword">const</span> existingChildren = mapRemainingChildren(returnFiber, oldFiber);</span><br><span class="line">    <span class="comment">// Keep scanning and use the map to restore deleted items as moves.</span></span><br><span class="line">    <span class="keyword">for</span> (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">        <span class="keyword">const</span> newFiber = updateFromMap(</span><br><span class="line">            existingChildren,</span><br><span class="line">            returnFiber,</span><br><span class="line">            newIdx,</span><br><span class="line">            newChildren[newIdx],</span><br><span class="line">            expirationTime,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (newFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">                <span class="keyword">if</span> (newFiber.alternate !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// The new fiber is a work in progress, but if there exists a</span></span><br><span class="line">                    <span class="comment">// current, that means that we reused the fiber. We need to delete</span></span><br><span class="line">                    <span class="comment">// it from the child list so that we don&#x27;t add it to the deletion</span></span><br><span class="line">                    <span class="comment">// list.</span></span><br><span class="line">                    existingChildren.delete(newFiber.key === <span class="literal">null</span> ? newIdx : newFiber.key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">            <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">                resultingFirstChild = newFiber;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 设置兄弟节点</span></span><br><span class="line">                previousNewFiber.sibling = newFiber;</span><br><span class="line">            &#125;</span><br><span class="line">            previousNewFiber = newFiber;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">        <span class="comment">// Any existing children that weren&#x27;t consumed above were deleted. We need</span></span><br><span class="line">        <span class="comment">// to add them to the deletion list.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除在新fiber李没有的老fiber， 给effectTag添加删除标记</span></span><br><span class="line">        existingChildren.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> deleteChild(returnFiber, child));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/09/react/hooks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2020/09/09/react/hooks/" class="post-title-link" itemprop="url">hooks</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-09 14:00:00" itemprop="dateCreated datePublished" datetime="2020-09-09T14:00:00+08:00">2020-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在<code>renderWithHooks</code>中添加了方法,调用的 mount 或者 uodate 的 hooks 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ReactCurrentDispatcher.current =</span><br><span class="line">        nextCurrentHook === <span class="literal">null</span> ? HooksDispatcherOnMount : HooksDispatcherOnUpdate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行函数，得到children</span></span><br><span class="line"><span class="keyword">let</span> children = Component(props, refOrContext);</span><br></pre></td></tr></table></figure>

<h2 id="公共"><a href="#公共" class="headerlink" title="公共"></a>公共</h2><h3 id="mountWorkInProgressHook"><a href="#mountWorkInProgressHook" class="headerlink" title="mountWorkInProgressHook"></a>mountWorkInProgressHook</h3><p>基于这个方法，所有的 hooks 都在一条链上</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountWorkInProgressHook</span>(<span class="params"></span>): <span class="title">Hook</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> hook: Hook = &#123;</span><br><span class="line">        memoizedState: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">        baseState: <span class="literal">null</span>,</span><br><span class="line">        queue: <span class="literal">null</span>,</span><br><span class="line">        baseUpdate: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">        next: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// This is the first hook in the list</span></span><br><span class="line">        firstWorkInProgressHook = workInProgressHook = hook;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Append to the end of the list</span></span><br><span class="line">        workInProgressHook = workInProgressHook.next = hook;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateWorkInProgressHook"><a href="#updateWorkInProgressHook" class="headerlink" title="updateWorkInProgressHook"></a>updateWorkInProgressHook</h3><p>在跟新时都有用到，用来记录当前工作的 hook 和 next hook</p>
<p>并返回一个 clone hook</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateWorkInProgressHook</span>(<span class="params"></span>): <span class="title">Hook</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function is used both for updates and for re-renders triggered by a</span></span><br><span class="line">    <span class="comment">// render phase update. It assumes there is either a current hook we can</span></span><br><span class="line">    <span class="comment">// clone, or a work-in-progress hook from a previous render pass that we can</span></span><br><span class="line">    <span class="comment">// use as a base. When we reach the end of the base list, we must switch to</span></span><br><span class="line">    <span class="comment">// the dispatcher used for mounts.</span></span><br><span class="line">    <span class="keyword">if</span> (nextWorkInProgressHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// There&#x27;s already a work-in-progress. Reuse it.</span></span><br><span class="line">        workInProgressHook = nextWorkInProgressHook;</span><br><span class="line">        nextWorkInProgressHook = workInProgressHook.next;</span><br><span class="line"></span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line">        nextCurrentHook = currentHook !== <span class="literal">null</span> ? currentHook.next : <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Clone from the current hook.</span></span><br><span class="line">        invariant(nextCurrentHook !== <span class="literal">null</span>, <span class="string">&#x27;Rendered more hooks than during the previous render.&#x27;</span>);</span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> newHook: Hook = &#123;</span><br><span class="line">            memoizedState: currentHook.memoizedState,</span><br><span class="line"></span><br><span class="line">            baseState: currentHook.baseState,</span><br><span class="line">            queue: currentHook.queue,</span><br><span class="line">            baseUpdate: currentHook.baseUpdate,</span><br><span class="line"></span><br><span class="line">            next: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is the first hook in the list.</span></span><br><span class="line">            workInProgressHook = firstWorkInProgressHook = newHook;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Append to the end of the list.</span></span><br><span class="line">            workInProgressHook = workInProgressHook.next = newHook;</span><br><span class="line">        &#125;</span><br><span class="line">        nextCurrentHook = currentHook.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="方法绑定"><a href="#方法绑定" class="headerlink" title="方法绑定"></a>方法绑定</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 应该是错误处理</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ContextOnlyDispatcher: Dispatcher = &#123;</span><br><span class="line">    readContext,</span><br><span class="line"></span><br><span class="line">    useCallback: throwInvalidHookError,</span><br><span class="line">    useContext: throwInvalidHookError,</span><br><span class="line">    useEffect: throwInvalidHookError,</span><br><span class="line">    useImperativeHandle: throwInvalidHookError,</span><br><span class="line">    useLayoutEffect: throwInvalidHookError,</span><br><span class="line">    useMemo: throwInvalidHookError,</span><br><span class="line">    useReducer: throwInvalidHookError,</span><br><span class="line">    useRef: throwInvalidHookError,</span><br><span class="line">    useState: throwInvalidHookError,</span><br><span class="line">    useDebugValue: throwInvalidHookError,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化用</span></span><br><span class="line"><span class="keyword">const</span> HooksDispatcherOnMount: Dispatcher = &#123;</span><br><span class="line">    readContext,</span><br><span class="line"></span><br><span class="line">    useCallback: mountCallback,</span><br><span class="line">    useContext: readContext,</span><br><span class="line">    useEffect: mountEffect,</span><br><span class="line">    useImperativeHandle: mountImperativeHandle,</span><br><span class="line">    useLayoutEffect: mountLayoutEffect,</span><br><span class="line">    useMemo: mountMemo,</span><br><span class="line">    useReducer: mountReducer,</span><br><span class="line">    useRef: mountRef,</span><br><span class="line">    useState: mountState,</span><br><span class="line">    useDebugValue: mountDebugValue,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跟新用</span></span><br><span class="line"><span class="keyword">const</span> HooksDispatcherOnUpdate: Dispatcher = &#123;</span><br><span class="line">    readContext,</span><br><span class="line"></span><br><span class="line">    useCallback: updateCallback,</span><br><span class="line">    useContext: readContext,</span><br><span class="line">    useEffect: updateEffect,</span><br><span class="line">    useImperativeHandle: updateImperativeHandle,</span><br><span class="line">    useLayoutEffect: updateLayoutEffect,</span><br><span class="line">    useMemo: updateMemo,</span><br><span class="line">    useReducer: updateReducer,</span><br><span class="line">    useRef: updateRef,</span><br><span class="line">    useState: updateState,</span><br><span class="line">    useDebugValue: updateDebugValue,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="useRef"><a href="#useRef" class="headerlink" title="useRef"></a>useRef</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useRef</span>(<span class="params">initialValue</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> dispatcher = resolveDispatcher();</span><br><span class="line">    <span class="keyword">return</span> dispatcher.useRef(initialValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveDispatcher</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> dispatcher = ReactCurrentDispatcher.current;</span><br><span class="line">    !(dispatcher !== <span class="literal">null</span>)</span><br><span class="line">        ? invariant(</span><br><span class="line">              <span class="literal">false</span>,</span><br><span class="line">              <span class="string">&#x27;Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for one of the following reasons:\n1. You might have mismatching versions of React and the renderer (such as React DOM)\n2. You might be breaking the Rules of Hooks\n3. You might have more than one copy of React in the same app\nSee https://fb.me/react-invalid-hook-call for tips about how to debug and fix this problem.&#x27;</span>,</span><br><span class="line">          )</span><br><span class="line">        : <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> dispatcher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>然后进入<code>dispatcher.useRef</code>即<code>mountRef</code></p>
<h4 id="mountRef"><a href="#mountRef" class="headerlink" title="mountRef"></a>mountRef</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountRef</span>&lt;<span class="title">T</span>&gt;(<span class="params">initialValue: T</span>): </span>&#123;current: T&#125; &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line">    <span class="keyword">const</span> ref = &#123;<span class="attr">current</span>: initialValue&#125;;</span><br><span class="line">    hook.memoizedState = ref;</span><br><span class="line">    <span class="keyword">return</span> ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useState</span>(<span class="params">initialState</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> dispatcher = resolveDispatcher();</span><br><span class="line">    <span class="keyword">return</span> dispatcher.useState(initialState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h3><p>开始都差不多，进入 <code>dispatcher.useState</code>即<code>mountState</code></p>
<h4 id="mountState"><a href="#mountState" class="headerlink" title="mountState"></a>mountState</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">basicStateReducer</span>&lt;<span class="title">S</span>&gt;(<span class="params">state: S, action: BasicStateAction&lt;S&gt;</span>): <span class="title">S</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span> ? action(state) : action;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mountState&lt;S&gt;(initialState: (() =&gt; S) | S): [S, Dispatch&lt;BasicStateAction&lt;S&gt;&gt;] &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        initialState = initialState();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// memoizedState 最新结果</span></span><br><span class="line">    hook.memoizedState = hook.baseState = initialState;</span><br><span class="line">    <span class="keyword">const</span> queue = (hook.queue = &#123;</span><br><span class="line">        last: <span class="literal">null</span>,</span><br><span class="line">        dispatch: <span class="literal">null</span>,</span><br><span class="line">        lastRenderedReducer: basicStateReducer,</span><br><span class="line">        lastRenderedState: (initialState: any),</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 跟新方法</span></span><br><span class="line">    <span class="keyword">const</span> dispatch: Dispatch&lt;BasicStateAction&lt;S&gt;&gt; = (queue.dispatch = (dispatchAction.bind(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="comment">// Flow doesn&#x27;t know this is non-null, but we do.</span></span><br><span class="line">        ((currentlyRenderingFiber: any): Fiber),</span><br><span class="line">        queue,</span><br><span class="line">    ): any));</span><br><span class="line">    <span class="keyword">return</span> [hook.memoizedState, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><h4 id="dispatchAction"><a href="#dispatchAction" class="headerlink" title="dispatchAction"></a>dispatchAction</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Object.is polyfill</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is</span>(<span class="params">x: any, y: any</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        (x === y &amp;&amp; (x !== <span class="number">0</span> || <span class="number">1</span> / x === <span class="number">1</span> / y)) || (x !== x &amp;&amp; y !== y) <span class="comment">// eslint-disable-line no-self-compare</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// action 已经计算好的值，即setXXX的传参,</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchAction</span>&lt;<span class="title">S</span>, <span class="title">A</span>&gt;(<span class="params">fiber: Fiber, queue: UpdateQueue&lt;S, A&gt;, action: A</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> alternate = fiber.alternate;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        fiber === currentlyRenderingFiber ||</span><br><span class="line">        (alternate !== <span class="literal">null</span> &amp;&amp; alternate === currentlyRenderingFiber)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// This is a render phase update. Stash it in a lazily-created map of</span></span><br><span class="line">        <span class="comment">// queue -&gt; linked list of updates. After this render pass, we&#x27;ll restart</span></span><br><span class="line">        <span class="comment">// and apply the stashed updates on top of the work-in-progress hook.</span></span><br><span class="line">        didScheduleRenderPhaseUpdate = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">const</span> update: Update&lt;S, A&gt; = &#123;</span><br><span class="line">            expirationTime: renderExpirationTime,</span><br><span class="line">            suspenseConfig: <span class="literal">null</span>,</span><br><span class="line">            action,</span><br><span class="line">            eagerReducer: <span class="literal">null</span>,</span><br><span class="line">            eagerState: <span class="literal">null</span>,</span><br><span class="line">            next: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (renderPhaseUpdates === <span class="literal">null</span>) &#123;</span><br><span class="line">            renderPhaseUpdates = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> firstRenderPhaseUpdate = renderPhaseUpdates.get(queue);</span><br><span class="line">        <span class="keyword">if</span> (firstRenderPhaseUpdate === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            renderPhaseUpdates.set(queue, update);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Append the update to the end of the list.</span></span><br><span class="line">            <span class="keyword">let</span> lastRenderPhaseUpdate = firstRenderPhaseUpdate;</span><br><span class="line">            <span class="keyword">while</span> (lastRenderPhaseUpdate.next !== <span class="literal">null</span>) &#123;</span><br><span class="line">                lastRenderPhaseUpdate = lastRenderPhaseUpdate.next;</span><br><span class="line">            &#125;</span><br><span class="line">            lastRenderPhaseUpdate.next = update;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (revertPassiveEffectsChange) &#123;</span><br><span class="line">            flushPassiveEffects();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> currentTime = requestCurrentTime();</span><br><span class="line">        <span class="keyword">const</span> suspenseConfig = requestCurrentSuspenseConfig();</span><br><span class="line">        <span class="keyword">const</span> expirationTime = computeExpirationForFiber(currentTime, fiber, suspenseConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> update: Update&lt;S, A&gt; = &#123;</span><br><span class="line">            expirationTime,</span><br><span class="line">            suspenseConfig,</span><br><span class="line">            action,</span><br><span class="line">            eagerReducer: <span class="literal">null</span>,</span><br><span class="line">            eagerState: <span class="literal">null</span>,</span><br><span class="line">            next: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Append the update to the end of the list.</span></span><br><span class="line">        <span class="keyword">const</span> last = queue.last;</span><br><span class="line">        <span class="keyword">if</span> (last === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is the first update. Create a circular list.</span></span><br><span class="line">            update.next = update;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> first = last.next;</span><br><span class="line">            <span class="keyword">if</span> (first !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Still circular.</span></span><br><span class="line">                update.next = first;</span><br><span class="line">            &#125;</span><br><span class="line">            last.next = update;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// queue里放着就数据，last是新数据</span></span><br><span class="line">        queue.last = update;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            fiber.expirationTime === NoWork &amp;&amp;</span><br><span class="line">            (alternate === <span class="literal">null</span> || alternate.expirationTime === NoWork)</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// The queue is currently empty, which means we can eagerly compute the</span></span><br><span class="line">            <span class="comment">// next state before entering the render phase. If the new state is the</span></span><br><span class="line">            <span class="comment">// same as the current state, we may be able to bail out entirely.</span></span><br><span class="line">            <span class="keyword">const</span> lastRenderedReducer = queue.lastRenderedReducer;</span><br><span class="line">            <span class="keyword">if</span> (lastRenderedReducer !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> prevDispatcher;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 上一个值</span></span><br><span class="line">                    <span class="keyword">const</span> currentState: S = (queue.lastRenderedState: any);</span><br><span class="line">                    <span class="comment">// 最新值</span></span><br><span class="line">                    <span class="keyword">const</span> eagerState = lastRenderedReducer(currentState, action);</span><br><span class="line">                    <span class="comment">// Stash the eagerly computed state, and the reducer used to compute</span></span><br><span class="line">                    <span class="comment">// it, on the update object. If the reducer hasn&#x27;t changed by the</span></span><br><span class="line">                    <span class="comment">// time we enter the render phase, then the eager state can be used</span></span><br><span class="line">                    <span class="comment">// without calling the reducer again.</span></span><br><span class="line">                    update.eagerReducer = lastRenderedReducer;</span><br><span class="line">                    update.eagerState = eagerState;</span><br><span class="line">                    <span class="comment">// 即Object.is,相同就return</span></span><br><span class="line">                    <span class="keyword">if</span> (is(eagerState, currentState)) &#123;</span><br><span class="line">                        <span class="comment">// Fast path. We can bail out without scheduling React to re-render.</span></span><br><span class="line">                        <span class="comment">// It&#x27;s still possible that we&#x27;ll need to rebase this update later,</span></span><br><span class="line">                        <span class="comment">// if the component re-renders for a different reason and by that</span></span><br><span class="line">                        <span class="comment">// time the reducer has changed.</span></span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="comment">// Suppress the error. It will throw again in the render phase.</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">                        ReactCurrentDispatcher.current = prevDispatcher;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 有跟新，就去scheduleWork</span></span><br><span class="line">        scheduleWork(fiber, expirationTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="scheduleWork"><a href="#scheduleWork" class="headerlink" title="scheduleWork"></a>scheduleWork</h4><p>见 schedule.md</p>
<h3 id="跟新"><a href="#跟新" class="headerlink" title="跟新"></a>跟新</h3><p>跟新时 <code>dispatcher.useState</code> = <code>updateState</code></p>
<h4 id="updateState"><a href="#updateState" class="headerlink" title="updateState"></a>updateState</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">function updateState&lt;S&gt;(initialState: (() =&gt; S) | S): [S, Dispatch&lt;BasicStateAction&lt;S&gt;&gt;] &#123;</span><br><span class="line">    <span class="keyword">return</span> updateReducer(basicStateReducer, (initialState: any));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateReducer</span>&lt;<span class="title">S</span>, <span class="title">I</span>, <span class="title">A</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    reducer: (S, A) =&gt; S,</span></span></span><br><span class="line"><span class="function"><span class="params">    initialArg: I,</span></span></span><br><span class="line"><span class="function"><span class="params">    init?: (I) =&gt; S,</span></span></span><br><span class="line">): [S, Dispatch&lt;A&gt;] &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = updateWorkInProgressHook();</span><br><span class="line">    <span class="keyword">const</span> queue = hook.queue;</span><br><span class="line">    invariant(</span><br><span class="line">        queue !== <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&#x27;Should have a queue. This is likely a bug in React. Please file an issue.&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    queue.lastRenderedReducer = reducer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (numberOfReRenders &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// This is a re-render. Apply the new render phase updates to the previous</span></span><br><span class="line">        <span class="comment">// work-in-progress hook.</span></span><br><span class="line">        <span class="keyword">const</span> dispatch: Dispatch&lt;A&gt; = (queue.dispatch: any);</span><br><span class="line">        <span class="keyword">if</span> (renderPhaseUpdates !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Render phase updates are stored in a map of queue -&gt; linked list</span></span><br><span class="line">            <span class="keyword">const</span> firstRenderPhaseUpdate = renderPhaseUpdates.get(queue);</span><br><span class="line">            <span class="keyword">if</span> (firstRenderPhaseUpdate !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                renderPhaseUpdates.delete(queue);</span><br><span class="line">                <span class="keyword">let</span> newState = hook.memoizedState;</span><br><span class="line">                <span class="keyword">let</span> update = firstRenderPhaseUpdate;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="comment">// Process this render phase update. We don&#x27;t have to check the</span></span><br><span class="line">                    <span class="comment">// priority because it will always be the same as the current</span></span><br><span class="line">                    <span class="comment">// render&#x27;s.</span></span><br><span class="line">                    <span class="keyword">const</span> action = update.action;</span><br><span class="line">                    newState = reducer(newState, action);</span><br><span class="line">                    update = update.next;</span><br><span class="line">                &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Mark that the fiber performed work, but only if the new state is</span></span><br><span class="line">                <span class="comment">// different from the current state.</span></span><br><span class="line">                <span class="keyword">if</span> (!is(newState, hook.memoizedState)) &#123;</span><br><span class="line">                    markWorkInProgressReceivedUpdate();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                hook.memoizedState = newState;</span><br><span class="line">                <span class="comment">// Don&#x27;t persist the state accumlated from the render phase updates to</span></span><br><span class="line">                <span class="comment">// the base state unless the queue is empty.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Not sure if this is the desired semantics, but it&#x27;s what we</span></span><br><span class="line">                <span class="comment">// do for gDSFP. I can&#x27;t remember why.</span></span><br><span class="line">                <span class="keyword">if</span> (hook.baseUpdate === queue.last) &#123;</span><br><span class="line">                    hook.baseState = newState;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                queue.lastRenderedState = newState;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> [newState, dispatch];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [hook.memoizedState, dispatch];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The last update in the entire queue</span></span><br><span class="line">    <span class="keyword">const</span> last = queue.last;</span><br><span class="line">    <span class="comment">// The last update that is part of the base state.</span></span><br><span class="line">    <span class="keyword">const</span> baseUpdate = hook.baseUpdate;</span><br><span class="line">    <span class="keyword">const</span> baseState = hook.baseState;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the first unprocessed update.</span></span><br><span class="line">    <span class="keyword">let</span> first;</span><br><span class="line">    <span class="keyword">if</span> (baseUpdate !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (last !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// For the first update, the queue is a circular linked list where</span></span><br><span class="line">            <span class="comment">// `queue.last.next = queue.first`. Once the first update commits, and</span></span><br><span class="line">            <span class="comment">// the `baseUpdate` is no longer empty, we can unravel the list.</span></span><br><span class="line">            last.next = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        first = baseUpdate.next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        first = last !== <span class="literal">null</span> ? last.next : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (first !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 新 state 数据</span></span><br><span class="line">        <span class="keyword">let</span> newState = baseState;</span><br><span class="line">        <span class="keyword">let</span> newBaseState = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> newBaseUpdate = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> prevUpdate = baseUpdate;</span><br><span class="line">        <span class="keyword">let</span> update = first;</span><br><span class="line">        <span class="keyword">let</span> didSkip = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> updateExpirationTime = update.expirationTime;</span><br><span class="line">            <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">                <span class="comment">// Priority is insufficient. Skip this update. If this is the first</span></span><br><span class="line">                <span class="comment">// skipped update, the previous update/state is the new base</span></span><br><span class="line">                <span class="comment">// update/state.</span></span><br><span class="line">                <span class="keyword">if</span> (!didSkip) &#123;</span><br><span class="line">                    didSkip = <span class="literal">true</span>;</span><br><span class="line">                    newBaseUpdate = prevUpdate;</span><br><span class="line">                    newBaseState = newState;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Update the remaining priority in the queue.</span></span><br><span class="line">                <span class="keyword">if</span> (updateExpirationTime &gt; remainingExpirationTime) &#123;</span><br><span class="line">                    remainingExpirationTime = updateExpirationTime;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// This update does have sufficient priority.</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Mark the event time of this update as relevant to this render pass.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> This should ideally use the true event time of this update rather than</span></span><br><span class="line">                <span class="comment">// its priority which is a derived and not reverseable value.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> We should skip this update if it was already committed but currently</span></span><br><span class="line">                <span class="comment">// we have no way of detecting the difference between a committed and suspended</span></span><br><span class="line">                <span class="comment">// update here.</span></span><br><span class="line">                markRenderEventTimeAndConfig(updateExpirationTime, update.suspenseConfig);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Process this update.</span></span><br><span class="line">                <span class="keyword">if</span> (update.eagerReducer === reducer) &#123;</span><br><span class="line">                    <span class="comment">// If this update was processed eagerly, and its reducer matches the</span></span><br><span class="line">                    <span class="comment">// current reducer, we can use the eagerly computed state.</span></span><br><span class="line">                    newState = ((update.eagerState: any): S);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> action = update.action;</span><br><span class="line">                    newState = reducer(newState, action);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            prevUpdate = update;</span><br><span class="line">            update = update.next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span> &amp;&amp; update !== first);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!didSkip) &#123;</span><br><span class="line">            newBaseUpdate = prevUpdate;</span><br><span class="line">            newBaseState = newState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mark that the fiber performed work, but only if the new state is</span></span><br><span class="line">        <span class="comment">// different from the current state.</span></span><br><span class="line">        <span class="comment">// 标记fiber已完成工作，前提是新旧数据不同，通过Object.is</span></span><br><span class="line">        <span class="keyword">if</span> (!is(newState, hook.memoizedState)) &#123;</span><br><span class="line">            markWorkInProgressReceivedUpdate();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hook.memoizedState = newState;</span><br><span class="line">        hook.baseUpdate = newBaseUpdate;</span><br><span class="line">        hook.baseState = newBaseState;</span><br><span class="line"></span><br><span class="line">        queue.lastRenderedState = newState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dispatch: Dispatch&lt;A&gt; = (queue.dispatch: any);</span><br><span class="line">    <span class="keyword">return</span> [hook.memoizedState, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="updateWorkInProgressHook-1"><a href="#updateWorkInProgressHook-1" class="headerlink" title="updateWorkInProgressHook"></a>updateWorkInProgressHook</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateWorkInProgressHook</span>(<span class="params"></span>): <span class="title">Hook</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function is used both for updates and for re-renders triggered by a</span></span><br><span class="line">    <span class="comment">// render phase update. It assumes there is either a current hook we can</span></span><br><span class="line">    <span class="comment">// clone, or a work-in-progress hook from a previous render pass that we can</span></span><br><span class="line">    <span class="comment">// use as a base. When we reach the end of the base list, we must switch to</span></span><br><span class="line">    <span class="comment">// the dispatcher used for mounts.</span></span><br><span class="line">    <span class="keyword">if</span> (nextWorkInProgressHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// There&#x27;s already a work-in-progress. Reuse it.</span></span><br><span class="line">        workInProgressHook = nextWorkInProgressHook;</span><br><span class="line">        nextWorkInProgressHook = workInProgressHook.next;</span><br><span class="line"></span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line">        nextCurrentHook = currentHook !== <span class="literal">null</span> ? currentHook.next : <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Clone from the current hook.</span></span><br><span class="line">        invariant(nextCurrentHook !== <span class="literal">null</span>, <span class="string">&#x27;Rendered more hooks than during the previous render.&#x27;</span>);</span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clone 当前 hook</span></span><br><span class="line">        <span class="keyword">const</span> newHook: Hook = &#123;</span><br><span class="line">            memoizedState: currentHook.memoizedState,</span><br><span class="line"></span><br><span class="line">            baseState: currentHook.baseState,</span><br><span class="line">            queue: currentHook.queue,</span><br><span class="line">            baseUpdate: currentHook.baseUpdate,</span><br><span class="line"></span><br><span class="line">            next: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is the first hook in the list.</span></span><br><span class="line">            workInProgressHook = firstWorkInProgressHook = newHook;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Append to the end of the list.</span></span><br><span class="line">            workInProgressHook = workInProgressHook.next = newHook;</span><br><span class="line">        &#125;</span><br><span class="line">        nextCurrentHook = currentHook.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h2><h3 id="初始化-2"><a href="#初始化-2" class="headerlink" title="初始化"></a>初始化</h3><h4 id="mountEffect-和-mountEffectImpl"><a href="#mountEffect-和-mountEffectImpl" class="headerlink" title="mountEffect 和 mountEffectImpl"></a>mountEffect 和 mountEffectImpl</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountEffect</span>(<span class="params">create: () =&gt; (() =&gt; void) | void, deps: Array&lt;mixed&gt; | void | null</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mountEffectImpl(</span><br><span class="line">        UpdateEffect | PassiveEffect, <span class="comment">// 有这两种effect处理</span></span><br><span class="line">        UnmountPassive | MountPassive, <span class="comment">// 192</span></span><br><span class="line">        create,</span><br><span class="line">        deps,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountEffectImpl</span>(<span class="params">fiberEffectTag, hookEffectTag, create, deps</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line">    <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">    sideEffectTag |= fiberEffectTag;</span><br><span class="line">    hook.memoizedState = pushEffect(hookEffectTag, create, <span class="literal">undefined</span>, nextDeps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="pushEffect"><a href="#pushEffect" class="headerlink" title="pushEffect"></a>pushEffect</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushEffect</span>(<span class="params">tag, create, destroy, deps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> effect: Effect = &#123;</span><br><span class="line">        tag,</span><br><span class="line">        create,</span><br><span class="line">        destroy,</span><br><span class="line">        deps,</span><br><span class="line">        <span class="comment">// Circular</span></span><br><span class="line">        next: (<span class="literal">null</span>: any),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (componentUpdateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">        componentUpdateQueue = createFunctionComponentUpdateQueue();</span><br><span class="line">        componentUpdateQueue.lastEffect = effect.next = effect;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> lastEffect = componentUpdateQueue.lastEffect;</span><br><span class="line">        <span class="keyword">if</span> (lastEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">            componentUpdateQueue.lastEffect = effect.next = effect;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> firstEffect = lastEffect.next;</span><br><span class="line">            lastEffect.next = effect;</span><br><span class="line">            effect.next = firstEffect;</span><br><span class="line">            componentUpdateQueue.lastEffect = effect;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> effect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行-1"><a href="#执行-1" class="headerlink" title="执行"></a>执行</h3><p>从 <code>commitRoot</code>开始</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRoot</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 开始渲染流程</span></span><br><span class="line">    <span class="comment">// debugger;</span></span><br><span class="line">    <span class="comment">// 优先级相关，最后还是运行commitRootImpl</span></span><br><span class="line">    runWithPriority(ImmediatePriority, commitRootImpl.bind(<span class="literal">null</span>, root)); <span class="comment">// 渲染并执行componentDidMount</span></span><br><span class="line">    <span class="comment">// If there are passive effects, schedule a callback to flush them. This goes</span></span><br><span class="line">    <span class="comment">// outside commitRootImpl so that it inherits the priority of the render.</span></span><br><span class="line">    <span class="keyword">if</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        <span class="comment">// 这里是调度管理，先不看，直接进里面</span></span><br><span class="line">        <span class="keyword">const</span> priorityLevel = getCurrentPriorityLevel();</span><br><span class="line">        scheduleCallback(priorityLevel, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// hooks的useEffect在这里执行,不过是在RequestAnimationFrame里,不好一步追踪到这，只能打断点反追</span></span><br><span class="line">            flushPassiveEffects();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="flushPassiveEffects"><a href="#flushPassiveEffects" class="headerlink" title="flushPassiveEffects"></a>flushPassiveEffects</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">flushPassiveEffects</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rootWithPendingPassiveEffects === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> root = rootWithPendingPassiveEffects;</span><br><span class="line">    <span class="keyword">const</span> expirationTime = pendingPassiveEffectsExpirationTime;</span><br><span class="line">    rootWithPendingPassiveEffects = <span class="literal">null</span>;</span><br><span class="line">    pendingPassiveEffectsExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> prevInteractions: <span class="built_in">Set</span>&lt;Interaction&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= CommitContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note: This currently assumes there are no passive effects on the root</span></span><br><span class="line">    <span class="comment">// fiber, because the root is not part of its own effect list. This could</span></span><br><span class="line">    <span class="comment">// change in the future.</span></span><br><span class="line">    <span class="keyword">let</span> effect = root.current.firstEffect;</span><br><span class="line">    <span class="keyword">while</span> (effect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                commitPassiveHookEffects(effect);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                invariant(effect !== <span class="literal">null</span>, <span class="string">&#x27;Should be working on an effect.&#x27;</span>);</span><br><span class="line">                captureCommitPhaseError(effect, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        effect = effect.nextEffect;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line">    flushSyncCallbackQueue();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If additional passive effects were scheduled, increment a counter. If this</span></span><br><span class="line">    <span class="comment">// exceeds the limit, we&#x27;ll fire a warning.</span></span><br><span class="line">    nestedPassiveUpdateCount =</span><br><span class="line">        rootWithPendingPassiveEffects === <span class="literal">null</span> ? <span class="number">0</span> : nestedPassiveUpdateCount + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="commitPassiveHookEffects"><a href="#commitPassiveHookEffects" class="headerlink" title="commitPassiveHookEffects"></a>commitPassiveHookEffects</h4><p>先执行卸载的<code>return</code>,在执行本体</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">commitPassiveHookEffects</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    commitHookEffectList(UnmountPassive, NoHookEffect, finishedWork);</span><br><span class="line">    commitHookEffectList(NoHookEffect, MountPassive, finishedWork);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="commitHookEffectList"><a href="#commitHookEffectList" class="headerlink" title="commitHookEffectList"></a>commitHookEffectList</h4><p>这个方法在很多地方都有用到，目前已知的从<code>commitPassiveHookEffects</code>过来的是<code>useEffect</code>,其他未知</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitHookEffectList</span>(<span class="params">unmountTag: number, mountTag: number, finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> updateQueue: FunctionComponentUpdateQueue | <span class="literal">null</span> = (finishedWork.updateQueue: any);</span><br><span class="line">    <span class="keyword">let</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.lastEffect : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> firstEffect = lastEffect.next;</span><br><span class="line">        <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((effect.tag &amp; unmountTag) !== NoHookEffect) &#123;</span><br><span class="line">                <span class="comment">// Unmount</span></span><br><span class="line">                <span class="keyword">const</span> destroy = effect.destroy;</span><br><span class="line">                effect.destroy = <span class="literal">undefined</span>;</span><br><span class="line">                <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    destroy();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((effect.tag &amp; mountTag) !== NoHookEffect) &#123;</span><br><span class="line">                <span class="comment">// Mount</span></span><br><span class="line">                <span class="keyword">const</span> create = effect.create;</span><br><span class="line">                <span class="comment">// return就是destroy</span></span><br><span class="line">                effect.destroy = create();</span><br><span class="line">            &#125;</span><br><span class="line">            effect = effect.next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><h4 id="updateEffect"><a href="#updateEffect" class="headerlink" title="updateEffect"></a>updateEffect</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateEffect</span>(<span class="params">create: () =&gt; (() =&gt; void) | void, deps: Array&lt;mixed&gt; | void | null</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> updateEffectImpl(</span><br><span class="line">        UpdateEffect | PassiveEffect,</span><br><span class="line">        UnmountPassive | MountPassive,</span><br><span class="line">        create,</span><br><span class="line">        deps,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateEffectImpl</span>(<span class="params">fiberEffectTag, hookEffectTag, create, deps</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> hook = updateWorkInProgressHook();</span><br><span class="line">    <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">    <span class="keyword">let</span> destroy = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> prevEffect = currentHook.memoizedState;</span><br><span class="line">        destroy = prevEffect.destroy;</span><br><span class="line">        <span class="comment">// 判断依赖是否有变，</span></span><br><span class="line">        <span class="keyword">if</span> (nextDeps !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> prevDeps = prevEffect.deps;</span><br><span class="line">            <span class="comment">//  循环依赖，用Object.is</span></span><br><span class="line">            <span class="keyword">if</span> (areHookInputsEqual(nextDeps, prevDeps)) &#123;</span><br><span class="line">                <span class="comment">// 依赖不变，是NoHookEffect，所以useEffect不执行destroy和create</span></span><br><span class="line">                pushEffect(NoHookEffect, create, destroy, nextDeps);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 只有依赖有变或者没依赖才有fiberEffectTag标记，不过没发现有什么用</span></span><br><span class="line">    sideEffectTag |= fiberEffectTag;</span><br><span class="line">    hook.memoizedState = pushEffect(hookEffectTag, create, destroy, nextDeps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="useContext"><a href="#useContext" class="headerlink" title="useContext"></a>useContext</h2><p>context 见 context.md</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/09/react/commitRoot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2020/09/09/react/commitRoot/" class="post-title-link" itemprop="url">commitRoot</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-09 11:00:00" itemprop="dateCreated datePublished" datetime="2020-09-09T11:00:00+08:00">2020-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="commitRoot"><a href="#commitRoot" class="headerlink" title="commitRoot"></a>commitRoot</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRoot</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 开始渲染流程</span></span><br><span class="line">    <span class="comment">// debugger;</span></span><br><span class="line">    <span class="comment">// 优先级相关，最后还是运行commitRootImpl</span></span><br><span class="line">    runWithPriority(ImmediatePriority, commitRootImpl.bind(<span class="literal">null</span>, root)); <span class="comment">// 渲染并执行componentDidMount</span></span><br><span class="line">    <span class="comment">// If there are passive effects, schedule a callback to flush them. This goes</span></span><br><span class="line">    <span class="comment">// outside commitRootImpl so that it inherits the priority of the render.</span></span><br><span class="line">    <span class="keyword">if</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        <span class="comment">// 这里是调度管理，先不看，直接进里面</span></span><br><span class="line">        <span class="keyword">const</span> priorityLevel = getCurrentPriorityLevel();</span><br><span class="line">        scheduleCallback(priorityLevel, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// hooks的useEffect在这里执行</span></span><br><span class="line">            flushPassiveEffects();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="commitRootImpl"><a href="#commitRootImpl" class="headerlink" title="commitRootImpl"></a>commitRootImpl</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRootImpl</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">    flushPassiveEffects();</span><br><span class="line">    flushRenderPhaseStrictModeWarningsInDEV(); <span class="comment">// __DEV__</span></span><br><span class="line">    flushSuspensePriorityWarningInDEV(); <span class="comment">// __DEV__</span></span><br><span class="line"></span><br><span class="line">    invariant(</span><br><span class="line">        (executionContext &amp; (RenderContext | CommitContext)) === NoContext,</span><br><span class="line">        <span class="string">&#x27;Should not already be working.&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> finishedWork = root.finishedWork;</span><br><span class="line">    <span class="keyword">const</span> expirationTime = root.finishedExpirationTime;</span><br><span class="line">    <span class="keyword">if</span> (finishedWork === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    root.finishedWork = <span class="literal">null</span>;</span><br><span class="line">    root.finishedExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">    invariant(</span><br><span class="line">        finishedWork !== root.current,</span><br><span class="line">        <span class="string">&#x27;Cannot commit the same tree as before. This error is likely caused by &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;a bug in React. Please file an issue.&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// commitRoot never returns a continuation; it always finishes synchronously.</span></span><br><span class="line">    <span class="comment">// So we can clear these now to allow a new callback to be scheduled.</span></span><br><span class="line">    root.callbackNode = <span class="literal">null</span>;</span><br><span class="line">    root.callbackExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">    startCommitTimer(); <span class="comment">//  也算是__DEV__</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the first and last pending times on this root. The new first</span></span><br><span class="line">    <span class="comment">// pending time is whatever is left on the root fiber.</span></span><br><span class="line">    <span class="keyword">const</span> updateExpirationTimeBeforeCommit = finishedWork.expirationTime;</span><br><span class="line">    <span class="keyword">const</span> childExpirationTimeBeforeCommit = finishedWork.childExpirationTime;</span><br><span class="line">    <span class="keyword">const</span> firstPendingTimeBeforeCommit =</span><br><span class="line">        childExpirationTimeBeforeCommit &gt; updateExpirationTimeBeforeCommit</span><br><span class="line">            ? childExpirationTimeBeforeCommit</span><br><span class="line">            : updateExpirationTimeBeforeCommit;</span><br><span class="line">    root.firstPendingTime = firstPendingTimeBeforeCommit;</span><br><span class="line">    <span class="keyword">if</span> (firstPendingTimeBeforeCommit &lt; root.lastPendingTime) &#123;</span><br><span class="line">        <span class="comment">// This usually means we&#x27;ve finished all the work, but it can also happen</span></span><br><span class="line">        <span class="comment">// when something gets downprioritized during render, like a hidden tree.</span></span><br><span class="line">        root.lastPendingTime = firstPendingTimeBeforeCommit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">        <span class="comment">// We can reset these now that they are finished.</span></span><br><span class="line">        workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line">        workInProgress = <span class="literal">null</span>;</span><br><span class="line">        renderExpirationTime = NoWork;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 超时？这里复制过来就是没代码的，只有注释</span></span><br><span class="line">        <span class="comment">// This indicates that the last root we worked on is not the same one that</span></span><br><span class="line">        <span class="comment">// we&#x27;re committing now. This most commonly happens when a suspended root</span></span><br><span class="line">        <span class="comment">// times out.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the list of effects.</span></span><br><span class="line">    <span class="keyword">let</span> firstEffect;</span><br><span class="line">    <span class="keyword">if</span> (finishedWork.effectTag &gt; PerformedWork) &#123;</span><br><span class="line">        <span class="comment">// A fiber&#x27;s effect list consists only of its children, not itself. So if</span></span><br><span class="line">        <span class="comment">// the root has an effect, we need to add it to the end of the list. The</span></span><br><span class="line">        <span class="comment">// resulting list is the set that would belong to the root&#x27;s parent, if it</span></span><br><span class="line">        <span class="comment">// had one; that is, all the effects in the tree including the root.</span></span><br><span class="line">        <span class="keyword">if</span> (finishedWork.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">            finishedWork.lastEffect.nextEffect = finishedWork;</span><br><span class="line">            firstEffect = finishedWork.firstEffect;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            firstEffect = finishedWork;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// There is no effect on the root.</span></span><br><span class="line">        firstEffect = finishedWork.firstEffect;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (firstEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">        executionContext |= CommitContext;</span><br><span class="line">        <span class="keyword">let</span> prevInteractions: <span class="built_in">Set</span>&lt;Interaction&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">            prevInteractions = __interactionsRef.current;</span><br><span class="line">            __interactionsRef.current = root.memoizedInteractions;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset this to null before calling lifecycles</span></span><br><span class="line">        ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The commit phase is broken into several sub-phases. We do a separate pass</span></span><br><span class="line">        <span class="comment">// of the effect list for each phase: all mutation effects come before all</span></span><br><span class="line">        <span class="comment">// layout effects, and so on.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// commit阶段</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// The first phase a &quot;before mutation&quot; phase. We use this phase to read the</span></span><br><span class="line">        <span class="comment">// state of the host tree right before we mutate it. This is where</span></span><br><span class="line">        <span class="comment">// getSnapshotBeforeUpdate is called.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一个阶段，不知道在做什么，和snapshot有关</span></span><br><span class="line">        startCommitSnapshotEffectsTimer(); <span class="comment">// false</span></span><br><span class="line">        prepareForCommit(root.containerInfo); <span class="comment">// 准备</span></span><br><span class="line">        nextEffect = firstEffect;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    commitBeforeMutationEffects();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    invariant(nextEffect !== <span class="literal">null</span>, <span class="string">&#x27;Should be working on an effect.&#x27;</span>);</span><br><span class="line">                    captureCommitPhaseError(nextEffect, error);</span><br><span class="line">                    nextEffect = nextEffect.nextEffect;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>);</span><br><span class="line">        stopCommitSnapshotEffectsTimer(); <span class="comment">// false__DEV__</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">            <span class="comment">// false</span></span><br><span class="line">            <span class="comment">// Mark the current commit time to be shared by all Profilers in this</span></span><br><span class="line">            <span class="comment">// batch. This enables them to be grouped later.</span></span><br><span class="line">            recordCommitTime();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The next phase is the mutation phase, where we mutate the host tree.</span></span><br><span class="line">        startCommitHostEffectsTimer(); <span class="comment">// false__DEV__</span></span><br><span class="line">        <span class="comment">// 第二个阶段</span></span><br><span class="line">        nextEffect = firstEffect;</span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    commitMutationEffects(); <span class="comment">// 渲染dom</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    invariant(nextEffect !== <span class="literal">null</span>, <span class="string">&#x27;Should be working on an effect.&#x27;</span>);</span><br><span class="line">                    captureCommitPhaseError(nextEffect, error);</span><br><span class="line">                    nextEffect = nextEffect.nextEffect;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>);</span><br><span class="line">        stopCommitHostEffectsTimer(); <span class="comment">// false</span></span><br><span class="line">        resetAfterCommit(root.containerInfo); <span class="comment">// 重置一些数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// The work-in-progress tree is now the current tree. This must come after</span></span><br><span class="line">        <span class="comment">// the mutation phase, so that the previous tree is still current during</span></span><br><span class="line">        <span class="comment">// componentWillUnmount, but before the layout phase, so that the finished</span></span><br><span class="line">        <span class="comment">// work is current during componentDidMount/Update.</span></span><br><span class="line">        root.current = finishedWork;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The next phase is the layout phase, where we call effects that read</span></span><br><span class="line">        <span class="comment">// the host tree after it&#x27;s been mutated. The idiomatic use case for this is</span></span><br><span class="line">        <span class="comment">// layout, but class component lifecycles also fire here for legacy reasons.</span></span><br><span class="line">        startCommitLifeCyclesTimer(); <span class="comment">// false</span></span><br><span class="line">        nextEffect = firstEffect;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// debugger</span></span><br><span class="line">                    <span class="comment">// 生命周期和ref</span></span><br><span class="line">                    commitLayoutEffects(root, expirationTime);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    invariant(nextEffect !== <span class="literal">null</span>, <span class="string">&#x27;Should be working on an effect.&#x27;</span>);</span><br><span class="line">                    captureCommitPhaseError(nextEffect, error);</span><br><span class="line">                    nextEffect = nextEffect.nextEffect;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>);</span><br><span class="line">        stopCommitLifeCyclesTimer(); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">        nextEffect = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">            __interactionsRef.current = ((prevInteractions: any): <span class="built_in">Set</span>&lt;Interaction&gt;);</span><br><span class="line">        &#125;</span><br><span class="line">        executionContext = prevExecutionContext;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No effects.</span></span><br><span class="line">        root.current = finishedWork;</span><br><span class="line">        <span class="comment">// Measure these anyway so the flamegraph explicitly shows that there were</span></span><br><span class="line">        <span class="comment">// no effects.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Maybe there&#x27;s a better way to report this.</span></span><br><span class="line">        startCommitSnapshotEffectsTimer();</span><br><span class="line">        stopCommitSnapshotEffectsTimer();</span><br><span class="line">        <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">            recordCommitTime();</span><br><span class="line">        &#125;</span><br><span class="line">        startCommitHostEffectsTimer();</span><br><span class="line">        stopCommitHostEffectsTimer();</span><br><span class="line">        startCommitLifeCyclesTimer();</span><br><span class="line">        stopCommitLifeCyclesTimer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stopCommitTimer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> rootDidHavePassiveEffects = rootDoesHavePassiveEffects;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rootDoesHavePassiveEffects) &#123;</span><br><span class="line">        <span class="comment">// This commit has passive effects. Stash a reference to them. But don&#x27;t</span></span><br><span class="line">        <span class="comment">// schedule a callback until after flushing layout work.</span></span><br><span class="line">        rootDoesHavePassiveEffects = <span class="literal">false</span>;</span><br><span class="line">        rootWithPendingPassiveEffects = root;</span><br><span class="line">        pendingPassiveEffectsExpirationTime = expirationTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if there&#x27;s remaining work on this root</span></span><br><span class="line">    <span class="keyword">const</span> remainingExpirationTime = root.firstPendingTime;</span><br><span class="line">    <span class="keyword">if</span> (remainingExpirationTime !== NoWork) &#123;</span><br><span class="line">        <span class="keyword">const</span> currentTime = requestCurrentTime();</span><br><span class="line">        <span class="keyword">const</span> priorityLevel = inferPriorityFromExpirationTime(currentTime, remainingExpirationTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">            <span class="keyword">if</span> (didDeprioritizeIdleSubtree) &#123;</span><br><span class="line">                didDeprioritizeIdleSubtree = <span class="literal">false</span>;</span><br><span class="line">                scheduleInteractions(root, Never, root.memoizedInteractions);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 到这, DidMount已执行</span></span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        scheduleCallbackForRoot(root, priorityLevel, remainingExpirationTime);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If there&#x27;s no remaining work, we can clear the set of already failed</span></span><br><span class="line">        <span class="comment">// error boundaries.</span></span><br><span class="line">        legacyErrorBoundariesThatAlreadyFailed = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!rootDidHavePassiveEffects) &#123;</span><br><span class="line">            <span class="comment">// If there are no passive effects, then we can complete the pending interactions.</span></span><br><span class="line">            <span class="comment">// Otherwise, we&#x27;ll wait until after the passive effects are flushed.</span></span><br><span class="line">            <span class="comment">// Wait to do this until after remaining work has been scheduled,</span></span><br><span class="line">            <span class="comment">// so that we don&#x27;t prematurely signal complete for interactions when there&#x27;s e.g. hidden work.</span></span><br><span class="line">            finishPendingInteractions(root, expirationTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onCommitRoot(finishedWork.stateNode, expirationTime); <span class="comment">// 里面应该是dev-tool的处理，先不看</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (remainingExpirationTime === Sync) &#123;</span><br><span class="line">        <span class="comment">// Count the number of times the root synchronously re-renders without</span></span><br><span class="line">        <span class="comment">// finishing. If there are too many, it indicates an infinite update loop.</span></span><br><span class="line">        <span class="keyword">if</span> (root === rootWithNestedUpdates) &#123;</span><br><span class="line">            nestedUpdateCount++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">            rootWithNestedUpdates = root;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasUncaughtError) &#123;</span><br><span class="line">        hasUncaughtError = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">const</span> error = firstUncaughtError;</span><br><span class="line">        firstUncaughtError = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((executionContext &amp; LegacyUnbatchedContext) !== NoContext) &#123;</span><br><span class="line">        <span class="comment">// This is a legacy edge case. We just committed the initial mount of</span></span><br><span class="line">        <span class="comment">// a ReactDOM.render-ed root inside of batchedUpdates. The commit fired</span></span><br><span class="line">        <span class="comment">// synchronously, but layout updates should be deferred until the end</span></span><br><span class="line">        <span class="comment">// of the batch.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If layout work was scheduled, flush it now.</span></span><br><span class="line">    flushSyncCallbackQueue();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="prepareForCommit"><a href="#prepareForCommit" class="headerlink" title="prepareForCommit"></a>prepareForCommit</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">prepareForCommit</span>(<span class="params">containerInfo: Container</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    eventsEnabled = ReactBrowserEventEmitterIsEnabled(); <span class="comment">// 启用 _enabled</span></span><br><span class="line">    selectionInformation = getSelectionInformation(); <span class="comment">// 获取当前activeElement, 现在是body</span></span><br><span class="line">    ReactBrowserEventEmitterSetEnabled(<span class="literal">false</span>); <span class="comment">// 设为false, 对应上上 _enabled = false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="commitMutationEffects"><a href="#commitMutationEffects" class="headerlink" title="commitMutationEffects"></a>commitMutationEffects</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should probably move the bulk of this function to commitWork.</span></span><br><span class="line">    <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        setCurrentDebugFiberInDEV(nextEffect); <span class="comment">// __DEV__</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> effectTag = nextEffect.effectTag; <span class="comment">// 将要执行的步骤状态</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (effectTag &amp; ContentReset) &#123;</span><br><span class="line">            commitResetTextContent(nextEffect);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (effectTag &amp; Ref) &#123;</span><br><span class="line">            <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">            <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">                commitDetachRef(current);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The following switch statement is only concerned about placement,</span></span><br><span class="line">        <span class="comment">// updates, and deletions. To avoid needing to add a case for every possible</span></span><br><span class="line">        <span class="comment">// bitmap value, we remove the secondary effects from the effect tag and</span></span><br><span class="line">        <span class="comment">// switch on that value.</span></span><br><span class="line">        <span class="comment">// 新增 or 更新 or 删除</span></span><br><span class="line">        <span class="keyword">let</span> primaryEffectTag = effectTag &amp; (Placement | Update | Deletion); <span class="comment">// (2 | 4 | 8)</span></span><br><span class="line">        <span class="keyword">switch</span> (primaryEffectTag) &#123;</span><br><span class="line">            <span class="keyword">case</span> Placement: &#123;</span><br><span class="line">                <span class="comment">// debugger</span></span><br><span class="line">                commitPlacement(nextEffect);</span><br><span class="line">                <span class="comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is</span></span><br><span class="line">                <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> findDOMNode doesn&#x27;t rely on this any more but isMounted does</span></span><br><span class="line">                <span class="comment">// and isMounted is deprecated anyway so we should be able to kill this.</span></span><br><span class="line">                nextEffect.effectTag &amp;= ~Placement;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> PlacementAndUpdate: &#123;</span><br><span class="line">                <span class="comment">// 6</span></span><br><span class="line">                <span class="comment">// Placement</span></span><br><span class="line">                commitPlacement(nextEffect); <span class="comment">// 插入dom</span></span><br><span class="line">                <span class="comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is</span></span><br><span class="line">                <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">                nextEffect.effectTag &amp;= ~Placement;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Update</span></span><br><span class="line">                <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">                commitWork(current, nextEffect);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> Update: &#123;</span><br><span class="line">                <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">                commitWork(current, nextEffect);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> Deletion: &#123;</span><br><span class="line">                commitDeletion(nextEffect);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Only record a mutation effect if primaryEffectTag is non-zero.</span></span><br><span class="line">        recordEffect(); <span class="comment">// __DEV__</span></span><br><span class="line"></span><br><span class="line">        resetCurrentDebugFiberInDEV(); <span class="comment">// __DEV__</span></span><br><span class="line">        nextEffect = nextEffect.nextEffect;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="commitWork"><a href="#commitWork" class="headerlink" title="commitWork"></a>commitWork</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitWork</span>(<span class="params">current: Fiber | null, finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">        <span class="keyword">case</span> ForwardRef:</span><br><span class="line">        <span class="keyword">case</span> MemoComponent:</span><br><span class="line">        <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">            <span class="comment">// Note: We currently never use MountMutation, but useLayout uses</span></span><br><span class="line">            <span class="comment">// UnmountMutation.</span></span><br><span class="line">            commitHookEffectList(UnmountMutation, MountMutation, finishedWork);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">            <span class="keyword">const</span> instance: Instance = finishedWork.stateNode;</span><br><span class="line">            <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Commit the work prepared earlier.</span></span><br><span class="line">                <span class="keyword">const</span> newProps = finishedWork.memoizedProps;</span><br><span class="line">                <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">                <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">                <span class="comment">// this case.</span></span><br><span class="line">                <span class="keyword">const</span> oldProps = current !== <span class="literal">null</span> ? current.memoizedProps : newProps;</span><br><span class="line">                <span class="keyword">const</span> type = finishedWork.type;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Type the updateQueue to be specific to host components.</span></span><br><span class="line">                <span class="keyword">const</span> updatePayload: <span class="literal">null</span> | UpdatePayload = (finishedWork.updateQueue: any);</span><br><span class="line">                finishedWork.updateQueue = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// 更新</span></span><br><span class="line">                <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    commitUpdate(instance, updatePayload, type, oldProps, newProps, finishedWork);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostText: &#123;</span><br><span class="line">            invariant(</span><br><span class="line">                finishedWork.stateNode !== <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&#x27;This should have a text node initialized. This error is likely &#x27;</span> +</span><br><span class="line">                    <span class="string">&#x27;caused by a bug in React. Please file an issue.&#x27;</span>,</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">const</span> textInstance: TextInstance = finishedWork.stateNode;</span><br><span class="line">            <span class="keyword">const</span> newText: string = finishedWork.memoizedProps;</span><br><span class="line">            <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">            <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">            <span class="comment">// this case.</span></span><br><span class="line">            <span class="keyword">const</span> oldText: string = current !== <span class="literal">null</span> ? current.memoizedProps : newText;</span><br><span class="line">            commitTextUpdate(textInstance, oldText, newText);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> EventTarget: &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> Profiler: &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">            commitSuspenseComponent(finishedWork);</span><br><span class="line">            attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">            attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> IncompleteClassComponent: &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> EventComponent: &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            invariant(</span><br><span class="line">                <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;This unit of work tag should not have side-effects. This error is &#x27;</span> +</span><br><span class="line">                    <span class="string">&#x27;likely caused by a bug in React. Please file an issue.&#x27;</span>,</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="commitHookEffectList"><a href="#commitHookEffectList" class="headerlink" title="commitHookEffectList"></a>commitHookEffectList</h3><p>见 <code>hooks.md</code> -&gt; <code>useeffect</code>-&gt; <code>commitHookEffectList</code></p>
<h3 id="commitPlacement"><a href="#commitPlacement" class="headerlink" title="commitPlacement"></a>commitPlacement</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPlacement</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">        <span class="comment">// supportsMutation固定true</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Recursively insert all host nodes into the parent.</span></span><br><span class="line">    <span class="comment">// 递归获得父节点fiber</span></span><br><span class="line">    <span class="keyword">const</span> parentFiber = getHostParentFiber(finishedWork);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note: these two variables *must* always be updated together.</span></span><br><span class="line">    <span class="keyword">let</span> parent;</span><br><span class="line">    <span class="keyword">let</span> isContainer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (parentFiber.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> HostComponent:</span><br><span class="line">            parent = parentFiber.stateNode;</span><br><span class="line">            isContainer = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HostRoot:</span><br><span class="line">            parent = parentFiber.stateNode.containerInfo; <span class="comment">// dom</span></span><br><span class="line">            isContainer = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HostPortal:</span><br><span class="line">            parent = parentFiber.stateNode.containerInfo;</span><br><span class="line">            isContainer = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            invariant(</span><br><span class="line">                <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;Invalid host parent fiber. This error is likely caused by a bug &#x27;</span> +</span><br><span class="line">                    <span class="string">&#x27;in React. Please file an issue.&#x27;</span>,</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (parentFiber.effectTag &amp; ContentReset) &#123;</span><br><span class="line">        <span class="comment">// Reset the text content of the parent before doing any insertions</span></span><br><span class="line">        resetTextContent(parent);</span><br><span class="line">        <span class="comment">// Clear ContentReset from the effect tag</span></span><br><span class="line">        parentFiber.effectTag &amp;= ~ContentReset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> before = getHostSibling(finishedWork); <span class="comment">// 复用情况下找到下一个相邻节点</span></span><br><span class="line">    <span class="comment">// We only have the top Fiber that was inserted but we need to recurse down its</span></span><br><span class="line">    <span class="comment">// children to find all the terminal nodes.</span></span><br><span class="line">    <span class="keyword">let</span> node: Fiber = finishedWork;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.tag === HostComponent || node.tag === HostText) &#123;</span><br><span class="line">            <span class="keyword">const</span> stateNode = node.stateNode;</span><br><span class="line">            <span class="keyword">if</span> (before) &#123;</span><br><span class="line">                <span class="comment">// 如果有相邻节点，插在前面</span></span><br><span class="line">                <span class="comment">// 这里都是插在before前面</span></span><br><span class="line">                <span class="comment">// 区别是insertInContainerBefore里面判断了parent是不是COMMENT_NODE</span></span><br><span class="line">                <span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">                    insertInContainerBefore(parent, stateNode, before);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    insertBefore(parent, stateNode, before);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 都是parent.appendChild(stateNode)</span></span><br><span class="line">                <span class="comment">// 区别同上</span></span><br><span class="line">                <span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">                    appendChildToContainer(parent, stateNode);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    appendChild(parent, stateNode);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.tag === HostPortal) &#123;</span><br><span class="line">            <span class="comment">// If the insertion itself is a portal, then we don&#x27;t want to traverse</span></span><br><span class="line">            <span class="comment">// down its children. Instead, we&#x27;ll get insertions from each child in</span></span><br><span class="line">            <span class="comment">// the portal directly.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.child !== <span class="literal">null</span>) &#123;</span><br><span class="line">            node.child.return = node;</span><br><span class="line">            node = node.child;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node === finishedWork) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (node.return === <span class="literal">null</span> || node.return === finishedWork) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            node = node.return;</span><br><span class="line">        &#125;</span><br><span class="line">        node.sibling.return = node.return;</span><br><span class="line">        node = node.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="commitLayoutEffects"><a href="#commitLayoutEffects" class="headerlink" title="commitLayoutEffects"></a>commitLayoutEffects</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutEffects</span>(<span class="params">root: FiberRoot, committedExpirationTime: ExpirationTime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 生命周期和ref</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should probably move the bulk of this function to commitWork.</span></span><br><span class="line">    <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        setCurrentDebugFiberInDEV(nextEffect); <span class="comment">// dev</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> effectTag = nextEffect.effectTag;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (effectTag &amp; (Update | Callback)) &#123;</span><br><span class="line">            recordEffect(); <span class="comment">// false</span></span><br><span class="line">            <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">            commitLayoutEffectOnFiber(</span><br><span class="line">                <span class="comment">// componentDidUpdate</span></span><br><span class="line">                root,</span><br><span class="line">                current,</span><br><span class="line">                nextEffect,</span><br><span class="line">                committedExpirationTime,</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (effectTag &amp; Ref) &#123;</span><br><span class="line">            recordEffect(); <span class="comment">// false</span></span><br><span class="line">            commitAttachRef(nextEffect);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (effectTag &amp; Passive) &#123;</span><br><span class="line">            rootDoesHavePassiveEffects = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        resetCurrentDebugFiberInDEV();</span><br><span class="line">        nextEffect = nextEffect.nextEffect;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="commitLifeCycles"><a href="#commitLifeCycles" class="headerlink" title="commitLifeCycles"></a>commitLifeCycles</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLifeCycles</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    finishedRoot: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    committedExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">        <span class="keyword">case</span> ForwardRef:</span><br><span class="line">        <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">            commitHookEffectList(UnmountLayout, MountLayout, finishedWork);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">            <span class="keyword">const</span> instance = finishedWork.stateNode;</span><br><span class="line">            <span class="keyword">if</span> (finishedWork.effectTag &amp; Update) &#123;</span><br><span class="line">                <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">                    startPhaseTimer(finishedWork, <span class="string">&#x27;componentDidMount&#x27;</span>); <span class="comment">// false</span></span><br><span class="line">                    <span class="comment">// We could update instance props and state here,</span></span><br><span class="line">                    <span class="comment">// but instead we rely on them being set during last render.</span></span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> revisit this when we implement resuming.</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// debugger</span></span><br><span class="line">                    instance.componentDidMount(); <span class="comment">// 生命周期</span></span><br><span class="line">                    stopPhaseTimer(); <span class="comment">// false</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> prevProps =</span><br><span class="line">                        finishedWork.elementType === finishedWork.type</span><br><span class="line">                            ? current.memoizedProps</span><br><span class="line">                            : resolveDefaultProps(finishedWork.type, current.memoizedProps);</span><br><span class="line">                    <span class="keyword">const</span> prevState = current.memoizedState;</span><br><span class="line">                    startPhaseTimer(finishedWork, <span class="string">&#x27;componentDidUpdate&#x27;</span>);</span><br><span class="line">                    <span class="comment">// We could update instance props and state here,</span></span><br><span class="line">                    <span class="comment">// but instead we rely on them being set during last render.</span></span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> revisit this when we implement resuming.</span></span><br><span class="line"></span><br><span class="line">                    instance.componentDidUpdate(</span><br><span class="line">                        prevProps,</span><br><span class="line">                        prevState,</span><br><span class="line">                        instance.__reactInternalSnapshotBeforeUpdate,</span><br><span class="line">                    );</span><br><span class="line">                    stopPhaseTimer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">const</span> updateQueue = finishedWork.updateQueue;</span><br><span class="line">            <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// We could update instance props and state here,</span></span><br><span class="line">                <span class="comment">// but instead we rely on them being set during last render.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> revisit this when we implement resuming.</span></span><br><span class="line">                commitUpdateQueue(finishedWork, updateQueue, instance, committedExpirationTime);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">            <span class="keyword">const</span> updateQueue = finishedWork.updateQueue;</span><br><span class="line">            <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> instance = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (finishedWork.child !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (finishedWork.child.tag) &#123;</span><br><span class="line">                        <span class="keyword">case</span> HostComponent:</span><br><span class="line">                            instance = getPublicInstance(finishedWork.child.stateNode);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> ClassComponent:</span><br><span class="line">                            instance = finishedWork.child.stateNode;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                commitUpdateQueue(finishedWork, updateQueue, instance, committedExpirationTime);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">            <span class="keyword">const</span> instance: Instance = finishedWork.stateNode;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Renderers may schedule work to be done after host components are mounted</span></span><br><span class="line">            <span class="comment">// (eg DOM renderer may schedule auto-focus for inputs and form controls).</span></span><br><span class="line">            <span class="comment">// These effects should only be committed when components are first mounted,</span></span><br><span class="line">            <span class="comment">// aka when there is no current/alternate.</span></span><br><span class="line">            <span class="keyword">if</span> (current === <span class="literal">null</span> &amp;&amp; finishedWork.effectTag &amp; Update) &#123;</span><br><span class="line">                <span class="keyword">const</span> type = finishedWork.type;</span><br><span class="line">                <span class="keyword">const</span> props = finishedWork.memoizedProps;</span><br><span class="line">                commitMount(instance, type, props, finishedWork);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostText: &#123;</span><br><span class="line">            <span class="comment">// We have no life-cycles associated with text.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostPortal: &#123;</span><br><span class="line">            <span class="comment">// We have no life-cycles associated with portals.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> Profiler: &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SuspenseComponent:</span><br><span class="line">        <span class="keyword">case</span> SuspenseListComponent:</span><br><span class="line">        <span class="keyword">case</span> IncompleteClassComponent:</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">case</span> EventTarget: &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> EventComponent: &#123;</span><br><span class="line">            <span class="keyword">if</span> (enableEventAPI) &#123;</span><br><span class="line">                mountEventComponent(finishedWork.stateNode);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/09/react/completeWork/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2020/09/09/react/completeWork/" class="post-title-link" itemprop="url">completeWork</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-09 11:00:00" itemprop="dateCreated datePublished" datetime="2020-09-09T11:00:00+08:00">2020-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>根据 fiber tag 创建 dom 节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.pendingProps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> IndeterminateComponent:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LazyComponent:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SimpleMemoComponent:</span><br><span class="line">        <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">            <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">            <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">                popLegacyContext(workInProgress);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">            popHostContainer(workInProgress);</span><br><span class="line">            popTopLevelLegacyContextObject(workInProgress);</span><br><span class="line">            <span class="keyword">const</span> fiberRoot = (workInProgress.stateNode: FiberRoot);</span><br><span class="line">            <span class="keyword">if</span> (fiberRoot.pendingContext) &#123;</span><br><span class="line">                fiberRoot.context = fiberRoot.pendingContext;</span><br><span class="line">                fiberRoot.pendingContext = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (current === <span class="literal">null</span> || current.child === <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// If we hydrated, pop so that we can delete any remaining children</span></span><br><span class="line">                <span class="comment">// that weren&#x27;t hydrated.</span></span><br><span class="line">                popHydrationState(workInProgress);</span><br><span class="line">                <span class="comment">// This resets the hacky state to fix isMounted before committing.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Delete this when we delete isMounted and findDOMNode.</span></span><br><span class="line">                workInProgress.effectTag &amp;= ~Placement;</span><br><span class="line">            &#125;</span><br><span class="line">            updateHostContainer(workInProgress);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">            <span class="comment">// 5</span></span><br><span class="line">            popHostContext(workInProgress);</span><br><span class="line">            <span class="keyword">const</span> rootContainerInstance = getRootHostContainer(); <span class="comment">// 返回div#app</span></span><br><span class="line">            <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">            <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; workInProgress.stateNode != <span class="literal">null</span>) &#123;</span><br><span class="line">                updateHostComponent(</span><br><span class="line">                    <span class="comment">// 有stateNode（dom）,更新</span></span><br><span class="line">                    current,</span><br><span class="line">                    workInProgress,</span><br><span class="line">                    type,</span><br><span class="line">                    newProps,</span><br><span class="line">                    rootContainerInstance,</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (current.ref !== workInProgress.ref) &#123;</span><br><span class="line">                    markRef(workInProgress);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!newProps) &#123;</span><br><span class="line">                    invariant(</span><br><span class="line">                        workInProgress.stateNode !== <span class="literal">null</span>,</span><br><span class="line">                        <span class="string">&#x27;We must have new props for new mounts. This error is likely &#x27;</span> +</span><br><span class="line">                            <span class="string">&#x27;caused by a bug in React. Please file an issue.&#x27;</span>,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="comment">// This can happen when we abort work.</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 返回 http://www.w3.org/1999/xhtml</span></span><br><span class="line">                <span class="keyword">const</span> currentHostContext = getHostContext();</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Move createInstance to beginWork and keep it on a context</span></span><br><span class="line">                <span class="comment">// &quot;stack&quot; as the parent. Then append children as we go in beginWork</span></span><br><span class="line">                <span class="comment">// or completeWork depending on we want to add then top-&gt;down or</span></span><br><span class="line">                <span class="comment">// bottom-&gt;up. Top-&gt;down is faster in IE11.</span></span><br><span class="line">                <span class="keyword">let</span> wasHydrated = popHydrationState(workInProgress);</span><br><span class="line">                <span class="keyword">if</span> (wasHydrated) &#123;</span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Move this and createInstance step into the beginPhase</span></span><br><span class="line">                    <span class="comment">// to consolidate.</span></span><br><span class="line">                    <span class="keyword">if</span> (</span><br><span class="line">                        prepareToHydrateHostInstance(</span><br><span class="line">                            workInProgress,</span><br><span class="line">                            rootContainerInstance,</span><br><span class="line">                            currentHostContext,</span><br><span class="line">                        )</span><br><span class="line">                    ) &#123;</span><br><span class="line">                        <span class="comment">// If changes to the hydrated node needs to be applied at the</span></span><br><span class="line">                        <span class="comment">// commit-phase we mark this as such.</span></span><br><span class="line">                        markUpdate(workInProgress);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// debugger</span></span><br><span class="line">                    <span class="comment">// 根据fiber创建dom</span></span><br><span class="line">                    <span class="comment">// 返回创建的dom节点</span></span><br><span class="line">                    <span class="keyword">let</span> instance = createInstance(</span><br><span class="line">                        type,</span><br><span class="line">                        newProps,</span><br><span class="line">                        rootContainerInstance,</span><br><span class="line">                        currentHostContext,</span><br><span class="line">                        workInProgress,</span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">                    appendAllChildren(instance, workInProgress, <span class="literal">false</span>, <span class="literal">false</span>); <span class="comment">// 添加child ?</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Certain renderers require commit-time effects for initial mount.</span></span><br><span class="line">                    <span class="comment">// (eg DOM renderer supports auto-focus for certain elements).</span></span><br><span class="line">                    <span class="comment">// Make sure such renderers get scheduled for later work.</span></span><br><span class="line">                    <span class="keyword">if</span> (</span><br><span class="line">                        finalizeInitialChildren(</span><br><span class="line">                            instance,</span><br><span class="line">                            type,</span><br><span class="line">                            newProps,</span><br><span class="line">                            rootContainerInstance,</span><br><span class="line">                            currentHostContext,</span><br><span class="line">                        )</span><br><span class="line">                    ) &#123;</span><br><span class="line">                        markUpdate(workInProgress);</span><br><span class="line">                    &#125;</span><br><span class="line">                    workInProgress.stateNode = instance;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (workInProgress.ref !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// If there is a ref on a host node we need to schedule a callback</span></span><br><span class="line">                    markRef(workInProgress);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostText: &#123;</span><br><span class="line">            <span class="keyword">let</span> newText = newProps;</span><br><span class="line">            <span class="keyword">if</span> (current &amp;&amp; workInProgress.stateNode != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> oldText = current.memoizedProps;</span><br><span class="line">                <span class="comment">// If we have an alternate, that means this is an update and we need</span></span><br><span class="line">                <span class="comment">// to schedule a side-effect to do the updates.</span></span><br><span class="line">                updateHostText(current, workInProgress, oldText, newText);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> newText !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">                    invariant(</span><br><span class="line">                        workInProgress.stateNode !== <span class="literal">null</span>,</span><br><span class="line">                        <span class="string">&#x27;We must have new props for new mounts. This error is likely &#x27;</span> +</span><br><span class="line">                            <span class="string">&#x27;caused by a bug in React. Please file an issue.&#x27;</span>,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="comment">// This can happen when we abort work.</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">const</span> rootContainerInstance = getRootHostContainer();</span><br><span class="line">                <span class="keyword">const</span> currentHostContext = getHostContext();</span><br><span class="line">                <span class="keyword">let</span> wasHydrated = popHydrationState(workInProgress);</span><br><span class="line">                <span class="keyword">if</span> (wasHydrated) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (prepareToHydrateHostTextInstance(workInProgress)) &#123;</span><br><span class="line">                        markUpdate(workInProgress);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    workInProgress.stateNode = createTextInstance(</span><br><span class="line">                        newText,</span><br><span class="line">                        rootContainerInstance,</span><br><span class="line">                        currentHostContext,</span><br><span class="line">                        workInProgress,</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> ForwardRef:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">            popSuspenseContext(workInProgress);</span><br><span class="line">            <span class="keyword">const</span> nextState: <span class="literal">null</span> | SuspenseState = workInProgress.memoizedState;</span><br><span class="line">            <span class="keyword">if</span> ((workInProgress.effectTag &amp; DidCapture) !== NoEffect) &#123;</span><br><span class="line">                <span class="comment">// Something suspended. Re-render with the fallback children.</span></span><br><span class="line">                workInProgress.expirationTime = renderExpirationTime;</span><br><span class="line">                <span class="comment">// Do not reset the effect list.</span></span><br><span class="line">                <span class="keyword">return</span> workInProgress;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> nextDidTimeout = nextState !== <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">let</span> prevDidTimeout = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// In cases where we didn&#x27;t find a suitable hydration boundary we never</span></span><br><span class="line">                <span class="comment">// downgraded this to a DehydratedSuspenseComponent, but we still need to</span></span><br><span class="line">                <span class="comment">// pop the hydration state since we might be inside the insertion tree.</span></span><br><span class="line">                popHydrationState(workInProgress);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> prevState: <span class="literal">null</span> | SuspenseState = current.memoizedState;</span><br><span class="line">                prevDidTimeout = prevState !== <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (!nextDidTimeout &amp;&amp; prevState !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// We just switched from the fallback to the normal children.</span></span><br><span class="line">                    <span class="comment">// Delete the fallback.</span></span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Would it be better to store the fallback fragment on</span></span><br><span class="line">                    <span class="comment">// the stateNode during the begin phase?</span></span><br><span class="line">                    <span class="keyword">const</span> currentFallbackChild: Fiber | <span class="literal">null</span> = (current.child: any).sibling;</span><br><span class="line">                    <span class="keyword">if</span> (currentFallbackChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// Deletions go at the beginning of the return fiber&#x27;s effect list</span></span><br><span class="line">                        <span class="keyword">const</span> first = workInProgress.firstEffect;</span><br><span class="line">                        <span class="keyword">if</span> (first !== <span class="literal">null</span>) &#123;</span><br><span class="line">                            workInProgress.firstEffect = currentFallbackChild;</span><br><span class="line">                            currentFallbackChild.nextEffect = first;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            workInProgress.firstEffect = workInProgress.lastEffect = currentFallbackChild;</span><br><span class="line">                            currentFallbackChild.nextEffect = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        currentFallbackChild.effectTag = Deletion;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextDidTimeout &amp;&amp; !prevDidTimeout) &#123;</span><br><span class="line">                <span class="comment">// If this subtreee is running in batched mode we can suspend,</span></span><br><span class="line">                <span class="comment">// otherwise we won&#x27;t suspend.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> This will still suspend a synchronous tree if anything</span></span><br><span class="line">                <span class="comment">// in the concurrent tree already suspended during this render.</span></span><br><span class="line">                <span class="comment">// This is a known bug.</span></span><br><span class="line">                <span class="keyword">if</span> ((workInProgress.mode &amp; BatchedMode) !== NoMode) &#123;</span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Move this back to throwException because this is too late</span></span><br><span class="line">                    <span class="comment">// if this is a large tree which is common for initial loads. We</span></span><br><span class="line">                    <span class="comment">// don&#x27;t know if we should restart a render or not until we get</span></span><br><span class="line">                    <span class="comment">// this marker, and this is too late.</span></span><br><span class="line">                    <span class="comment">// If this render already had a ping or lower pri updates,</span></span><br><span class="line">                    <span class="comment">// and this is the first time we know we&#x27;re going to suspend we</span></span><br><span class="line">                    <span class="comment">// should be able to immediately restart from within throwException.</span></span><br><span class="line">                    <span class="keyword">const</span> hasInvisibleChildContext =</span><br><span class="line">                        current === <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                        workInProgress.memoizedProps.unstable_avoidThisFallback !== <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (</span><br><span class="line">                        hasInvisibleChildContext ||</span><br><span class="line">                        hasSuspenseContext(</span><br><span class="line">                            suspenseStackCursor.current,</span><br><span class="line">                            (InvisibleParentSuspenseContext: SuspenseContext),</span><br><span class="line">                        )</span><br><span class="line">                    ) &#123;</span><br><span class="line">                        <span class="comment">// If this was in an invisible tree or a new render, then showing</span></span><br><span class="line">                        <span class="comment">// this boundary is ok.</span></span><br><span class="line">                        renderDidSuspend();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// Otherwise, we&#x27;re going to have to hide content so we should</span></span><br><span class="line">                        <span class="comment">// suspend for longer if possible.</span></span><br><span class="line">                        renderDidSuspendDelayIfPossible();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (supportsPersistence) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Only schedule updates if not prevDidTimeout.</span></span><br><span class="line">                <span class="keyword">if</span> (nextDidTimeout) &#123;</span><br><span class="line">                    <span class="comment">// If this boundary just timed out, schedule an effect to attach a</span></span><br><span class="line">                    <span class="comment">// retry listener to the proimse. This flag is also used to hide the</span></span><br><span class="line">                    <span class="comment">// primary children.</span></span><br><span class="line">                    workInProgress.effectTag |= Update;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Only schedule updates if these values are non equal, i.e. it changed.</span></span><br><span class="line">                <span class="keyword">if</span> (nextDidTimeout || prevDidTimeout) &#123;</span><br><span class="line">                    <span class="comment">// If this boundary just timed out, schedule an effect to attach a</span></span><br><span class="line">                    <span class="comment">// retry listener to the proimse. This flag is also used to hide the</span></span><br><span class="line">                    <span class="comment">// primary children. In mutation mode, we also need the flag to</span></span><br><span class="line">                    <span class="comment">// *unhide* children that were previously hidden, so check if the</span></span><br><span class="line">                    <span class="comment">// is currently timed out, too.</span></span><br><span class="line">                    workInProgress.effectTag |= Update;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> Fragment:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Mode:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Profiler:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HostPortal:</span><br><span class="line">            popHostContainer(workInProgress);</span><br><span class="line">            updateHostContainer(workInProgress);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ContextProvider:</span><br><span class="line">            <span class="comment">// Pop provider fiber</span></span><br><span class="line">            popProvider(workInProgress);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ContextConsumer:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MemoComponent:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IncompleteClassComponent: &#123;</span><br><span class="line">            <span class="comment">// Same as class component case. I put it down here so that the tags are</span></span><br><span class="line">            <span class="comment">// sequential to ensure this switch is compiled to a jump table.</span></span><br><span class="line">            <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">            <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">                popLegacyContext(workInProgress);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> DehydratedSuspenseComponent: &#123;</span><br><span class="line">            <span class="keyword">if</span> (enableSuspenseServerRenderer) &#123;</span><br><span class="line">                popSuspenseContext(workInProgress);</span><br><span class="line">                <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> wasHydrated = popHydrationState(workInProgress);</span><br><span class="line">                    invariant(</span><br><span class="line">                        wasHydrated,</span><br><span class="line">                        <span class="string">&#x27;A dehydrated suspense component was completed without a hydrated node. &#x27;</span> +</span><br><span class="line">                            <span class="string">&#x27;This is probably a bug in React.&#x27;</span>,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">                        markDidDeprioritizeIdleSubtree();</span><br><span class="line">                    &#125;</span><br><span class="line">                    skipPastDehydratedSuspenseInstance(workInProgress);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((workInProgress.effectTag &amp; DidCapture) === NoEffect) &#123;</span><br><span class="line">                    <span class="comment">// This boundary did not suspend so it&#x27;s now hydrated.</span></span><br><span class="line">                    <span class="comment">// To handle any future suspense cases, we&#x27;re going to now upgrade it</span></span><br><span class="line">                    <span class="comment">// to a Suspense component. We detach it from the existing current fiber.</span></span><br><span class="line">                    current.alternate = <span class="literal">null</span>;</span><br><span class="line">                    workInProgress.alternate = <span class="literal">null</span>;</span><br><span class="line">                    workInProgress.tag = SuspenseComponent;</span><br><span class="line">                    workInProgress.memoizedState = <span class="literal">null</span>;</span><br><span class="line">                    workInProgress.stateNode = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">            popSuspenseContext(workInProgress);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((workInProgress.effectTag &amp; DidCapture) === NoEffect) &#123;</span><br><span class="line">                <span class="comment">// This is the first pass. We need to figure out if anything is still</span></span><br><span class="line">                <span class="comment">// suspended in the rendered set.</span></span><br><span class="line">                <span class="keyword">const</span> renderedChildren = workInProgress.child;</span><br><span class="line">                <span class="comment">// If new content unsuspended, but there&#x27;s still some content that</span></span><br><span class="line">                <span class="comment">// didn&#x27;t. Then we need to do a second pass that forces everything</span></span><br><span class="line">                <span class="comment">// to keep showing their fallbacks.</span></span><br><span class="line">                <span class="keyword">const</span> needsRerender = hasSuspendedChildrenAndNewContent(</span><br><span class="line">                    workInProgress,</span><br><span class="line">                    renderedChildren,</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">if</span> (needsRerender) &#123;</span><br><span class="line">                    <span class="comment">// Rerender the whole list, but this time, we&#x27;ll force fallbacks</span></span><br><span class="line">                    <span class="comment">// to stay in place.</span></span><br><span class="line">                    workInProgress.effectTag |= DidCapture;</span><br><span class="line">                    <span class="comment">// Reset the effect list before doing the second pass since that&#x27;s now invalid.</span></span><br><span class="line">                    workInProgress.firstEffect = workInProgress.lastEffect = <span class="literal">null</span>;</span><br><span class="line">                    <span class="comment">// Schedule work so we know not to bail out.</span></span><br><span class="line">                    workInProgress.expirationTime = renderExpirationTime;</span><br><span class="line">                    <span class="keyword">return</span> workInProgress;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                workInProgress.effectTag &amp;= ~DidCapture;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> EventComponent: &#123;</span><br><span class="line">            <span class="keyword">if</span> (enableEventAPI) &#123;</span><br><span class="line">                popHostContext(workInProgress);</span><br><span class="line">                <span class="keyword">const</span> rootContainerInstance = getRootHostContainer();</span><br><span class="line">                <span class="keyword">const</span> responder = workInProgress.type.responder;</span><br><span class="line">                <span class="keyword">let</span> eventComponentInstance: ReactEventComponentInstance | <span class="literal">null</span> =</span><br><span class="line">                    workInProgress.stateNode;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (eventComponentInstance === <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> responderState = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (__DEV__ &amp;&amp; !responder.allowMultipleHostChildren) &#123;</span><br><span class="line">                        <span class="keyword">const</span> hostChildrenCount = getEventComponentHostChildrenCount(</span><br><span class="line">                            workInProgress,</span><br><span class="line">                        );</span><br><span class="line">                        warning(</span><br><span class="line">                            (hostChildrenCount || <span class="number">0</span>) &lt; <span class="number">2</span>,</span><br><span class="line">                            <span class="string">&#x27;A &quot;&lt;%s&gt;&quot; event component cannot contain multiple host children.&#x27;</span>,</span><br><span class="line">                            getComponentName(workInProgress.type),</span><br><span class="line">                        );</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (responder.createInitialState !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                        responderState = responder.createInitialState(newProps);</span><br><span class="line">                    &#125;</span><br><span class="line">                    eventComponentInstance = workInProgress.stateNode = &#123;</span><br><span class="line">                        currentFiber: workInProgress,</span><br><span class="line">                        props: newProps,</span><br><span class="line">                        responder,</span><br><span class="line">                        rootEventTypes: <span class="literal">null</span>,</span><br><span class="line">                        rootInstance: rootContainerInstance,</span><br><span class="line">                        state: responderState,</span><br><span class="line">                    &#125;;</span><br><span class="line">                    markUpdate(workInProgress);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Update the props on the event component state node</span></span><br><span class="line">                    eventComponentInstance.props = newProps;</span><br><span class="line">                    <span class="comment">// Update the root container, so we can properly unmount events at some point</span></span><br><span class="line">                    eventComponentInstance.rootInstance = rootContainerInstance;</span><br><span class="line">                    <span class="comment">// Update the current fiber</span></span><br><span class="line">                    eventComponentInstance.currentFiber = workInProgress;</span><br><span class="line">                    updateEventComponent(eventComponentInstance);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> EventTarget: &#123;</span><br><span class="line">            <span class="keyword">if</span> (enableEventAPI) &#123;</span><br><span class="line">                popHostContext(workInProgress);</span><br><span class="line">                <span class="keyword">const</span> type = workInProgress.type.type;</span><br><span class="line">                <span class="keyword">const</span> rootContainerInstance = getRootHostContainer();</span><br><span class="line">                <span class="keyword">const</span> shouldUpdate = handleEventTarget(</span><br><span class="line">                    type,</span><br><span class="line">                    newProps,</span><br><span class="line">                    rootContainerInstance,</span><br><span class="line">                    workInProgress,</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// Update the latest props on the stateNode. This is used</span></span><br><span class="line">                <span class="comment">// during the event phase to find the most current props.</span></span><br><span class="line">                workInProgress.stateNode.props = newProps;</span><br><span class="line">                <span class="keyword">if</span> (shouldUpdate) &#123;</span><br><span class="line">                    markUpdate(workInProgress);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            invariant(</span><br><span class="line">                <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;Unknown unit of work tag. This error is likely caused by a bug in &#x27;</span> +</span><br><span class="line">                    <span class="string">&#x27;React. Please file an issue.&#x27;</span>,</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="createInstance"><a href="#createInstance" class="headerlink" title="createInstance"></a>createInstance</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    type: string,</span></span></span><br><span class="line"><span class="function"><span class="params">    props: Props,</span></span></span><br><span class="line"><span class="function"><span class="params">    rootContainerInstance: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">    hostContext: HostContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    internalInstanceHandle: Object,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Instance</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> parentNamespace: string;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        parentNamespace = ((hostContext: any): HostContextProd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获得当前的dom实例 createElement结果</span></span><br><span class="line">    <span class="keyword">const</span> domElement: Instance = createElement(type, props, rootContainerInstance, parentNamespace);</span><br><span class="line">    <span class="comment">// 给dom添加属性指向对应fiber</span></span><br><span class="line">    precacheFiberNode(internalInstanceHandle, domElement);</span><br><span class="line">    <span class="comment">// 给dom添加属性指向对应props</span></span><br><span class="line">    updateFiberProps(domElement, props);</span><br><span class="line">    <span class="keyword">return</span> domElement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendAllChildren"><a href="#appendAllChildren" class="headerlink" title="appendAllChildren"></a>appendAllChildren</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在浏览器环境中他固定为true</span></span><br><span class="line"><span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">    <span class="comment">// Mutation mode</span></span><br><span class="line"></span><br><span class="line">    appendAllChildren = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        parent: Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">        workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">        needsVisibilityToggle: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">        isHidden: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) </span>&#123;</span><br><span class="line">        <span class="comment">// We only have the top Fiber that was created but we need recurse down its</span></span><br><span class="line">        <span class="comment">// children to find all the terminal nodes.</span></span><br><span class="line">        <span class="keyword">let</span> node = workInProgress.child;</span><br><span class="line">        <span class="keyword">while</span> (node !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (node.tag === HostComponent || node.tag === HostText) &#123;</span><br><span class="line">                appendInitialChild(parent, node.stateNode);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.tag === HostPortal) &#123;</span><br><span class="line">                <span class="comment">// If we have a portal child, then we don&#x27;t want to traverse</span></span><br><span class="line">                <span class="comment">// down its children. Instead, we&#x27;ll get insertions from each child in</span></span><br><span class="line">                <span class="comment">// the portal directly.</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.child !== <span class="literal">null</span>) &#123;</span><br><span class="line">                node.child.return = node;</span><br><span class="line">                node = node.child;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (node === workInProgress) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (node.return === <span class="literal">null</span> || node.return === workInProgress) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                node = node.return;</span><br><span class="line">            &#125;</span><br><span class="line">            node.sibling.return = node.return;</span><br><span class="line">            node = node.sibling;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="finalizeInitialChildren"><a href="#finalizeInitialChildren" class="headerlink" title="finalizeInitialChildren"></a>finalizeInitialChildren</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">finalizeInitialChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    domElement: Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">    type: string,</span></span></span><br><span class="line"><span class="function"><span class="params">    props: Props,</span></span></span><br><span class="line"><span class="function"><span class="params">    rootContainerInstance: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">    hostContext: HostContext,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">    setInitialProperties(domElement, type, props, rootContainerInstance);</span><br><span class="line">    <span class="comment">// 判断是否需要autoFocus</span></span><br><span class="line">    <span class="keyword">return</span> shouldAutoFocusHostComponent(type, props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="setInitialProperties"><a href="#setInitialProperties" class="headerlink" title="setInitialProperties"></a>setInitialProperties</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">setInitialProperties</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    domElement: Element,</span></span></span><br><span class="line"><span class="function"><span class="params">    tag: string,</span></span></span><br><span class="line"><span class="function"><span class="params">    rawProps: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">    rootContainerElement: Element | Document,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> isCustomComponentTag = isCustomComponent(tag, rawProps); <span class="comment">// 是否自定义标签</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Make sure that we check isMounted before firing any of these events.</span></span><br><span class="line">    <span class="keyword">let</span> props: <span class="built_in">Object</span>;</span><br><span class="line">    <span class="keyword">switch</span> (</span><br><span class="line">        tag <span class="comment">// 给以下特殊标签添加默认事件</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;iframe&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;object&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;embed&#x27;</span>:</span><br><span class="line">            trapBubbledEvent(TOP_LOAD, domElement);</span><br><span class="line">            props = rawProps;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;video&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;audio&#x27;</span>:</span><br><span class="line">            <span class="comment">// Create listener for each media event</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; mediaEventTypes.length; i++) &#123;</span><br><span class="line">                trapBubbledEvent(mediaEventTypes[i], domElement);</span><br><span class="line">            &#125;</span><br><span class="line">            props = rawProps;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;source&#x27;</span>:</span><br><span class="line">            trapBubbledEvent(TOP_ERROR, domElement);</span><br><span class="line">            props = rawProps;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;img&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;image&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;link&#x27;</span>:</span><br><span class="line">            trapBubbledEvent(TOP_ERROR, domElement);</span><br><span class="line">            trapBubbledEvent(TOP_LOAD, domElement);</span><br><span class="line">            props = rawProps;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;form&#x27;</span>:</span><br><span class="line">            trapBubbledEvent(TOP_RESET, domElement);</span><br><span class="line">            trapBubbledEvent(TOP_SUBMIT, domElement);</span><br><span class="line">            props = rawProps;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;details&#x27;</span>:</span><br><span class="line">            trapBubbledEvent(TOP_TOGGLE, domElement);</span><br><span class="line">            props = rawProps;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;input&#x27;</span>:</span><br><span class="line">            ReactDOMInputInitWrapperState(domElement, rawProps);</span><br><span class="line">            props = ReactDOMInputGetHostProps(domElement, rawProps);</span><br><span class="line">            trapBubbledEvent(TOP_INVALID, domElement);</span><br><span class="line">            <span class="comment">// For controlled components we always need to ensure we&#x27;re listening</span></span><br><span class="line">            <span class="comment">// to onChange. Even if there is no listener.</span></span><br><span class="line">            ensureListeningTo(rootContainerElement, <span class="string">&#x27;onChange&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;option&#x27;</span>:</span><br><span class="line">            ReactDOMOptionValidateProps(domElement, rawProps);</span><br><span class="line">            props = ReactDOMOptionGetHostProps(domElement, rawProps);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;select&#x27;</span>:</span><br><span class="line">            ReactDOMSelectInitWrapperState(domElement, rawProps);</span><br><span class="line">            props = ReactDOMSelectGetHostProps(domElement, rawProps);</span><br><span class="line">            trapBubbledEvent(TOP_INVALID, domElement);</span><br><span class="line">            <span class="comment">// For controlled components we always need to ensure we&#x27;re listening</span></span><br><span class="line">            <span class="comment">// to onChange. Even if there is no listener.</span></span><br><span class="line">            ensureListeningTo(rootContainerElement, <span class="string">&#x27;onChange&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;textarea&#x27;</span>:</span><br><span class="line">            ReactDOMTextareaInitWrapperState(domElement, rawProps);</span><br><span class="line">            props = ReactDOMTextareaGetHostProps(domElement, rawProps);</span><br><span class="line">            trapBubbledEvent(TOP_INVALID, domElement);</span><br><span class="line">            <span class="comment">// For controlled components we always need to ensure we&#x27;re listening</span></span><br><span class="line">            <span class="comment">// to onChange. Even if there is no listener.</span></span><br><span class="line">            ensureListeningTo(rootContainerElement, <span class="string">&#x27;onChange&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            props = rawProps;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    assertValidProps(tag, props); <span class="comment">// 判断props合法</span></span><br><span class="line">    setInitialDOMProperties(</span><br><span class="line">        <span class="comment">// 根据props设置dom属性, 事件绑定的开始</span></span><br><span class="line">        tag,</span><br><span class="line">        domElement,</span><br><span class="line">        rootContainerElement,</span><br><span class="line">        props,</span><br><span class="line">        isCustomComponentTag,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;input&#x27;</span>:</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Make sure we check if this is still unmounted or do any clean</span></span><br><span class="line">            <span class="comment">// up necessary since we never stop tracking anymore.</span></span><br><span class="line">            track((domElement: any));</span><br><span class="line">            ReactDOMInputPostMountWrapper(domElement, rawProps, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;textarea&#x27;</span>:</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Make sure we check if this is still unmounted or do any clean</span></span><br><span class="line">            <span class="comment">// up necessary since we never stop tracking anymore.</span></span><br><span class="line">            track((domElement: any));</span><br><span class="line">            ReactDOMTextareaPostMountWrapper(domElement, rawProps);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;option&#x27;</span>:</span><br><span class="line">            ReactDOMOptionPostMountWrapper(domElement, rawProps);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;select&#x27;</span>:</span><br><span class="line">            ReactDOMSelectPostMountWrapper(domElement, rawProps);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> props.onClick === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> This cast may not be sound for SVG, MathML or custom elements.</span></span><br><span class="line">                trapClickOnNonInteractiveElement(((domElement: any): HTMLElement));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/08/react/fiber/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2020/09/08/react/fiber/" class="post-title-link" itemprop="url">fiber</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-08 14:00:00" itemprop="dateCreated datePublished" datetime="2020-09-08T14:00:00+08:00">2020-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>从 <code>ReactSyncRoot</code>开始</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dom, 0, false</span></span><br><span class="line"><span class="keyword">const</span> root = createContainer(container, tag, hydrate); <span class="comment">// FiberRootNode</span></span><br><span class="line"><span class="built_in">this</span>._internalRoot = root;</span><br></pre></td></tr></table></figure>

<p><code>createContainer</code>在<code>react-reconciler/inline.dom</code>,引用的<code>./src/ReactFiberReconciler</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    containerInfo: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">    tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">    hydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">OpaqueRoot</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建fiberroot</span></span><br><span class="line">    <span class="keyword">return</span> createFiberRoot(containerInfo, tag, hydrate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params">containerInfo: any, tag: RootTag, hydrate: boolean</span>): <span class="title">FiberRoot</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建fiber对象</span></span><br><span class="line">    <span class="keyword">const</span> root: FiberRoot = (<span class="keyword">new</span> FiberRootNode(containerInfo, tag, hydrate): any);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cyclic construction. This cheats the type system right now because</span></span><br><span class="line">    <span class="comment">// stateNode is any.</span></span><br><span class="line">    <span class="keyword">const</span> uninitializedFiber = createHostRootFiber(tag);</span><br><span class="line">    root.current = uninitializedFiber;</span><br><span class="line">    uninitializedFiber.stateNode = root;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建<code>FiberRoot</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在其他文件定义的常量</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoWork = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> noTimeout = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面有注释</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberRootNode</span>(<span class="params">containerInfo, tag, hydrate</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.tag = tag;</span><br><span class="line">    <span class="built_in">this</span>.current = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.containerInfo = containerInfo;</span><br><span class="line">    <span class="built_in">this</span>.pendingChildren = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.pingCache = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.finishedExpirationTime = NoWork;</span><br><span class="line">    <span class="built_in">this</span>.finishedWork = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.timeoutHandle = noTimeout; <span class="comment">// -1</span></span><br><span class="line">    <span class="built_in">this</span>.context = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.pendingContext = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.hydrate = hydrate;</span><br><span class="line">    <span class="built_in">this</span>.firstBatch = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.callbackNode = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.callbackExpirationTime = NoWork;</span><br><span class="line">    <span class="built_in">this</span>.firstPendingTime = NoWork;</span><br><span class="line">    <span class="built_in">this</span>.lastPendingTime = NoWork;</span><br><span class="line">    <span class="built_in">this</span>.pingTime = NoWork;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// false 无视</span></span><br><span class="line">    <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">        <span class="built_in">this</span>.interactionThreadID = unstable_getThreadID();</span><br><span class="line">        <span class="built_in">this</span>.memoizedInteractions = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">        <span class="built_in">this</span>.pendingInteractionMap = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>BaseFiberRootProperties</code>中有相关注释</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">type BaseFiberRootProperties = &#123;|</span><br><span class="line">    <span class="comment">// The type of root (legacy, batched, concurrent, etc.)</span></span><br><span class="line">    <span class="comment">// 类型0或1或2</span></span><br><span class="line">    tag: RootTag,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Any additional information from the host associated with this root.</span></span><br><span class="line">    <span class="comment">// 根节点挂载元素</span></span><br><span class="line">    containerInfo: any,</span><br><span class="line">    <span class="comment">// Used only by persistent updates.</span></span><br><span class="line">    pendingChildren: any,</span><br><span class="line">    <span class="comment">// The currently active root fiber. This is the mutable root of the tree.</span></span><br><span class="line">    current: Fiber,</span><br><span class="line"></span><br><span class="line">    pingCache: <span class="built_in">WeakMap</span>&lt;Thenable, <span class="built_in">Set</span>&lt;ExpirationTime&gt;&gt; | <span class="built_in">Map</span>&lt;Thenable, <span class="built_in">Set</span>&lt;ExpirationTime&gt;&gt; | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    finishedExpirationTime: ExpirationTime,</span><br><span class="line">    <span class="comment">// A finished work-in-progress HostRoot that&#x27;s ready to be committed.</span></span><br><span class="line">    finishedWork: Fiber | <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// Timeout handle returned by setTimeout. Used to cancel a pending timeout, if</span></span><br><span class="line">    <span class="comment">// it&#x27;s superseded by a new one.</span></span><br><span class="line">    timeoutHandle: TimeoutHandle | NoTimeout,</span><br><span class="line">    <span class="comment">// Top context object, used by renderSubtreeIntoContainer</span></span><br><span class="line">    context: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">    pendingContext: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// Determines if we should attempt to hydrate on the initial mount</span></span><br><span class="line">    +hydrate: boolean,</span><br><span class="line">    <span class="comment">// List of top-level batches. This list indicates whether a commit should be</span></span><br><span class="line">    <span class="comment">// deferred. Also contains completion callbacks.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Lift this into the renderer</span></span><br><span class="line">    firstBatch: Batch | <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// Node returned by Scheduler.scheduleCallback</span></span><br><span class="line">    callbackNode: *,</span><br><span class="line">    <span class="comment">// Expiration of the callback associated with this root</span></span><br><span class="line">    callbackExpirationTime: ExpirationTime,</span><br><span class="line">    <span class="comment">// The earliest pending expiration time that exists in the tree</span></span><br><span class="line">    firstPendingTime: ExpirationTime,</span><br><span class="line">    <span class="comment">// The latest pending expiration time that exists in the tree</span></span><br><span class="line">    lastPendingTime: ExpirationTime,</span><br><span class="line">    <span class="comment">// The time at which a suspended component pinged the root to render again</span></span><br><span class="line">    pingTime: ExpirationTime,</span><br><span class="line">|&#125;;</span><br></pre></td></tr></table></figure>

<p>创建<code>RootFiber</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createHostRootFiber</span>(<span class="params">tag: RootTag</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> mode;</span><br><span class="line">    <span class="keyword">if</span> (tag === ConcurrentRoot) &#123;</span><br><span class="line">        mode = ConcurrentMode | BatchedMode | StrictMode; <span class="comment">// 利用二进制特性,一个参数就能同时表示多种状态</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === BatchedRoot) &#123;</span><br><span class="line">        mode = BatchedMode | StrictMode;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mode = NoMode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3, null, null, 0</span></span><br><span class="line">    <span class="keyword">return</span> createFiber(HostRoot, <span class="literal">null</span>, <span class="literal">null</span>, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberNode</span>(<span class="params">tag: WorkTag, pendingProps: mixed, key: null | string, mode: TypeOfMode</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Instance</span></span><br><span class="line">    <span class="built_in">this</span>.tag = tag; <span class="comment">// 标记不同的组件类型 3</span></span><br><span class="line">    <span class="built_in">this</span>.key = key; <span class="comment">// ReactElement里面的key null</span></span><br><span class="line">    <span class="built_in">this</span>.elementType = <span class="literal">null</span>; <span class="comment">// ReactElement.type，也就是我们调用`createElement`的第一个参数</span></span><br><span class="line">    <span class="built_in">this</span>.type = <span class="literal">null</span>; <span class="comment">// 异步组件resolved之后返回的内容，一般是`function`或者`class`</span></span><br><span class="line">    <span class="built_in">this</span>.stateNode = <span class="literal">null</span>; <span class="comment">// 跟当前Fiber相关本地状态（比如浏览器环境就是DOM节点）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fiber</span></span><br><span class="line">    <span class="built_in">this</span>.return = <span class="literal">null</span>; <span class="comment">// 指向他在Fiber节点树中的`parent`，用来在处理完这个节点之后向上返回</span></span><br><span class="line">    <span class="built_in">this</span>.child = <span class="literal">null</span>; <span class="comment">// 单链表树结构 指向自己的第一个子节点</span></span><br><span class="line">    <span class="built_in">this</span>.sibling = <span class="literal">null</span>; <span class="comment">// 指向自己的兄弟结构 兄弟节点的return指向同一个父节点</span></span><br><span class="line">    <span class="built_in">this</span>.index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.ref = <span class="literal">null</span>; <span class="comment">// ref属性</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.pendingProps = pendingProps; <span class="comment">// 新的变动带来的新的props</span></span><br><span class="line">    <span class="built_in">this</span>.memoizedProps = <span class="literal">null</span>; <span class="comment">// 上一次渲染完成之后的props</span></span><br><span class="line">    <span class="built_in">this</span>.updateQueue = <span class="literal">null</span>; <span class="comment">// 该Fiber对应的组件产生的Update会存放在这个队列里面</span></span><br><span class="line">    <span class="built_in">this</span>.memoizedState = <span class="literal">null</span>; <span class="comment">// 上一次渲染的时候的state</span></span><br><span class="line">    <span class="built_in">this</span>.contextDependencies = <span class="literal">null</span>; <span class="comment">// 一个列表，存放这个Fiber依赖的context</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用来描述当前Fiber和他子树的`Bitfield`</span></span><br><span class="line">    <span class="comment">// 共存的模式表示这个子树是否默认是异步渲染的</span></span><br><span class="line">    <span class="comment">// Fiber被创建的时候他会继承父Fiber</span></span><br><span class="line">    <span class="comment">// 其他的标识也可以在创建的时候被设置</span></span><br><span class="line">    <span class="comment">// 但是在创建之后不应该再被修改，特别是他的子Fiber创建之前</span></span><br><span class="line">    <span class="built_in">this</span>.mode = mode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Effects</span></span><br><span class="line">    <span class="built_in">this</span>.effectTag = NoEffect; <span class="comment">// 用来记录Side Effect</span></span><br><span class="line">    <span class="built_in">this</span>.nextEffect = <span class="literal">null</span>; <span class="comment">// 单链表用来快速查找下一个side effect</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.firstEffect = <span class="literal">null</span>; <span class="comment">// 子树中第一个side effect</span></span><br><span class="line">    <span class="built_in">this</span>.lastEffect = <span class="literal">null</span>; <span class="comment">// 子树中最后一个side effect</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.expirationTime = NoWork; <span class="comment">// 代表任务在未来的哪个时间点应该被完成 不包括他的子树产生的任务</span></span><br><span class="line">    <span class="built_in">this</span>.childExpirationTime = NoWork; <span class="comment">// 快速确定子树中是否有不在等待的变化</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在Fiber树更新的过程中，每个Fiber都会有一个跟其对应的Fiber</span></span><br><span class="line">    <span class="comment">// 我们称他为`current &lt;==&gt; workInProgress`</span></span><br><span class="line">    <span class="comment">// 在渲染完成之后他们会交换位置</span></span><br><span class="line">    <span class="built_in">this</span>.alternate = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is a constructor function, rather than a POJO constructor, still</span></span><br><span class="line"><span class="comment">// please ensure we do the following:</span></span><br><span class="line"><span class="comment">// 1) Nobody should add any instance methods on this. Instance methods can be</span></span><br><span class="line"><span class="comment">//    more difficult to predict when they get optimized and they are almost</span></span><br><span class="line"><span class="comment">//    never inlined properly in static compilers.</span></span><br><span class="line"><span class="comment">// 2) Nobody should rely on `instanceof Fiber` for type testing. We should</span></span><br><span class="line"><span class="comment">//    always know when it is a fiber.</span></span><br><span class="line"><span class="comment">// 3) We might want to experiment with using numeric keys since they are easier</span></span><br><span class="line"><span class="comment">//    to optimize in a non-JIT environment.</span></span><br><span class="line"><span class="comment">// 4) We can easily go from a constructor to a createFiber object literal if that</span></span><br><span class="line"><span class="comment">//    is faster.</span></span><br><span class="line"><span class="comment">// 5) It should be easy to port this to a C struct and keep a C implementation</span></span><br><span class="line"><span class="comment">//    compatible.</span></span><br><span class="line"><span class="keyword">const</span> createFiber = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    tag: WorkTag,</span></span></span><br><span class="line"><span class="function"><span class="params">    pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">    key: null | string,</span></span></span><br><span class="line"><span class="function"><span class="params">    mode: TypeOfMode,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="comment">// $FlowFixMe: the shapes are exact here but Flow doesn&#x27;t like constructors</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FiberNode(tag, pendingProps, key, mode);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>之后是两个对象的互相引用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root.current = uninitializedFiber; <span class="comment">// root即FiberRoot</span></span><br><span class="line">uninitializedFiber.stateNode = root; <span class="comment">// uninitializedFiber即RootFiber</span></span><br></pre></td></tr></table></figure>

<p><code>FiberRoot</code>更多的是和 dom 相关的作用<br><code>RootFiber</code>更多的是一个虚拟 dom，他也有类似 dom 的树结构，每次 react 跟新，都先处理<code>RootFiber</code>，然后在作用于<code>FiberRoot</code>,最后更新 dom</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/08/react/renderRoot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2020/09/08/react/renderRoot/" class="post-title-link" itemprop="url">renderRoot</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-08 14:00:00" itemprop="dateCreated datePublished" datetime="2020-09-08T14:00:00+08:00">2020-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>构建 fiber 树和 dom 树，互相对应为参数，能互相找到，并执行了渲染前的生命周期</p>
<h3 id="然后是renderRoot"><a href="#然后是renderRoot" class="headerlink" title="然后是renderRoot"></a>然后是<code>renderRoot</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">    isSync: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">SchedulerCallback</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root.firstPendingTime &lt; expirationTime) &#123;</span><br><span class="line">        <span class="comment">// If there&#x27;s no work left at this expiration time, exit immediately. This</span></span><br><span class="line">        <span class="comment">// happens when multiple callbacks are scheduled for a single root, but an</span></span><br><span class="line">        <span class="comment">// earlier callback flushes the work of a later one.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在同步情况下，如果还存在待提交的处理，就先执行他</span></span><br><span class="line">    <span class="keyword">if</span> (isSync &amp;&amp; root.finishedExpirationTime === expirationTime) &#123;</span><br><span class="line">        <span class="comment">// false</span></span><br><span class="line">        <span class="comment">// There&#x27;s already a pending commit at this expiration time.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This is poorly factored. This case only exists for the</span></span><br><span class="line">        <span class="comment">// batch.commit() API.</span></span><br><span class="line">        <span class="keyword">return</span> commitRoot.bind(<span class="literal">null</span>, root);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// debugger</span></span><br><span class="line">    flushPassiveEffects(); <span class="comment">// 第一次return false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the root or expiration time have changed, throw out the existing stack</span></span><br><span class="line">    <span class="comment">// and prepare a fresh one. Otherwise we&#x27;ll continue where we left off.</span></span><br><span class="line">    <span class="keyword">if</span> (root !== workInProgressRoot || expirationTime !== renderExpirationTime) &#123;</span><br><span class="line">        <span class="comment">// 创建备份为当前执行工作（workInProgress）</span></span><br><span class="line">        <span class="comment">// 给root.current创建alternate,alternate和root.current拥有相同参数，并互相为对方的alternate</span></span><br><span class="line">        prepareFreshStack(root, expirationTime);</span><br><span class="line">        <span class="comment">// 执行后workInProgressRoot就等于root.current.alternate</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we have a work-in-progress fiber, it means there&#x27;s still work to do</span></span><br><span class="line">    <span class="comment">// in this root.</span></span><br><span class="line">    <span class="keyword">if</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> prevExecutionContext = executionContext; <span class="comment">// 8 记录状态</span></span><br><span class="line">        executionContext |= RenderContext; <span class="comment">// 添加RenderContext状态</span></span><br><span class="line">        <span class="keyword">let</span> prevDispatcher = ReactCurrentDispatcher.current;</span><br><span class="line">        <span class="keyword">if</span> (prevDispatcher === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// The React isomorphic package does not include a default dispatcher.</span></span><br><span class="line">            <span class="comment">// Instead the first renderer will lazily attach one, in order to give</span></span><br><span class="line">            <span class="comment">// nicer error messages.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ContextOnlyDispatcher错误提示对象函数</span></span><br><span class="line">            <span class="comment">// hooks报错函数对象</span></span><br><span class="line">            prevDispatcher = ContextOnlyDispatcher;</span><br><span class="line">        &#125;</span><br><span class="line">        ReactCurrentDispatcher.current = ContextOnlyDispatcher;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isSync) &#123;</span><br><span class="line">                    <span class="comment">// 进这</span></span><br><span class="line">                    workLoopSync();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    workLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        executionContext = prevExecutionContext;</span><br><span class="line">        resetContextDependencies(); <span class="comment">// 重置context相关</span></span><br><span class="line">        ReactCurrentDispatcher.current = prevDispatcher;</span><br><span class="line">        <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">            __interactionsRef.current = ((prevInteractions: any): <span class="built_in">Set</span>&lt;Interaction&gt;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// There&#x27;s still work left over. Return a continuation.</span></span><br><span class="line">            stopInterruptedWorkLoopTimer();</span><br><span class="line">            <span class="keyword">if</span> (expirationTime !== Sync) &#123;</span><br><span class="line">                startRequestCallbackTimer();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, expirationTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// debugger;</span></span><br><span class="line">    <span class="comment">// We now have a consistent tree. The next step is either to commit it, or, if</span></span><br><span class="line">    <span class="comment">// something suspended, wait to commit it after a timeout.</span></span><br><span class="line">    stopFinishedWorkLoopTimer(); <span class="comment">// __DEV__ ?</span></span><br><span class="line"></span><br><span class="line">    root.finishedWork = root.current.alternate;</span><br><span class="line">    root.finishedExpirationTime = expirationTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> isLocked = resolveLocksOnRoot(root, expirationTime);</span><br><span class="line">    <span class="keyword">if</span> (isLocked) &#123;</span><br><span class="line">        <span class="comment">// This root has a lock that prevents it from committing. Exit. If we begin</span></span><br><span class="line">        <span class="comment">// work on the root again, without any intervening updates, it will finish</span></span><br><span class="line">        <span class="comment">// without doing additional work.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set this to null to indicate there&#x27;s no in-progress render.</span></span><br><span class="line">    workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (workInProgressRootExitStatus) &#123;</span><br><span class="line">        <span class="keyword">case</span> RootIncomplete: &#123;</span><br><span class="line">            invariant(<span class="literal">false</span>, <span class="string">&#x27;Should have a work-in-progress.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Flow knows about invariant, so it compains if I add a break statement,</span></span><br><span class="line">        <span class="comment">// but eslint doesn&#x27;t know about invariant, so it complains if I do.</span></span><br><span class="line">        <span class="comment">// eslint-disable-next-line no-fallthrough</span></span><br><span class="line">        <span class="keyword">case</span> RootErrored: &#123;</span><br><span class="line">            <span class="comment">// An error was thrown. First check if there is lower priority work</span></span><br><span class="line">            <span class="comment">// scheduled on this root.</span></span><br><span class="line">            <span class="keyword">const</span> lastPendingTime = root.lastPendingTime;</span><br><span class="line">            <span class="keyword">if</span> (lastPendingTime &lt; expirationTime) &#123;</span><br><span class="line">                <span class="comment">// There&#x27;s lower priority work. Before raising the error, try rendering</span></span><br><span class="line">                <span class="comment">// at the lower priority to see if it fixes it. Use a continuation to</span></span><br><span class="line">                <span class="comment">// maintain the existing priority and position in the queue.</span></span><br><span class="line">                <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, lastPendingTime);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!isSync) &#123;</span><br><span class="line">                <span class="comment">// If we&#x27;re rendering asynchronously, it&#x27;s possible the error was</span></span><br><span class="line">                <span class="comment">// caused by tearing due to a mutation during an event. Try rendering</span></span><br><span class="line">                <span class="comment">// one more time without yiedling to events.</span></span><br><span class="line">                prepareFreshStack(root, expirationTime);</span><br><span class="line">                scheduleSyncCallback(renderRoot.bind(<span class="literal">null</span>, root, expirationTime));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If we&#x27;re already rendering synchronously, commit the root in its</span></span><br><span class="line">            <span class="comment">// errored state.</span></span><br><span class="line">            <span class="keyword">return</span> commitRoot.bind(<span class="literal">null</span>, root);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> RootSuspended: &#123;</span><br><span class="line">            <span class="comment">// We have an acceptable loading state. We need to figure out if we should</span></span><br><span class="line">            <span class="comment">// immediately commit it or wait a bit.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we have processed new updates during this render, we may now have a</span></span><br><span class="line">            <span class="comment">// new loading state ready. We want to ensure that we commit that as soon as</span></span><br><span class="line">            <span class="comment">// possible.</span></span><br><span class="line">            <span class="keyword">const</span> hasNotProcessedNewUpdates =</span><br><span class="line">                workInProgressRootLatestProcessedExpirationTime === Sync;</span><br><span class="line">            <span class="keyword">if</span> (hasNotProcessedNewUpdates &amp;&amp; !isSync) &#123;</span><br><span class="line">                <span class="comment">// If we have not processed any new updates during this pass, then this is</span></span><br><span class="line">                <span class="comment">// either a retry of an existing fallback state or a hidden tree.</span></span><br><span class="line">                <span class="comment">// Hidden trees shouldn&#x27;t be batched with other work and after that&#x27;s</span></span><br><span class="line">                <span class="comment">// fixed it can only be a retry.</span></span><br><span class="line">                <span class="comment">// We&#x27;re going to throttle committing retries so that we don&#x27;t show too</span></span><br><span class="line">                <span class="comment">// many loading states too quickly.</span></span><br><span class="line">                <span class="keyword">let</span> msUntilTimeout = globalMostRecentFallbackTime + FALLBACK_THROTTLE_MS - now();</span><br><span class="line">                <span class="comment">// Don&#x27;t bother with a very short suspense time.</span></span><br><span class="line">                <span class="keyword">if</span> (msUntilTimeout &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (workInProgressRootHasPendingPing) &#123;</span><br><span class="line">                        <span class="comment">// This render was pinged but we didn&#x27;t get to restart earlier so try</span></span><br><span class="line">                        <span class="comment">// restarting now instead.</span></span><br><span class="line">                        prepareFreshStack(root, expirationTime);</span><br><span class="line">                        <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, expirationTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">const</span> lastPendingTime = root.lastPendingTime;</span><br><span class="line">                    <span class="keyword">if</span> (lastPendingTime &lt; expirationTime) &#123;</span><br><span class="line">                        <span class="comment">// There&#x27;s lower priority work. It might be unsuspended. Try rendering</span></span><br><span class="line">                        <span class="comment">// at that level.</span></span><br><span class="line">                        <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, lastPendingTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// The render is suspended, it hasn&#x27;t timed out, and there&#x27;s no lower</span></span><br><span class="line">                    <span class="comment">// priority work to do. Instead of committing the fallback</span></span><br><span class="line">                    <span class="comment">// immediately, wait for more data to arrive.</span></span><br><span class="line">                    root.timeoutHandle = scheduleTimeout(</span><br><span class="line">                        commitRoot.bind(<span class="literal">null</span>, root),</span><br><span class="line">                        msUntilTimeout,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// The work expired. Commit immediately.</span></span><br><span class="line">            <span class="keyword">return</span> commitRoot.bind(<span class="literal">null</span>, root);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> RootSuspendedWithDelay: &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isSync) &#123;</span><br><span class="line">                <span class="comment">// We&#x27;re suspended in a state that should be avoided. We&#x27;ll try to avoid committing</span></span><br><span class="line">                <span class="comment">// it for as long as the timeouts let us.</span></span><br><span class="line">                <span class="keyword">if</span> (workInProgressRootHasPendingPing) &#123;</span><br><span class="line">                    <span class="comment">// This render was pinged but we didn&#x27;t get to restart earlier so try</span></span><br><span class="line">                    <span class="comment">// restarting now instead.</span></span><br><span class="line">                    prepareFreshStack(root, expirationTime);</span><br><span class="line">                    <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, expirationTime);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">const</span> lastPendingTime = root.lastPendingTime;</span><br><span class="line">                <span class="keyword">if</span> (lastPendingTime &lt; expirationTime) &#123;</span><br><span class="line">                    <span class="comment">// There&#x27;s lower priority work. It might be unsuspended. Try rendering</span></span><br><span class="line">                    <span class="comment">// at that level immediately.</span></span><br><span class="line">                    <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, lastPendingTime);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> msUntilTimeout;</span><br><span class="line">                <span class="keyword">if</span> (workInProgressRootLatestSuspenseTimeout !== Sync) &#123;</span><br><span class="line">                    <span class="comment">// We have processed a suspense config whose expiration time we can use as</span></span><br><span class="line">                    <span class="comment">// the timeout.</span></span><br><span class="line">                    msUntilTimeout =</span><br><span class="line">                        expirationTimeToMs(workInProgressRootLatestSuspenseTimeout) - now();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workInProgressRootLatestProcessedExpirationTime === Sync) &#123;</span><br><span class="line">                    <span class="comment">// This should never normally happen because only new updates cause</span></span><br><span class="line">                    <span class="comment">// delayed states, so we should have processed something. However,</span></span><br><span class="line">                    <span class="comment">// this could also happen in an offscreen tree.</span></span><br><span class="line">                    msUntilTimeout = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// If we don&#x27;t have a suspense config, we&#x27;re going to use a heuristic to</span></span><br><span class="line">                    <span class="comment">// determine how long we can suspend.</span></span><br><span class="line">                    <span class="keyword">const</span> eventTimeMs: number = inferTimeFromExpirationTime(</span><br><span class="line">                        workInProgressRootLatestProcessedExpirationTime,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">const</span> currentTimeMs = now();</span><br><span class="line">                    <span class="keyword">const</span> timeUntilExpirationMs =</span><br><span class="line">                        expirationTimeToMs(expirationTime) - currentTimeMs;</span><br><span class="line">                    <span class="keyword">let</span> timeElapsed = currentTimeMs - eventTimeMs;</span><br><span class="line">                    <span class="keyword">if</span> (timeElapsed &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// We get this wrong some time since we estimate the time.</span></span><br><span class="line">                        timeElapsed = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    msUntilTimeout = jnd(timeElapsed) - timeElapsed;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Clamp the timeout to the expiration time.</span></span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Once the event time is exact instead of inferred from expiration time</span></span><br><span class="line">                    <span class="comment">// we don&#x27;t need this.</span></span><br><span class="line">                    <span class="keyword">if</span> (timeUntilExpirationMs &lt; msUntilTimeout) &#123;</span><br><span class="line">                        msUntilTimeout = timeUntilExpirationMs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Don&#x27;t bother with a very short suspense time.</span></span><br><span class="line">                <span class="keyword">if</span> (msUntilTimeout &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                    <span class="comment">// The render is suspended, it hasn&#x27;t timed out, and there&#x27;s no lower</span></span><br><span class="line">                    <span class="comment">// priority work to do. Instead of committing the fallback</span></span><br><span class="line">                    <span class="comment">// immediately, wait for more data to arrive.</span></span><br><span class="line">                    root.timeoutHandle = scheduleTimeout(</span><br><span class="line">                        commitRoot.bind(<span class="literal">null</span>, root),</span><br><span class="line">                        msUntilTimeout,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// The work expired. Commit immediately.</span></span><br><span class="line">            <span class="keyword">return</span> commitRoot.bind(<span class="literal">null</span>, root);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> RootCompleted: &#123;</span><br><span class="line">            <span class="comment">// The work completed. Ready to commit.</span></span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                !isSync &amp;&amp;</span><br><span class="line">                workInProgressRootLatestProcessedExpirationTime !== Sync &amp;&amp;</span><br><span class="line">                workInProgressRootCanSuspendUsingConfig !== <span class="literal">null</span></span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// If we have exceeded the minimum loading delay, which probably</span></span><br><span class="line">                <span class="comment">// means we have shown a spinner already, we might have to suspend</span></span><br><span class="line">                <span class="comment">// a bit longer to ensure that the spinner is shown for enough time.</span></span><br><span class="line">                <span class="keyword">const</span> msUntilTimeout = computeMsUntilSuspenseLoadingDelay(</span><br><span class="line">                    workInProgressRootLatestProcessedExpirationTime,</span><br><span class="line">                    expirationTime,</span><br><span class="line">                    workInProgressRootCanSuspendUsingConfig,</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">if</span> (msUntilTimeout &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                    root.timeoutHandle = scheduleTimeout(</span><br><span class="line">                        commitRoot.bind(<span class="literal">null</span>, root),</span><br><span class="line">                        msUntilTimeout,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> commitRoot.bind(<span class="literal">null</span>, root);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            invariant(<span class="literal">false</span>, <span class="string">&#x27;Unknown root exit status.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="先进入workLoopSync"><a href="#先进入workLoopSync" class="headerlink" title="先进入workLoopSync"></a>先进入<code>workLoopSync</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoopSync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// debugger;</span></span><br><span class="line">    <span class="comment">// 遍历</span></span><br><span class="line">    <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">    <span class="comment">// 构建fiber树</span></span><br><span class="line">    <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 每次都返回他的子节点生层的fiber, 给workInProgress添加child的fiber</span></span><br><span class="line">        <span class="comment">// debugger</span></span><br><span class="line">        workInProgress = performUnitOfWork(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// debugger;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>workInProgress</code>是 current.alternate</p>
<h3 id="performUnitOfWork"><a href="#performUnitOfWork" class="headerlink" title="performUnitOfWork"></a>performUnitOfWork</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The current, flushed, state of this fiber is the alternate. Ideally</span></span><br><span class="line">    <span class="comment">// nothing should rely on this, but relying on it here means that we don&#x27;t</span></span><br><span class="line">    <span class="comment">// need an additional field on the work in progress.</span></span><br><span class="line">    <span class="keyword">const</span> current = unitOfWork.alternate; <span class="comment">// unitOfWork是备份，current是本体</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> next;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        next = beginWork(current, unitOfWork, renderExpirationTime); <span class="comment">// 返回了当前子节点的fiber</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    unitOfWork.memoizedProps = unitOfWork.pendingProps; <span class="comment">// 记住props</span></span><br><span class="line">    <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 没有子节点了,就找兄弟节点，都没有，返回父节点的兄弟节点</span></span><br><span class="line">        <span class="comment">// If this doesn&#x27;t spawn new work, complete the current work.</span></span><br><span class="line">        next = completeUnitOfWork(unitOfWork);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ReactCurrentOwner.current = <span class="literal">null</span>; <span class="comment">// 重置</span></span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a>beginWork</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null, <span class="regexp">//</span> 本体 （old）</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber, <span class="regexp">//</span> 备份 （new）</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> updateExpirationTime = workInProgress.expirationTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before entering the begin phase, clear the expiration time.</span></span><br><span class="line">    <span class="comment">// 清除到期时间</span></span><br><span class="line">    workInProgress.expirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 按照tag的执行不同的方法</span></span><br><span class="line">    <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> IndeterminateComponent: &#123;</span><br><span class="line">            <span class="comment">// 2 function类型组件是这个tag</span></span><br><span class="line">            <span class="keyword">return</span> mountIndeterminateComponent(</span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                workInProgress.type,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">            <span class="comment">// 从这里开始和上一步不一样了</span></span><br><span class="line">            <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">            <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">            <span class="comment">// 是否一样，不一样则合并defaultProps属性并返回结果</span></span><br><span class="line">            <span class="keyword">const</span> resolvedProps =</span><br><span class="line">                workInProgress.elementType === Component</span><br><span class="line">                    ? unresolvedProps</span><br><span class="line">                    : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">            <span class="keyword">return</span> updateClassComponent(</span><br><span class="line">                <span class="comment">// 返回child fiber</span></span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                Component,</span><br><span class="line">                resolvedProps,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 第一次执行的这个</span></span><br><span class="line">        <span class="keyword">case</span> HostRoot: <span class="comment">// 3 根节点</span></span><br><span class="line">            <span class="keyword">return</span> updateHostRoot(current, workInProgress, renderExpirationTime);</span><br><span class="line">        <span class="keyword">case</span> HostComponent: <span class="comment">// 5 子组件的根节点(最外层节点)</span></span><br><span class="line">            <span class="keyword">return</span> updateHostComponent(current, workInProgress, renderExpirationTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateHostRoot"><a href="#updateHostRoot" class="headerlink" title="updateHostRoot"></a>updateHostRoot</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHostRoot</span>(<span class="params">current, workInProgress, renderExpirationTime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 把一些变量入栈了，放在了文件全局变量中,意义不明</span></span><br><span class="line">    pushHostRootContext(workInProgress);</span><br><span class="line">    <span class="comment">// 跟新队列</span></span><br><span class="line">    <span class="keyword">const</span> updateQueue = workInProgress.updateQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从变量名得知意思</span></span><br><span class="line">    <span class="keyword">const</span> nextProps = workInProgress.pendingProps;</span><br><span class="line">    <span class="keyword">const</span> prevState = workInProgress.memoizedState;</span><br><span class="line">    <span class="keyword">const</span> prevChildren = prevState !== <span class="literal">null</span> ? prevState.element : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以理解为初始化赋值一些数据，如workInProgress.memoizedState等</span></span><br><span class="line">    processUpdateQueue(workInProgress, updateQueue, nextProps, <span class="literal">null</span>, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> nextState = workInProgress.memoizedState; <span class="comment">// 是一个ReactNode</span></span><br><span class="line">    <span class="comment">// Caution: React DevTools currently depends on this property</span></span><br><span class="line">    <span class="comment">// being called &quot;element&quot;.</span></span><br><span class="line">    <span class="keyword">const</span> nextChildren = nextState.element;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> root: FiberRoot = workInProgress.stateNode;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        (current === <span class="literal">null</span> || current.child === <span class="literal">null</span>) &amp;&amp;</span><br><span class="line">        root.hydrate &amp;&amp;</span><br><span class="line">        enterHydrationState(workInProgress)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Otherwise reset hydration state in case we aborted and resumed another</span></span><br><span class="line">        <span class="comment">// root.</span></span><br><span class="line">        <span class="comment">// 给workInProgress添加了child属性</span></span><br><span class="line">        reconcileChildren(current, workInProgress, nextChildren, renderExpirationTime);</span><br><span class="line">        resetHydrationState(); <span class="comment">// 重置了一些属性,目前意义未知</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 到这里就走完了一个循环，然后看child再来一个流程</span></span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="processUpdateQueue"><a href="#processUpdateQueue" class="headerlink" title="processUpdateQueue"></a>processUpdateQueue</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">processUpdateQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    queue: UpdateQueue&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    props: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    instance: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    hasForceUpdate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 克隆了queue(部分属性),执行后queue === workInProgress.updateQueue，好像并没有什么变化</span></span><br><span class="line">    queue = ensureWorkInProgressQueueIsAClone(workInProgress, queue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// These values may change as we process the queue.</span></span><br><span class="line">    <span class="keyword">let</span> newBaseState = queue.baseState;</span><br><span class="line">    <span class="keyword">let</span> newFirstUpdate = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> newExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Iterate through the list of updates to compute the result.</span></span><br><span class="line">    <span class="keyword">let</span> update = queue.firstUpdate;</span><br><span class="line">    <span class="keyword">let</span> resultState = newBaseState;</span><br><span class="line">    <span class="keyword">while</span> (update !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> updateExpirationTime = update.expirationTime;</span><br><span class="line">        <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This update does have sufficient priority.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Mark the event time of this update as relevant to this render pass.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> This should ideally use the true event time of this update rather than</span></span><br><span class="line">            <span class="comment">// its priority which is a derived and not reverseable value.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> We should skip this update if it was already committed but currently</span></span><br><span class="line">            <span class="comment">// we have no way of detecting the difference between a committed and suspended</span></span><br><span class="line">            <span class="comment">// update here.</span></span><br><span class="line">            <span class="comment">// 不知道做了什么，因为第一次初始化时大部分都是null，仅仅是一些变量的初始化处理，下面也都是这样</span></span><br><span class="line">            markRenderEventTimeAndConfig(updateExpirationTime, update.suspenseConfig);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process it and compute a new result.</span></span><br><span class="line">            <span class="comment">// 更新组件state</span></span><br><span class="line">            resultState = getStateFromUpdate(</span><br><span class="line">                workInProgress,</span><br><span class="line">                queue,</span><br><span class="line">                update,</span><br><span class="line">                resultState,</span><br><span class="line">                props,</span><br><span class="line">                instance,</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">const</span> callback = update.callback;</span><br><span class="line">            <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">                workInProgress.effectTag |= Callback;</span><br><span class="line">                <span class="comment">// Set this to null, in case it was mutated during an aborted render.</span></span><br><span class="line">                update.nextEffect = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (queue.lastEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">                    queue.firstEffect = queue.lastEffect = update;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    queue.lastEffect.nextEffect = update;</span><br><span class="line">                    queue.lastEffect = update;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Continue to the next update.</span></span><br><span class="line">        update = update.next; <span class="comment">// 下一个更新</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newFirstUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">        queue.lastUpdate = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newFirstCapturedUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">        queue.lastCapturedUpdate = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        workInProgress.effectTag |= Callback;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newFirstUpdate === <span class="literal">null</span> &amp;&amp; newFirstCapturedUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We processed every update, without skipping. That means the new base</span></span><br><span class="line">        <span class="comment">// state is the same as the result state.</span></span><br><span class="line">        newBaseState = resultState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    queue.baseState = newBaseState;</span><br><span class="line">    queue.firstUpdate = newFirstUpdate;</span><br><span class="line">    queue.firstCapturedUpdate = newFirstCapturedUpdate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the remaining expiration time to be whatever is remaining in the queue.</span></span><br><span class="line">    <span class="comment">// This should be fine because the only two other things that contribute to</span></span><br><span class="line">    <span class="comment">// expiration time are props and context. We&#x27;re already in the middle of the</span></span><br><span class="line">    <span class="comment">// begin phase by the time we start processing the queue, so we&#x27;ve already</span></span><br><span class="line">    <span class="comment">// dealt with the props. Context in components that specify</span></span><br><span class="line">    <span class="comment">// shouldComponentUpdate is tricky; but we&#x27;ll have to account for</span></span><br><span class="line">    <span class="comment">// that regardless.</span></span><br><span class="line">    workInProgress.expirationTime = newExpirationTime; <span class="comment">// 剩余到期时间？</span></span><br><span class="line">    workInProgress.memoizedState = resultState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reconcileChildren-gt-reconcileChildFibers"><a href="#reconcileChildren-gt-reconcileChildFibers" class="headerlink" title="reconcileChildren -&gt; reconcileChildFibers"></a>reconcileChildren -&gt; reconcileChildFibers</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">workInProgress.child = reconcileChildFibers(</span><br><span class="line">    workInProgress,</span><br><span class="line">    current.child,</span><br><span class="line">    nextChildren,</span><br><span class="line">    renderExpirationTime,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> key = element.key;</span><br><span class="line">    <span class="keyword">let</span> child = currentFirstChild;</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (element.type === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// created是一个fiber</span></span><br><span class="line">        <span class="comment">// 更具element创建fiber</span></span><br><span class="line">        <span class="keyword">const</span> created = createFiberFromElement(element, returnFiber.mode, expirationTime);</span><br><span class="line">        created.ref = coerceRef(returnFiber, currentFirstChild, element); <span class="comment">// 处理ref,因为例子上没，先不看</span></span><br><span class="line">        created.return = returnFiber; <span class="comment">// 父节点</span></span><br><span class="line">        <span class="keyword">return</span> created;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">placeSingleChild</span>(<span class="params">newFiber: Fiber</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This is simpler for the single child case. We only need to do a</span></span><br><span class="line">    <span class="comment">// placement for inserting new children.</span></span><br><span class="line">    <span class="comment">// shouldTrackSideEffects是直接传参为true（运行时）</span></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects &amp;&amp; newFiber.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">        newFiber.effectTag = Placement; <span class="comment">// 0 -&gt; 2</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newFiber;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This API will tag the children with the side-effect of the reconciliation</span></span><br><span class="line"><span class="comment">// itself. They will be added to the side-effect list as we pass through the</span></span><br><span class="line"><span class="comment">// children and the parent.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function is not recursive.</span></span><br><span class="line">    <span class="comment">// If the top level item is an array, we treat it as a set of children,</span></span><br><span class="line">    <span class="comment">// not as a fragment. Nested arrays on the other hand will be treated as</span></span><br><span class="line">    <span class="comment">// fragment nodes. Recursion happens at the normal flow.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle top level unkeyed fragments as if they were arrays.</span></span><br><span class="line">    <span class="comment">// This leads to an ambiguity between &lt;&gt;&#123;[...]&#125;&lt;/&gt; and &lt;&gt;...&lt;/&gt;.</span></span><br><span class="line">    <span class="comment">// We treat the ambiguous cases above the same.</span></span><br><span class="line">    <span class="comment">// 是否fragment</span></span><br><span class="line">    <span class="keyword">const</span> isUnkeyedTopLevelFragment =</span><br><span class="line">        <span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">        newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">        newChild.key === <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">        newChild = newChild.props.children; <span class="comment">// 如果是fragment取他的子节点</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle object types</span></span><br><span class="line">    <span class="comment">// newChild可能是一个children</span></span><br><span class="line">    <span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (</span><br><span class="line">            newChild.$$typeof <span class="comment">// 子节点是单一的</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">                <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">                    reconcileSingleElement(</span><br><span class="line">                        returnFiber,</span><br><span class="line">                        currentFirstChild,</span><br><span class="line">                        newChild,</span><br><span class="line">                        expirationTime,</span><br><span class="line">                    ),</span><br><span class="line">                );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateClassComponent"><a href="#updateClassComponent" class="headerlink" title="updateClassComponent"></a>updateClassComponent</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    Component: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    nextProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Push context providers early to prevent context stack mismatches.</span></span><br><span class="line">    <span class="comment">// During mounting we don&#x27;t know the child context yet as the instance doesn&#x27;t exist.</span></span><br><span class="line">    <span class="comment">// We will invalidate the child context in finishClassComponent() right after rendering.</span></span><br><span class="line">    <span class="comment">// 是否有context</span></span><br><span class="line">    <span class="keyword">let</span> hasContext;</span><br><span class="line">    <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">        hasContext = <span class="literal">true</span>;</span><br><span class="line">        pushLegacyContextProvider(workInProgress);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        hasContext = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// context相关,先不管</span></span><br><span class="line">    prepareToReadContext(workInProgress, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.stateNode;</span><br><span class="line">    <span class="keyword">let</span> shouldUpdate;</span><br><span class="line">    <span class="keyword">if</span> (instance === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// An class component without an instance only mounts if it suspended</span></span><br><span class="line">            <span class="comment">// inside a non- concurrent tree, in an inconsistent state. We want to</span></span><br><span class="line">            <span class="comment">// tree it like a new mount, even though an empty version of it already</span></span><br><span class="line">            <span class="comment">// committed. Disconnect the alternate pointers.</span></span><br><span class="line">            current.alternate = <span class="literal">null</span>;</span><br><span class="line">            workInProgress.alternate = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">            workInProgress.effectTag |= Placement;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// In the initial pass we might need to construct the instance.</span></span><br><span class="line">        <span class="comment">// 构造实例</span></span><br><span class="line">        constructClassInstance(workInProgress, Component, nextProps, renderExpirationTime);</span><br><span class="line">        <span class="comment">// 执行渲染前的生命周期</span></span><br><span class="line">        mountClassInstance(workInProgress, Component, nextProps, renderExpirationTime);</span><br><span class="line">        shouldUpdate = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> nextUnitOfWork = finishClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        shouldUpdate,</span><br><span class="line">        hasContext,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nextUnitOfWork;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="constructClassInstance"><a href="#constructClassInstance" class="headerlink" title="constructClassInstance"></a>constructClassInstance</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">constructClassInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    ctor: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    props: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> isLegacyContextConsumer = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> unmaskedContext = emptyContextObject;</span><br><span class="line">    <span class="keyword">let</span> context = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> contextType = ctor.contextType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 到这 前景：从root -&gt; LocaleProvider,一层层下去</span></span><br><span class="line">    <span class="comment">// debugger</span></span><br><span class="line">    <span class="comment">// 获取context ? context相关，先不看</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">&#x27;object&#x27;</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">        context = readContext((contextType: any));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        unmaskedContext = getUnmaskedContext(workInProgress, ctor, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">const</span> contextTypes = ctor.contextTypes;</span><br><span class="line">        isLegacyContextConsumer = contextTypes !== <span class="literal">null</span> &amp;&amp; contextTypes !== <span class="literal">undefined</span>;</span><br><span class="line">        context = isLegacyContextConsumer</span><br><span class="line">            ? getMaskedContext(workInProgress, unmaskedContext)</span><br><span class="line">            : emptyContextObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new 当前组件（class）,获得实例</span></span><br><span class="line">    <span class="keyword">const</span> instance = <span class="keyword">new</span> ctor(props, context);</span><br><span class="line">    <span class="keyword">const</span> state = (workInProgress.memoizedState =</span><br><span class="line">        instance.state !== <span class="literal">null</span> &amp;&amp; instance.state !== <span class="literal">undefined</span> ? instance.state : <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// workInProgress和instance互相添加为属性，stateNode和_reactInternalFiber，能够让双方互相找到</span></span><br><span class="line">    <span class="comment">// 更新了instance的updater方法（直接被替换了一个新的）</span></span><br><span class="line">    adoptClassInstance(workInProgress, instance);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cache unmasked context so we can avoid recreating masked context unless necessary.</span></span><br><span class="line">    <span class="comment">// ReactFiberContext usually updates this cache but can&#x27;t for newly-created instances.</span></span><br><span class="line">    <span class="comment">// 在contextType有数据时是true</span></span><br><span class="line">    <span class="keyword">if</span> (isLegacyContextConsumer) &#123;</span><br><span class="line">        cacheContext(workInProgress, unmaskedContext, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mountClassInstance"><a href="#mountClassInstance" class="headerlink" title="mountClassInstance"></a>mountClassInstance</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Invokes the mount life-cycles on a previously never rendered instance.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountClassInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    ctor: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    newProps: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 更新state等数据</span></span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.stateNode;</span><br><span class="line">    instance.props = newProps;</span><br><span class="line">    instance.state = workInProgress.memoizedState;</span><br><span class="line">    instance.refs = emptyRefsObject;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> contextType = ctor.contextType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// context</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">&#x27;object&#x27;</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">        instance.context = readContext(contextType);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> unmaskedContext = getUnmaskedContext(workInProgress, ctor, <span class="literal">true</span>);</span><br><span class="line">        instance.context = getMaskedContext(workInProgress, unmaskedContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> updateQueue = workInProgress.updateQueue;</span><br><span class="line">    <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">        processUpdateQueue(workInProgress, updateQueue, newProps, instance, renderExpirationTime);</span><br><span class="line">        instance.state = workInProgress.memoizedState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理getDerivedStateFromProps，第一个看到的生命周期处理</span></span><br><span class="line">    <span class="comment">// getDerivedStateFromProps 有返回值，做Object.assign处理，否则返回原state</span></span><br><span class="line">    <span class="comment">// workInProgress.memoizedState被更新了</span></span><br><span class="line">    <span class="comment">// 现在还处于渲染前</span></span><br><span class="line">    <span class="keyword">const</span> getDerivedStateFromProps = ctor.getDerivedStateFromProps;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        applyDerivedStateFromProps(workInProgress, ctor, getDerivedStateFromProps, newProps);</span><br><span class="line">        instance.state = workInProgress.memoizedState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// In order to support react-lifecycles-compat polyfilled components,</span></span><br><span class="line">    <span class="comment">// Unsafe lifecycles should not be invoked for components using the new APIs.</span></span><br><span class="line">    <span class="comment">// 如果使用了新的生命周期函数，就不调用老的不安全的生命周期函数componentWillMount</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="keyword">typeof</span> ctor.getDerivedStateFromProps !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> instance.getSnapshotBeforeUpdate !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">        (<span class="keyword">typeof</span> instance.UNSAFE_componentWillMount === <span class="string">&#x27;function&#x27;</span> ||</span><br><span class="line">            <span class="keyword">typeof</span> instance.componentWillMount === <span class="string">&#x27;function&#x27;</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// 调用componentWillMount、UNSAFE_componentWillMount</span></span><br><span class="line">        callComponentWillMount(workInProgress, instance);</span><br><span class="line">        <span class="comment">// If we had additional state updates during this life-cycle, let&#x27;s</span></span><br><span class="line">        <span class="comment">// process them now.</span></span><br><span class="line">        updateQueue = workInProgress.updateQueue;</span><br><span class="line">        <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">            processUpdateQueue(</span><br><span class="line">                workInProgress,</span><br><span class="line">                updateQueue,</span><br><span class="line">                newProps,</span><br><span class="line">                instance,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">            );</span><br><span class="line">            instance.state = workInProgress.memoizedState;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.componentDidMount === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        workInProgress.effectTag |= Update; <span class="comment">// effectTag添加Update</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="finishClassComponent"><a href="#finishClassComponent" class="headerlink" title="finishClassComponent"></a>finishClassComponent</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finishClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    Component: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    shouldUpdate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">    hasContext: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Refs should update even if shouldComponentUpdate returns false</span></span><br><span class="line">    <span class="comment">// 标记ref,表示workInProgress上存在ref属性，通过effectTag</span></span><br><span class="line">    <span class="comment">// debugger</span></span><br><span class="line">    markRef(current, workInProgress);</span><br><span class="line">    <span class="comment">//  是否包含DidCapture标记</span></span><br><span class="line">    <span class="keyword">const</span> didCaptureError = (workInProgress.effectTag &amp; DidCapture) !== NoEffect;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!shouldUpdate &amp;&amp; !didCaptureError) &#123;</span><br><span class="line">        <span class="comment">// Context providers should defer to sCU for rendering</span></span><br><span class="line">        <span class="keyword">if</span> (hasContext) &#123;</span><br><span class="line">            invalidateContextProvider(workInProgress, Component, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(current, workInProgress, renderExpirationTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.stateNode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rerender</span></span><br><span class="line">    ReactCurrentOwner.current = workInProgress;</span><br><span class="line">    <span class="keyword">let</span> nextChildren;</span><br><span class="line">    <span class="comment">// 包含DidCapture标记 &amp;&amp; getDerivedStateFromError不是函数</span></span><br><span class="line">    <span class="keyword">if</span> (didCaptureError &amp;&amp; <span class="keyword">typeof</span> Component.getDerivedStateFromError !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// If we captured an error, but getDerivedStateFrom catch is not defined,</span></span><br><span class="line">        <span class="comment">// unmount all the children. componentDidCatch will schedule an update to</span></span><br><span class="line">        <span class="comment">// re-render a fallback. This is temporary until we migrate everyone to</span></span><br><span class="line">        <span class="comment">// the new API.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Warn in a future release.</span></span><br><span class="line">        nextChildren = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">            stopProfilerTimerIfRunning(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 正常渲染</span></span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// debugger</span></span><br><span class="line">            <span class="comment">// 执行render, 即React.createElement</span></span><br><span class="line">            <span class="comment">// 把es6模板转成React.createElement应该是loader完成的,具体怎么转的就先不管了</span></span><br><span class="line">            <span class="comment">// 见createElement.md</span></span><br><span class="line">            nextChildren = instance.render();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// React DevTools reads this flag.</span></span><br><span class="line">    <span class="comment">// React DevTools需要</span></span><br><span class="line">    workInProgress.effectTag |= PerformedWork;</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; didCaptureError) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 和reconcileChildFibers代码一样，唯一区别是调用时shouldTrackSideEffects为false</span></span><br><span class="line">        reconcileChildren(current, workInProgress, nextChildren, renderExpirationTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Memoize state using the values we just used to render.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Restructure so we never read values from the instance.</span></span><br><span class="line">    <span class="comment">// 记住state, 这个是preState?</span></span><br><span class="line">    workInProgress.memoizedState = instance.state;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The context might have changed so we need to recalculate it.</span></span><br><span class="line">    <span class="keyword">if</span> (hasContext) &#123;</span><br><span class="line">        invalidateContextProvider(workInProgress, Component, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reconcileChildFibers-和-mountChildFibers"><a href="#reconcileChildFibers-和-mountChildFibers" class="headerlink" title="reconcileChildFibers 和 mountChildFibers"></a>reconcileChildFibers 和 mountChildFibers</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reconcileChildFibers = ChildReconciler(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mountChildFibers = ChildReconciler(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    nextChildren: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If this is a fresh new component that hasn&#x27;t been rendered yet, we</span></span><br><span class="line">        <span class="comment">// won&#x27;t update its child set by applying minimal side-effects. Instead,</span></span><br><span class="line">        <span class="comment">// we will add them all to the child before it gets rendered. That means</span></span><br><span class="line">        <span class="comment">// we can optimize this reconciliation pass by not tracking side-effects.</span></span><br><span class="line">        workInProgress.child = mountChildFibers(</span><br><span class="line">            workInProgress,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            nextChildren,</span><br><span class="line">            renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If the current child is the same as the work in progress, it means that</span></span><br><span class="line">        <span class="comment">// we haven&#x27;t yet started any work on these children. Therefore, we use</span></span><br><span class="line">        <span class="comment">// the clone algorithm to create a copy of all the current children.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we had any progressed work already, that is invalid at this point so</span></span><br><span class="line">        <span class="comment">// let&#x27;s throw it out.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把子节点转换成一个fiber</span></span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        workInProgress.child = reconcileChildFibers(</span><br><span class="line">            workInProgress,</span><br><span class="line">            current.child,</span><br><span class="line">            nextChildren,</span><br><span class="line">            renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateHostComponent"><a href="#updateHostComponent" class="headerlink" title="updateHostComponent"></a>updateHostComponent</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHostComponent</span>(<span class="params">current, workInProgress, renderExpirationTime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// debugger</span></span><br><span class="line">    pushHostContext(workInProgress);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">        tryToClaimNextHydratableInstance(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">    <span class="keyword">const</span> nextProps = workInProgress.pendingProps;</span><br><span class="line">    <span class="keyword">const</span> prevProps = current !== <span class="literal">null</span> ? current.memoizedProps : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> nextChildren = nextProps.children;</span><br><span class="line">    <span class="keyword">const</span> isDirectTextChild = shouldSetTextContent(type, nextProps); <span class="comment">// 子节点是文本节点</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isDirectTextChild) &#123;</span><br><span class="line">        <span class="comment">// 如果是文本节点</span></span><br><span class="line">        <span class="comment">// We special case a direct text child of a host node. This is a common</span></span><br><span class="line">        <span class="comment">// case. We won&#x27;t handle it as a reified child. We will instead handle</span></span><br><span class="line">        <span class="comment">// this in the host environment that also have access to this prop. That</span></span><br><span class="line">        <span class="comment">// avoids allocating another HostText fiber and traversing it.</span></span><br><span class="line">        nextChildren = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevProps !== <span class="literal">null</span> &amp;&amp; shouldSetTextContent(type, prevProps)) &#123;</span><br><span class="line">        <span class="comment">// If we&#x27;re switching from a direct text child to a normal child, or to</span></span><br><span class="line">        <span class="comment">// empty, we need to schedule the text content to be reset.</span></span><br><span class="line">        workInProgress.effectTag |= ContentReset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    markRef(current, workInProgress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the host config to see if the children are offscreen/hidden.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        workInProgress.mode &amp; ConcurrentMode &amp;&amp;</span><br><span class="line">        renderExpirationTime !== Never &amp;&amp;</span><br><span class="line">        shouldDeprioritizeSubtree(type, nextProps)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reconcileChildren(current, workInProgress, nextChildren, renderExpirationTime);</span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reconcileChildFibers（详细）"><a href="#reconcileChildFibers（详细）" class="headerlink" title="reconcileChildFibers（详细）"></a>reconcileChildFibers（详细）</h3><p>见 reconcileChildFibers.md</p>
<h3 id="completeUnitOfWork"><a href="#completeUnitOfWork" class="headerlink" title="completeUnitOfWork"></a>completeUnitOfWork</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Attempt to complete the current unit of work, then move to the next</span></span><br><span class="line">    <span class="comment">// sibling. If there are no more siblings, return to the parent fiber.</span></span><br><span class="line">    <span class="comment">// 翻译：结束当前的工作单元，然后移动到下一个兄弟。如果没有，返回父fiber</span></span><br><span class="line">    workInProgress = unitOfWork;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// The current, flushed, state of this fiber is the alternate. Ideally</span></span><br><span class="line">        <span class="comment">// nothing should rely on this, but relying on it here means that we don&#x27;t</span></span><br><span class="line">        <span class="comment">// need an additional field on the work in progress.</span></span><br><span class="line">        <span class="keyword">const</span> current = workInProgress.alternate;</span><br><span class="line">        <span class="keyword">const</span> returnFiber = workInProgress.return;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if the work completed or if something threw.</span></span><br><span class="line">        <span class="keyword">if</span> ((workInProgress.effectTag &amp; Incomplete) === NoEffect) &#123;</span><br><span class="line">            <span class="keyword">let</span> next;</span><br><span class="line">            <span class="keyword">if</span> (!enableProfilerTimer || (workInProgress.mode &amp; ProfileMode) === NoMode) &#123;</span><br><span class="line">                next = completeWork(current, workInProgress, renderExpirationTime);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                startProfilerTimer(workInProgress);</span><br><span class="line">                next = completeWork(current, workInProgress, renderExpirationTime);</span><br><span class="line">                <span class="comment">// Update render duration assuming we didn&#x27;t error.</span></span><br><span class="line">                stopProfilerTimerIfRunningAndRecordDelta(workInProgress, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            resetChildExpirationTime(workInProgress); <span class="comment">// 重置时间</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Completing this fiber spawned new work. Work on that next.</span></span><br><span class="line">                <span class="keyword">return</span> next;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                returnFiber !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                <span class="comment">// Do not append effects to parents if a sibling failed to complete</span></span><br><span class="line">                (returnFiber.effectTag &amp; Incomplete) === NoEffect</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// Append all the effects of the subtree and this fiber onto the effect</span></span><br><span class="line">                <span class="comment">// list of the parent. The completion order of the children affects the</span></span><br><span class="line">                <span class="comment">// side-effect order.</span></span><br><span class="line">                <span class="keyword">if</span> (returnFiber.firstEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">                    returnFiber.firstEffect = workInProgress.firstEffect;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (workInProgress.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (returnFiber.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">                        returnFiber.lastEffect.nextEffect = workInProgress.firstEffect;</span><br><span class="line">                    &#125;</span><br><span class="line">                    returnFiber.lastEffect = workInProgress.lastEffect;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If this fiber had side-effects, we append it AFTER the children&#x27;s</span></span><br><span class="line">                <span class="comment">// side-effects. We can perform certain side-effects earlier if needed,</span></span><br><span class="line">                <span class="comment">// by doing multiple passes over the effect list. We don&#x27;t want to</span></span><br><span class="line">                <span class="comment">// schedule our own side-effect on our own list because if end up</span></span><br><span class="line">                <span class="comment">// reusing children we&#x27;ll schedule this effect onto itself since we&#x27;re</span></span><br><span class="line">                <span class="comment">// at the end.</span></span><br><span class="line">                <span class="keyword">const</span> effectTag = workInProgress.effectTag;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Skip both NoWork and PerformedWork tags when creating the effect</span></span><br><span class="line">                <span class="comment">// list. PerformedWork effect is read by React DevTools but shouldn&#x27;t be</span></span><br><span class="line">                <span class="comment">// committed.</span></span><br><span class="line">                <span class="comment">// debugger</span></span><br><span class="line">                <span class="comment">// effect添加，</span></span><br><span class="line">                <span class="keyword">if</span> (effectTag &gt; PerformedWork) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (returnFiber.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">                        returnFiber.lastEffect.nextEffect = workInProgress;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        returnFiber.firstEffect = workInProgress;</span><br><span class="line">                    &#125;</span><br><span class="line">                    returnFiber.lastEffect = workInProgress;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This fiber did not complete because something threw. Pop values off</span></span><br><span class="line">            <span class="comment">// the stack without entering the complete phase. If this is a boundary,</span></span><br><span class="line">            <span class="comment">// capture values if possible.</span></span><br><span class="line">            <span class="keyword">const</span> next = unwindWork(workInProgress, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Because this fiber did not complete, don&#x27;t reset its expiration time.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; (workInProgress.mode &amp; ProfileMode) !== NoMode) &#123;</span><br><span class="line">                <span class="comment">// Record the render duration for the fiber that errored.</span></span><br><span class="line">                stopProfilerTimerIfRunningAndRecordDelta(workInProgress, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Include the time spent working on failed children before continuing.</span></span><br><span class="line">                <span class="keyword">let</span> actualDuration = workInProgress.actualDuration;</span><br><span class="line">                <span class="keyword">let</span> child = workInProgress.child;</span><br><span class="line">                <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    actualDuration += child.actualDuration;</span><br><span class="line">                    child = child.sibling;</span><br><span class="line">                &#125;</span><br><span class="line">                workInProgress.actualDuration = actualDuration;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// If completing this work spawned new work, do that next. We&#x27;ll come</span></span><br><span class="line">                <span class="comment">// back here again.</span></span><br><span class="line">                <span class="comment">// Since we&#x27;re restarting, remove anything that is not a host effect</span></span><br><span class="line">                <span class="comment">// from the effect tag.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> The name stopFailedWorkTimer is misleading because Suspense</span></span><br><span class="line">                <span class="comment">// also captures and restarts.</span></span><br><span class="line">                stopFailedWorkTimer(workInProgress);</span><br><span class="line">                next.effectTag &amp;= HostEffectMask;</span><br><span class="line">                <span class="keyword">return</span> next;</span><br><span class="line">            &#125;</span><br><span class="line">            stopWorkTimer(workInProgress);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Mark the parent fiber as incomplete and clear its effect list.</span></span><br><span class="line">                returnFiber.firstEffect = returnFiber.lastEffect = <span class="literal">null</span>;</span><br><span class="line">                returnFiber.effectTag |= Incomplete;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> siblingFiber = workInProgress.sibling; <span class="comment">// 返回相邻节点</span></span><br><span class="line">        <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">            <span class="keyword">return</span> siblingFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Otherwise, return to the parent 没有就从父节点中找相邻节点</span></span><br><span class="line">        workInProgress = returnFiber;</span><br><span class="line">    &#125; <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We&#x27;ve reached the root.</span></span><br><span class="line">    <span class="keyword">if</span> (workInProgressRootExitStatus === RootIncomplete) &#123;</span><br><span class="line">        workInProgressRootExitStatus = RootCompleted;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/my-notes/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/my-notes/">1</a><span class="page-number current">2</span><a class="page-number" href="/my-notes/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/my-notes/page/7/">7</a><a class="extend next" rel="next" href="/my-notes/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">lokve</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/my-notes/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/my-notes/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lokve</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/my-notes/lib/anime.min.js"></script>
  <script src="/my-notes/lib/velocity/velocity.min.js"></script>
  <script src="/my-notes/lib/velocity/velocity.ui.min.js"></script>

<script src="/my-notes/js/utils.js"></script>

<script src="/my-notes/js/motion.js"></script>


<script src="/my-notes/js/schemes/pisces.js"></script>


<script src="/my-notes/js/next-boot.js"></script>




  




  
<script src="/my-notes/js/local-search.js"></script>













  

  

</body>
</html>
