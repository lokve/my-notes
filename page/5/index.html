<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/my-notes/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/my-notes/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/my-notes/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/my-notes/images/logo.svg" color="#222">

<link rel="stylesheet" href="/my-notes/css/main.css">


<link rel="stylesheet" href="/my-notes/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/my-notes/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="学习笔记">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="学习笔记">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="lokve">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>学习笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/my-notes/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">学习笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/my-notes/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/my-notes/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/my-notes/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/my-notes/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/06/14/js%E9%AB%98%E7%BA%A7/4.%E5%8F%98%E9%87%8F%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%86%85%E5%AD%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2019/06/14/js%E9%AB%98%E7%BA%A7/4.%E5%8F%98%E9%87%8F%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%86%85%E5%AD%98/" class="post-title-link" itemprop="url">变量作用域内存</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-14 00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-14T00:00:00+08:00">2019-06-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 14:10:42" itemprop="dateModified" datetime="2020-09-15T14:10:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/06/14/js%E9%AB%98%E7%BA%A7/5.%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2019/06/14/js%E9%AB%98%E7%BA%A7/5.%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">引用类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-14 00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-14T00:00:00+08:00">2019-06-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 14:11:03" itemprop="dateModified" datetime="2020-09-15T14:11:03+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="RegExp-实力属性"><a href="#RegExp-实力属性" class="headerlink" title="RegExp 实力属性"></a>RegExp 实力属性</h3><ul>
<li>global g 全局</li>
<li>ignoreCase i 不区分大小写</li>
<li>lastIndex 开始搜索下一个匹配项的字符位置，默认 0</li>
<li>multiline m 多行</li>
<li>source 正则的字符串表示</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/06/14/js%E9%AB%98%E7%BA%A7/6.%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2019/06/14/js%E9%AB%98%E7%BA%A7/6.%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="post-title-link" itemprop="url">面向对象</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-14 00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-14T00:00:00+08:00">2019-06-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 14:11:15" itemprop="dateModified" datetime="2020-09-15T14:11:15+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h2><h3 id="属性类型"><a href="#属性类型" class="headerlink" title="属性类型"></a>属性类型</h3><h4 id="数据属性"><a href="#数据属性" class="headerlink" title="数据属性"></a>数据属性</h4><ul>
<li><p>[[Configurable]] 能否通过 delete 删除属性, 通过 defineProperty 编辑数据属性 默认 true</p>
</li>
<li><p>[[Enumerable]] 能否用 for-in 循环属性 默认 true</p>
</li>
<li><p>[[Wtirable]] 能否修改属性的值 默认 true</p>
</li>
<li><p>[[Value]] 属性的数据值 默认 undefined</p>
</li>
<li><p>[[Get]] 在读取属性时调用的函数 默认 undefined 旧浏览器兼容可使用<strong>defineGetter</strong></p>
</li>
<li><p>[[Set]] 在写入属性时调用的函数 默认 undefined 旧浏览器兼容可使用<strong>defineSetter</strong></p>
</li>
</ul>
<h3 id="定义多个属性"><a href="#定义多个属性" class="headerlink" title="定义多个属性"></a>定义多个属性</h3><p>Object.defineProperties(obj, {xxx:{value:sss}})</p>
<h3 id="读取属性的特性"><a href="#读取属性的特性" class="headerlink" title="读取属性的特性"></a>读取属性的特性</h3><p>Object.getOwnPropertyDescriptor(obj, key) 读取 configurable 等属性</p>
<h2 id="创建对象"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象</h2><h3 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function createPerson(name, age, job)&#123;</span><br><span class="line">        var o &#x3D; new Object();</span><br><span class="line">        o.name &#x3D; name;</span><br><span class="line">        o.age &#x3D; age;</span><br><span class="line">        o.job &#x3D; job;</span><br><span class="line">        o.sayName &#x3D; function()&#123;</span><br><span class="line">            alert(this.name);</span><br><span class="line">        &#125;;</span><br><span class="line">    return o;</span><br><span class="line">&#125;</span><br><span class="line">var person1 &#x3D; createPerson(&quot;Nicholas&quot;, 29, &quot;Software Engineer&quot;);</span><br></pre></td></tr></table></figure>

<p>缺点：不能识别对象</p>
<h3 id="构造函数模式"><a href="#构造函数模式" class="headerlink" title="构造函数模式"></a>构造函数模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function Person(name, age, job)&#123;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">        this.age &#x3D; age;</span><br><span class="line">        this.job &#x3D; job;</span><br><span class="line">        this.sayName &#x3D; function()&#123;</span><br><span class="line">            alert(this.name);</span><br><span class="line">&#125;; &#125;</span><br><span class="line">    var person1 &#x3D; new Person(&quot;Nicholas&quot;, 29, &quot;Software Engineer&quot;);</span><br></pre></td></tr></table></figure>

<p>使用 new 会经历 4 个步骤</p>
<ol>
<li>创建一个新的对象</li>
<li>设置原型链</li>
<li>把 this 指向新对象并执行</li>
<li>判断返回值类型，如果是值类型(undexfined 等),返回上面对象;如果是引用类型(this 等),返回引用类型的对象</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function newFunc (name) &#123;</span><br><span class="line">    var o &#x3D; &#123;&#125;;</span><br><span class="line">    o.__proto__ &#x3D; Person.prototype;&#x2F;&#x2F;绑定Person的原型</span><br><span class="line">    Person.call(o, name);</span><br><span class="line">    return o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">作者：MeloGuo</span><br><span class="line">链接：https:&#x2F;&#x2F;www.zhihu.com&#x2F;question&#x2F;36440948&#x2F;answer&#x2F;213711157</span><br><span class="line">来源：知乎</span><br><span class="line">著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</span><br></pre></td></tr></table></figure>

<p>缺点：部分属性不共享，浪费内存</p>
<h3 id="原型模式"><a href="#原型模式" class="headerlink" title="原型模式"></a>原型模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function Person()&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    Person.prototype.name &#x3D; &quot;Nicholas&quot;;</span><br><span class="line">    Person.prototype.age &#x3D; 29;</span><br><span class="line">    Person.prototype.job &#x3D; &quot;Software Engineer&quot;;</span><br><span class="line">    Person.prototype.sayName &#x3D; function()&#123;</span><br><span class="line">        alert(this.name);</span><br><span class="line">    &#125;;</span><br><span class="line">    var person1 &#x3D; new Person();</span><br><span class="line">    person1.sayName();   &#x2F;&#x2F;&quot;Nicholas&quot;</span><br></pre></td></tr></table></figure>

<h4 id="理解原型对象"><a href="#理解原型对象" class="headerlink" title="理解原型对象"></a>理解原型对象</h4><p>只要创建一个新函数，就会为该函数创建一个 prototype 属性，这个属性指向函数的原型对象。默认情况下，所有的原型对象都会获得一个 constructor(构造函数)属性，指向原型对象所在函数本身。<br>Person.prototype.constructor === Person</p>
<h4 id="原型与-in"><a href="#原型与-in" class="headerlink" title="原型与 in"></a>原型与 in</h4><p>无论属性存在实例还是原型中，in 都能访问到<br>hasPrototypeProperty 只能访问到实例属性<br>下面方法能判断属性只存在于原型中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function hasPrototypeProperty(object, name)&#123;</span><br><span class="line">        return !object.hasOwnProperty(name) &amp;&amp; (name in object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>for-in 能访问到可枚举的,存在于原型或实例中的属性<br>Object.keys 能访问到可枚举的，只存在于实例中的属性<br>Object.getOwnPropertyNames 能访问到枚举或不可枚举的，只存在于实例中的属性</p>
<h4 id="同时设置多个-prototype"><a href="#同时设置多个-prototype" class="headerlink" title="同时设置多个 prototype"></a>同时设置多个 prototype</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function Person()&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    Person.prototype &#x3D; &#123;</span><br><span class="line">        name : &quot;Nicholas&quot;,</span><br><span class="line">        age : 29,</span><br><span class="line">        job : &quot;Software Engineer&quot;,</span><br><span class="line">        sayName : function () &#123;&#125;,</span><br><span class="line">     &#125;;</span><br><span class="line"></span><br><span class="line">     Object.defineProperty(Person.prototype, &quot;constructor&quot;, &#123;</span><br><span class="line">        enumerable: false,</span><br><span class="line">        value: Person</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>constructor 是不可枚举的，不能直接设置 Person.prototype.constructor = Person</p>
<p>缺点：所有值都是共享的，如果是数组等数据，会出现无法单独修改的情况</p>
<h3 id="组合使用原型模式和构造函数模式"><a href="#组合使用原型模式和构造函数模式" class="headerlink" title="组合使用原型模式和构造函数模式"></a>组合使用原型模式和构造函数模式</h3><p>构造函数用于定义实例属性，原型模式用于定义方法和共享属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function Person(name, age, job)&#123;</span><br><span class="line">    this.name &#x3D; name;</span><br><span class="line">    this.age &#x3D; age;</span><br><span class="line">    this.job &#x3D; job;</span><br><span class="line">    this.friends &#x3D; [&quot;Shelby&quot;, &quot;Court&quot;];</span><br><span class="line">  &#125;</span><br><span class="line">Person.prototype &#x3D; &#123;</span><br><span class="line">    constructor : Person,</span><br><span class="line">    sayName : function()&#123;</span><br><span class="line">        alert(this.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">var person1 &#x3D; new Person(&quot;Nicholas&quot;, 29, &quot;Software Engineer&quot;);</span><br><span class="line">var person2 &#x3D; new Person(&quot;Greg&quot;, 27, &quot;Doctor&quot;);</span><br><span class="line"></span><br><span class="line">person1.friends.push(&quot;Van&quot;);</span><br><span class="line">alert(person1.friends);    &#x2F;&#x2F;&quot;Shelby,Count,Van&quot;</span><br><span class="line">alert(person2.friends);    &#x2F;&#x2F;&quot;Shelby,Count&quot;</span><br><span class="line">alert(person1.friends &#x3D;&#x3D;&#x3D; person2.friends);</span><br><span class="line">alert(person1.sayName &#x3D;&#x3D;&#x3D; person2.sayName);</span><br><span class="line">&#x2F;&#x2F;false</span><br><span class="line">&#x2F;&#x2F;true</span><br></pre></td></tr></table></figure>

<h3 id="动态原型模式"><a href="#动态原型模式" class="headerlink" title="动态原型模式"></a>动态原型模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function Person() &#123;</span><br><span class="line">    if (typeof this.sayName !&#x3D; &quot;function&quot;)&#123;</span><br><span class="line">        Person.prototype.sayName &#x3D; function()&#123;</span><br><span class="line">                alert(this.name);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="寄生构造函数模式"><a href="#寄生构造函数模式" class="headerlink" title="寄生构造函数模式"></a>寄生构造函数模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function Person(name, age, job)&#123;</span><br><span class="line">        var o &#x3D; new Object();</span><br><span class="line">        o.name &#x3D; name;</span><br><span class="line">        o.age &#x3D; age;</span><br><span class="line">        o.job &#x3D; job;</span><br><span class="line">        o.sayName &#x3D; function()&#123;</span><br><span class="line">            alert(this.name);</span><br><span class="line">        &#125;;</span><br><span class="line">        return o;</span><br><span class="line">&#125;</span><br><span class="line">    var friend &#x3D; new Person(&quot;Nicholas&quot;, 29, &quot;Software Engineer&quot;);</span><br><span class="line">    friend.sayName();  &#x2F;&#x2F;&quot;Nicholas&quot;</span><br></pre></td></tr></table></figure>

<p>可以用这种方式扩展原生对象属性，但创建出来的对象和构造函数无关，也不能用 instanceof 确定类型，一般不使用</p>
<h3 id="稳妥构造函数模式"><a href="#稳妥构造函数模式" class="headerlink" title="稳妥构造函数模式"></a>稳妥构造函数模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">unction Person(name, age, job)&#123;</span><br><span class="line">        var o &#x3D; new Object();</span><br><span class="line">        var name &#x3D; name;</span><br><span class="line">        ...</span><br><span class="line">        o.sayName &#x3D; function()&#123;</span><br><span class="line">            alert(this.name);</span><br><span class="line">        &#125;;</span><br><span class="line">        return o;</span><br><span class="line">&#125;</span><br><span class="line">    var friend &#x3D; new Person(&quot;Nicholas&quot;, 29, &quot;Software Engineer&quot;);</span><br><span class="line">    friend.sayName();  &#x2F;&#x2F;&quot;Nicholas&quot;</span><br></pre></td></tr></table></figure>

<p>属性不会被外部修改，推荐用在安全环境</p>
<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><h3 id="原型链"><a href="#原型链" class="headerlink" title="原型链"></a>原型链</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function SuperType()&#123;</span><br><span class="line">        this.property &#x3D; true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SuperType.prototype.getSuperValue &#x3D; function()&#123;</span><br><span class="line">    return this.property;</span><br><span class="line">&#125;;</span><br><span class="line">function SubType()&#123;</span><br><span class="line">    this.subproperty &#x3D; false;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;􏸕􏴫􏽙 SuperType</span><br><span class="line">SubType.prototype &#x3D; new SuperType();</span><br><span class="line">SubType.prototype.getSubValue &#x3D; function ()&#123;</span><br><span class="line">    return this.subproperty;</span><br><span class="line">  &#125;;</span><br><span class="line">var instance &#x3D; new SubType();</span><br><span class="line">alert(instance.getSuperValue()); &#x2F;&#x2F; true</span><br></pre></td></tr></table></figure>

<p>缺点：引用类型属性共享，没有办法在不影响所有对象实例的情况下给超类型的构造函数传参（超类型的实例属性会被改变）</p>
<h3 id="借用构造函数"><a href="#借用构造函数" class="headerlink" title="借用构造函数"></a>借用构造函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function SuperType()&#123;</span><br><span class="line">    this.colors &#x3D; [&quot;red&quot;, &quot;blue&quot;, &quot;green&quot;];</span><br><span class="line">&#125;</span><br><span class="line"> function SubType()&#123;</span><br><span class="line">    SuperType.call(this);</span><br><span class="line">&#125;</span><br><span class="line">var instance1 &#x3D; new SubType();</span><br><span class="line">instance1.colors.push(&quot;black&quot;);</span><br><span class="line">alert(instance1.colors);    &#x2F;&#x2F;&quot;red,blue,green,black&quot;</span><br><span class="line">var instance2 &#x3D; new SubType();</span><br><span class="line">alert(instance2.colors);    &#x2F;&#x2F;&quot;red,blue,green&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function SuperType(name)&#123;</span><br><span class="line">    this.name &#x3D; name;</span><br><span class="line">&#125;</span><br><span class="line">function SubType()&#123;</span><br><span class="line">    SuperType.call(this, &quot;Nicholas&quot;);</span><br><span class="line">    this.age &#x3D; 29;</span><br><span class="line">&#125;</span><br><span class="line">var instance &#x3D; new SubType();</span><br><span class="line">alert(instance.name);    &#x2F;&#x2F;&quot;Nicholas&quot;;</span><br><span class="line">alert(instance.age);     &#x2F;&#x2F;29</span><br></pre></td></tr></table></figure>

<p>缺点：无法复用</p>
<h3 id="组合继承"><a href="#组合继承" class="headerlink" title="组合继承"></a>组合继承</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">function SuperType(name)&#123;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">        this.colors &#x3D; [&quot;red&quot;, &quot;blue&quot;, &quot;green&quot;];</span><br><span class="line">&#125;</span><br><span class="line">SuperType.prototype.sayName &#x3D; function()&#123;</span><br><span class="line">    alert(this.name);</span><br><span class="line">&#125;;</span><br><span class="line">function SubType(name, age)&#123;</span><br><span class="line">    SuperType.call(this, name);</span><br><span class="line">    this.age &#x3D; age;</span><br><span class="line">&#125;</span><br><span class="line">SubType.prototype &#x3D; new SuperType();</span><br><span class="line">SubType.prototype.constructor &#x3D; SubType;</span><br><span class="line">SubType.prototype.sayAge &#x3D; function()&#123;</span><br><span class="line">    alert(this.age);</span><br><span class="line">&#125;;</span><br><span class="line">var instance1 &#x3D; new SubType(&quot;Nicholas&quot;, 29);</span><br><span class="line">instance1.colors.push(&quot;black&quot;);</span><br><span class="line">alert(instance1.colors); &#x2F;&#x2F;&quot;red,blue,green,black&quot;</span><br><span class="line">instance1.sayName(); &#x2F;&#x2F;&quot;Nicholas&quot;;</span><br><span class="line">instance1.sayAge(); &#x2F;&#x2F;29</span><br><span class="line"></span><br><span class="line">var instance2 &#x3D; new SubType(&quot;Greg&quot;, 27);</span><br><span class="line">alert(instance2.colors); &#x2F;&#x2F;&quot;red,blue,green&quot;</span><br><span class="line">instance2.sayName(); &#x2F;&#x2F;&quot;Greg&quot;;</span><br><span class="line">instance2.sayAge(); &#x2F;&#x2F;27</span><br></pre></td></tr></table></figure>

<h3 id="原型式继承"><a href="#原型式继承" class="headerlink" title="原型式继承"></a>原型式继承</h3><p>Object.create()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function object(o)&#123;</span><br><span class="line">    function F()&#123;&#125;</span><br><span class="line">    F.prototype &#x3D; o;</span><br><span class="line">    return new F();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="寄生式继承"><a href="#寄生式继承" class="headerlink" title="寄生式继承"></a>寄生式继承</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function createAnother(original)&#123;</span><br><span class="line">    var clone&#x3D;object(original);</span><br><span class="line">    clone.sayHi &#x3D; function()&#123;</span><br><span class="line">        alert(&quot;hi&quot;);</span><br><span class="line">    &#125;;</span><br><span class="line">    return clone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在原型式继承的基础上添加了自己的方法(sayHi)</p>
<h3 id="寄生组合式继承"><a href="#寄生组合式继承" class="headerlink" title="寄生组合式继承"></a>寄生组合式继承</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function inheritPrototype(subType, superType)&#123;</span><br><span class="line">    var prototype &#x3D; object(superType.prototype);</span><br><span class="line">    prototype.constructor &#x3D; subType;</span><br><span class="line">    subType.prototype &#x3D; prototype;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function SuperType(name)&#123;</span><br><span class="line">    this.name &#x3D; name;</span><br><span class="line">    this.colors &#x3D; [&quot;red&quot;, &quot;blue&quot;, &quot;green&quot;];</span><br><span class="line">&#125;</span><br><span class="line">SuperType.prototype.sayName &#x3D; function()&#123;</span><br><span class="line">    alert(this.name);</span><br><span class="line">&#125;;</span><br><span class="line">function SubType(name, age)&#123;</span><br><span class="line">    SuperType.call(this, name);</span><br><span class="line">    this.age &#x3D; age;</span><br><span class="line">&#125;</span><br><span class="line">inheritPrototype(SubType, SuperType);</span><br><span class="line">SubType.prototype.sayAge &#x3D; function()&#123;</span><br><span class="line">    alert(this.age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只调用了一次 SuperType 构造函数，并且在 SubType 的 prototype 上没有多余的属性，可以说是目前能选择的最佳继承方案了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/06/14/js%E9%AB%98%E7%BA%A7/7.%E5%87%BD%E6%95%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2019/06/14/js%E9%AB%98%E7%BA%A7/7.%E5%87%BD%E6%95%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="post-title-link" itemprop="url">函数表达式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-14 00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-14T00:00:00+08:00">2019-06-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 14:11:27" itemprop="dateModified" datetime="2020-09-15T14:11:27+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="函数闭包"><a href="#函数闭包" class="headerlink" title="函数闭包"></a>函数闭包</h2><p><code>闭包</code>是指有权访问另一个函数作用域中的变量的函数</p>
<h2 id="内存泄漏"><a href="#内存泄漏" class="headerlink" title="内存泄漏"></a>内存泄漏</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function assignHandler()&#123;</span><br><span class="line">        var element &#x3D; document.getElementById(&quot;someElement&quot;);</span><br><span class="line">        element.onclick &#x3D; function()&#123;</span><br><span class="line">            alert(element.id);</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>↓</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function assignHandler()&#123;</span><br><span class="line">var element &#x3D; document.getElementById(&quot;someElement&quot;); var id &#x3D; element.id;</span><br><span class="line">        element.onclick &#x3D; function()&#123;</span><br><span class="line">alert(id);</span><br><span class="line">&#125;;</span><br><span class="line">        element &#x3D; null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>把 element 设为 null,可以借出对 dom 对象的引用，回收其占用的内存</p>
<h2 id="私有变量"><a href="#私有变量" class="headerlink" title="私有变量"></a>私有变量</h2><p>任何在函数中定义的变量，都可以叫做<code>私有变量</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function add(num1, num2)&#123;</span><br><span class="line">        var sum &#x3D; num1 + num2;</span><br><span class="line">        return sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们把有权访问私有变量和私有函数的公有方法称为<code>特权方法</code></p>
<ol>
<li>在构造函数中定义特权方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function MyObject()&#123;</span><br><span class="line">    var privateVariable &#x3D; 10;</span><br><span class="line">    function privateFunction()&#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    this.publicMethod &#x3D; function ()&#123;</span><br><span class="line">        privateVariable++;</span><br><span class="line">        return privateFunction();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>利用私有和特权成员，隐藏那些不应该被直接修改的数据</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function Person(name)&#123;</span><br><span class="line">    this.getName &#x3D; function()&#123;</span><br><span class="line">        return name;</span><br><span class="line">&#125;;</span><br><span class="line">    this.setName &#x3D; function (value) &#123;</span><br><span class="line">        name &#x3D; value;</span><br><span class="line">&#125;; &#125;</span><br><span class="line">var person &#x3D; new Person(&quot;Nicholas&quot;);</span><br><span class="line">alert(person.getName());   &#x2F;&#x2F;&quot;Nicholas&quot;</span><br><span class="line">person.setName(&quot;Greg&quot;);</span><br><span class="line">alert(person.getName());   &#x2F;&#x2F;&quot;Greg&quot;</span><br></pre></td></tr></table></figure>

<p>缺点：构造函数会给每个实例创建相同的方法，浪费</p>
<h3 id="静态私有变量"><a href="#静态私有变量" class="headerlink" title="静态私有变量"></a>静态私有变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(function()&#123;</span><br><span class="line">        var name &#x3D; &quot;&quot;;</span><br><span class="line">        Person &#x3D; function(value)&#123;</span><br><span class="line">            name &#x3D; value;</span><br><span class="line">        &#125;;</span><br><span class="line">        Person.prototype.getName &#x3D; function()&#123;</span><br><span class="line">            return name;</span><br><span class="line">        &#125;;</span><br><span class="line">        Person.prototype.setName &#x3D; function (value)&#123;</span><br><span class="line">            name &#x3D; value;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line">var person1 &#x3D; new Person(&quot;Nicholas&quot;);</span><br><span class="line">alert(person1.getName()); &#x2F;&#x2F;&quot;Nicholas&quot;</span><br><span class="line">person1.setName(&quot;Greg&quot;);</span><br><span class="line">alert(person1.getName()); &#x2F;&#x2F;&quot;Greg&quot;</span><br><span class="line">var person2 &#x3D; new Person(&quot;Michael&quot;);</span><br><span class="line">alert(person1.getName()); &#x2F;&#x2F;&quot;Michael&quot;</span><br><span class="line">alert(person2.getName()); &#x2F;&#x2F;&quot;Michael&quot;</span><br></pre></td></tr></table></figure>

<p>定义全局构造函数，但每个实例没有自己的私有变量</p>
<h3 id="模块模式"><a href="#模块模式" class="headerlink" title="模块模式"></a>模块模式</h3><p>模块模式通过为单例添加私有变量和特权方法来使其增强</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">var singleton &#x3D; function()&#123;</span><br><span class="line">    var privateVariable &#x3D; 10;</span><br><span class="line">    function privateFunction()&#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    return &#123;</span><br><span class="line">        publicProperty: true,</span><br><span class="line">        publicMethod : function()&#123;</span><br><span class="line">            privateVariable++;</span><br><span class="line">            return privateFunction();</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;;</span><br><span class="line">&#125;();</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/06/14/js%E9%AB%98%E7%BA%A7/8.BOM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2019/06/14/js%E9%AB%98%E7%BA%A7/8.BOM/" class="post-title-link" itemprop="url">BOM</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-14 00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-14T00:00:00+08:00">2019-06-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 14:11:38" itemprop="dateModified" datetime="2020-09-15T14:11:38+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="window"><a href="#window" class="headerlink" title="window"></a>window</h2><p>即使 js 访问浏览器的接口，也是 ESCMScript 的全局 Global 对象</p>
<h3 id="全局作用域"><a href="#全局作用域" class="headerlink" title="全局作用域"></a>全局作用域</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var age &#x3D; 29;</span><br><span class="line">function sayAge()&#123;</span><br><span class="line">    alert(this.age);</span><br><span class="line">&#125;</span><br><span class="line">alert(window.age); &#x2F;&#x2F;29</span><br><span class="line">sayAge(); &#x2F;&#x2F;29</span><br><span class="line"> window.sayAge(); &#x2F;&#x2F;29</span><br></pre></td></tr></table></figure>

<p>使用 var 添加的全局属性的 configurable 默认为 false, 所有不能<code>delete window.age</code>（无效）</p>
<h3 id="弹出窗口"><a href="#弹出窗口" class="headerlink" title="弹出窗口"></a>弹出窗口</h3><p>检测弹出窗是否被屏蔽</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var blocked &#x3D; false;</span><br><span class="line">try &#123;</span><br><span class="line">        var wroxWin &#x3D; window.open(&quot;http:&#x2F;&#x2F;www.wrox.com&quot;, &quot;_blank&quot;);</span><br><span class="line">        if (wroxWin &#x3D;&#x3D; null)&#123;</span><br><span class="line">            blocked &#x3D; true;</span><br><span class="line">&#125;</span><br><span class="line">&#125; catch (ex)&#123;</span><br><span class="line">    blocked &#x3D; true;</span><br><span class="line">&#125;</span><br><span class="line">if (blocked)&#123;</span><br><span class="line">    alert(&quot;The popup was blocked!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="navigator"><a href="#navigator" class="headerlink" title="navigator"></a>navigator</h2><h3 id="检测插件"><a href="#检测插件" class="headerlink" title="检测插件"></a>检测插件</h3><p><code>navigator.plugins</code></p>
<ul>
<li>name</li>
<li>description</li>
<li>filename</li>
<li>length 插件所处理的 MIME 类型数量</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/06/07/vue/attr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2018/06/07/vue/attr/" class="post-title-link" itemprop="url">attr</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-07 14:08:00" itemprop="dateCreated datePublished" datetime="2018-06-07T14:08:00+08:00">2018-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 14:06:07" itemprop="dateModified" datetime="2020-09-15T14:06:07+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>在 parseHTML 首次处理(剩下的属性都在这个方法里进行了第一次处理)<br>代码在 vue/src/compiler/parser/index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">parseHTML(template, &#123;</span><br><span class="line">    ...</span><br><span class="line">    start(tag, attrs, unary) &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 对element的其他属性做处理</span><br><span class="line">        processAttrs(element);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="processAttrs"><a href="#processAttrs" class="headerlink" title="processAttrs"></a>processAttrs</h2><p>代码在 vue/src/compiler/parser/index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">function processAttrs (el) &#123;</span><br><span class="line">  const list &#x3D; el.attrsList</span><br><span class="line">  let i, l, name, rawName, value, modifiers, isProp</span><br><span class="line">  for (i &#x3D; 0, l &#x3D; list.length; i &lt; l; i++) &#123;</span><br><span class="line">    name &#x3D; rawName &#x3D; list[i].name</span><br><span class="line">    value &#x3D; list[i].value</span><br><span class="line">    &#x2F;&#x2F; dirRE &#x2F;^v-|^@|^:&#x2F;</span><br><span class="line">    if (dirRE.test(name)) &#123;</span><br><span class="line">      &#x2F;&#x2F; mark element as dynamic</span><br><span class="line">      el.hasBindings &#x3D; true</span><br><span class="line">      &#x2F;&#x2F; modifiers</span><br><span class="line">      modifiers &#x3D; parseModifiers(name)</span><br><span class="line">      if (modifiers) &#123;</span><br><span class="line">        name &#x3D; name.replace(modifierRE, &#39;&#39;)</span><br><span class="line">      &#125;</span><br><span class="line">      if (bindRE.test(name)) &#123; &#x2F;&#x2F; v-bind</span><br><span class="line">        name &#x3D; name.replace(bindRE, &#39;&#39;)</span><br><span class="line">        value &#x3D; parseFilters(value)</span><br><span class="line">        isProp &#x3D; false</span><br><span class="line">        if (modifiers) &#123;</span><br><span class="line">          if (modifiers.prop) &#123;</span><br><span class="line">            isProp &#x3D; true</span><br><span class="line">            name &#x3D; camelize(name)</span><br><span class="line">            if (name &#x3D;&#x3D;&#x3D; &#39;innerHtml&#39;) name &#x3D; &#39;innerHTML&#39;</span><br><span class="line">          &#125;</span><br><span class="line">          if (modifiers.camel) &#123;</span><br><span class="line">            name &#x3D; camelize(name)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (isProp || platformMustUseProp(el.tag, el.attrsMap.type, name)) &#123;</span><br><span class="line">          addProp(el, name, value)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          addAttr(el, name, value)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else if (onRE.test(name)) &#123; &#x2F;&#x2F; v-on</span><br><span class="line">        name &#x3D; name.replace(onRE, &#39;&#39;)</span><br><span class="line">        addHandler(el, name, value, modifiers)</span><br><span class="line">      &#125; else &#123; &#x2F;&#x2F; normal directives</span><br><span class="line">        name &#x3D; name.replace(dirRE, &#39;&#39;)</span><br><span class="line">        &#x2F;&#x2F; parse arg</span><br><span class="line">        const argMatch &#x3D; name.match(argRE)</span><br><span class="line">        const arg &#x3D; argMatch &amp;&amp; argMatch[1]</span><br><span class="line">        if (arg) &#123;</span><br><span class="line">          name &#x3D; name.slice(0, -(arg.length + 1))</span><br><span class="line">        &#125;</span><br><span class="line">        addDirective(el, name, rawName, value, arg, modifiers)</span><br><span class="line">        if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; name &#x3D;&#x3D;&#x3D; &#39;model&#39;) &#123;</span><br><span class="line">          checkForAliasModel(el, value)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; literal attribute 普通属性</span><br><span class="line">      if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">        const expression &#x3D; parseText(value, delimiters)</span><br><span class="line">        if (expression) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            &#96;$&#123;name&#125;&#x3D;&quot;$&#123;value&#125;&quot;: &#96; +</span><br><span class="line">            &#39;Interpolation inside attributes has been removed. &#39; +</span><br><span class="line">            &#39;Use v-bind or the colon shorthand instead. For example, &#39; +</span><br><span class="line">            &#39;instead of &lt;div id&#x3D;&quot;&#123;&#123; val &#125;&#125;&quot;&gt;, use &lt;div :id&#x3D;&quot;val&quot;&gt;.&#39;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      addAttr(el, name, JSON.stringify(value))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/06/07/vue/v-if/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2018/06/07/vue/v-if/" class="post-title-link" itemprop="url">Vue源码阅读笔记 (v-if)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-07 11:08:00" itemprop="dateCreated datePublished" datetime="2018-06-07T11:08:00+08:00">2018-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 14:06:39" itemprop="dateModified" datetime="2020-09-15T14:06:39+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>在 parseHTML 首次处理 v-if<br>代码在 vue/src/compiler/parser/index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">parseHTML(template, &#123;</span><br><span class="line">    ...</span><br><span class="line">    start(tag, attrs, unary) &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        processIf(element);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="processIf"><a href="#processIf" class="headerlink" title="processIf"></a>processIf</h2><p>代码在 vue/src/compiler/parser/index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function processIf (el) &#123;</span><br><span class="line">  const exp &#x3D; getAndRemoveAttr(el, &#39;v-if&#39;)</span><br><span class="line">  if (exp) &#123;</span><br><span class="line">    el.if &#x3D; exp</span><br><span class="line">    addIfCondition(el, &#123;</span><br><span class="line">      exp: exp,</span><br><span class="line">      block: el</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    if (getAndRemoveAttr(el, &#39;v-else&#39;) !&#x3D; null) &#123;</span><br><span class="line">      el.else &#x3D; true</span><br><span class="line">    &#125;</span><br><span class="line">    const elseif &#x3D; getAndRemoveAttr(el, &#39;v-else-if&#39;)</span><br><span class="line">    if (elseif) &#123;</span><br><span class="line">      el.elseif &#x3D; elseif</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function addIfCondition (el, condition) &#123;</span><br><span class="line">  if (!el.ifConditions) &#123;</span><br><span class="line">    el.ifConditions &#x3D; []</span><br><span class="line">  &#125;</span><br><span class="line">  el.ifConditions.push(condition)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>element 多几个属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">element &#x3D; &#123;</span><br><span class="line">  ...</span><br><span class="line">  if:&quot;i % 2 &#x3D;&#x3D;&#x3D; 0&quot;,</span><br><span class="line">  ifConditions: [&#123;</span><br><span class="line">    block: el, &#x2F;&#x2F; 所在元素，就是element</span><br><span class="line">    exp: &quot;i % 2 &#x3D;&#x3D;&#x3D; 0&quot;</span><br><span class="line">  &#125;]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>未完待续</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/06/07/vue/v-for/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2018/06/07/vue/v-for/" class="post-title-link" itemprop="url">Vue源码阅读笔记 (v-for)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-07 11:08:00" itemprop="dateCreated datePublished" datetime="2018-06-07T11:08:00+08:00">2018-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>在 parseHTML 首次处理 v-for<br>代码在 vue/src/compiler/parser/index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">parseHTML(template, &#123;</span><br><span class="line">    ...</span><br><span class="line">    start(tag, attrs, unary) &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        processFor(element);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="processFor"><a href="#processFor" class="headerlink" title="processFor"></a>processFor</h2><p>代码在 vue/src/compiler/parser/index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">function processFor (el) &#123;</span><br><span class="line">  let exp</span><br><span class="line">  if ((exp &#x3D; getAndRemoveAttr(el, &#39;v-for&#39;))) &#123;</span><br><span class="line">    &#x2F;&#x2F; forAliasRE &#x2F;(.*?)\s+(?:in|of)\s+(.*)&#x2F; 匹配 * in或者of *</span><br><span class="line">    const inMatch &#x3D; exp.match(forAliasRE)</span><br><span class="line">    if (!inMatch) &#123;</span><br><span class="line">      process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; warn(</span><br><span class="line">        &#96;Invalid v-for expression: $&#123;exp&#125;&#96;</span><br><span class="line">      )</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line">    el.for &#x3D; inMatch[2].trim() &#x2F;&#x2F; i in 9里面的 9</span><br><span class="line">    const alias &#x3D; inMatch[1].trim() &#x2F;&#x2F; i in 9里面的 i</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; forIteratorRE &#x2F;\((\&#123;[^&#125;]*\&#125;|[^,]*),([^,]*)(?:,([^,]*))?\)&#x2F;</span><br><span class="line">    const iteratorMatch &#x3D; alias.match(forIteratorRE)</span><br><span class="line">    if (iteratorMatch) &#123;</span><br><span class="line">      el.alias &#x3D; iteratorMatch[1].trim() &#x2F;&#x2F; i</span><br><span class="line">      el.iterator1 &#x3D; iteratorMatch[2].trim() &#x2F;&#x2F; 第二个参数</span><br><span class="line">      if (iteratorMatch[3]) &#123;</span><br><span class="line">        el.iterator2 &#x3D; iteratorMatch[3].trim() &#x2F;&#x2F; 对象遍历可带第三个参数</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      el.alias &#x3D; alias</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>element 多几个属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">element &#x3D; &#123;</span><br><span class="line">  ...</span><br><span class="line">  alias:&quot;i&quot;,</span><br><span class="line">  for:&quot;9&quot;,</span><br><span class="line">  iterator1:&quot;index&quot; &#x2F;&#x2F; 可能有</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="processKey"><a href="#processKey" class="headerlink" title="processKey"></a>processKey</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function processKey (el) &#123;</span><br><span class="line">  const exp &#x3D; getBindingAttr(el, &#39;key&#39;)</span><br><span class="line">  if (exp) &#123;</span><br><span class="line">    if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; el.tag &#x3D;&#x3D;&#x3D; &#39;template&#39;) &#123;</span><br><span class="line">      &#x2F;&#x2F; template不能加key</span><br><span class="line">      warn(&#96;&lt;template&gt; cannot be keyed. Place the key on real elements instead.&#96;)</span><br><span class="line">    &#125;</span><br><span class="line">    el.key &#x3D; exp</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">element &#x3D; &#123;</span><br><span class="line">  ...</span><br><span class="line">  key:&quot;i&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>未完待续</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/06/07/vue/class/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2018/06/07/vue/class/" class="post-title-link" itemprop="url">Vue源码阅读笔记 (class,style)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-07 09:43:00" itemprop="dateCreated datePublished" datetime="2018-06-07T09:43:00+08:00">2018-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 14:06:09" itemprop="dateModified" datetime="2020-09-15T14:06:09+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>在 parseHTML 首次处理 class,style<br>代码在 vue/src/compiler/parser/index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">parseHTML(template, &#123;</span><br><span class="line">    ...</span><br><span class="line">    start(tag, attrs, unary) &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        for (let i &#x3D; 0; i &lt; transforms.length; i++) &#123;</span><br><span class="line">          transforms[i](element, options)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>transforms 里面包含了两个函数</p>
<h2 id="class"><a href="#class" class="headerlink" title="class"></a>class</h2><p>src/platforms/web/compiler/modules/class.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">function transformNode (el: ASTElement, options: CompilerOptions) &#123;</span><br><span class="line">  const warn &#x3D; options.warn || baseWarn</span><br><span class="line">  const staticClass &#x3D; getAndRemoveAttr(el, &#39;class&#39;) &#x2F;&#x2F; 获取class</span><br><span class="line">  if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; staticClass) &#123;</span><br><span class="line">    &#x2F;&#x2F; 判断class&#x3D;&quot;&#123;&#123;value&#125;&#125;&quot;这种情况</span><br><span class="line">    const expression &#x3D; parseText(staticClass, options.delimiters)</span><br><span class="line">    if (expression) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        &#96;class&#x3D;&quot;$&#123;staticClass&#125;&quot;: &#96; +</span><br><span class="line">        &#39;Interpolation inside attributes has been removed. &#39; +</span><br><span class="line">        &#39;Use v-bind or the colon shorthand instead. For example, &#39; +</span><br><span class="line">        &#39;instead of &lt;div class&#x3D;&quot;&#123;&#123; val &#125;&#125;&quot;&gt;, use &lt;div :class&#x3D;&quot;val&quot;&gt;.&#39;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 如果是静态class</span><br><span class="line">  if (staticClass) &#123;</span><br><span class="line">    el.staticClass &#x3D; JSON.stringify(staticClass)</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 判断:class这种情况</span><br><span class="line">  const classBinding &#x3D; getBindingAttr(el, &#39;class&#39;, false &#x2F;* getStatic *&#x2F;)</span><br><span class="line">  if (classBinding) &#123;</span><br><span class="line">    el.classBinding &#x3D; classBinding</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; vue&#x2F;src&#x2F;compiler&#x2F;helpers.js</span><br><span class="line">export function getBindingAttr (</span><br><span class="line">  el: ASTElement,</span><br><span class="line">  name: string,</span><br><span class="line">  getStatic?: boolean</span><br><span class="line">): ?string &#123;</span><br><span class="line">  const dynamicValue &#x3D;</span><br><span class="line">    getAndRemoveAttr(el, &#39;:&#39; + name) ||</span><br><span class="line">    getAndRemoveAttr(el, &#39;v-bind:&#39; + name)</span><br><span class="line">  if (dynamicValue !&#x3D; null) &#123;</span><br><span class="line">    return parseFilters(dynamicValue)</span><br><span class="line">  &#125; else if (getStatic !&#x3D;&#x3D; false) &#123;</span><br><span class="line">    const staticValue &#x3D; getAndRemoveAttr(el, name)</span><br><span class="line">    if (staticValue !&#x3D; null) &#123;</span><br><span class="line">      return JSON.stringify(staticValue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; src&#x2F;compiler&#x2F;parser&#x2F;filter-parser.js</span><br><span class="line">export function parseFilters (exp: string): string &#123;</span><br><span class="line">  let inSingle &#x3D; false</span><br><span class="line">  let inDouble &#x3D; false</span><br><span class="line">  let inTemplateString &#x3D; false</span><br><span class="line">  let inRegex &#x3D; false</span><br><span class="line">  let curly &#x3D; 0</span><br><span class="line">  let square &#x3D; 0</span><br><span class="line">  let paren &#x3D; 0</span><br><span class="line">  let lastFilterIndex &#x3D; 0</span><br><span class="line">  let c, prev, i, expression, filters</span><br><span class="line"></span><br><span class="line">  for (i &#x3D; 0; i &lt; exp.length; i++) &#123;</span><br><span class="line">    prev &#x3D; c</span><br><span class="line">    c &#x3D; exp.charCodeAt(i)</span><br><span class="line">    if (inSingle) &#123;</span><br><span class="line">      &#x2F;&#x2F; 0x27 &#39;      0x5C \</span><br><span class="line">      if (c &#x3D;&#x3D;&#x3D; 0x27 &amp;&amp; prev !&#x3D;&#x3D; 0x5C) inSingle &#x3D; false</span><br><span class="line">    &#125; else if (inDouble) &#123;</span><br><span class="line">      &#x2F;&#x2F; 0x22 &quot;</span><br><span class="line">      if (c &#x3D;&#x3D;&#x3D; 0x22 &amp;&amp; prev !&#x3D;&#x3D; 0x5C) inDouble &#x3D; false</span><br><span class="line">    &#125; else if (inTemplateString) &#123;</span><br><span class="line">      &#x2F;&#x2F; 0x60 &#96;</span><br><span class="line">      if (c &#x3D;&#x3D;&#x3D; 0x60 &amp;&amp; prev !&#x3D;&#x3D; 0x5C) inTemplateString &#x3D; false</span><br><span class="line">    &#125; else if (inRegex) &#123;</span><br><span class="line">      &#x2F;&#x2F; 0x2f &#x2F;</span><br><span class="line">      if (c &#x3D;&#x3D;&#x3D; 0x2f &amp;&amp; prev !&#x3D;&#x3D; 0x5C) inRegex &#x3D; false</span><br><span class="line">    &#125; else if (</span><br><span class="line">      c &#x3D;&#x3D;&#x3D; 0x7C &amp;&amp; &#x2F;&#x2F; pipe  0x7C |</span><br><span class="line">      exp.charCodeAt(i + 1) !&#x3D;&#x3D; 0x7C &amp;&amp;</span><br><span class="line">      exp.charCodeAt(i - 1) !&#x3D;&#x3D; 0x7C &amp;&amp;</span><br><span class="line">      !curly &amp;&amp; !square &amp;&amp; !paren</span><br><span class="line">    ) &#123;</span><br><span class="line">      if (expression &#x3D;&#x3D;&#x3D; undefined) &#123;</span><br><span class="line">        &#x2F;&#x2F; first filter, end of expression</span><br><span class="line">        lastFilterIndex &#x3D; i + 1</span><br><span class="line">        expression &#x3D; exp.slice(0, i).trim()</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        pushFilter()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      switch (c) &#123;</span><br><span class="line">        case 0x22: inDouble &#x3D; true; break         &#x2F;&#x2F; &quot;</span><br><span class="line">        case 0x27: inSingle &#x3D; true; break         &#x2F;&#x2F; &#39;</span><br><span class="line">        case 0x60: inTemplateString &#x3D; true; break &#x2F;&#x2F; &#96;</span><br><span class="line">        case 0x28: paren++; break                 &#x2F;&#x2F; (</span><br><span class="line">        case 0x29: paren--; break                 &#x2F;&#x2F; )</span><br><span class="line">        case 0x5B: square++; break                &#x2F;&#x2F; [</span><br><span class="line">        case 0x5D: square--; break                &#x2F;&#x2F; ]</span><br><span class="line">        case 0x7B: curly++; break                 &#x2F;&#x2F; &#123;</span><br><span class="line">        case 0x7D: curly--; break                 &#x2F;&#x2F; &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (c &#x3D;&#x3D;&#x3D; 0x2f) &#123; &#x2F;&#x2F; &#x2F;</span><br><span class="line">        let j &#x3D; i - 1</span><br><span class="line">        let p</span><br><span class="line">        &#x2F;&#x2F; find first non-whitespace prev char</span><br><span class="line">        for (; j &gt;&#x3D; 0; j--) &#123;</span><br><span class="line">          p &#x3D; exp.charAt(j)</span><br><span class="line">          if (p !&#x3D;&#x3D; &#39; &#39;) break</span><br><span class="line">        &#125;</span><br><span class="line">        if (!p || !validDivisionCharRE.test(p)) &#123;</span><br><span class="line">          inRegex &#x3D; true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (expression &#x3D;&#x3D;&#x3D; undefined) &#123;</span><br><span class="line">    expression &#x3D; exp.slice(0, i).trim()</span><br><span class="line">  &#125; else if (lastFilterIndex !&#x3D;&#x3D; 0) &#123;</span><br><span class="line">    pushFilter()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function pushFilter () &#123;</span><br><span class="line">    (filters || (filters &#x3D; [])).push(exp.slice(lastFilterIndex, i).trim())</span><br><span class="line">    lastFilterIndex &#x3D; i + 1</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (filters) &#123;</span><br><span class="line">    for (i &#x3D; 0; i &lt; filters.length; i++) &#123;</span><br><span class="line">      expression &#x3D; wrapFilter(expression, filters[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return expression</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="style"><a href="#style" class="headerlink" title="style"></a>style</h2><p>src/platforms/web/compiler/modules/style.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function transformNode (el: ASTElement, options: CompilerOptions) &#123;</span><br><span class="line">  const warn &#x3D; options.warn || baseWarn</span><br><span class="line">  const staticStyle &#x3D; getAndRemoveAttr(el, &#39;style&#39;) &#x2F;&#x2F; style</span><br><span class="line">  if (staticStyle) &#123;</span><br><span class="line">    &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">    if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">      &#x2F;&#x2F; style&#x3D;&quot;&#123;&#123; val &#125;&#125;&quot; 情况</span><br><span class="line">      const expression &#x3D; parseText(staticStyle, options.delimiters)</span><br><span class="line">      if (expression) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          &#96;style&#x3D;&quot;$&#123;staticStyle&#125;&quot;: &#96; +</span><br><span class="line">          &#39;Interpolation inside attributes has been removed. &#39; +</span><br><span class="line">          &#39;Use v-bind or the colon shorthand instead. For example, &#39; +</span><br><span class="line">          &#39;instead of &lt;div style&#x3D;&quot;&#123;&#123; val &#125;&#125;&quot;&gt;, use &lt;div :style&#x3D;&quot;val&quot;&gt;.&#39;</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    el.staticStyle &#x3D; JSON.stringify(parseStyleText(staticStyle))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const styleBinding &#x3D; getBindingAttr(el, &#39;style&#39;, false &#x2F;* getStatic *&#x2F;)</span><br><span class="line">  if (styleBinding) &#123;</span><br><span class="line">    el.styleBinding &#x3D; styleBinding</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/05/25/vue/4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/my-notes/2018/05/25/vue/4/" class="post-title-link" itemprop="url">Vue源码阅读笔记（4）(compile)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-25 10:14:00" itemprop="dateCreated datePublished" datetime="2018-05-25T10:14:00+08:00">2018-05-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 14:06:05" itemprop="dateModified" datetime="2020-09-15T14:06:05+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://github.com/liutao/vue2.0-source/blob/be4ac775e26efae7b64e5254e23a97d50a9e880c/compile%E6%A6%82%E8%BF%B0.md">参考了的文章</a></p>
<p>从这里开始我会尽可能的把源码里所有的<code>if</code>情况考虑进去，还是以一个简单例子开始，之后会不断的把这个例子补充完整，以完成对每一行的解读</p>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>模板编译分为三个阶段：生成 ast、优化静态内容、生成 render</p>
<p>以下面代码开始</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">  &lt;p&gt;&#123;&#123;message&#125;&#125;&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;..&#x2F;dist&#x2F;vue.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">  var vm &#x3D; new Vue(&#123;</span><br><span class="line">    el: &#39;#app&#39;,</span><br><span class="line">    data: &#123;</span><br><span class="line">      message: &#39;第一个vue实例&#39;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br></pre></td></tr></table></figure>

<h2 id="正则补充"><a href="#正则补充" class="headerlink" title="正则补充"></a>正则补充</h2><p>这里用到了很多的正则判断，对于一些比较复杂的不清楚的在这里进行说明(超的<a target="_blank" rel="noopener" href="https://github.com/liutao/vue2.0-source/blob/be4ac775e26efae7b64e5254e23a97d50a9e880c/compile%E2%80%94%E2%80%94%E7%94%9F%E6%88%90ast.md">参考文章</a>)</p>
<p>代码片段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">while (</span><br><span class="line">  !endTag.test(rest) &amp;&amp;</span><br><span class="line">  !startTagOpen.test(rest) &amp;&amp;</span><br><span class="line">  !comment.test(rest) &amp;&amp;</span><br><span class="line">  !conditionalComment.test(rest)</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>endTag = /^&lt;/((?:[a-zA-Z_][\w-.]_:)?[a-zA-Z_][\w-.]_)[^&gt;]*&gt;/<br>endTag 是匹配双标签的结束标签。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#39;&lt;&#x2F;div&gt;&#39;.match(endTag)</span><br><span class="line">&#x2F;&#x2F; [&quot;&lt;&#x2F;div&gt;&quot;, &quot;div&quot;, index: 0, input: &quot;&lt;&#x2F;div&gt;&quot;]</span><br><span class="line"></span><br><span class="line">&#39;&lt;&#x2F;div    &gt;&#39;.match(endTag)</span><br><span class="line">&#x2F;&#x2F; [&quot;&lt;&#x2F;div    &gt;&quot;, &quot;div&quot;, index: 0, input: &quot;&lt;&#x2F;div    &gt;&quot;]</span><br><span class="line"></span><br><span class="line">&#39; &lt;&#x2F;div    &gt;&#39;.match(endTag)</span><br><span class="line">&#x2F;&#x2F; null</span><br></pre></td></tr></table></figure>

<p>startTagOpen = /^&lt;((?:[a-zA-Z_][\w-.]<em>:)?[a-zA-Z\</em>][\w-.]_)/<br>匹配开始标签</p>
<h2 id="compileToFunctions"><a href="#compileToFunctions" class="headerlink" title="compileToFunctions"></a>compileToFunctions</h2><p>从<code>compileToFunctions</code>开始，路径<code>/src/compiler/index.js</code>,<br>首先在 mount 方法里有使用到<code>compileToFunctions</code>方法，他返回了 render 函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">const &#123; render, staticRenderFns &#125; &#x3D; compileToFunctions(template, &#123;</span><br><span class="line">    shouldDecodeNewlines,</span><br><span class="line">    delimiters: options.delimiters</span><br><span class="line">&#125;, this)</span><br><span class="line"></span><br><span class="line">function compileToFunctions (</span><br><span class="line">    template: string, &#x2F;&#x2F; html模板</span><br><span class="line">    options?: CompilerOptions, &#x2F;&#x2F; 上面的参数</span><br><span class="line">    vm?: Component &#x2F;&#x2F; vue</span><br><span class="line">  ): CompiledFunctionResult &#123;</span><br><span class="line">    options &#x3D; options || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">    if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">      &#x2F;&#x2F; detect possible CSP restriction</span><br><span class="line">      try &#123;</span><br><span class="line">        new Function(&#39;return 1&#39;)</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        if (e.toString().match(&#x2F;unsafe-eval|CSP&#x2F;)) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            &#39;It seems you are using the standalone build of Vue.js in an &#39; +</span><br><span class="line">            &#39;environment with Content Security Policy that prohibits unsafe-eval. &#39; +</span><br><span class="line">            &#39;The template compiler cannot work in this environment. Consider &#39; +</span><br><span class="line">            &#39;relaxing the policy to allow unsafe-eval or pre-compiling your &#39; +</span><br><span class="line">            &#39;templates into render functions.&#39;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; check cache</span><br><span class="line">    const key &#x3D; options.delimiters</span><br><span class="line">      ? String(options.delimiters) + template</span><br><span class="line">      : template &#x2F;&#x2F; key是模板html</span><br><span class="line">    if (functionCompileCache[key]) &#123; &#x2F;&#x2F; 应该是缓存</span><br><span class="line">      return functionCompileCache[key]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; compile</span><br><span class="line">    const compiled &#x3D; compile(template, options)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; check compilation errors&#x2F;tips</span><br><span class="line">    if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">      if (compiled.errors &amp;&amp; compiled.errors.length) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          &#96;Error compiling template:\n\n$&#123;template&#125;\n\n&#96; +</span><br><span class="line">          compiled.errors.map(e &#x3D;&gt; &#96;- $&#123;e&#125;&#96;).join(&#39;\n&#39;) + &#39;\n&#39;,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      if (compiled.tips &amp;&amp; compiled.tips.length) &#123;</span><br><span class="line">        compiled.tips.forEach(msg &#x3D;&gt; tip(msg, vm))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; turn code into functions</span><br><span class="line">    const res &#x3D; &#123;&#125;</span><br><span class="line">    const fnGenErrors &#x3D; []</span><br><span class="line">    res.render &#x3D; makeFunction(compiled.render, fnGenErrors)</span><br><span class="line">    const l &#x3D; compiled.staticRenderFns.length</span><br><span class="line">    res.staticRenderFns &#x3D; new Array(l)</span><br><span class="line">    for (let i &#x3D; 0; i &lt; l; i++) &#123;</span><br><span class="line">      res.staticRenderFns[i] &#x3D; makeFunction(compiled.staticRenderFns[i], fnGenErrors)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; check function generation errors.</span><br><span class="line">    &#x2F;&#x2F; this should only happen if there is a bug in the compiler itself.</span><br><span class="line">    &#x2F;&#x2F; mostly for codegen development use</span><br><span class="line">    &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">    if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">      if ((!compiled.errors || !compiled.errors.length) &amp;&amp; fnGenErrors.length) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          &#96;Failed to generate render function:\n\n&#96; +</span><br><span class="line">          fnGenErrors.map((&#123; err, code &#125;) &#x3D;&gt; &#96;$&#123;err.toString()&#125; in\n\n$&#123;code&#125;\n&#96;).join(&#39;\n&#39;),</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return (functionCompileCache[key] &#x3D; res)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>具体说明看上面注释</p>
<p>运行到<code>compile</code>，我们跟着进去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">function compile (</span><br><span class="line">    template: string,</span><br><span class="line">    options?: CompilerOptions</span><br><span class="line">  ): CompiledResult &#123;</span><br><span class="line">    &#x2F;&#x2F; finalOptions.prototype &#x3D; baseOption</span><br><span class="line">    const finalOptions &#x3D; Object.create(baseOptions)</span><br><span class="line">    const errors &#x3D; []</span><br><span class="line">    const tips &#x3D; []</span><br><span class="line">    &#x2F;&#x2F; 定义了warn方法</span><br><span class="line">    finalOptions.warn &#x3D; (msg, tip) &#x3D;&gt; &#123;</span><br><span class="line">      (tip ? tips : errors).push(msg)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (options) &#123;</span><br><span class="line">      &#x2F;&#x2F; merge custom modules</span><br><span class="line">      &#x2F;&#x2F; 合并自定义modules</span><br><span class="line">      &#x2F;&#x2F; TODO 这里的options应该肯定没有这些参数才对啊？下同</span><br><span class="line">      if (options.modules) &#123;</span><br><span class="line">        finalOptions.modules &#x3D; (baseOptions.modules || []).concat(options.modules)</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; merge custom directives</span><br><span class="line">      &#x2F;&#x2F; 合并自定义directives</span><br><span class="line">      if (options.directives) &#123;</span><br><span class="line">        finalOptions.directives &#x3D; extend(</span><br><span class="line">          Object.create(baseOptions.directives),</span><br><span class="line">          options.directives</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; copy other options</span><br><span class="line">      &#x2F;&#x2F; 赋值给finalOptions</span><br><span class="line">      for (const key in options) &#123;</span><br><span class="line">        if (key !&#x3D;&#x3D; &#39;modules&#39; &amp;&amp; key !&#x3D;&#x3D; &#39;directives&#39;) &#123;</span><br><span class="line">          finalOptions[key] &#x3D; options[key]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 把参数带到baseCompile</span><br><span class="line">    const compiled &#x3D; baseCompile(template, finalOptions)</span><br><span class="line">    if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">      errors.push.apply(errors, detectErrors(compiled.ast))</span><br><span class="line">    &#125;</span><br><span class="line">    compiled.errors &#x3D; errors</span><br><span class="line">    compiled.tips &#x3D; tips</span><br><span class="line">    return compiled</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>第一句就出现了位置变量，根据 build/alias 的定义以及 web-runtime-with-compiler.js 里面的引用，可以发现在<code>src/platforms/web/compiler/index.js</code>里面使用了 createCompiler 方法，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* @flow *&#x2F;</span><br><span class="line"></span><br><span class="line">import &#123; isUnaryTag, canBeLeftOpenTag &#125; from &#39;.&#x2F;util&#39;</span><br><span class="line">import &#123; genStaticKeys &#125; from &#39;shared&#x2F;util&#39;</span><br><span class="line">import &#123; createCompiler &#125; from &#39;compiler&#x2F;index&#39;</span><br><span class="line"></span><br><span class="line">import modules from &#39;.&#x2F;modules&#x2F;index&#39;</span><br><span class="line">import directives from &#39;.&#x2F;directives&#x2F;index&#39;</span><br><span class="line"></span><br><span class="line">import &#123;</span><br><span class="line">  isPreTag,</span><br><span class="line">  mustUseProp,</span><br><span class="line">  isReservedTag,</span><br><span class="line">  getTagNamespace</span><br><span class="line">&#125; from &#39;..&#x2F;util&#x2F;index&#39;</span><br><span class="line"></span><br><span class="line">export const baseOptions: CompilerOptions &#x3D; &#123;</span><br><span class="line">  expectHTML: true,</span><br><span class="line">  modules,</span><br><span class="line">  directives,</span><br><span class="line">  isPreTag,</span><br><span class="line">  isUnaryTag,</span><br><span class="line">  mustUseProp,</span><br><span class="line">  canBeLeftOpenTag,</span><br><span class="line">  isReservedTag,</span><br><span class="line">  getTagNamespace,</span><br><span class="line">  staticKeys: genStaticKeys(modules)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const &#123; compile, compileToFunctions &#125; &#x3D; createCompiler(baseOptions)</span><br><span class="line">export &#123; compile, compileToFunctions &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后 baseOptions 就在这里定义了，具体参数及方法会在用到的时候细看</p>
<p>运行到<code>baseCompile</code>，然后进入<code>parse</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function baseCompile (</span><br><span class="line">  template: string,</span><br><span class="line">  options: CompilerOptions</span><br><span class="line">): CompiledResult &#123;</span><br><span class="line">  const ast &#x3D; parse(template.trim(), options)</span><br><span class="line">  optimize(ast, options)</span><br><span class="line">  const code &#x3D; generate(ast, options)</span><br><span class="line">  return &#123;</span><br><span class="line">    ast,</span><br><span class="line">    render: code.render,</span><br><span class="line">    staticRenderFns: code.staticRenderFns</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>parse</code>在/src/compiler/parser/index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Convert HTML string to AST.</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function parse (</span><br><span class="line">  template: string,</span><br><span class="line">  options: CompilerOptions</span><br><span class="line">): ASTElement | void &#123;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; warn函数</span><br><span class="line">  warn &#x3D; options.warn || baseWarn</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 获取命名空间，svg和math</span><br><span class="line">  platformGetTagNamespace &#x3D; options.getTagNamespace || no</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 需要使用props绑定的属性，比如value、selected等</span><br><span class="line">  platformMustUseProp &#x3D; options.mustUseProp || no</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 是否是pre标签</span><br><span class="line">  platformIsPreTag &#x3D; options.isPreTag || no</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 取options.modules里有preTransformNode参数的数组，下同</span><br><span class="line">  preTransforms &#x3D; pluckModuleFunction(options.modules, &#39;preTransformNode&#39;)</span><br><span class="line">  transforms &#x3D; pluckModuleFunction(options.modules, &#39;transformNode&#39;)</span><br><span class="line">  postTransforms &#x3D; pluckModuleFunction(options.modules, &#39;postTransformNode&#39;)</span><br><span class="line">  delimiters &#x3D; options.delimiters</span><br><span class="line"></span><br><span class="line">  const stack &#x3D; []</span><br><span class="line">  const preserveWhitespace &#x3D; options.preserveWhitespace !&#x3D;&#x3D; false</span><br><span class="line">  let root</span><br><span class="line">  let currentParent</span><br><span class="line">  let inVPre &#x3D; false</span><br><span class="line">  let inPre &#x3D; false</span><br><span class="line">  let warned &#x3D; false</span><br><span class="line"></span><br><span class="line">  function warnOnce (msg) &#123;</span><br><span class="line">    if (!warned) &#123;</span><br><span class="line">      warned &#x3D; true</span><br><span class="line">      warn(msg)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function endPre (element) &#123;</span><br><span class="line">    &#x2F;&#x2F; check pre state</span><br><span class="line">    if (element.pre) &#123;</span><br><span class="line">      inVPre &#x3D; false</span><br><span class="line">    &#125;</span><br><span class="line">    if (platformIsPreTag(element.tag)) &#123;</span><br><span class="line">      inPre &#x3D; false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  parseHTML(template, &#123;</span><br><span class="line">    warn,</span><br><span class="line">    expectHTML: options.expectHTML,</span><br><span class="line">    isUnaryTag: options.isUnaryTag,</span><br><span class="line">    canBeLeftOpenTag: options.canBeLeftOpenTag,</span><br><span class="line">    shouldDecodeNewlines: options.shouldDecodeNewlines,</span><br><span class="line">    start (tag, attrs, unary) &#123;</span><br><span class="line">      &#x2F;&#x2F; check namespace.</span><br><span class="line">      &#x2F;&#x2F; inherit parent ns if there is one</span><br><span class="line">      &#x2F;&#x2F; 第一遍还不清楚是啥</span><br><span class="line">      const ns &#x3D; (currentParent &amp;&amp; currentParent.ns) || platformGetTagNamespace(tag)</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; handle IE svg bug</span><br><span class="line">      &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">      if (isIE &amp;&amp; ns &#x3D;&#x3D;&#x3D; &#39;svg&#39;) &#123;</span><br><span class="line">        attrs &#x3D; guardIESVGBug(attrs)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      const element: ASTElement &#x3D; &#123;</span><br><span class="line">        type: 1,</span><br><span class="line">        tag,</span><br><span class="line">        attrsList: attrs,</span><br><span class="line">        attrsMap: makeAttrsMap(attrs), &#x2F;&#x2F; 把attr转换成对象，并且检验重复属性</span><br><span class="line">        parent: currentParent,</span><br><span class="line">        children: []</span><br><span class="line">      &#125;</span><br><span class="line">      if (ns) &#123;</span><br><span class="line">        element.ns &#x3D; ns</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; 如果标签是style和script</span><br><span class="line">      if (isForbiddenTag(element) &amp;&amp; !isServerRendering()) &#123;</span><br><span class="line">        element.forbidden &#x3D; true</span><br><span class="line">        process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; warn(</span><br><span class="line">          &#39;Templates should only be responsible for mapping the state to the &#39; +</span><br><span class="line">          &#39;UI. Avoid placing tags with side-effects in your templates, such as &#39; +</span><br><span class="line">          &#96;&lt;$&#123;tag&#125;&gt;&#96; + &#39;, as they will not be parsed.&#39;</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; apply pre-transforms</span><br><span class="line">      for (let i &#x3D; 0; i &lt; preTransforms.length; i++) &#123;</span><br><span class="line">        preTransforms[i](element, options)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (!inVPre) &#123;</span><br><span class="line">        processPre(element) &#x2F;&#x2F; 如果标签有v-pre，则element.pre &#x3D; true</span><br><span class="line">        if (element.pre) &#123;</span><br><span class="line">          inVPre &#x3D; true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (platformIsPreTag(element.tag)) &#123; &#x2F;&#x2F; 判断tag是不是pre</span><br><span class="line">        inPre &#x3D; true</span><br><span class="line">      &#125;</span><br><span class="line">      if (inVPre) &#123;</span><br><span class="line">        processRawAttrs(element)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        processFor(element) &#x2F;&#x2F; v-for</span><br><span class="line">        processIf(element) &#x2F;&#x2F; v-if</span><br><span class="line">        processOnce(element) &#x2F;&#x2F; v-once element.once &#x3D; true</span><br><span class="line">        processKey(element) &#x2F;&#x2F; key element.key &#x3D; i</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; determine whether this is a plain element after</span><br><span class="line">        &#x2F;&#x2F; removing structural attributes</span><br><span class="line">        &#x2F;&#x2F; 不存在其他属性的&#39;纯&#39;元素</span><br><span class="line">        element.plain &#x3D; !element.key &amp;&amp; !attrs.length</span><br><span class="line"></span><br><span class="line">        processRef(element) &#x2F;&#x2F; ref</span><br><span class="line">        processSlot(element) &#x2F;&#x2F; slot</span><br><span class="line">        processComponent(element) &#x2F;&#x2F; is</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; transforms包含了class和style的处理函数</span><br><span class="line">        &#x2F;&#x2F; 给element添加了staticClass(class)和classBinding(:class||v-bind:class)属性</span><br><span class="line">        &#x2F;&#x2F; 给element添加了staticStyle(style)和styleBinding(:style||v-bind:style)属性</span><br><span class="line">        for (let i &#x3D; 0; i &lt; transforms.length; i++) &#123;</span><br><span class="line">          transforms[i](element, options)</span><br><span class="line">        &#125;</span><br><span class="line">        processAttrs(element) &#x2F;&#x2F; 处理除了上面的其他属性</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      function checkRootConstraints (el) &#123;</span><br><span class="line">        if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">          &#x2F;&#x2F; slot和template报错提示</span><br><span class="line">          if (el.tag &#x3D;&#x3D;&#x3D; &#39;slot&#39; || el.tag &#x3D;&#x3D;&#x3D; &#39;template&#39;) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              &#96;Cannot use &lt;$&#123;el.tag&#125;&gt; as component root element because it may &#96; +</span><br><span class="line">              &#39;contain multiple nodes.&#39;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          &#x2F;&#x2F; 根节点不能加v-for报错提示</span><br><span class="line">          if (el.attrsMap.hasOwnProperty(&#39;v-for&#39;)) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              &#39;Cannot use v-for on stateful component root element because &#39; +</span><br><span class="line">              &#39;it renders multiple elements.&#39;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; tree management</span><br><span class="line">      if (!root) &#123; &#x2F;&#x2F; 第一次进入这个if</span><br><span class="line">        root &#x3D; element</span><br><span class="line">        checkRootConstraints(root) &#x2F;&#x2F; 见上面函数</span><br><span class="line">      &#125; else if (!stack.length) &#123;</span><br><span class="line">        &#x2F;&#x2F; allow root elements with v-if, v-else-if and v-else</span><br><span class="line">        if (root.if &amp;&amp; (element.elseif || element.else)) &#123;</span><br><span class="line">          checkRootConstraints(element)</span><br><span class="line">          addIfCondition(root, &#123;</span><br><span class="line">            exp: element.elseif,</span><br><span class="line">            block: element</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; else if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">          warnOnce(</span><br><span class="line">            &#96;Component template should contain exactly one root element. &#96; +</span><br><span class="line">            &#96;If you are using v-if on multiple elements, &#96; +</span><br><span class="line">            &#96;use v-else-if to chain them instead.&#96;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (currentParent &amp;&amp; !element.forbidden) &#123; &#x2F;&#x2F; 第一次不进if</span><br><span class="line">        if (element.elseif || element.else) &#123;</span><br><span class="line">          processIfConditions(element, currentParent)</span><br><span class="line">        &#125; else if (element.slotScope) &#123; &#x2F;&#x2F; scoped slot</span><br><span class="line">          currentParent.plain &#x3D; false</span><br><span class="line">          const name &#x3D; element.slotTarget || &#39;&quot;default&quot;&#39;</span><br><span class="line">          ;(currentParent.scopedSlots || (currentParent.scopedSlots &#x3D; &#123;&#125;))[name] &#x3D; element</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          currentParent.children.push(element)</span><br><span class="line">          element.parent &#x3D; currentParent</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (!unary) &#123; &#x2F;&#x2F; 不是单标签</span><br><span class="line">        currentParent &#x3D; element</span><br><span class="line">        stack.push(element)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        endPre(element)</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; apply post-transforms</span><br><span class="line">      &#x2F;&#x2F; 不知道是啥</span><br><span class="line">      for (let i &#x3D; 0; i &lt; postTransforms.length; i++) &#123;</span><br><span class="line">        postTransforms[i](element, options)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    end () &#123;</span><br><span class="line">      &#x2F;&#x2F; remove trailing whitespace</span><br><span class="line">      const element &#x3D; stack[stack.length - 1]</span><br><span class="line">      const lastNode &#x3D; element.children[element.children.length - 1]</span><br><span class="line">      if (lastNode &amp;&amp; lastNode.type &#x3D;&#x3D;&#x3D; 3 &amp;&amp; lastNode.text &#x3D;&#x3D;&#x3D; &#39; &#39; &amp;&amp; !inPre) &#123;</span><br><span class="line">        element.children.pop()</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; pop stack 删除最近的一个闭合标签</span><br><span class="line">      stack.length -&#x3D; 1</span><br><span class="line">      &#x2F;&#x2F; currentParent变为上一层节点</span><br><span class="line">      currentParent &#x3D; stack[stack.length - 1]</span><br><span class="line">      &#x2F;&#x2F; pre做结束处理</span><br><span class="line">      endPre(element)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    chars (text: string) &#123;</span><br><span class="line">      if (!currentParent) &#123; &#x2F;&#x2F; 这里可能是Component template必须要有个根节点</span><br><span class="line">        if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;) &#123;</span><br><span class="line">          if (text &#x3D;&#x3D;&#x3D; template) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              &#39;Component template requires a root element, rather than just text.&#39;</span><br><span class="line">            )</span><br><span class="line">          &#125; else if ((text &#x3D; text.trim())) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              &#96;text &quot;$&#123;text&#125;&quot; outside root element will be ignored.&#96;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; IE textarea placeholder bug</span><br><span class="line">      &#x2F;&#x2F; ie才有的bug，现在没条件测试</span><br><span class="line">      &#x2F;* istanbul ignore if *&#x2F;</span><br><span class="line">      if (isIE &amp;&amp;</span><br><span class="line">          currentParent.tag &#x3D;&#x3D;&#x3D; &#39;textarea&#39; &amp;&amp;</span><br><span class="line">          currentParent.attrsMap.placeholder &#x3D;&#x3D;&#x3D; text) &#123;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      const children &#x3D; currentParent.children</span><br><span class="line">      text &#x3D; inPre || text.trim() &#x2F;&#x2F; pre里面或者存在静态文本</span><br><span class="line">        ? decodeHTMLCached(text) &#x2F;&#x2F; text处理,取了textContent的值，在chrome把&lt;转为了&lt;</span><br><span class="line">        &#x2F;&#x2F; only preserve whitespace if its not right after a starting tag</span><br><span class="line">        : preserveWhitespace &amp;&amp; children.length ? &#39; &#39; : &#39;&#39;</span><br><span class="line">      if (text) &#123;</span><br><span class="line">        let expression</span><br><span class="line">        if (!inVPre &amp;&amp; text !&#x3D;&#x3D; &#39; &#39; &amp;&amp; (expression &#x3D; parseText(text, delimiters))) &#123; &#x2F;&#x2F; 判断是不是&#123;&#123;&#125;&#125;表达式, 并提取表达式为render函数</span><br><span class="line">          children.push(&#123;</span><br><span class="line">            type: 2,</span><br><span class="line">            expression,</span><br><span class="line">            text</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; else if (text !&#x3D;&#x3D; &#39; &#39; || !children.length || children[children.length - 1].text !&#x3D;&#x3D; &#39; &#39;) &#123; &#x2F;&#x2F; 纯粹的静态文本、父节点v-pre|pre、</span><br><span class="line">          children.push(&#123;</span><br><span class="line">            type: 3,</span><br><span class="line">            text</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  return root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行到<code>parseHTML</code>,继续跟进</p>
<p>文件在 src/compiler/parser/html-parser.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line">export function parseHTML (html, options) &#123;</span><br><span class="line">  const stack &#x3D; [] &#x2F;&#x2F; 一些赋值操作</span><br><span class="line">  const expectHTML &#x3D; options.expectHTML</span><br><span class="line">  const isUnaryTag &#x3D; options.isUnaryTag || no</span><br><span class="line">  const canBeLeftOpenTag &#x3D; options.canBeLeftOpenTag || no</span><br><span class="line">  let index &#x3D; 0</span><br><span class="line">  let last, lastTag</span><br><span class="line">  while (html) &#123; &#x2F;&#x2F; 循环template模板</span><br><span class="line">    last &#x3D; html</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Make sure we&#39;re not in a plaintext content element like script&#x2F;style</span><br><span class="line">    &#x2F;&#x2F; 不是script,style,textarea中的一个</span><br><span class="line">    if (!lastTag || !isPlainTextElement(lastTag)) &#123;</span><br><span class="line">      let textEnd &#x3D; html.indexOf(&#39;&lt;&#39;)</span><br><span class="line">      if (textEnd &#x3D;&#x3D;&#x3D; 0) &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Comment: 是不是注释</span><br><span class="line">        &#x2F;&#x2F; 注释直接截取不做额外处理</span><br><span class="line">        if (comment.test(html)) &#123;</span><br><span class="line">          const commentEnd &#x3D; html.indexOf(&#39;--&gt;&#39;)</span><br><span class="line"></span><br><span class="line">          if (commentEnd &gt;&#x3D; 0) &#123;</span><br><span class="line">            advance(commentEnd + 3)</span><br><span class="line">            continue</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; http:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Conditional_comment#Downlevel-revealed_conditional_comment</span><br><span class="line">        &#x2F;&#x2F; 看链接</span><br><span class="line">        if (conditionalComment.test(html)) &#123;</span><br><span class="line">          const conditionalEnd &#x3D; html.indexOf(&#39;]&gt;&#39;)</span><br><span class="line"></span><br><span class="line">          if (conditionalEnd &gt;&#x3D; 0) &#123;</span><br><span class="line">            advance(conditionalEnd + 2)</span><br><span class="line">            continue</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Doctype:</span><br><span class="line">        const doctypeMatch &#x3D; html.match(doctype)</span><br><span class="line">        if (doctypeMatch) &#123;</span><br><span class="line">          advance(doctypeMatch[0].length)</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; End tag: 末尾标签</span><br><span class="line">        const endTagMatch &#x3D; html.match(endTag)</span><br><span class="line">        if (endTagMatch) &#123;</span><br><span class="line">          const curIndex &#x3D; index</span><br><span class="line">          advance(endTagMatch[0].length)</span><br><span class="line">          parseEndTag(endTagMatch[1], curIndex, index)</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Start tag: 开始标签</span><br><span class="line">        const startTagMatch &#x3D; parseStartTag()</span><br><span class="line">        if (startTagMatch) &#123;</span><br><span class="line">          handleStartTag(startTagMatch)</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      let text, rest, next</span><br><span class="line">      if (textEnd &gt;&#x3D; 0) &#123; &#x2F;&#x2F; 第二次进这里 去除换行符</span><br><span class="line">        rest &#x3D; html.slice(textEnd)</span><br><span class="line">        while (</span><br><span class="line">          !endTag.test(rest) &amp;&amp; &#x2F;&#x2F; 不是结束标签</span><br><span class="line">          !startTagOpen.test(rest) &amp;&amp; &#x2F;&#x2F; 不是开始标签</span><br><span class="line">          !comment.test(rest) &amp;&amp; &#x2F;&#x2F; 不是注释</span><br><span class="line">          !conditionalComment.test(rest) &#x2F;&#x2F; 不是![</span><br><span class="line">        ) &#123;</span><br><span class="line">          &#x2F;&#x2F; &lt; in plain text, be forgiving and treat it as text</span><br><span class="line">          &#x2F;&#x2F; &lt;可能会存在文本中，fds&quot;&lt;&quot;fasdf,但在chrome里&lt;会被转化为&lt;</span><br><span class="line">          &#x2F;&#x2F; 目前还不清楚怎么进这个条件</span><br><span class="line">          &#x2F;&#x2F; 不过这里的最终目的还是为了找到最近的并且是标签的&lt;</span><br><span class="line">          next &#x3D; rest.indexOf(&#39;&lt;&#39;, 1)</span><br><span class="line">          if (next &lt; 0) break</span><br><span class="line">          textEnd +&#x3D; next</span><br><span class="line">          rest &#x3D; html.slice(textEnd)</span><br><span class="line">        &#125;</span><br><span class="line">        text &#x3D; html.substring(0, textEnd)</span><br><span class="line">        advance(textEnd)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (textEnd &lt; 0) &#123;</span><br><span class="line">        text &#x3D; html</span><br><span class="line">        html &#x3D; &#39;&#39;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (options.chars &amp;&amp; text) &#123; &#x2F;&#x2F; 本例第二次loop进入这里</span><br><span class="line">        options.chars(text)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      var stackedTag &#x3D; lastTag.toLowerCase()</span><br><span class="line">      var reStackedTag &#x3D; reCache[stackedTag] || (reCache[stackedTag] &#x3D; new RegExp(&#39;([\\s\\S]*?)(&lt;&#x2F;&#39; + stackedTag + &#39;[^&gt;]*&gt;)&#39;, &#39;i&#39;))</span><br><span class="line">      var endTagLength &#x3D; 0</span><br><span class="line">      var rest &#x3D; html.replace(reStackedTag, function (all, text, endTag) &#123;</span><br><span class="line">        endTagLength &#x3D; endTag.length</span><br><span class="line">        if (!isPlainTextElement(stackedTag) &amp;&amp; stackedTag !&#x3D;&#x3D; &#39;noscript&#39;) &#123;</span><br><span class="line">          text &#x3D; text</span><br><span class="line">            .replace(&#x2F;&lt;!--([\s\S]*?)--&gt;&#x2F;g, &#39;$1&#39;)</span><br><span class="line">            .replace(&#x2F;&lt;!\[CDATA\[([\s\S]*?)]]&gt;&#x2F;g, &#39;$1&#39;)</span><br><span class="line">        &#125;</span><br><span class="line">        if (options.chars) &#123;</span><br><span class="line">          options.chars(text)</span><br><span class="line">        &#125;</span><br><span class="line">        return &#39;&#39;</span><br><span class="line">      &#125;)</span><br><span class="line">      index +&#x3D; html.length - rest.length</span><br><span class="line">      html &#x3D; rest</span><br><span class="line">      parseEndTag(stackedTag, index - endTagLength, index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (html &#x3D;&#x3D;&#x3D; last) &#123;</span><br><span class="line">      options.chars &amp;&amp; options.chars(html)</span><br><span class="line">      if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; !stack.length &amp;&amp; options.warn) &#123;</span><br><span class="line">        options.warn(&#96;Mal-formatted tag at end of template: &quot;$&#123;html&#125;&quot;&#96;)</span><br><span class="line">      &#125;</span><br><span class="line">      break</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Clean up any remaining tags</span><br><span class="line">  parseEndTag()</span><br><span class="line"></span><br><span class="line">  function advance (n) &#123;</span><br><span class="line">    index +&#x3D; n</span><br><span class="line">    html &#x3D; html.substring(n)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function parseStartTag () &#123;</span><br><span class="line">    &#x2F;&#x2F; match在不加g的时候同exec方法</span><br><span class="line">    &#x2F;&#x2F; 0返回匹配，1返回正则括号里的匹配</span><br><span class="line">    const start &#x3D; html.match(startTagOpen)</span><br><span class="line">    if (start) &#123;</span><br><span class="line">      const match &#x3D; &#123;</span><br><span class="line">        tagName: start[1],</span><br><span class="line">        attrs: [],</span><br><span class="line">        start: index</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; 给index重新赋值并且截取html模板</span><br><span class="line">      advance(start[0].length)</span><br><span class="line">      let end, attr</span><br><span class="line">      &#x2F;&#x2F; end匹配&gt;,attr获取标签的属性(id,class等)</span><br><span class="line">      &#x2F;&#x2F; attr并不能一次性获取全部属性，而是通过不断的遍历和截取字符窜每次获取一组属性</span><br><span class="line">      &#x2F;&#x2F; 这个匹配正则需要研究一下</span><br><span class="line">      &#x2F;&#x2F; &#x2F;^\s*([^\s&quot;&#39;&lt;&gt;\&#x2F;&#x3D;]+)(?:\s*((?:&#x3D;))\s*(?:&quot;([^&quot;]*)&quot;+|&#39;([^&#39;]*)&#39;+|([^\s&quot;&#39;&#x3D;&lt;&gt;&#96;]+)))?&#x2F;</span><br><span class="line">      &#x2F;&#x2F; 3,4,5分别匹配了id&#x3D;&quot;app&quot;|id&#x3D;&#39;app&#39;|id&#x3D;app 三种属性书写格式</span><br><span class="line">      &#x2F;&#x2F; 当匹配到末尾标签&gt;时跳出循环</span><br><span class="line">      while (!(end &#x3D; html.match(startTagClose)) &amp;&amp; (attr &#x3D; html.match(attribute))) &#123;</span><br><span class="line">        advance(attr[0].length)</span><br><span class="line">        match.attrs.push(attr)</span><br><span class="line">      &#125;</span><br><span class="line">      if (end) &#123;</span><br><span class="line">        &#x2F;&#x2F; 单标签斜杠</span><br><span class="line">        match.unarySlash &#x3D; end[1]</span><br><span class="line">        advance(end[0].length)</span><br><span class="line">        match.end &#x3D; index &#x2F;&#x2F; 末尾index</span><br><span class="line">        return match</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function handleStartTag (match) &#123;</span><br><span class="line">    const tagName &#x3D; match.tagName</span><br><span class="line">    const unarySlash &#x3D; match.unarySlash</span><br><span class="line"></span><br><span class="line">    if (expectHTML) &#123;</span><br><span class="line">      &#x2F;&#x2F; 判断了p和 不是段落标签 (这是标签嵌套规范，可以自行搜索)</span><br><span class="line">      if (lastTag &#x3D;&#x3D;&#x3D; &#39;p&#39; &amp;&amp; isNonPhrasingTag(tagName)) &#123;</span><br><span class="line">        parseEndTag(lastTag)</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 可以不闭合的标签</span><br><span class="line">      if (canBeLeftOpenTag(tagName) &amp;&amp; lastTag &#x3D;&#x3D;&#x3D; tagName) &#123;</span><br><span class="line">        parseEndTag(tagName)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否单标签</span><br><span class="line">    const unary &#x3D; isUnaryTag(tagName) || tagName &#x3D;&#x3D;&#x3D; &#39;html&#39; &amp;&amp; lastTag &#x3D;&#x3D;&#x3D; &#39;head&#39; || !!unarySlash</span><br><span class="line"></span><br><span class="line">    const l &#x3D; match.attrs.length</span><br><span class="line">    const attrs &#x3D; new Array(l)</span><br><span class="line">    for (let i &#x3D; 0; i &lt; l; i++) &#123;</span><br><span class="line">      const args &#x3D; match.attrs[i]</span><br><span class="line">      &#x2F;&#x2F; hackish work around FF bug https:&#x2F;&#x2F;bugzilla.mozilla.org&#x2F;show_bug.cgi?id&#x3D;369778</span><br><span class="line">      if (IS_REGEX_CAPTURING_BROKEN &amp;&amp; args[0].indexOf(&#39;&quot;&quot;&#39;) &#x3D;&#x3D;&#x3D; -1) &#123;</span><br><span class="line">        if (args[3] &#x3D;&#x3D;&#x3D; &#39;&#39;) &#123; delete args[3] &#125;</span><br><span class="line">        if (args[4] &#x3D;&#x3D;&#x3D; &#39;&#39;) &#123; delete args[4] &#125;</span><br><span class="line">        if (args[5] &#x3D;&#x3D;&#x3D; &#39;&#39;) &#123; delete args[5] &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      const value &#x3D; args[3] || args[4] || args[5] || &#39;&#39;</span><br><span class="line">      attrs[i] &#x3D; &#123;</span><br><span class="line">        name: args[1],</span><br><span class="line">        value: decodeAttr(</span><br><span class="line">          value,</span><br><span class="line">          options.shouldDecodeNewlines &#x2F;&#x2F; ie才会出的问题，其他浏览器没有</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 不是单标签就添加到stack数组</span><br><span class="line">    if (!unary) &#123;</span><br><span class="line">      stack.push(&#123; tag: tagName, lowerCasedTag: tagName.toLowerCase(), attrs: attrs &#125;)</span><br><span class="line">      lastTag &#x3D; tagName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (options.start) &#123; &#x2F;&#x2F; 这里调用start方法，回到start函数</span><br><span class="line">      options.start(tagName, attrs, unary, match.start, match.end)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function parseEndTag (tagName, start, end) &#123;</span><br><span class="line">    let pos, lowerCasedTagName</span><br><span class="line">    if (start &#x3D;&#x3D; null) start &#x3D; index</span><br><span class="line">    if (end &#x3D;&#x3D; null) end &#x3D; index</span><br><span class="line"></span><br><span class="line">    if (tagName) &#123;</span><br><span class="line">      lowerCasedTagName &#x3D; tagName.toLowerCase()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Find the closest opened tag of the same type</span><br><span class="line">    &#x2F;&#x2F; 找到最近的相同标签</span><br><span class="line">    if (tagName) &#123;</span><br><span class="line">      for (pos &#x3D; stack.length - 1; pos &gt;&#x3D; 0; pos--) &#123;</span><br><span class="line">        if (stack[pos].lowerCasedTag &#x3D;&#x3D;&#x3D; lowerCasedTagName) &#123;</span><br><span class="line">          break</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; If no tag name is provided, clean shop</span><br><span class="line">      pos &#x3D; 0</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (pos &gt;&#x3D; 0) &#123;</span><br><span class="line">      &#x2F;&#x2F; Close all the open elements, up the stack</span><br><span class="line">      &#x2F;&#x2F;</span><br><span class="line">      for (let i &#x3D; stack.length - 1; i &gt;&#x3D; pos; i--) &#123;</span><br><span class="line">        if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp;</span><br><span class="line">            (i &gt; pos || !tagName) &amp;&amp;</span><br><span class="line">            options.warn) &#123;</span><br><span class="line">          &#x2F;&#x2F; 没有对应的结束标签</span><br><span class="line">          options.warn(</span><br><span class="line">            &#96;tag &lt;$&#123;stack[i].tag&#125;&gt; has no matching end tag.&#96;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        if (options.end) &#123;</span><br><span class="line">          options.end(stack[i].tag, start, end)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; Remove the open elements from the stack</span><br><span class="line">      &#x2F;&#x2F; 删除最后一个</span><br><span class="line">      stack.length &#x3D; pos</span><br><span class="line">      &#x2F;&#x2F; lastTag变成最后一个</span><br><span class="line">      lastTag &#x3D; pos &amp;&amp; stack[pos - 1].tag</span><br><span class="line">    &#125; else if (lowerCasedTagName &#x3D;&#x3D;&#x3D; &#39;br&#39;) &#123;</span><br><span class="line">      if (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], true, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (lowerCasedTagName &#x3D;&#x3D;&#x3D; &#39;p&#39;) &#123;</span><br><span class="line">      if (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], false, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">      if (options.end) &#123;</span><br><span class="line">        options.end(tagName, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>parse 返回了一个 ast 树，所有的节点都经过了最基础的处理。<br>然后是<code>optimize(ast, options)</code></p>
<p><code>optimize</code>在 src/compiler/optimizer.js</p>
<p><code>optimize</code>的作用是找出 ast 树里面的静态节点(节点是静态文本也没有 v 事件绑定)和静态根节点(节点下的所有子节点都是静态节点)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Goal of the optimizer: walk the generated template AST tree</span><br><span class="line"> * and detect sub-trees that are purely static, i.e. parts of</span><br><span class="line"> * the DOM that never needs to change.</span><br><span class="line"> * 找出ast里面的静态节点，然后不需要重复的取处理他们(因为他们是静态的不会改变的)</span><br><span class="line"> *</span><br><span class="line"> * Once we detect these sub-trees, we can:</span><br><span class="line"> *</span><br><span class="line"> * 1. Hoist them into constants, so that we no longer need to</span><br><span class="line"> *    create fresh nodes for them on each re-render;</span><br><span class="line"> * 2. Completely skip them in the patching process.</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function optimize (root: ?ASTElement, options: CompilerOptions) &#123;</span><br><span class="line">  if (!root) return</span><br><span class="line">  isStaticKey &#x3D; genStaticKeysCached(options.staticKeys || &#39;&#39;)</span><br><span class="line">  isPlatformReservedTag &#x3D; options.isReservedTag || no</span><br><span class="line">  &#x2F;&#x2F; first pass: mark all non-static nodes.</span><br><span class="line">  &#x2F;&#x2F; 标记节点是否静态</span><br><span class="line">  markStatic(root)</span><br><span class="line">  &#x2F;&#x2F; second pass: mark static roots.</span><br><span class="line">  &#x2F;&#x2F; 标记是否是静态根节点</span><br><span class="line">  markStaticRoots(root, false)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function markStatic (node: ASTNode) &#123;</span><br><span class="line">  node.static &#x3D; isStatic(node)</span><br><span class="line">  if (node.type &#x3D;&#x3D;&#x3D; 1) &#123;</span><br><span class="line">    &#x2F;&#x2F; do not make component slot content static. this avoids</span><br><span class="line">    &#x2F;&#x2F; 1. components not able to mutate slot nodes</span><br><span class="line">    &#x2F;&#x2F; 2. static slot content fails for hot-reloading</span><br><span class="line">    if (</span><br><span class="line">      !isPlatformReservedTag(node.tag) &amp;&amp;</span><br><span class="line">      node.tag !&#x3D;&#x3D; &#39;slot&#39; &amp;&amp;</span><br><span class="line">      node.attrsMap[&#39;inline-template&#39;] &#x3D;&#x3D; null</span><br><span class="line">    ) &#123;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line">    for (let i &#x3D; 0, l &#x3D; node.children.length; i &lt; l; i++) &#123;</span><br><span class="line">      const child &#x3D; node.children[i]</span><br><span class="line">      markStatic(child)</span><br><span class="line">      if (!child.static) &#123;</span><br><span class="line">        node.static &#x3D; false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function isStatic (node: ASTNode): boolean &#123;</span><br><span class="line">  if (node.type &#x3D;&#x3D;&#x3D; 2) &#123; &#x2F;&#x2F; expression 有表达式就不是</span><br><span class="line">    return false</span><br><span class="line">  &#125;</span><br><span class="line">  if (node.type &#x3D;&#x3D;&#x3D; 3) &#123; &#x2F;&#x2F; text &#x2F;&#x2F; 文本就是</span><br><span class="line">    return true</span><br><span class="line">  &#125;</span><br><span class="line">  return !!(node.pre || ( &#x2F;&#x2F; v-pre不做编译，是</span><br><span class="line">    !node.hasBindings &amp;&amp; &#x2F;&#x2F; no dynamic bindings 没有动态绑定</span><br><span class="line">    !node.if &amp;&amp; !node.for &amp;&amp; &#x2F;&#x2F; not v-if or v-for or v-else</span><br><span class="line">    !isBuiltInTag(node.tag) &amp;&amp; &#x2F;&#x2F; not a built-in</span><br><span class="line">    isPlatformReservedTag(node.tag) &amp;&amp; &#x2F;&#x2F; not a component</span><br><span class="line">    !isDirectChildOfTemplateFor(node) &amp;&amp; &#x2F;&#x2F; template没有for</span><br><span class="line">    Object.keys(node).every(isStaticKey) &#x2F;&#x2F; 节点的属性只能是isStaticKey里面那几个</span><br><span class="line">  ))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function markStaticRoots (node: ASTNode, isInFor: boolean) &#123;</span><br><span class="line">  if (node.type &#x3D;&#x3D;&#x3D; 1) &#123;</span><br><span class="line">    if (node.static || node.once) &#123;</span><br><span class="line">      node.staticInFor &#x3D; isInFor</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; For a node to qualify as a static root, it should have children that</span><br><span class="line">    &#x2F;&#x2F; are not just static text. Otherwise the cost of hoisting out will</span><br><span class="line">    &#x2F;&#x2F; outweigh the benefits and it&#39;s better off to just always render it fresh.</span><br><span class="line">    if (node.static &amp;&amp; node.children.length &amp;&amp; !( &#x2F;&#x2F; 该节点静态</span><br><span class="line">      node.children.length &#x3D;&#x3D;&#x3D; 1 &amp;&amp; &#x2F;&#x2F; 节点只有一个子节点</span><br><span class="line">      node.children[0].type &#x3D;&#x3D;&#x3D; 3 &#x2F;&#x2F; 子节点是文本节点</span><br><span class="line">    )) &#123;</span><br><span class="line">      node.staticRoot &#x3D; true</span><br><span class="line">      return</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      node.staticRoot &#x3D; false</span><br><span class="line">    &#125;</span><br><span class="line">    if (node.children) &#123; &#x2F;&#x2F; 有多个子节点就进行循环递归判断</span><br><span class="line">      for (let i &#x3D; 0, l &#x3D; node.children.length; i &lt; l; i++) &#123;</span><br><span class="line">        markStaticRoots(node.children[i], isInFor || !!node.for)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (node.ifConditions) &#123;</span><br><span class="line">      walkThroughConditionsBlocks(node.ifConditions, isInFor)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/my-notes/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/my-notes/">1</a><span class="space">&hellip;</span><a class="page-number" href="/my-notes/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/my-notes/page/6/">6</a><a class="page-number" href="/my-notes/page/7/">7</a><a class="extend next" rel="next" href="/my-notes/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">lokve</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/my-notes/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/my-notes/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lokve</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/my-notes/lib/anime.min.js"></script>
  <script src="/my-notes/lib/velocity/velocity.min.js"></script>
  <script src="/my-notes/lib/velocity/velocity.ui.min.js"></script>

<script src="/my-notes/js/utils.js"></script>

<script src="/my-notes/js/motion.js"></script>


<script src="/my-notes/js/schemes/pisces.js"></script>


<script src="/my-notes/js/next-boot.js"></script>




  




  
<script src="/my-notes/js/local-search.js"></script>













  

  

</body>
</html>
