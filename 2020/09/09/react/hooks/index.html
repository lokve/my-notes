



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/my-notes/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/my-notes/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="学习笔记" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="学习笔记" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="学习笔记" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/my-notes/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="react源码解析" />


<link rel="canonical" href="http://example.com/2020/09/09/react/hooks/">



  <title>
hooks - react |
hee note = 学习笔记</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">hooks
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2020-09-09 14:00:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2020-09-09T14:00:00+08:00">2020-09-09</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>20k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>19 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/my-notes/" rel="start">hee note</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipevgoki5j20zk0m84qp.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicmnywqgpj20zk0m8dwx.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclxp31goj20zk0m8qv5.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclhpw3lwj20zk0m8gvw.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicm07ih54j20zk0m84qp.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicljitigmj20zk0m87fp.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/my-notes/">首页</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/my-notes/categories/react/" itemprop="item" rel="index" title="分类于 react"><span itemprop="name">react</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/09/react/hooks/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/my-notes/images/head.jpeg">
    <meta itemprop="name" content="lokve">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="学习笔记">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p>在 <code>renderWithHooks</code>  中添加了方法，调用的 mount 或者 uodate 的 hooks 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> =</span><br><span class="line">        nextCurrentHook === <span class="literal">null</span> ? <span class="title class_">HooksDispatcherOnMount</span> : <span class="title class_">HooksDispatcherOnUpdate</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行函数，得到children</span></span><br><span class="line"><span class="keyword">let</span> children = <span class="title class_">Component</span>(props, refOrContext);</span><br></pre></td></tr></table></figure>
<h2 id="公共"><a class="markdownIt-Anchor" href="#公共">#</a> 公共</h2>
<h3 id="mountworkinprogresshook"><a class="markdownIt-Anchor" href="#mountworkinprogresshook">#</a> mountWorkInProgressHook</h3>
<p>基于这个方法，所有的 hooks 都在一条链上</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountWorkInProgressHook</span>(<span class="params"></span>): <span class="title class_">Hook</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">hook</span>: <span class="title class_">Hook</span> = &#123;</span><br><span class="line">        <span class="attr">memoizedState</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">        <span class="attr">baseState</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">queue</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">baseUpdate</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">        <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// This is the first hook in the list</span></span><br><span class="line">        firstWorkInProgressHook = workInProgressHook = hook;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Append to the end of the list</span></span><br><span class="line">        workInProgressHook = workInProgressHook.<span class="property">next</span> = hook;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="updateworkinprogresshook"><a class="markdownIt-Anchor" href="#updateworkinprogresshook">#</a> updateWorkInProgressHook</h3>
<p>在跟新时都有用到，用来记录当前工作的 hook 和 next hook</p>
<p>并返回一个 clone hook</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateWorkInProgressHook</span>(<span class="params"></span>): <span class="title class_">Hook</span> &#123;</span><br><span class="line">    <span class="comment">// This function is used both for updates and for re-renders triggered by a</span></span><br><span class="line">    <span class="comment">// render phase update. It assumes there is either a current hook we can</span></span><br><span class="line">    <span class="comment">// clone, or a work-in-progress hook from a previous render pass that we can</span></span><br><span class="line">    <span class="comment">// use as a base. When we reach the end of the base list, we must switch to</span></span><br><span class="line">    <span class="comment">// the dispatcher used for mounts.</span></span><br><span class="line">    <span class="keyword">if</span> (nextWorkInProgressHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// There&#x27;s already a work-in-progress. Reuse it.</span></span><br><span class="line">        workInProgressHook = nextWorkInProgressHook;</span><br><span class="line">        nextWorkInProgressHook = workInProgressHook.<span class="property">next</span>;</span><br><span class="line"></span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line">        nextCurrentHook = currentHook !== <span class="literal">null</span> ? currentHook.<span class="property">next</span> : <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Clone from the current hook.</span></span><br><span class="line">        <span class="title function_">invariant</span>(nextCurrentHook !== <span class="literal">null</span>, <span class="string">&#x27;Rendered more hooks than during the previous render.&#x27;</span>);</span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="attr">newHook</span>: <span class="title class_">Hook</span> = &#123;</span><br><span class="line">            <span class="attr">memoizedState</span>: currentHook.<span class="property">memoizedState</span>,</span><br><span class="line"></span><br><span class="line">            <span class="attr">baseState</span>: currentHook.<span class="property">baseState</span>,</span><br><span class="line">            <span class="attr">queue</span>: currentHook.<span class="property">queue</span>,</span><br><span class="line">            <span class="attr">baseUpdate</span>: currentHook.<span class="property">baseUpdate</span>,</span><br><span class="line"></span><br><span class="line">            <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is the first hook in the list.</span></span><br><span class="line">            workInProgressHook = firstWorkInProgressHook = newHook;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Append to the end of the list.</span></span><br><span class="line">            workInProgressHook = workInProgressHook.<span class="property">next</span> = newHook;</span><br><span class="line">        &#125;</span><br><span class="line">        nextCurrentHook = currentHook.<span class="property">next</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="方法绑定"><a class="markdownIt-Anchor" href="#方法绑定">#</a> 方法绑定</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 应该是错误处理</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ContextOnlyDispatcher</span>: <span class="title class_">Dispatcher</span> = &#123;</span><br><span class="line">    readContext,</span><br><span class="line"></span><br><span class="line">    <span class="attr">useCallback</span>: throwInvalidHookError,</span><br><span class="line">    <span class="attr">useContext</span>: throwInvalidHookError,</span><br><span class="line">    <span class="attr">useEffect</span>: throwInvalidHookError,</span><br><span class="line">    <span class="attr">useImperativeHandle</span>: throwInvalidHookError,</span><br><span class="line">    <span class="attr">useLayoutEffect</span>: throwInvalidHookError,</span><br><span class="line">    <span class="attr">useMemo</span>: throwInvalidHookError,</span><br><span class="line">    <span class="attr">useReducer</span>: throwInvalidHookError,</span><br><span class="line">    <span class="attr">useRef</span>: throwInvalidHookError,</span><br><span class="line">    <span class="attr">useState</span>: throwInvalidHookError,</span><br><span class="line">    <span class="attr">useDebugValue</span>: throwInvalidHookError,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化用</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HooksDispatcherOnMount</span>: <span class="title class_">Dispatcher</span> = &#123;</span><br><span class="line">    readContext,</span><br><span class="line"></span><br><span class="line">    <span class="attr">useCallback</span>: mountCallback,</span><br><span class="line">    <span class="attr">useContext</span>: readContext,</span><br><span class="line">    <span class="attr">useEffect</span>: mountEffect,</span><br><span class="line">    <span class="attr">useImperativeHandle</span>: mountImperativeHandle,</span><br><span class="line">    <span class="attr">useLayoutEffect</span>: mountLayoutEffect,</span><br><span class="line">    <span class="attr">useMemo</span>: mountMemo,</span><br><span class="line">    <span class="attr">useReducer</span>: mountReducer,</span><br><span class="line">    <span class="attr">useRef</span>: mountRef,</span><br><span class="line">    <span class="attr">useState</span>: mountState,</span><br><span class="line">    <span class="attr">useDebugValue</span>: mountDebugValue,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跟新用</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HooksDispatcherOnUpdate</span>: <span class="title class_">Dispatcher</span> = &#123;</span><br><span class="line">    readContext,</span><br><span class="line"></span><br><span class="line">    <span class="attr">useCallback</span>: updateCallback,</span><br><span class="line">    <span class="attr">useContext</span>: readContext,</span><br><span class="line">    <span class="attr">useEffect</span>: updateEffect,</span><br><span class="line">    <span class="attr">useImperativeHandle</span>: updateImperativeHandle,</span><br><span class="line">    <span class="attr">useLayoutEffect</span>: updateLayoutEffect,</span><br><span class="line">    <span class="attr">useMemo</span>: updateMemo,</span><br><span class="line">    <span class="attr">useReducer</span>: updateReducer,</span><br><span class="line">    <span class="attr">useRef</span>: updateRef,</span><br><span class="line">    <span class="attr">useState</span>: updateState,</span><br><span class="line">    <span class="attr">useDebugValue</span>: updateDebugValue,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="useref"><a class="markdownIt-Anchor" href="#useref">#</a> useRef</h2>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useRef</span>(<span class="params">initialValue</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> dispatcher = <span class="title function_">resolveDispatcher</span>();</span><br><span class="line">    <span class="keyword">return</span> dispatcher.<span class="title function_">useRef</span>(initialValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveDispatcher</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> dispatcher = <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span>;</span><br><span class="line">    !(dispatcher !== <span class="literal">null</span>)</span><br><span class="line">        ? <span class="title function_">invariant</span>(</span><br><span class="line">              <span class="literal">false</span>,</span><br><span class="line">              <span class="string">&#x27;Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for one of the following reasons:\n1. You might have mismatching versions of React and the renderer (such as React DOM)\n2. You might be breaking the Rules of Hooks\n3. You might have more than one copy of React in the same app\nSee https://fb.me/react-invalid-hook-call for tips about how to debug and fix this problem.&#x27;</span>,</span><br><span class="line">          )</span><br><span class="line">        : <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> dispatcher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化"><a class="markdownIt-Anchor" href="#初始化">#</a> 初始化</h3>
<p>然后进入 <code>dispatcher.useRef</code>  即 <code>mountRef</code></p>
<h4 id="mountref"><a class="markdownIt-Anchor" href="#mountref">#</a> mountRef</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> mountRef&lt;T&gt;(<span class="attr">initialValue</span>: T): &#123;<span class="attr">current</span>: T&#125; &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">    <span class="keyword">const</span> ref = &#123;<span class="attr">current</span>: initialValue&#125;;</span><br><span class="line">    hook.<span class="property">memoizedState</span> = ref;</span><br><span class="line">    <span class="keyword">return</span> ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="usestate"><a class="markdownIt-Anchor" href="#usestate">#</a> useState</h2>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useState</span>(<span class="params">initialState</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> dispatcher = <span class="title function_">resolveDispatcher</span>();</span><br><span class="line">    <span class="keyword">return</span> dispatcher.<span class="title function_">useState</span>(initialState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化-2"><a class="markdownIt-Anchor" href="#初始化-2">#</a> 初始化</h3>
<p>开始都差不多，进入  <code>dispatcher.useState</code>  即 <code>mountState</code></p>
<h4 id="mountstate"><a class="markdownIt-Anchor" href="#mountstate">#</a> mountState</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> basicStateReducer&lt;S&gt;(<span class="attr">state</span>: S, <span class="attr">action</span>: <span class="title class_">BasicStateAction</span>&lt;S&gt;): S &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span> ? <span class="title function_">action</span>(state) : action;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> mountState&lt;S&gt;(<span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S): [S, <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt;] &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        initialState = <span class="title function_">initialState</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// memoizedState 最新结果</span></span><br><span class="line">    hook.<span class="property">memoizedState</span> = hook.<span class="property">baseState</span> = initialState;</span><br><span class="line">    <span class="keyword">const</span> queue = (hook.<span class="property">queue</span> = &#123;</span><br><span class="line">        <span class="attr">last</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">dispatch</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">lastRenderedReducer</span>: basicStateReducer,</span><br><span class="line">        <span class="attr">lastRenderedState</span>: (<span class="attr">initialState</span>: any),</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 跟新方法</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">dispatch</span>: <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt; = (queue.<span class="property">dispatch</span> = (dispatchAction.<span class="title function_">bind</span>(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="comment">// Flow doesn&#x27;t know this is non-null, but we do.</span></span><br><span class="line">        ((<span class="attr">currentlyRenderingFiber</span>: any): <span class="title class_">Fiber</span>),</span><br><span class="line">        queue,</span><br><span class="line">    ): any));</span><br><span class="line">    <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="执行"><a class="markdownIt-Anchor" href="#执行">#</a> 执行</h3>
<h4 id="dispatchaction"><a class="markdownIt-Anchor" href="#dispatchaction">#</a> dispatchAction</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Object.is polyfill</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">is</span>(<span class="params">x: any, y: any</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        (x === y &amp;&amp; (x !== <span class="number">0</span> || <span class="number">1</span> / x === <span class="number">1</span> / y)) || (x !== x &amp;&amp; y !== y) <span class="comment">// eslint-disable-line no-self-compare</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// action 已经计算好的值，即setXXX的传参,</span></span><br><span class="line"><span class="keyword">function</span> dispatchAction&lt;S, A&gt;(<span class="attr">fiber</span>: <span class="title class_">Fiber</span>, <span class="attr">queue</span>: <span class="title class_">UpdateQueue</span>&lt;S, A&gt;, <span class="attr">action</span>: A) &#123;</span><br><span class="line">    <span class="keyword">const</span> alternate = fiber.<span class="property">alternate</span>;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        fiber === currentlyRenderingFiber ||</span><br><span class="line">        (alternate !== <span class="literal">null</span> &amp;&amp; alternate === currentlyRenderingFiber)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// This is a render phase update. Stash it in a lazily-created map of</span></span><br><span class="line">        <span class="comment">// queue -&gt; linked list of updates. After this render pass, we&#x27;ll restart</span></span><br><span class="line">        <span class="comment">// and apply the stashed updates on top of the work-in-progress hook.</span></span><br><span class="line">        didScheduleRenderPhaseUpdate = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">update</span>: <span class="title class_">Update</span>&lt;S, A&gt; = &#123;</span><br><span class="line">            <span class="attr">expirationTime</span>: renderExpirationTime,</span><br><span class="line">            <span class="attr">suspenseConfig</span>: <span class="literal">null</span>,</span><br><span class="line">            action,</span><br><span class="line">            <span class="attr">eagerReducer</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">eagerState</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (renderPhaseUpdates === <span class="literal">null</span>) &#123;</span><br><span class="line">            renderPhaseUpdates = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> firstRenderPhaseUpdate = renderPhaseUpdates.<span class="title function_">get</span>(queue);</span><br><span class="line">        <span class="keyword">if</span> (firstRenderPhaseUpdate === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            renderPhaseUpdates.<span class="title function_">set</span>(queue, update);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Append the update to the end of the list.</span></span><br><span class="line">            <span class="keyword">let</span> lastRenderPhaseUpdate = firstRenderPhaseUpdate;</span><br><span class="line">            <span class="keyword">while</span> (lastRenderPhaseUpdate.<span class="property">next</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">                lastRenderPhaseUpdate = lastRenderPhaseUpdate.<span class="property">next</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            lastRenderPhaseUpdate.<span class="property">next</span> = update;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (revertPassiveEffectsChange) &#123;</span><br><span class="line">            <span class="title function_">flushPassiveEffects</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> currentTime = <span class="title function_">requestCurrentTime</span>();</span><br><span class="line">        <span class="keyword">const</span> suspenseConfig = <span class="title function_">requestCurrentSuspenseConfig</span>();</span><br><span class="line">        <span class="keyword">const</span> expirationTime = <span class="title function_">computeExpirationForFiber</span>(currentTime, fiber, suspenseConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="attr">update</span>: <span class="title class_">Update</span>&lt;S, A&gt; = &#123;</span><br><span class="line">            expirationTime,</span><br><span class="line">            suspenseConfig,</span><br><span class="line">            action,</span><br><span class="line">            <span class="attr">eagerReducer</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">eagerState</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Append the update to the end of the list.</span></span><br><span class="line">        <span class="keyword">const</span> last = queue.<span class="property">last</span>;</span><br><span class="line">        <span class="keyword">if</span> (last === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is the first update. Create a circular list.</span></span><br><span class="line">            update.<span class="property">next</span> = update;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> first = last.<span class="property">next</span>;</span><br><span class="line">            <span class="keyword">if</span> (first !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Still circular.</span></span><br><span class="line">                update.<span class="property">next</span> = first;</span><br><span class="line">            &#125;</span><br><span class="line">            last.<span class="property">next</span> = update;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// queue里放着就数据，last是新数据</span></span><br><span class="line">        queue.<span class="property">last</span> = update;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            fiber.<span class="property">expirationTime</span> === <span class="title class_">NoWork</span> &amp;&amp;</span><br><span class="line">            (alternate === <span class="literal">null</span> || alternate.<span class="property">expirationTime</span> === <span class="title class_">NoWork</span>)</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// The queue is currently empty, which means we can eagerly compute the</span></span><br><span class="line">            <span class="comment">// next state before entering the render phase. If the new state is the</span></span><br><span class="line">            <span class="comment">// same as the current state, we may be able to bail out entirely.</span></span><br><span class="line">            <span class="keyword">const</span> lastRenderedReducer = queue.<span class="property">lastRenderedReducer</span>;</span><br><span class="line">            <span class="keyword">if</span> (lastRenderedReducer !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> prevDispatcher;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 上一个值</span></span><br><span class="line">                    <span class="keyword">const</span> <span class="attr">currentState</span>: S = (queue.<span class="property">lastRenderedState</span>: any);</span><br><span class="line">                    <span class="comment">// 最新值</span></span><br><span class="line">                    <span class="keyword">const</span> eagerState = <span class="title function_">lastRenderedReducer</span>(currentState, action);</span><br><span class="line">                    <span class="comment">// Stash the eagerly computed state, and the reducer used to compute</span></span><br><span class="line">                    <span class="comment">// it, on the update object. If the reducer hasn&#x27;t changed by the</span></span><br><span class="line">                    <span class="comment">// time we enter the render phase, then the eager state can be used</span></span><br><span class="line">                    <span class="comment">// without calling the reducer again.</span></span><br><span class="line">                    update.<span class="property">eagerReducer</span> = lastRenderedReducer;</span><br><span class="line">                    update.<span class="property">eagerState</span> = eagerState;</span><br><span class="line">                    <span class="comment">// 即Object.is,相同就return</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_">is</span>(eagerState, currentState)) &#123;</span><br><span class="line">                        <span class="comment">// Fast path. We can bail out without scheduling React to re-render.</span></span><br><span class="line">                        <span class="comment">// It&#x27;s still possible that we&#x27;ll need to rebase this update later,</span></span><br><span class="line">                        <span class="comment">// if the component re-renders for a different reason and by that</span></span><br><span class="line">                        <span class="comment">// time the reducer has changed.</span></span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="comment">// Suppress the error. It will throw again in the render phase.</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">                        <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> = prevDispatcher;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 有跟新，就去scheduleWork</span></span><br><span class="line">        <span class="title function_">scheduleWork</span>(fiber, expirationTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="schedulework"><a class="markdownIt-Anchor" href="#schedulework">#</a> scheduleWork</h4>
<p>见 <span class="exturl" data-url="aHR0cDovL3NjaGVkdWxlLm1k">schedule.md</span></p>
<h3 id="跟新"><a class="markdownIt-Anchor" href="#跟新">#</a> 跟新</h3>
<p>跟新时  <code>dispatcher.useState</code>  =  <code>updateState</code></p>
<h4 id="updatestate"><a class="markdownIt-Anchor" href="#updatestate">#</a> updateState</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> updateState&lt;S&gt;(<span class="attr">initialState</span>: (<span class="function">() =&gt;</span> S) | S): [S, <span class="title class_">Dispatch</span>&lt;<span class="title class_">BasicStateAction</span>&lt;S&gt;&gt;] &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">updateReducer</span>(basicStateReducer, (<span class="attr">initialState</span>: any));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> updateReducer&lt;S, I, A&gt;(</span><br><span class="line">    <span class="attr">reducer</span>: <span class="function">(<span class="params">S, A</span>) =&gt;</span> S,</span><br><span class="line">    <span class="attr">initialArg</span>: I,</span><br><span class="line">    init?: <span class="function">(<span class="params">I</span>) =&gt;</span> S,</span><br><span class="line">): [S, <span class="title class_">Dispatch</span>&lt;A&gt;] &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">updateWorkInProgressHook</span>();</span><br><span class="line">    <span class="keyword">const</span> queue = hook.<span class="property">queue</span>;</span><br><span class="line">    <span class="title function_">invariant</span>(</span><br><span class="line">        queue !== <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&#x27;Should have a queue. This is likely a bug in React. Please file an issue.&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    queue.<span class="property">lastRenderedReducer</span> = reducer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (numberOfReRenders &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// This is a re-render. Apply the new render phase updates to the previous</span></span><br><span class="line">        <span class="comment">// work-in-progress hook.</span></span><br><span class="line">        <span class="keyword">const</span> <span class="attr">dispatch</span>: <span class="title class_">Dispatch</span>&lt;A&gt; = (queue.<span class="property">dispatch</span>: any);</span><br><span class="line">        <span class="keyword">if</span> (renderPhaseUpdates !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Render phase updates are stored in a map of queue -&gt; linked list</span></span><br><span class="line">            <span class="keyword">const</span> firstRenderPhaseUpdate = renderPhaseUpdates.<span class="title function_">get</span>(queue);</span><br><span class="line">            <span class="keyword">if</span> (firstRenderPhaseUpdate !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                renderPhaseUpdates.<span class="title function_">delete</span>(queue);</span><br><span class="line">                <span class="keyword">let</span> newState = hook.<span class="property">memoizedState</span>;</span><br><span class="line">                <span class="keyword">let</span> update = firstRenderPhaseUpdate;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="comment">// Process this render phase update. We don&#x27;t have to check the</span></span><br><span class="line">                    <span class="comment">// priority because it will always be the same as the current</span></span><br><span class="line">                    <span class="comment">// render&#x27;s.</span></span><br><span class="line">                    <span class="keyword">const</span> action = update.<span class="property">action</span>;</span><br><span class="line">                    newState = <span class="title function_">reducer</span>(newState, action);</span><br><span class="line">                    update = update.<span class="property">next</span>;</span><br><span class="line">                &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Mark that the fiber performed work, but only if the new state is</span></span><br><span class="line">                <span class="comment">// different from the current state.</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_">is</span>(newState, hook.<span class="property">memoizedState</span>)) &#123;</span><br><span class="line">                    <span class="title function_">markWorkInProgressReceivedUpdate</span>();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                hook.<span class="property">memoizedState</span> = newState;</span><br><span class="line">                <span class="comment">// Don&#x27;t persist the state accumlated from the render phase updates to</span></span><br><span class="line">                <span class="comment">// the base state unless the queue is empty.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Not sure if this is the desired semantics, but it&#x27;s what we</span></span><br><span class="line">                <span class="comment">// do for gDSFP. I can&#x27;t remember why.</span></span><br><span class="line">                <span class="keyword">if</span> (hook.<span class="property">baseUpdate</span> === queue.<span class="property">last</span>) &#123;</span><br><span class="line">                    hook.<span class="property">baseState</span> = newState;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                queue.<span class="property">lastRenderedState</span> = newState;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> [newState, dispatch];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The last update in the entire queue</span></span><br><span class="line">    <span class="keyword">const</span> last = queue.<span class="property">last</span>;</span><br><span class="line">    <span class="comment">// The last update that is part of the base state.</span></span><br><span class="line">    <span class="keyword">const</span> baseUpdate = hook.<span class="property">baseUpdate</span>;</span><br><span class="line">    <span class="keyword">const</span> baseState = hook.<span class="property">baseState</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the first unprocessed update.</span></span><br><span class="line">    <span class="keyword">let</span> first;</span><br><span class="line">    <span class="keyword">if</span> (baseUpdate !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (last !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// For the first update, the queue is a circular linked list where</span></span><br><span class="line">            <span class="comment">// `queue.last.next = queue.first`. Once the first update commits, and</span></span><br><span class="line">            <span class="comment">// the `baseUpdate` is no longer empty, we can unravel the list.</span></span><br><span class="line">            last.<span class="property">next</span> = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        first = baseUpdate.<span class="property">next</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        first = last !== <span class="literal">null</span> ? last.<span class="property">next</span> : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (first !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 新 state 数据</span></span><br><span class="line">        <span class="keyword">let</span> newState = baseState;</span><br><span class="line">        <span class="keyword">let</span> newBaseState = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> newBaseUpdate = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> prevUpdate = baseUpdate;</span><br><span class="line">        <span class="keyword">let</span> update = first;</span><br><span class="line">        <span class="keyword">let</span> didSkip = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> updateExpirationTime = update.<span class="property">expirationTime</span>;</span><br><span class="line">            <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">                <span class="comment">// Priority is insufficient. Skip this update. If this is the first</span></span><br><span class="line">                <span class="comment">// skipped update, the previous update/state is the new base</span></span><br><span class="line">                <span class="comment">// update/state.</span></span><br><span class="line">                <span class="keyword">if</span> (!didSkip) &#123;</span><br><span class="line">                    didSkip = <span class="literal">true</span>;</span><br><span class="line">                    newBaseUpdate = prevUpdate;</span><br><span class="line">                    newBaseState = newState;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Update the remaining priority in the queue.</span></span><br><span class="line">                <span class="keyword">if</span> (updateExpirationTime &gt; remainingExpirationTime) &#123;</span><br><span class="line">                    remainingExpirationTime = updateExpirationTime;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// This update does have sufficient priority.</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Mark the event time of this update as relevant to this render pass.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> This should ideally use the true event time of this update rather than</span></span><br><span class="line">                <span class="comment">// its priority which is a derived and not reverseable value.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> We should skip this update if it was already committed but currently</span></span><br><span class="line">                <span class="comment">// we have no way of detecting the difference between a committed and suspended</span></span><br><span class="line">                <span class="comment">// update here.</span></span><br><span class="line">                <span class="title function_">markRenderEventTimeAndConfig</span>(updateExpirationTime, update.<span class="property">suspenseConfig</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Process this update.</span></span><br><span class="line">                <span class="keyword">if</span> (update.<span class="property">eagerReducer</span> === reducer) &#123;</span><br><span class="line">                    <span class="comment">// If this update was processed eagerly, and its reducer matches the</span></span><br><span class="line">                    <span class="comment">// current reducer, we can use the eagerly computed state.</span></span><br><span class="line">                    newState = ((update.<span class="property">eagerState</span>: any): S);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> action = update.<span class="property">action</span>;</span><br><span class="line">                    newState = <span class="title function_">reducer</span>(newState, action);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            prevUpdate = update;</span><br><span class="line">            update = update.<span class="property">next</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span> &amp;&amp; update !== first);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!didSkip) &#123;</span><br><span class="line">            newBaseUpdate = prevUpdate;</span><br><span class="line">            newBaseState = newState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mark that the fiber performed work, but only if the new state is</span></span><br><span class="line">        <span class="comment">// different from the current state.</span></span><br><span class="line">        <span class="comment">// 标记fiber已完成工作，前提是新旧数据不同，通过Object.is</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">is</span>(newState, hook.<span class="property">memoizedState</span>)) &#123;</span><br><span class="line">            <span class="title function_">markWorkInProgressReceivedUpdate</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hook.<span class="property">memoizedState</span> = newState;</span><br><span class="line">        hook.<span class="property">baseUpdate</span> = newBaseUpdate;</span><br><span class="line">        hook.<span class="property">baseState</span> = newBaseState;</span><br><span class="line"></span><br><span class="line">        queue.<span class="property">lastRenderedState</span> = newState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">dispatch</span>: <span class="title class_">Dispatch</span>&lt;A&gt; = (queue.<span class="property">dispatch</span>: any);</span><br><span class="line">    <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="updateworkinprogresshook-2"><a class="markdownIt-Anchor" href="#updateworkinprogresshook-2">#</a> updateWorkInProgressHook</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateWorkInProgressHook</span>(<span class="params"></span>): <span class="title class_">Hook</span> &#123;</span><br><span class="line">    <span class="comment">// This function is used both for updates and for re-renders triggered by a</span></span><br><span class="line">    <span class="comment">// render phase update. It assumes there is either a current hook we can</span></span><br><span class="line">    <span class="comment">// clone, or a work-in-progress hook from a previous render pass that we can</span></span><br><span class="line">    <span class="comment">// use as a base. When we reach the end of the base list, we must switch to</span></span><br><span class="line">    <span class="comment">// the dispatcher used for mounts.</span></span><br><span class="line">    <span class="keyword">if</span> (nextWorkInProgressHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// There&#x27;s already a work-in-progress. Reuse it.</span></span><br><span class="line">        workInProgressHook = nextWorkInProgressHook;</span><br><span class="line">        nextWorkInProgressHook = workInProgressHook.<span class="property">next</span>;</span><br><span class="line"></span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line">        nextCurrentHook = currentHook !== <span class="literal">null</span> ? currentHook.<span class="property">next</span> : <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Clone from the current hook.</span></span><br><span class="line">        <span class="title function_">invariant</span>(nextCurrentHook !== <span class="literal">null</span>, <span class="string">&#x27;Rendered more hooks than during the previous render.&#x27;</span>);</span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clone 当前 hook</span></span><br><span class="line">        <span class="keyword">const</span> <span class="attr">newHook</span>: <span class="title class_">Hook</span> = &#123;</span><br><span class="line">            <span class="attr">memoizedState</span>: currentHook.<span class="property">memoizedState</span>,</span><br><span class="line"></span><br><span class="line">            <span class="attr">baseState</span>: currentHook.<span class="property">baseState</span>,</span><br><span class="line">            <span class="attr">queue</span>: currentHook.<span class="property">queue</span>,</span><br><span class="line">            <span class="attr">baseUpdate</span>: currentHook.<span class="property">baseUpdate</span>,</span><br><span class="line"></span><br><span class="line">            <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is the first hook in the list.</span></span><br><span class="line">            workInProgressHook = firstWorkInProgressHook = newHook;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Append to the end of the list.</span></span><br><span class="line">            workInProgressHook = workInProgressHook.<span class="property">next</span> = newHook;</span><br><span class="line">        &#125;</span><br><span class="line">        nextCurrentHook = currentHook.<span class="property">next</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="useeffect"><a class="markdownIt-Anchor" href="#useeffect">#</a> useEffect</h2>
<h3 id="初始化-3"><a class="markdownIt-Anchor" href="#初始化-3">#</a> 初始化</h3>
<h4 id="mounteffect-和-mounteffectimpl"><a class="markdownIt-Anchor" href="#mounteffect-和-mounteffectimpl">#</a> mountEffect 和 mountEffectImpl</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountEffect</span>(<span class="params">create: () =&gt; (() =&gt; <span class="keyword">void</span>) | <span class="keyword">void</span>, deps: <span class="built_in">Array</span>&lt;mixed&gt; | <span class="keyword">void</span> | <span class="literal">null</span></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">mountEffectImpl</span>(</span><br><span class="line">        <span class="title class_">UpdateEffect</span> | <span class="title class_">PassiveEffect</span>, <span class="comment">// 有这两种effect处理</span></span><br><span class="line">        <span class="title class_">UnmountPassive</span> | <span class="title class_">MountPassive</span>, <span class="comment">// 192</span></span><br><span class="line">        create,</span><br><span class="line">        deps,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mountEffectImpl</span>(<span class="params">fiberEffectTag, hookEffectTag, create, deps</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">    <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">    sideEffectTag |= fiberEffectTag;</span><br><span class="line">    hook.<span class="property">memoizedState</span> = <span class="title function_">pushEffect</span>(hookEffectTag, create, <span class="literal">undefined</span>, nextDeps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="pusheffect"><a class="markdownIt-Anchor" href="#pusheffect">#</a> pushEffect</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">pushEffect</span>(<span class="params">tag, create, destroy, deps</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">effect</span>: <span class="title class_">Effect</span> = &#123;</span><br><span class="line">        tag,</span><br><span class="line">        create,</span><br><span class="line">        destroy,</span><br><span class="line">        deps,</span><br><span class="line">        <span class="comment">// Circular</span></span><br><span class="line">        <span class="attr">next</span>: (<span class="attr">null</span>: any),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (componentUpdateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">        componentUpdateQueue = <span class="title function_">createFunctionComponentUpdateQueue</span>();</span><br><span class="line">        componentUpdateQueue.<span class="property">lastEffect</span> = effect.<span class="property">next</span> = effect;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> lastEffect = componentUpdateQueue.<span class="property">lastEffect</span>;</span><br><span class="line">        <span class="keyword">if</span> (lastEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">            componentUpdateQueue.<span class="property">lastEffect</span> = effect.<span class="property">next</span> = effect;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> firstEffect = lastEffect.<span class="property">next</span>;</span><br><span class="line">            lastEffect.<span class="property">next</span> = effect;</span><br><span class="line">            effect.<span class="property">next</span> = firstEffect;</span><br><span class="line">            componentUpdateQueue.<span class="property">lastEffect</span> = effect;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> effect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="执行-2"><a class="markdownIt-Anchor" href="#执行-2">#</a> 执行</h3>
<p>从  <code>commitRoot</code>  开始</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitRoot</span>(<span class="params">root</span>) &#123;</span><br><span class="line">    <span class="comment">// 开始渲染流程</span></span><br><span class="line">    <span class="comment">// debugger;</span></span><br><span class="line">    <span class="comment">// 优先级相关，最后还是运行commitRootImpl</span></span><br><span class="line">    <span class="title function_">runWithPriority</span>(<span class="title class_">ImmediatePriority</span>, commitRootImpl.<span class="title function_">bind</span>(<span class="literal">null</span>, root)); <span class="comment">// 渲染并执行componentDidMount</span></span><br><span class="line">    <span class="comment">// If there are passive effects, schedule a callback to flush them. This goes</span></span><br><span class="line">    <span class="comment">// outside commitRootImpl so that it inherits the priority of the render.</span></span><br><span class="line">    <span class="keyword">if</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        <span class="comment">// 这里是调度管理，先不看，直接进里面</span></span><br><span class="line">        <span class="keyword">const</span> priorityLevel = <span class="title function_">getCurrentPriorityLevel</span>();</span><br><span class="line">        <span class="title function_">scheduleCallback</span>(priorityLevel, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// hooks的useEffect在这里执行,不过是在RequestAnimationFrame里,不好一步追踪到这，只能打断点反追</span></span><br><span class="line">            <span class="title function_">flushPassiveEffects</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="flushpassiveeffects"><a class="markdownIt-Anchor" href="#flushpassiveeffects">#</a> flushPassiveEffects</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">flushPassiveEffects</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (rootWithPendingPassiveEffects === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> root = rootWithPendingPassiveEffects;</span><br><span class="line">    <span class="keyword">const</span> expirationTime = pendingPassiveEffectsExpirationTime;</span><br><span class="line">    rootWithPendingPassiveEffects = <span class="literal">null</span>;</span><br><span class="line">    pendingPassiveEffectsExpirationTime = <span class="title class_">NoWork</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">prevInteractions</span>: <span class="title class_">Set</span>&lt;<span class="title class_">Interaction</span>&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= <span class="title class_">CommitContext</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note: This currently assumes there are no passive effects on the root</span></span><br><span class="line">    <span class="comment">// fiber, because the root is not part of its own effect list. This could</span></span><br><span class="line">    <span class="comment">// change in the future.</span></span><br><span class="line">    <span class="keyword">let</span> effect = root.<span class="property">current</span>.<span class="property">firstEffect</span>;</span><br><span class="line">    <span class="keyword">while</span> (effect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="title function_">commitPassiveHookEffects</span>(effect);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                <span class="title function_">invariant</span>(effect !== <span class="literal">null</span>, <span class="string">&#x27;Should be working on an effect.&#x27;</span>);</span><br><span class="line">                <span class="title function_">captureCommitPhaseError</span>(effect, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        effect = effect.<span class="property">nextEffect</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line">    <span class="title function_">flushSyncCallbackQueue</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If additional passive effects were scheduled, increment a counter. If this</span></span><br><span class="line">    <span class="comment">// exceeds the limit, we&#x27;ll fire a warning.</span></span><br><span class="line">    nestedPassiveUpdateCount =</span><br><span class="line">        rootWithPendingPassiveEffects === <span class="literal">null</span> ? <span class="number">0</span> : nestedPassiveUpdateCount + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="commitpassivehookeffects"><a class="markdownIt-Anchor" href="#commitpassivehookeffects">#</a> commitPassiveHookEffects</h4>
<p>先执行卸载的 <code>return</code> , 在执行本体</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">commitPassiveHookEffects</span>(<span class="params">finishedWork: Fiber</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="title function_">commitHookEffectList</span>(<span class="title class_">UnmountPassive</span>, <span class="title class_">NoHookEffect</span>, finishedWork);</span><br><span class="line">    <span class="title function_">commitHookEffectList</span>(<span class="title class_">NoHookEffect</span>, <span class="title class_">MountPassive</span>, finishedWork);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="commithookeffectlist"><a class="markdownIt-Anchor" href="#commithookeffectlist">#</a> commitHookEffectList</h4>
<p>这个方法在很多地方都有用到，目前已知的从 <code>commitPassiveHookEffects</code>  过来的是 <code>useEffect</code> , 其他未知</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitHookEffectList</span>(<span class="params">unmountTag: number, mountTag: number, finishedWork: Fiber</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">updateQueue</span>: <span class="title class_">FunctionComponentUpdateQueue</span> | <span class="literal">null</span> = (finishedWork.<span class="property">updateQueue</span>: any);</span><br><span class="line">    <span class="keyword">let</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.<span class="property">lastEffect</span> : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> firstEffect = lastEffect.<span class="property">next</span>;</span><br><span class="line">        <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((effect.<span class="property">tag</span> &amp; unmountTag) !== <span class="title class_">NoHookEffect</span>) &#123;</span><br><span class="line">                <span class="comment">// Unmount</span></span><br><span class="line">                <span class="keyword">const</span> destroy = effect.<span class="property">destroy</span>;</span><br><span class="line">                effect.<span class="property">destroy</span> = <span class="literal">undefined</span>;</span><br><span class="line">                <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    <span class="title function_">destroy</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((effect.<span class="property">tag</span> &amp; mountTag) !== <span class="title class_">NoHookEffect</span>) &#123;</span><br><span class="line">                <span class="comment">// Mount</span></span><br><span class="line">                <span class="keyword">const</span> create = effect.<span class="property">create</span>;</span><br><span class="line">                <span class="comment">// return就是destroy</span></span><br><span class="line">                effect.<span class="property">destroy</span> = <span class="title function_">create</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            effect = effect.<span class="property">next</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="更新"><a class="markdownIt-Anchor" href="#更新">#</a> 更新</h3>
<h4 id="updateeffect"><a class="markdownIt-Anchor" href="#updateeffect">#</a> updateEffect</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateEffect</span>(<span class="params">create: () =&gt; (() =&gt; <span class="keyword">void</span>) | <span class="keyword">void</span>, deps: <span class="built_in">Array</span>&lt;mixed&gt; | <span class="keyword">void</span> | <span class="literal">null</span></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">updateEffectImpl</span>(</span><br><span class="line">        <span class="title class_">UpdateEffect</span> | <span class="title class_">PassiveEffect</span>,</span><br><span class="line">        <span class="title class_">UnmountPassive</span> | <span class="title class_">MountPassive</span>,</span><br><span class="line">        create,</span><br><span class="line">        deps,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateEffectImpl</span>(<span class="params">fiberEffectTag, hookEffectTag, create, deps</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">updateWorkInProgressHook</span>();</span><br><span class="line">    <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">    <span class="keyword">let</span> destroy = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> prevEffect = currentHook.<span class="property">memoizedState</span>;</span><br><span class="line">        destroy = prevEffect.<span class="property">destroy</span>;</span><br><span class="line">        <span class="comment">// 判断依赖是否有变，</span></span><br><span class="line">        <span class="keyword">if</span> (nextDeps !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> prevDeps = prevEffect.<span class="property">deps</span>;</span><br><span class="line">            <span class="comment">//  循环依赖，用Object.is</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">areHookInputsEqual</span>(nextDeps, prevDeps)) &#123;</span><br><span class="line">                <span class="comment">// 依赖不变，是NoHookEffect，所以useEffect不执行destroy和create</span></span><br><span class="line">                <span class="title function_">pushEffect</span>(<span class="title class_">NoHookEffect</span>, create, destroy, nextDeps);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 只有依赖有变或者没依赖才有fiberEffectTag标记，不过没发现有什么用</span></span><br><span class="line">    sideEffectTag |= fiberEffectTag;</span><br><span class="line">    hook.<span class="property">memoizedState</span> = <span class="title function_">pushEffect</span>(hookEffectTag, create, destroy, nextDeps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="usecontext"><a class="markdownIt-Anchor" href="#usecontext">#</a> useContext</h2>
<p>context 见 <span class="exturl" data-url="aHR0cDovL2NvbnRleHQubWQ=">context.md</span></p>
<h2 id="usemome"><a class="markdownIt-Anchor" href="#usemome">#</a> useMome</h2>
<h3 id="mountmemo"><a class="markdownIt-Anchor" href="#mountmemo">#</a> mountMemo</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> mountMemo&lt;T&gt;(<span class="attr">nextCreate</span>: <span class="function">() =&gt;</span> T, <span class="attr">deps</span>: <span class="title class_">Array</span>&lt;mixed&gt; | <span class="keyword">void</span> | <span class="literal">null</span>): T &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">    <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">    <span class="keyword">const</span> nextValue = <span class="title function_">nextCreate</span>();</span><br><span class="line">    hook.<span class="property">memoizedState</span> = [nextValue, nextDeps];</span><br><span class="line">    <span class="keyword">return</span> nextValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="updatememo"><a class="markdownIt-Anchor" href="#updatememo">#</a> updateMemo</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> updateMemo&lt;T&gt;(<span class="attr">nextCreate</span>: <span class="function">() =&gt;</span> T, <span class="attr">deps</span>: <span class="title class_">Array</span>&lt;mixed&gt; | <span class="keyword">void</span> | <span class="literal">null</span>): T &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">updateWorkInProgressHook</span>();</span><br><span class="line">    <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">    <span class="keyword">const</span> prevState = hook.<span class="property">memoizedState</span>;</span><br><span class="line">    <span class="keyword">if</span> (prevState !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Assume these are defined. If they&#x27;re not, areHookInputsEqual will warn.</span></span><br><span class="line">        <span class="keyword">if</span> (nextDeps !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 依赖不变，就取旧值</span></span><br><span class="line">            <span class="keyword">const</span> <span class="attr">prevDeps</span>: <span class="title class_">Array</span>&lt;mixed&gt; | <span class="literal">null</span> = prevState[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">areHookInputsEqual</span>(nextDeps, prevDeps)) &#123;</span><br><span class="line">                <span class="keyword">return</span> prevState[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 否则重新执行获得最新值</span></span><br><span class="line">    <span class="keyword">const</span> nextValue = <span class="title function_">nextCreate</span>();</span><br><span class="line">    hook.<span class="property">memoizedState</span> = [nextValue, nextDeps];</span><br><span class="line">    <span class="keyword">return</span> nextValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      <div class="tags">
          <a href="/my-notes/tags/react%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag"><i class="ic i-tag"></i> react源码解析</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2024-01-10 14:46:33" itemprop="dateModified" datetime="2024-01-10T14:46:33+08:00">2024-01-10</time>
  </span>
  <span id="2020/09/09/react/hooks/" class="item leancloud_visitors" data-flag-title="hooks" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/my-notes/images/wechatpay.png" alt="lokve 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/my-notes/images/alipay.png" alt="lokve 支付宝">
        <p>支付宝</p>
      </div>
      
      <div>
        <img data-src="/my-notes/images/paypal.png" alt="lokve 贝宝">
        <p>贝宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>lokve <i class="ic i-at"><em>@</em></i>学习笔记
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2020/09/09/react/hooks/" title="hooks">http://example.com/2020/09/09/react/hooks/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/my-notes/2020/09/09/react/commitRoot/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclhpw3lwj20zk0m8gvw.jpg" title="commitRoot">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> react</span>
  <h3>commitRoot</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/my-notes/2020/09/09/react/reconcileChildFibers/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclhpw3lwj20zk0m8gvw.jpg" title="reconcileChildFibers">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> react</span>
  <h3>reconcileChildFibers</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AC%E5%85%B1"><span class="toc-number">1.</span> <span class="toc-text"> 公共</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mountworkinprogresshook"><span class="toc-number">1.1.</span> <span class="toc-text"> mountWorkInProgressHook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#updateworkinprogresshook"><span class="toc-number">1.2.</span> <span class="toc-text"> updateWorkInProgressHook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E7%BB%91%E5%AE%9A"><span class="toc-number">1.3.</span> <span class="toc-text"> 方法绑定</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#useref"><span class="toc-number">2.</span> <span class="toc-text"> useRef</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.</span> <span class="toc-text"> 初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mountref"><span class="toc-number">2.1.1.</span> <span class="toc-text"> mountRef</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#usestate"><span class="toc-number">3.</span> <span class="toc-text"> useState</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-2"><span class="toc-number">3.1.</span> <span class="toc-text"> 初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mountstate"><span class="toc-number">3.1.1.</span> <span class="toc-text"> mountState</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C"><span class="toc-number">3.2.</span> <span class="toc-text"> 执行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dispatchaction"><span class="toc-number">3.2.1.</span> <span class="toc-text"> dispatchAction</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#schedulework"><span class="toc-number">3.2.2.</span> <span class="toc-text"> scheduleWork</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%9F%E6%96%B0"><span class="toc-number">3.3.</span> <span class="toc-text"> 跟新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#updatestate"><span class="toc-number">3.3.1.</span> <span class="toc-text"> updateState</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#updateworkinprogresshook-2"><span class="toc-number">3.3.2.</span> <span class="toc-text"> updateWorkInProgressHook</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#useeffect"><span class="toc-number">4.</span> <span class="toc-text"> useEffect</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-3"><span class="toc-number">4.1.</span> <span class="toc-text"> 初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mounteffect-%E5%92%8C-mounteffectimpl"><span class="toc-number">4.1.1.</span> <span class="toc-text"> mountEffect 和 mountEffectImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pusheffect"><span class="toc-number">4.1.2.</span> <span class="toc-text"> pushEffect</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C-2"><span class="toc-number">4.2.</span> <span class="toc-text"> 执行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#flushpassiveeffects"><span class="toc-number">4.2.1.</span> <span class="toc-text"> flushPassiveEffects</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#commitpassivehookeffects"><span class="toc-number">4.2.2.</span> <span class="toc-text"> commitPassiveHookEffects</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#commithookeffectlist"><span class="toc-number">4.2.3.</span> <span class="toc-text"> commitHookEffectList</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0"><span class="toc-number">4.3.</span> <span class="toc-text"> 更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#updateeffect"><span class="toc-number">4.3.1.</span> <span class="toc-text"> updateEffect</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#usecontext"><span class="toc-number">5.</span> <span class="toc-text"> useContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#usemome"><span class="toc-number">6.</span> <span class="toc-text"> useMome</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mountmemo"><span class="toc-number">6.1.</span> <span class="toc-text"> mountMemo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#updatememo"><span class="toc-number">6.2.</span> <span class="toc-text"> updateMemo</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/my-notes/2020/09/07/react/1.%E5%88%9D%E5%A7%8B%E6%B5%81%E7%A8%8B/" rel="bookmark" title="初始流程">初始流程</a></li><li><a href="/my-notes/2020/09/07/react/%E5%B8%B8%E9%87%8F/" rel="bookmark" title="常量">常量</a></li><li><a href="/my-notes/2020/09/08/react/%E5%90%84%E7%A7%8D%E5%AF%B9%E8%B1%A1/" rel="bookmark" title="一些对象定义">一些对象定义</a></li><li><a href="/my-notes/2020/09/08/react/%E6%97%B6%E9%97%B4%E8%AE%A1%E7%AE%97/" rel="bookmark" title="时间">时间</a></li><li><a href="/my-notes/2020/09/08/react/fiber/" rel="bookmark" title="fiber">fiber</a></li><li><a href="/my-notes/2020/09/08/react/renderRoot/" rel="bookmark" title="renderRoot">renderRoot</a></li><li><a href="/my-notes/2020/09/09/react/commitRoot/" rel="bookmark" title="commitRoot">commitRoot</a></li><li><a href="/my-notes/2020/09/09/react/completeWork/" rel="bookmark" title="completeWork">completeWork</a></li><li><a href="/my-notes/2020/09/09/react/function%E7%BB%84%E4%BB%B6/" rel="bookmark" title="function组件">function组件</a></li><li><a href="/my-notes/2020/09/09/react/reconcileChildFibers/" rel="bookmark" title="reconcileChildFibers">reconcileChildFibers</a></li><li class="active"><a href="/my-notes/2020/09/09/react/hooks/" rel="bookmark" title="hooks">hooks</a></li><li><a href="/my-notes/2020/09/10/react/%E4%BA%8B%E4%BB%B6/" rel="bookmark" title="事件系统">事件系统</a></li><li><a href="/my-notes/2020/09/10/react/createElement(dom)/" rel="bookmark" title="createElement(dom)">createElement(dom)</a></li><li><a href="/my-notes/2020/09/10/react/createElement(react%20element)/" rel="bookmark" title="createElement(react element)">createElement(react element)</a></li><li><a href="/my-notes/2020/09/10/react/schedule/" rel="bookmark" title="reconcileChildFibers">reconcileChildFibers</a></li><li><a href="/my-notes/2020/09/11/react/context/" rel="bookmark" title="completeWork">completeWork</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="lokve"
      data-src="/my-notes/images/head.jpeg">
  <p class="name" itemprop="name">lokve</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/my-notes/archives/">
        <span class="count">73</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/my-notes/categories/">
        <span class="count">2</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/my-notes/tags/">
        <span class="count">8</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xva3Zl" title="https:&#x2F;&#x2F;github.com&#x2F;lokve"><i class="ic i-github"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/my-notes/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/my-notes/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/my-notes/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/my-notes/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/my-notes/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/my-notes/2020/09/09/react/commitRoot/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/my-notes/2020/09/09/react/reconcileChildFibers/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/my-notes/categories/leetcode/" title="分类于 leetcode">leetcode</a>
</div>

    <span><a href="/my-notes/2024/01/09/leetcode/198.House%20Robber/index/" title="198.House Robber">198.House Robber</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2018/06/07/vue/class/" title="Vue源码阅读笔记 (class,style)">Vue源码阅读笔记 (class,style)</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/my-notes/categories/leetcode/" title="分类于 leetcode">leetcode</a>
</div>

    <span><a href="/my-notes/2024/01/07/leetcode/241.Different%20Ways%20to%20Add%20Parentheses/index/" title="241.Different Ways to Add Parentheses">241.Different Ways to Add Parentheses</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/my-notes/categories/react/" title="分类于 react">react</a>
</div>

    <span><a href="/my-notes/2020/09/09/react/completeWork/" title="completeWork">completeWork</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/my-notes/categories/react/" title="分类于 react">react</a>
</div>

    <span><a href="/my-notes/2020/09/07/react/1.%E5%88%9D%E5%A7%8B%E6%B5%81%E7%A8%8B/" title="初始流程">初始流程</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/my-notes/categories/leetcode/" title="分类于 leetcode">leetcode</a>
</div>

    <span><a href="/my-notes/2024/01/10/leetcode/213.House%20Robber%20II/index/" title="213.House Robber II">213.House Robber II</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2018/05/25/vue/4/" title="Vue源码阅读笔记（4）(compile)">Vue源码阅读笔记（4）(compile)</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2020/09/14/react-redux/%E5%BC%80%E5%A7%8B/" title="流程">流程</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2019/06/14/js%E9%AB%98%E7%BA%A7/23.%E7%A6%BB%E7%BA%BF%E5%BA%94%E7%94%A8%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%82%A8%E5%AD%98/" title="离线应用与客户端储存">离线应用与客户端储存</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2018/01/22/vue/1/" title="Vue源码阅读笔记（1）(从入口文件开始)">Vue源码阅读笔记（1）(从入口文件开始)</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">lokve @ hee note</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">375k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">5:41</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2020/09/09/react/hooks/',
    favicon: {
      show: "（●´3｀●）やれやれだぜ",
      hide: "(´Д｀)大変だ！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/my-notes/js/app.js?v=0.2.5"></script>




</body>
</html>
