



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/my-notes/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/my-notes/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="学习笔记" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="学习笔记" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="学习笔记" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/my-notes/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="Vue笔记" />


<link rel="canonical" href="http://example.com/2018/05/25/vue/4/">



  <title>
Vue源码阅读笔记（4）(compile) |
hee note = 学习笔记</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Vue源码阅读笔记（4）(compile)
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2018-05-25 10:14:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2018-05-25T10:14:00+08:00">2018-05-25</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>23k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>21 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/my-notes/" rel="start">hee note</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://api.ouyangqiqi.cn/dm/img-webp.php?587484"></li>
          <li class="item" data-background-image="https://api.ouyangqiqi.cn/dm/img-webp.php?602971"></li>
          <li class="item" data-background-image="https://api.ouyangqiqi.cn/dm/img-webp.php?364892"></li>
          <li class="item" data-background-image="https://api.ouyangqiqi.cn/dm/img-webp.php?493156"></li>
          <li class="item" data-background-image="https://api.ouyangqiqi.cn/dm/img-webp.php?880002"></li>
          <li class="item" data-background-image="https://api.ouyangqiqi.cn/dm/img-webp.php?355802"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/my-notes/">首页</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://example.com/2018/05/25/vue/4/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/my-notes/images/head.jpeg">
    <meta itemprop="name" content="lokve">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="学习笔记">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdXRhby92dWUyLjAtc291cmNlL2Jsb2IvYmU0YWM3NzVlMjZlZmFlN2I2NGU1MjU0ZTIzYTk3ZDUwYTllODgwYy9jb21waWxlJUU2JUE2JTgyJUU4JUJGJUIwLm1k">参考了的文章</span></p>
<p>从这里开始我会尽可能的把源码里所有的 <code>if</code>  情况考虑进去，还是以一个简单例子开始，之后会不断的把这个例子补充完整，以完成对每一行的解读</p>
<h2 id="开始"><a class="markdownIt-Anchor" href="#开始">#</a> 开始</h2>
<p>模板编译分为三个阶段：生成 ast、优化静态内容、生成 render</p>
<p>以下面代码开始</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id=&quot;app&quot;&gt;</span><br><span class="line">  &lt;p&gt;&#123;&#123;message&#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;../dist/vue.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">  var vm = new Vue(&#123;</span><br><span class="line">    el: &#x27;#app&#x27;,</span><br><span class="line">    data: &#123;</span><br><span class="line">      message: &#x27;第一个vue实例&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<h2 id="正则补充"><a class="markdownIt-Anchor" href="#正则补充">#</a> 正则补充</h2>
<p>这里用到了很多的正则判断，对于一些比较复杂的不清楚的在这里进行说明 (超的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdXRhby92dWUyLjAtc291cmNlL2Jsb2IvYmU0YWM3NzVlMjZlZmFlN2I2NGU1MjU0ZTIzYTk3ZDUwYTllODgwYy9jb21waWxlJUUyJTgwJTk0JUUyJTgwJTk0JUU3JTk0JTlGJUU2JTg4JTkwYXN0Lm1k">参考文章</span>)</p>
<p>代码片段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">while (</span><br><span class="line">  !endTag.test(rest) &amp;&amp;</span><br><span class="line">  !startTagOpen.test(rest) &amp;&amp;</span><br><span class="line">  !comment.test(rest) &amp;&amp;</span><br><span class="line">  !conditionalComment.test(rest)</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>endTag = /<sup>&lt;/((?:[a-zA-Z_][\w-.]_😃?[a-zA-Z_][\w-.]_)[</sup>&gt;]*&gt;/<br>
endTag 是匹配双标签的结束标签。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&lt;/div&gt;&#x27;.match(endTag)</span><br><span class="line">// [&quot;&lt;/div&gt;&quot;, &quot;div&quot;, index: 0, input: &quot;&lt;/div&gt;&quot;]</span><br><span class="line"></span><br><span class="line">&#x27;&lt;/div    &gt;&#x27;.match(endTag)</span><br><span class="line">// [&quot;&lt;/div    &gt;&quot;, &quot;div&quot;, index: 0, input: &quot;&lt;/div    &gt;&quot;]</span><br><span class="line"></span><br><span class="line">&#x27; &lt;/div    &gt;&#x27;.match(endTag)</span><br><span class="line">// null</span><br></pre></td></tr></table></figure>
<p>startTagOpen = /^&lt;((?:[a-zA-Z_][\w-.]<em>😃?[a-zA-Z_][\w-.]</em>)/<br>
 匹配开始标签</p>
<h2 id="compiletofunctions"><a class="markdownIt-Anchor" href="#compiletofunctions">#</a> compileToFunctions</h2>
<p>从 <code>compileToFunctions</code>  开始，路径 <code>/src/compiler/index.js</code> ,<br>
 首先在 mount 方法里有使用到 <code>compileToFunctions</code>  方法，他返回了 render 函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">const &#123; render, staticRenderFns &#125; = compileToFunctions(template, &#123;</span><br><span class="line">    shouldDecodeNewlines,</span><br><span class="line">    delimiters: options.delimiters</span><br><span class="line">&#125;, this)</span><br><span class="line"></span><br><span class="line">function compileToFunctions (</span><br><span class="line">    template: string, // html模板</span><br><span class="line">    options?: CompilerOptions, // 上面的参数</span><br><span class="line">    vm?: Component // vue</span><br><span class="line">  ): CompiledFunctionResult &#123;</span><br><span class="line">    options = options || &#123;&#125;</span><br><span class="line"></span><br><span class="line">    /* istanbul ignore if */</span><br><span class="line">    if (process.env.NODE_ENV !== &#x27;production&#x27;) &#123;</span><br><span class="line">      // detect possible CSP restriction</span><br><span class="line">      try &#123;</span><br><span class="line">        new Function(&#x27;return 1&#x27;)</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        if (e.toString().match(/unsafe-eval|CSP/)) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            &#x27;It seems you are using the standalone build of Vue.js in an &#x27; +</span><br><span class="line">            &#x27;environment with Content Security Policy that prohibits unsafe-eval. &#x27; +</span><br><span class="line">            &#x27;The template compiler cannot work in this environment. Consider &#x27; +</span><br><span class="line">            &#x27;relaxing the policy to allow unsafe-eval or pre-compiling your &#x27; +</span><br><span class="line">            &#x27;templates into render functions.&#x27;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // check cache</span><br><span class="line">    const key = options.delimiters</span><br><span class="line">      ? String(options.delimiters) + template</span><br><span class="line">      : template // key是模板html</span><br><span class="line">    if (functionCompileCache[key]) &#123; // 应该是缓存</span><br><span class="line">      return functionCompileCache[key]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // compile</span><br><span class="line">    const compiled = compile(template, options)</span><br><span class="line"></span><br><span class="line">    // check compilation errors/tips</span><br><span class="line">    if (process.env.NODE_ENV !== &#x27;production&#x27;) &#123;</span><br><span class="line">      if (compiled.errors &amp;&amp; compiled.errors.length) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          `Error compiling template:\n\n$&#123;template&#125;\n\n` +</span><br><span class="line">          compiled.errors.map(e =&gt; `- $&#123;e&#125;`).join(&#x27;\n&#x27;) + &#x27;\n&#x27;,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      if (compiled.tips &amp;&amp; compiled.tips.length) &#123;</span><br><span class="line">        compiled.tips.forEach(msg =&gt; tip(msg, vm))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // turn code into functions</span><br><span class="line">    const res = &#123;&#125;</span><br><span class="line">    const fnGenErrors = []</span><br><span class="line">    res.render = makeFunction(compiled.render, fnGenErrors)</span><br><span class="line">    const l = compiled.staticRenderFns.length</span><br><span class="line">    res.staticRenderFns = new Array(l)</span><br><span class="line">    for (let i = 0; i &lt; l; i++) &#123;</span><br><span class="line">      res.staticRenderFns[i] = makeFunction(compiled.staticRenderFns[i], fnGenErrors)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // check function generation errors.</span><br><span class="line">    // this should only happen if there is a bug in the compiler itself.</span><br><span class="line">    // mostly for codegen development use</span><br><span class="line">    /* istanbul ignore if */</span><br><span class="line">    if (process.env.NODE_ENV !== &#x27;production&#x27;) &#123;</span><br><span class="line">      if ((!compiled.errors || !compiled.errors.length) &amp;&amp; fnGenErrors.length) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          `Failed to generate render function:\n\n` +</span><br><span class="line">          fnGenErrors.map((&#123; err, code &#125;) =&gt; `$&#123;err.toString()&#125; in\n\n$&#123;code&#125;\n`).join(&#x27;\n&#x27;),</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return (functionCompileCache[key] = res)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>具体说明看上面注释</p>
<p>运行到 <code>compile</code> ，我们跟着进去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">function compile (</span><br><span class="line">    template: string,</span><br><span class="line">    options?: CompilerOptions</span><br><span class="line">  ): CompiledResult &#123;</span><br><span class="line">    // finalOptions.prototype = baseOption</span><br><span class="line">    const finalOptions = Object.create(baseOptions)</span><br><span class="line">    const errors = []</span><br><span class="line">    const tips = []</span><br><span class="line">    // 定义了warn方法</span><br><span class="line">    finalOptions.warn = (msg, tip) =&gt; &#123;</span><br><span class="line">      (tip ? tips : errors).push(msg)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (options) &#123;</span><br><span class="line">      // merge custom modules</span><br><span class="line">      // 合并自定义modules</span><br><span class="line">      // TODO 这里的options应该肯定没有这些参数才对啊？下同</span><br><span class="line">      if (options.modules) &#123;</span><br><span class="line">        finalOptions.modules = (baseOptions.modules || []).concat(options.modules)</span><br><span class="line">      &#125;</span><br><span class="line">      // merge custom directives</span><br><span class="line">      // 合并自定义directives</span><br><span class="line">      if (options.directives) &#123;</span><br><span class="line">        finalOptions.directives = extend(</span><br><span class="line">          Object.create(baseOptions.directives),</span><br><span class="line">          options.directives</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      // copy other options</span><br><span class="line">      // 赋值给finalOptions</span><br><span class="line">      for (const key in options) &#123;</span><br><span class="line">        if (key !== &#x27;modules&#x27; &amp;&amp; key !== &#x27;directives&#x27;) &#123;</span><br><span class="line">          finalOptions[key] = options[key]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 把参数带到baseCompile</span><br><span class="line">    const compiled = baseCompile(template, finalOptions)</span><br><span class="line">    if (process.env.NODE_ENV !== &#x27;production&#x27;) &#123;</span><br><span class="line">      errors.push.apply(errors, detectErrors(compiled.ast))</span><br><span class="line">    &#125;</span><br><span class="line">    compiled.errors = errors</span><br><span class="line">    compiled.tips = tips</span><br><span class="line">    return compiled</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>第一句就出现了位置变量，根据 build/alias 的定义以及 web-runtime-with-compiler.js 里面的引用，可以发现在 <code>src/platforms/web/compiler/index.js</code>  里面使用了 createCompiler 方法，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">/* @flow */</span><br><span class="line"></span><br><span class="line">import &#123; isUnaryTag, canBeLeftOpenTag &#125; from &#x27;./util&#x27;</span><br><span class="line">import &#123; genStaticKeys &#125; from &#x27;shared/util&#x27;</span><br><span class="line">import &#123; createCompiler &#125; from &#x27;compiler/index&#x27;</span><br><span class="line"></span><br><span class="line">import modules from &#x27;./modules/index&#x27;</span><br><span class="line">import directives from &#x27;./directives/index&#x27;</span><br><span class="line"></span><br><span class="line">import &#123;</span><br><span class="line">  isPreTag,</span><br><span class="line">  mustUseProp,</span><br><span class="line">  isReservedTag,</span><br><span class="line">  getTagNamespace</span><br><span class="line">&#125; from &#x27;../util/index&#x27;</span><br><span class="line"></span><br><span class="line">export const baseOptions: CompilerOptions = &#123;</span><br><span class="line">  expectHTML: true,</span><br><span class="line">  modules,</span><br><span class="line">  directives,</span><br><span class="line">  isPreTag,</span><br><span class="line">  isUnaryTag,</span><br><span class="line">  mustUseProp,</span><br><span class="line">  canBeLeftOpenTag,</span><br><span class="line">  isReservedTag,</span><br><span class="line">  getTagNamespace,</span><br><span class="line">  staticKeys: genStaticKeys(modules)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const &#123; compile, compileToFunctions &#125; = createCompiler(baseOptions)</span><br><span class="line">export &#123; compile, compileToFunctions &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后 baseOptions 就在这里定义了，具体参数及方法会在用到的时候细看</p>
<p>运行到 <code>baseCompile</code> ，然后进入 <code>parse</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function baseCompile (</span><br><span class="line">  template: string,</span><br><span class="line">  options: CompilerOptions</span><br><span class="line">): CompiledResult &#123;</span><br><span class="line">  const ast = parse(template.trim(), options)</span><br><span class="line">  optimize(ast, options)</span><br><span class="line">  const code = generate(ast, options)</span><br><span class="line">  return &#123;</span><br><span class="line">    ast,</span><br><span class="line">    render: code.render,</span><br><span class="line">    staticRenderFns: code.staticRenderFns</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>parse</code>  在 /src/compiler/parser/index.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Convert HTML string to AST.</span><br><span class="line"> */</span><br><span class="line">export function parse (</span><br><span class="line">  template: string,</span><br><span class="line">  options: CompilerOptions</span><br><span class="line">): ASTElement | void &#123;</span><br><span class="line"></span><br><span class="line">  // warn函数</span><br><span class="line">  warn = options.warn || baseWarn</span><br><span class="line"></span><br><span class="line">  // 获取命名空间，svg和math</span><br><span class="line">  platformGetTagNamespace = options.getTagNamespace || no</span><br><span class="line"></span><br><span class="line">  // 需要使用props绑定的属性，比如value、selected等</span><br><span class="line">  platformMustUseProp = options.mustUseProp || no</span><br><span class="line"></span><br><span class="line">  // 是否是pre标签</span><br><span class="line">  platformIsPreTag = options.isPreTag || no</span><br><span class="line"></span><br><span class="line">  // 取options.modules里有preTransformNode参数的数组，下同</span><br><span class="line">  preTransforms = pluckModuleFunction(options.modules, &#x27;preTransformNode&#x27;)</span><br><span class="line">  transforms = pluckModuleFunction(options.modules, &#x27;transformNode&#x27;)</span><br><span class="line">  postTransforms = pluckModuleFunction(options.modules, &#x27;postTransformNode&#x27;)</span><br><span class="line">  delimiters = options.delimiters</span><br><span class="line"></span><br><span class="line">  const stack = []</span><br><span class="line">  const preserveWhitespace = options.preserveWhitespace !== false</span><br><span class="line">  let root</span><br><span class="line">  let currentParent</span><br><span class="line">  let inVPre = false</span><br><span class="line">  let inPre = false</span><br><span class="line">  let warned = false</span><br><span class="line"></span><br><span class="line">  function warnOnce (msg) &#123;</span><br><span class="line">    if (!warned) &#123;</span><br><span class="line">      warned = true</span><br><span class="line">      warn(msg)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function endPre (element) &#123;</span><br><span class="line">    // check pre state</span><br><span class="line">    if (element.pre) &#123;</span><br><span class="line">      inVPre = false</span><br><span class="line">    &#125;</span><br><span class="line">    if (platformIsPreTag(element.tag)) &#123;</span><br><span class="line">      inPre = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  parseHTML(template, &#123;</span><br><span class="line">    warn,</span><br><span class="line">    expectHTML: options.expectHTML,</span><br><span class="line">    isUnaryTag: options.isUnaryTag,</span><br><span class="line">    canBeLeftOpenTag: options.canBeLeftOpenTag,</span><br><span class="line">    shouldDecodeNewlines: options.shouldDecodeNewlines,</span><br><span class="line">    start (tag, attrs, unary) &#123;</span><br><span class="line">      // check namespace.</span><br><span class="line">      // inherit parent ns if there is one</span><br><span class="line">      // 第一遍还不清楚是啥</span><br><span class="line">      const ns = (currentParent &amp;&amp; currentParent.ns) || platformGetTagNamespace(tag)</span><br><span class="line"></span><br><span class="line">      // handle IE svg bug</span><br><span class="line">      /* istanbul ignore if */</span><br><span class="line">      if (isIE &amp;&amp; ns === &#x27;svg&#x27;) &#123;</span><br><span class="line">        attrs = guardIESVGBug(attrs)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      const element: ASTElement = &#123;</span><br><span class="line">        type: 1,</span><br><span class="line">        tag,</span><br><span class="line">        attrsList: attrs,</span><br><span class="line">        attrsMap: makeAttrsMap(attrs), // 把attr转换成对象，并且检验重复属性</span><br><span class="line">        parent: currentParent,</span><br><span class="line">        children: []</span><br><span class="line">      &#125;</span><br><span class="line">      if (ns) &#123;</span><br><span class="line">        element.ns = ns</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 如果标签是style和script</span><br><span class="line">      if (isForbiddenTag(element) &amp;&amp; !isServerRendering()) &#123;</span><br><span class="line">        element.forbidden = true</span><br><span class="line">        process.env.NODE_ENV !== &#x27;production&#x27; &amp;&amp; warn(</span><br><span class="line">          &#x27;Templates should only be responsible for mapping the state to the &#x27; +</span><br><span class="line">          &#x27;UI. Avoid placing tags with side-effects in your templates, such as &#x27; +</span><br><span class="line">          `&lt;$&#123;tag&#125;&gt;` + &#x27;, as they will not be parsed.&#x27;</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // apply pre-transforms</span><br><span class="line">      for (let i = 0; i &lt; preTransforms.length; i++) &#123;</span><br><span class="line">        preTransforms[i](element, options)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (!inVPre) &#123;</span><br><span class="line">        processPre(element) // 如果标签有v-pre，则element.pre = true</span><br><span class="line">        if (element.pre) &#123;</span><br><span class="line">          inVPre = true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (platformIsPreTag(element.tag)) &#123; // 判断tag是不是pre</span><br><span class="line">        inPre = true</span><br><span class="line">      &#125;</span><br><span class="line">      if (inVPre) &#123;</span><br><span class="line">        processRawAttrs(element)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        processFor(element) // v-for</span><br><span class="line">        processIf(element) // v-if</span><br><span class="line">        processOnce(element) // v-once element.once = true</span><br><span class="line">        processKey(element) // key element.key = i</span><br><span class="line"></span><br><span class="line">        // determine whether this is a plain element after</span><br><span class="line">        // removing structural attributes</span><br><span class="line">        // 不存在其他属性的&#x27;纯&#x27;元素</span><br><span class="line">        element.plain = !element.key &amp;&amp; !attrs.length</span><br><span class="line"></span><br><span class="line">        processRef(element) // ref</span><br><span class="line">        processSlot(element) // slot</span><br><span class="line">        processComponent(element) // is</span><br><span class="line"></span><br><span class="line">        // transforms包含了class和style的处理函数</span><br><span class="line">        // 给element添加了staticClass(class)和classBinding(:class||v-bind:class)属性</span><br><span class="line">        // 给element添加了staticStyle(style)和styleBinding(:style||v-bind:style)属性</span><br><span class="line">        for (let i = 0; i &lt; transforms.length; i++) &#123;</span><br><span class="line">          transforms[i](element, options)</span><br><span class="line">        &#125;</span><br><span class="line">        processAttrs(element) // 处理除了上面的其他属性</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      function checkRootConstraints (el) &#123;</span><br><span class="line">        if (process.env.NODE_ENV !== &#x27;production&#x27;) &#123;</span><br><span class="line">          // slot和template报错提示</span><br><span class="line">          if (el.tag === &#x27;slot&#x27; || el.tag === &#x27;template&#x27;) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              `Cannot use &lt;$&#123;el.tag&#125;&gt; as component root element because it may ` +</span><br><span class="line">              &#x27;contain multiple nodes.&#x27;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          // 根节点不能加v-for报错提示</span><br><span class="line">          if (el.attrsMap.hasOwnProperty(&#x27;v-for&#x27;)) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              &#x27;Cannot use v-for on stateful component root element because &#x27; +</span><br><span class="line">              &#x27;it renders multiple elements.&#x27;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // tree management</span><br><span class="line">      if (!root) &#123; // 第一次进入这个if</span><br><span class="line">        root = element</span><br><span class="line">        checkRootConstraints(root) // 见上面函数</span><br><span class="line">      &#125; else if (!stack.length) &#123;</span><br><span class="line">        // allow root elements with v-if, v-else-if and v-else</span><br><span class="line">        if (root.if &amp;&amp; (element.elseif || element.else)) &#123;</span><br><span class="line">          checkRootConstraints(element)</span><br><span class="line">          addIfCondition(root, &#123;</span><br><span class="line">            exp: element.elseif,</span><br><span class="line">            block: element</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; else if (process.env.NODE_ENV !== &#x27;production&#x27;) &#123;</span><br><span class="line">          warnOnce(</span><br><span class="line">            `Component template should contain exactly one root element. ` +</span><br><span class="line">            `If you are using v-if on multiple elements, ` +</span><br><span class="line">            `use v-else-if to chain them instead.`</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (currentParent &amp;&amp; !element.forbidden) &#123; // 第一次不进if</span><br><span class="line">        if (element.elseif || element.else) &#123;</span><br><span class="line">          processIfConditions(element, currentParent)</span><br><span class="line">        &#125; else if (element.slotScope) &#123; // scoped slot</span><br><span class="line">          currentParent.plain = false</span><br><span class="line">          const name = element.slotTarget || &#x27;&quot;default&quot;&#x27;</span><br><span class="line">          ;(currentParent.scopedSlots || (currentParent.scopedSlots = &#123;&#125;))[name] = element</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          currentParent.children.push(element)</span><br><span class="line">          element.parent = currentParent</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (!unary) &#123; // 不是单标签</span><br><span class="line">        currentParent = element</span><br><span class="line">        stack.push(element)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        endPre(element)</span><br><span class="line">      &#125;</span><br><span class="line">      // apply post-transforms</span><br><span class="line">      // 不知道是啥</span><br><span class="line">      for (let i = 0; i &lt; postTransforms.length; i++) &#123;</span><br><span class="line">        postTransforms[i](element, options)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    end () &#123;</span><br><span class="line">      // remove trailing whitespace</span><br><span class="line">      const element = stack[stack.length - 1]</span><br><span class="line">      const lastNode = element.children[element.children.length - 1]</span><br><span class="line">      if (lastNode &amp;&amp; lastNode.type === 3 &amp;&amp; lastNode.text === &#x27; &#x27; &amp;&amp; !inPre) &#123;</span><br><span class="line">        element.children.pop()</span><br><span class="line">      &#125;</span><br><span class="line">      // pop stack 删除最近的一个闭合标签</span><br><span class="line">      stack.length -= 1</span><br><span class="line">      // currentParent变为上一层节点</span><br><span class="line">      currentParent = stack[stack.length - 1]</span><br><span class="line">      // pre做结束处理</span><br><span class="line">      endPre(element)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    chars (text: string) &#123;</span><br><span class="line">      if (!currentParent) &#123; // 这里可能是Component template必须要有个根节点</span><br><span class="line">        if (process.env.NODE_ENV !== &#x27;production&#x27;) &#123;</span><br><span class="line">          if (text === template) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              &#x27;Component template requires a root element, rather than just text.&#x27;</span><br><span class="line">            )</span><br><span class="line">          &#125; else if ((text = text.trim())) &#123;</span><br><span class="line">            warnOnce(</span><br><span class="line">              `text &quot;$&#123;text&#125;&quot; outside root element will be ignored.`</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      // IE textarea placeholder bug</span><br><span class="line">      // ie才有的bug，现在没条件测试</span><br><span class="line">      /* istanbul ignore if */</span><br><span class="line">      if (isIE &amp;&amp;</span><br><span class="line">          currentParent.tag === &#x27;textarea&#x27; &amp;&amp;</span><br><span class="line">          currentParent.attrsMap.placeholder === text) &#123;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      const children = currentParent.children</span><br><span class="line">      text = inPre || text.trim() // pre里面或者存在静态文本</span><br><span class="line">        ? decodeHTMLCached(text) // text处理,取了textContent的值，在chrome把&amp;lt;转为了&lt;</span><br><span class="line">        // only preserve whitespace if its not right after a starting tag</span><br><span class="line">        : preserveWhitespace &amp;&amp; children.length ? &#x27; &#x27; : &#x27;&#x27;</span><br><span class="line">      if (text) &#123;</span><br><span class="line">        let expression</span><br><span class="line">        if (!inVPre &amp;&amp; text !== &#x27; &#x27; &amp;&amp; (expression = parseText(text, delimiters))) &#123; // 判断是不是&#123;&#123;&#125;&#125;表达式, 并提取表达式为render函数</span><br><span class="line">          children.push(&#123;</span><br><span class="line">            type: 2,</span><br><span class="line">            expression,</span><br><span class="line">            text</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; else if (text !== &#x27; &#x27; || !children.length || children[children.length - 1].text !== &#x27; &#x27;) &#123; // 纯粹的静态文本、父节点v-pre|pre、</span><br><span class="line">          children.push(&#123;</span><br><span class="line">            type: 3,</span><br><span class="line">            text</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  return root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行到 <code>parseHTML</code> , 继续跟进</p>
<p>文件在 src/compiler/parser/html-parser.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line">export function parseHTML (html, options) &#123;</span><br><span class="line">  const stack = [] // 一些赋值操作</span><br><span class="line">  const expectHTML = options.expectHTML</span><br><span class="line">  const isUnaryTag = options.isUnaryTag || no</span><br><span class="line">  const canBeLeftOpenTag = options.canBeLeftOpenTag || no</span><br><span class="line">  let index = 0</span><br><span class="line">  let last, lastTag</span><br><span class="line">  while (html) &#123; // 循环template模板</span><br><span class="line">    last = html</span><br><span class="line"></span><br><span class="line">    // Make sure we&#x27;re not in a plaintext content element like script/style</span><br><span class="line">    // 不是script,style,textarea中的一个</span><br><span class="line">    if (!lastTag || !isPlainTextElement(lastTag)) &#123;</span><br><span class="line">      let textEnd = html.indexOf(&#x27;&lt;&#x27;)</span><br><span class="line">      if (textEnd === 0) &#123;</span><br><span class="line"></span><br><span class="line">        // Comment: 是不是注释</span><br><span class="line">        // 注释直接截取不做额外处理</span><br><span class="line">        if (comment.test(html)) &#123;</span><br><span class="line">          const commentEnd = html.indexOf(&#x27;--&gt;&#x27;)</span><br><span class="line"></span><br><span class="line">          if (commentEnd &gt;= 0) &#123;</span><br><span class="line">            advance(commentEnd + 3)</span><br><span class="line">            continue</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // http://en.wikipedia.org/wiki/Conditional_comment#Downlevel-revealed_conditional_comment</span><br><span class="line">        // 看链接</span><br><span class="line">        if (conditionalComment.test(html)) &#123;</span><br><span class="line">          const conditionalEnd = html.indexOf(&#x27;]&gt;&#x27;)</span><br><span class="line"></span><br><span class="line">          if (conditionalEnd &gt;= 0) &#123;</span><br><span class="line">            advance(conditionalEnd + 2)</span><br><span class="line">            continue</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Doctype:</span><br><span class="line">        const doctypeMatch = html.match(doctype)</span><br><span class="line">        if (doctypeMatch) &#123;</span><br><span class="line">          advance(doctypeMatch[0].length)</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // End tag: 末尾标签</span><br><span class="line">        const endTagMatch = html.match(endTag)</span><br><span class="line">        if (endTagMatch) &#123;</span><br><span class="line">          const curIndex = index</span><br><span class="line">          advance(endTagMatch[0].length)</span><br><span class="line">          parseEndTag(endTagMatch[1], curIndex, index)</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Start tag: 开始标签</span><br><span class="line">        const startTagMatch = parseStartTag()</span><br><span class="line">        if (startTagMatch) &#123;</span><br><span class="line">          handleStartTag(startTagMatch)</span><br><span class="line">          continue</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      let text, rest, next</span><br><span class="line">      if (textEnd &gt;= 0) &#123; // 第二次进这里 去除换行符</span><br><span class="line">        rest = html.slice(textEnd)</span><br><span class="line">        while (</span><br><span class="line">          !endTag.test(rest) &amp;&amp; // 不是结束标签</span><br><span class="line">          !startTagOpen.test(rest) &amp;&amp; // 不是开始标签</span><br><span class="line">          !comment.test(rest) &amp;&amp; // 不是注释</span><br><span class="line">          !conditionalComment.test(rest) // 不是![</span><br><span class="line">        ) &#123;</span><br><span class="line">          // &lt; in plain text, be forgiving and treat it as text</span><br><span class="line">          // &lt;可能会存在文本中，fds&quot;&lt;&quot;fasdf,但在chrome里&lt;会被转化为&amp;lt;</span><br><span class="line">          // 目前还不清楚怎么进这个条件</span><br><span class="line">          // 不过这里的最终目的还是为了找到最近的并且是标签的&lt;</span><br><span class="line">          next = rest.indexOf(&#x27;&lt;&#x27;, 1)</span><br><span class="line">          if (next &lt; 0) break</span><br><span class="line">          textEnd += next</span><br><span class="line">          rest = html.slice(textEnd)</span><br><span class="line">        &#125;</span><br><span class="line">        text = html.substring(0, textEnd)</span><br><span class="line">        advance(textEnd)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (textEnd &lt; 0) &#123;</span><br><span class="line">        text = html</span><br><span class="line">        html = &#x27;&#x27;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (options.chars &amp;&amp; text) &#123; // 本例第二次loop进入这里</span><br><span class="line">        options.chars(text)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      var stackedTag = lastTag.toLowerCase()</span><br><span class="line">      var reStackedTag = reCache[stackedTag] || (reCache[stackedTag] = new RegExp(&#x27;([\\s\\S]*?)(&lt;/&#x27; + stackedTag + &#x27;[^&gt;]*&gt;)&#x27;, &#x27;i&#x27;))</span><br><span class="line">      var endTagLength = 0</span><br><span class="line">      var rest = html.replace(reStackedTag, function (all, text, endTag) &#123;</span><br><span class="line">        endTagLength = endTag.length</span><br><span class="line">        if (!isPlainTextElement(stackedTag) &amp;&amp; stackedTag !== &#x27;noscript&#x27;) &#123;</span><br><span class="line">          text = text</span><br><span class="line">            .replace(/&lt;!--([\s\S]*?)--&gt;/g, &#x27;$1&#x27;)</span><br><span class="line">            .replace(/&lt;!\[CDATA\[([\s\S]*?)]]&gt;/g, &#x27;$1&#x27;)</span><br><span class="line">        &#125;</span><br><span class="line">        if (options.chars) &#123;</span><br><span class="line">          options.chars(text)</span><br><span class="line">        &#125;</span><br><span class="line">        return &#x27;&#x27;</span><br><span class="line">      &#125;)</span><br><span class="line">      index += html.length - rest.length</span><br><span class="line">      html = rest</span><br><span class="line">      parseEndTag(stackedTag, index - endTagLength, index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (html === last) &#123;</span><br><span class="line">      options.chars &amp;&amp; options.chars(html)</span><br><span class="line">      if (process.env.NODE_ENV !== &#x27;production&#x27; &amp;&amp; !stack.length &amp;&amp; options.warn) &#123;</span><br><span class="line">        options.warn(`Mal-formatted tag at end of template: &quot;$&#123;html&#125;&quot;`)</span><br><span class="line">      &#125;</span><br><span class="line">      break</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Clean up any remaining tags</span><br><span class="line">  parseEndTag()</span><br><span class="line"></span><br><span class="line">  function advance (n) &#123;</span><br><span class="line">    index += n</span><br><span class="line">    html = html.substring(n)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function parseStartTag () &#123;</span><br><span class="line">    // match在不加g的时候同exec方法</span><br><span class="line">    // 0返回匹配，1返回正则括号里的匹配</span><br><span class="line">    const start = html.match(startTagOpen)</span><br><span class="line">    if (start) &#123;</span><br><span class="line">      const match = &#123;</span><br><span class="line">        tagName: start[1],</span><br><span class="line">        attrs: [],</span><br><span class="line">        start: index</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 给index重新赋值并且截取html模板</span><br><span class="line">      advance(start[0].length)</span><br><span class="line">      let end, attr</span><br><span class="line">      // end匹配&gt;,attr获取标签的属性(id,class等)</span><br><span class="line">      // attr并不能一次性获取全部属性，而是通过不断的遍历和截取字符窜每次获取一组属性</span><br><span class="line">      // 这个匹配正则需要研究一下</span><br><span class="line">      // /^\s*([^\s&quot;&#x27;&lt;&gt;\/=]+)(?:\s*((?:=))\s*(?:&quot;([^&quot;]*)&quot;+|&#x27;([^&#x27;]*)&#x27;+|([^\s&quot;&#x27;=&lt;&gt;`]+)))?/</span><br><span class="line">      // 3,4,5分别匹配了id=&quot;app&quot;|id=&#x27;app&#x27;|id=app 三种属性书写格式</span><br><span class="line">      // 当匹配到末尾标签&gt;时跳出循环</span><br><span class="line">      while (!(end = html.match(startTagClose)) &amp;&amp; (attr = html.match(attribute))) &#123;</span><br><span class="line">        advance(attr[0].length)</span><br><span class="line">        match.attrs.push(attr)</span><br><span class="line">      &#125;</span><br><span class="line">      if (end) &#123;</span><br><span class="line">        // 单标签斜杠</span><br><span class="line">        match.unarySlash = end[1]</span><br><span class="line">        advance(end[0].length)</span><br><span class="line">        match.end = index // 末尾index</span><br><span class="line">        return match</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function handleStartTag (match) &#123;</span><br><span class="line">    const tagName = match.tagName</span><br><span class="line">    const unarySlash = match.unarySlash</span><br><span class="line"></span><br><span class="line">    if (expectHTML) &#123;</span><br><span class="line">      // 判断了p和 不是段落标签 (这是标签嵌套规范，可以自行搜索)</span><br><span class="line">      if (lastTag === &#x27;p&#x27; &amp;&amp; isNonPhrasingTag(tagName)) &#123;</span><br><span class="line">        parseEndTag(lastTag)</span><br><span class="line">      &#125;</span><br><span class="line">      // 可以不闭合的标签</span><br><span class="line">      if (canBeLeftOpenTag(tagName) &amp;&amp; lastTag === tagName) &#123;</span><br><span class="line">        parseEndTag(tagName)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 是否单标签</span><br><span class="line">    const unary = isUnaryTag(tagName) || tagName === &#x27;html&#x27; &amp;&amp; lastTag === &#x27;head&#x27; || !!unarySlash</span><br><span class="line"></span><br><span class="line">    const l = match.attrs.length</span><br><span class="line">    const attrs = new Array(l)</span><br><span class="line">    for (let i = 0; i &lt; l; i++) &#123;</span><br><span class="line">      const args = match.attrs[i]</span><br><span class="line">      // hackish work around FF bug https://bugzilla.mozilla.org/show_bug.cgi?id=369778</span><br><span class="line">      if (IS_REGEX_CAPTURING_BROKEN &amp;&amp; args[0].indexOf(&#x27;&quot;&quot;&#x27;) === -1) &#123;</span><br><span class="line">        if (args[3] === &#x27;&#x27;) &#123; delete args[3] &#125;</span><br><span class="line">        if (args[4] === &#x27;&#x27;) &#123; delete args[4] &#125;</span><br><span class="line">        if (args[5] === &#x27;&#x27;) &#123; delete args[5] &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      const value = args[3] || args[4] || args[5] || &#x27;&#x27;</span><br><span class="line">      attrs[i] = &#123;</span><br><span class="line">        name: args[1],</span><br><span class="line">        value: decodeAttr(</span><br><span class="line">          value,</span><br><span class="line">          options.shouldDecodeNewlines // ie才会出的问题，其他浏览器没有</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 不是单标签就添加到stack数组</span><br><span class="line">    if (!unary) &#123;</span><br><span class="line">      stack.push(&#123; tag: tagName, lowerCasedTag: tagName.toLowerCase(), attrs: attrs &#125;)</span><br><span class="line">      lastTag = tagName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (options.start) &#123; // 这里调用start方法，回到start函数</span><br><span class="line">      options.start(tagName, attrs, unary, match.start, match.end)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function parseEndTag (tagName, start, end) &#123;</span><br><span class="line">    let pos, lowerCasedTagName</span><br><span class="line">    if (start == null) start = index</span><br><span class="line">    if (end == null) end = index</span><br><span class="line"></span><br><span class="line">    if (tagName) &#123;</span><br><span class="line">      lowerCasedTagName = tagName.toLowerCase()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Find the closest opened tag of the same type</span><br><span class="line">    // 找到最近的相同标签</span><br><span class="line">    if (tagName) &#123;</span><br><span class="line">      for (pos = stack.length - 1; pos &gt;= 0; pos--) &#123;</span><br><span class="line">        if (stack[pos].lowerCasedTag === lowerCasedTagName) &#123;</span><br><span class="line">          break</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // If no tag name is provided, clean shop</span><br><span class="line">      pos = 0</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (pos &gt;= 0) &#123;</span><br><span class="line">      // Close all the open elements, up the stack</span><br><span class="line">      //</span><br><span class="line">      for (let i = stack.length - 1; i &gt;= pos; i--) &#123;</span><br><span class="line">        if (process.env.NODE_ENV !== &#x27;production&#x27; &amp;&amp;</span><br><span class="line">            (i &gt; pos || !tagName) &amp;&amp;</span><br><span class="line">            options.warn) &#123;</span><br><span class="line">          // 没有对应的结束标签</span><br><span class="line">          options.warn(</span><br><span class="line">            `tag &lt;$&#123;stack[i].tag&#125;&gt; has no matching end tag.`</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        if (options.end) &#123;</span><br><span class="line">          options.end(stack[i].tag, start, end)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // Remove the open elements from the stack</span><br><span class="line">      // 删除最后一个</span><br><span class="line">      stack.length = pos</span><br><span class="line">      // lastTag变成最后一个</span><br><span class="line">      lastTag = pos &amp;&amp; stack[pos - 1].tag</span><br><span class="line">    &#125; else if (lowerCasedTagName === &#x27;br&#x27;) &#123;</span><br><span class="line">      if (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], true, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (lowerCasedTagName === &#x27;p&#x27;) &#123;</span><br><span class="line">      if (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], false, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">      if (options.end) &#123;</span><br><span class="line">        options.end(tagName, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>parse 返回了一个 ast 树，所有的节点都经过了最基础的处理。<br>
然后是 <code>optimize(ast, options)</code></p>
<p><code>optimize</code>  在 src/compiler/optimizer.js</p>
<p><code>optimize</code>  的作用是找出 ast 树里面的静态节点 (节点是静态文本也没有 v 事件绑定) 和静态根节点 (节点下的所有子节点都是静态节点)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Goal of the optimizer: walk the generated template AST tree</span><br><span class="line"> * and detect sub-trees that are purely static, i.e. parts of</span><br><span class="line"> * the DOM that never needs to change.</span><br><span class="line"> * 找出ast里面的静态节点，然后不需要重复的取处理他们(因为他们是静态的不会改变的)</span><br><span class="line"> *</span><br><span class="line"> * Once we detect these sub-trees, we can:</span><br><span class="line"> *</span><br><span class="line"> * 1. Hoist them into constants, so that we no longer need to</span><br><span class="line"> *    create fresh nodes for them on each re-render;</span><br><span class="line"> * 2. Completely skip them in the patching process.</span><br><span class="line"> */</span><br><span class="line">export function optimize (root: ?ASTElement, options: CompilerOptions) &#123;</span><br><span class="line">  if (!root) return</span><br><span class="line">  isStaticKey = genStaticKeysCached(options.staticKeys || &#x27;&#x27;)</span><br><span class="line">  isPlatformReservedTag = options.isReservedTag || no</span><br><span class="line">  // first pass: mark all non-static nodes.</span><br><span class="line">  // 标记节点是否静态</span><br><span class="line">  markStatic(root)</span><br><span class="line">  // second pass: mark static roots.</span><br><span class="line">  // 标记是否是静态根节点</span><br><span class="line">  markStaticRoots(root, false)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function markStatic (node: ASTNode) &#123;</span><br><span class="line">  node.static = isStatic(node)</span><br><span class="line">  if (node.type === 1) &#123;</span><br><span class="line">    // do not make component slot content static. this avoids</span><br><span class="line">    // 1. components not able to mutate slot nodes</span><br><span class="line">    // 2. static slot content fails for hot-reloading</span><br><span class="line">    if (</span><br><span class="line">      !isPlatformReservedTag(node.tag) &amp;&amp;</span><br><span class="line">      node.tag !== &#x27;slot&#x27; &amp;&amp;</span><br><span class="line">      node.attrsMap[&#x27;inline-template&#x27;] == null</span><br><span class="line">    ) &#123;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line">    for (let i = 0, l = node.children.length; i &lt; l; i++) &#123;</span><br><span class="line">      const child = node.children[i]</span><br><span class="line">      markStatic(child)</span><br><span class="line">      if (!child.static) &#123;</span><br><span class="line">        node.static = false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function isStatic (node: ASTNode): boolean &#123;</span><br><span class="line">  if (node.type === 2) &#123; // expression 有表达式就不是</span><br><span class="line">    return false</span><br><span class="line">  &#125;</span><br><span class="line">  if (node.type === 3) &#123; // text // 文本就是</span><br><span class="line">    return true</span><br><span class="line">  &#125;</span><br><span class="line">  return !!(node.pre || ( // v-pre不做编译，是</span><br><span class="line">    !node.hasBindings &amp;&amp; // no dynamic bindings 没有动态绑定</span><br><span class="line">    !node.if &amp;&amp; !node.for &amp;&amp; // not v-if or v-for or v-else</span><br><span class="line">    !isBuiltInTag(node.tag) &amp;&amp; // not a built-in</span><br><span class="line">    isPlatformReservedTag(node.tag) &amp;&amp; // not a component</span><br><span class="line">    !isDirectChildOfTemplateFor(node) &amp;&amp; // template没有for</span><br><span class="line">    Object.keys(node).every(isStaticKey) // 节点的属性只能是isStaticKey里面那几个</span><br><span class="line">  ))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function markStaticRoots (node: ASTNode, isInFor: boolean) &#123;</span><br><span class="line">  if (node.type === 1) &#123;</span><br><span class="line">    if (node.static || node.once) &#123;</span><br><span class="line">      node.staticInFor = isInFor</span><br><span class="line">    &#125;</span><br><span class="line">    // For a node to qualify as a static root, it should have children that</span><br><span class="line">    // are not just static text. Otherwise the cost of hoisting out will</span><br><span class="line">    // outweigh the benefits and it&#x27;s better off to just always render it fresh.</span><br><span class="line">    if (node.static &amp;&amp; node.children.length &amp;&amp; !( // 该节点静态</span><br><span class="line">      node.children.length === 1 &amp;&amp; // 节点只有一个子节点</span><br><span class="line">      node.children[0].type === 3 // 子节点是文本节点</span><br><span class="line">    )) &#123;</span><br><span class="line">      node.staticRoot = true</span><br><span class="line">      return</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      node.staticRoot = false</span><br><span class="line">    &#125;</span><br><span class="line">    if (node.children) &#123; // 有多个子节点就进行循环递归判断</span><br><span class="line">      for (let i = 0, l = node.children.length; i &lt; l; i++) &#123;</span><br><span class="line">        markStaticRoots(node.children[i], isInFor || !!node.for)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (node.ifConditions) &#123;</span><br><span class="line">      walkThroughConditionsBlocks(node.ifConditions, isInFor)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      <div class="tags">
          <a href="/my-notes/tags/Vue%E7%AC%94%E8%AE%B0/" rel="tag"><i class="ic i-tag"></i> Vue笔记</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2024-01-10 14:46:33" itemprop="dateModified" datetime="2024-01-10T14:46:33+08:00">2024-01-10</time>
  </span>
  <span id="2018/05/25/vue/4/" class="item leancloud_visitors" data-flag-title="Vue源码阅读笔记（4）(compile)" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/my-notes/images/wechatpay.png" alt="lokve 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/my-notes/images/alipay.png" alt="lokve 支付宝">
        <p>支付宝</p>
      </div>
      
      <div>
        <img data-src="/my-notes/images/paypal.png" alt="lokve 贝宝">
        <p>贝宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>lokve <i class="ic i-at"><em>@</em></i>学习笔记
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2018/05/25/vue/4/" title="Vue源码阅读笔记（4）(compile)">http://example.com/2018/05/25/vue/4/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/my-notes/2018/01/23/vue/3/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;api.ouyangqiqi.cn&#x2F;dm&#x2F;img-webp.php?79956" title="Vue源码阅读笔记（3）(Vue的双向数据绑定)">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Vue源码阅读笔记（3）(Vue的双向数据绑定)</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/my-notes/2018/06/07/vue/class/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;api.ouyangqiqi.cn&#x2F;dm&#x2F;img-webp.php?427086" title="Vue源码阅读笔记 (class,style)">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Vue源码阅读笔记 (class,style)</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B"><span class="toc-number">1.</span> <span class="toc-text"> 开始</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E8%A1%A5%E5%85%85"><span class="toc-number">2.</span> <span class="toc-text"> 正则补充</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#compiletofunctions"><span class="toc-number">3.</span> <span class="toc-text"> compileToFunctions</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="lokve"
      data-src="/my-notes/images/head.jpeg">
  <p class="name" itemprop="name">lokve</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/my-notes/archives/">
        <span class="count">89</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/my-notes/categories/">
        <span class="count">4</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/my-notes/tags/">
        <span class="count">13</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xva3Zl" title="https:&#x2F;&#x2F;github.com&#x2F;lokve"><i class="ic i-github"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/my-notes/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/my-notes/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/my-notes/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/my-notes/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/my-notes/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/my-notes/2018/01/23/vue/3/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/my-notes/2018/06/07/vue/class/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2018/06/07/vue/class/" title="Vue源码阅读笔记 (class,style)">Vue源码阅读笔记 (class,style)</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2020/09/14/react-redux/Provider/" title="Provider">Provider</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2019/07/10/%E7%AE%97%E6%B3%95/01.%E6%8E%92%E5%BA%8F/" title="数据结构">数据结构</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/my-notes/categories/react/" title="分类于 react">react</a>
</div>

    <span><a href="/my-notes/2020/09/08/react/fiber/" title="fiber">fiber</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2018/05/25/vue/4/" title="Vue源码阅读笔记（4）(compile)">Vue源码阅读笔记（4）(compile)</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/my-notes/categories/leetcode/" title="分类于 leetcode">leetcode</a>
<i class="ic i-angle-right"></i>
<a href="/my-notes/categories/leetcode/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="分类于 动态规划">动态规划</a>
</div>

    <span><a href="/my-notes/2024/01/30/leetcode/377.Combination%20Sum%20IV/index/" title="377.Combination Sum IV">377.Combination Sum IV</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2017/05/23/bue/5/" title="Bue源码阅读笔记（5）">Bue源码阅读笔记（5）</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/my-notes/categories/leetcode/" title="分类于 leetcode">leetcode</a>
<i class="ic i-angle-right"></i>
<a href="/my-notes/categories/leetcode/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="分类于 动态规划">动态规划</a>
</div>

    <span><a href="/my-notes/2024/01/24/leetcode/494.Target%20Sum/index/" title="494.Target Sum">494.Target Sum</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2019/06/14/js%E9%AB%98%E7%BA%A7/15.Canvas/" title="Canvas">Canvas</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/my-notes/2017/06/28/%E9%9A%8F%E8%AE%B0/2/" title="一些笔记">一些笔记</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">lokve @ hee note</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">394k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">5:59</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2018/05/25/vue/4/',
    favicon: {
      show: "（●´3｀●）やれやれだぜ",
      hide: "(´Д｀)大変だ！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/my-notes/js/app.js?v=0.2.5"></script>




</body>
</html>
