<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="构建 fiber 树和 dom 树，互相对应为参数，能互相找到，并执行了渲染前的生命周期 然后是renderRoot1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757">
<meta property="og:type" content="article">
<meta property="og:title" content="renderRoot">
<meta property="og:url" content="http://example.com/2020/09/08/react/renderRoot/index.html">
<meta property="og:site_name" content="学习笔记">
<meta property="og:description" content="构建 fiber 树和 dom 树，互相对应为参数，能互相找到，并执行了渲染前的生命周期 然后是renderRoot1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-09-08T06:00:00.000Z">
<meta property="article:modified_time" content="2020-09-15T04:15:42.803Z">
<meta property="article:author" content="lokve">
<meta property="article:tag" content="react源码解析">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2020/09/08/react/renderRoot/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>renderRoot | 学习笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">学习笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/08/react/renderRoot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          renderRoot
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-08 14:00:00" itemprop="dateCreated datePublished" datetime="2020-09-08T14:00:00+08:00">2020-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>构建 fiber 树和 dom 树，互相对应为参数，能互相找到，并执行了渲染前的生命周期</p>
<h3 id="然后是renderRoot"><a href="#然后是renderRoot" class="headerlink" title="然后是renderRoot"></a>然后是<code>renderRoot</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">    isSync: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">SchedulerCallback</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root.firstPendingTime &lt; expirationTime) &#123;</span><br><span class="line">        <span class="comment">// If there&#x27;s no work left at this expiration time, exit immediately. This</span></span><br><span class="line">        <span class="comment">// happens when multiple callbacks are scheduled for a single root, but an</span></span><br><span class="line">        <span class="comment">// earlier callback flushes the work of a later one.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在同步情况下，如果还存在待提交的处理，就先执行他</span></span><br><span class="line">    <span class="keyword">if</span> (isSync &amp;&amp; root.finishedExpirationTime === expirationTime) &#123;</span><br><span class="line">        <span class="comment">// false</span></span><br><span class="line">        <span class="comment">// There&#x27;s already a pending commit at this expiration time.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This is poorly factored. This case only exists for the</span></span><br><span class="line">        <span class="comment">// batch.commit() API.</span></span><br><span class="line">        <span class="keyword">return</span> commitRoot.bind(<span class="literal">null</span>, root);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// debugger</span></span><br><span class="line">    flushPassiveEffects(); <span class="comment">// 第一次return false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the root or expiration time have changed, throw out the existing stack</span></span><br><span class="line">    <span class="comment">// and prepare a fresh one. Otherwise we&#x27;ll continue where we left off.</span></span><br><span class="line">    <span class="keyword">if</span> (root !== workInProgressRoot || expirationTime !== renderExpirationTime) &#123;</span><br><span class="line">        <span class="comment">// 创建备份为当前执行工作（workInProgress）</span></span><br><span class="line">        <span class="comment">// 给root.current创建alternate,alternate和root.current拥有相同参数，并互相为对方的alternate</span></span><br><span class="line">        prepareFreshStack(root, expirationTime);</span><br><span class="line">        <span class="comment">// 执行后workInProgressRoot就等于root.current.alternate</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we have a work-in-progress fiber, it means there&#x27;s still work to do</span></span><br><span class="line">    <span class="comment">// in this root.</span></span><br><span class="line">    <span class="keyword">if</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> prevExecutionContext = executionContext; <span class="comment">// 8 记录状态</span></span><br><span class="line">        executionContext |= RenderContext; <span class="comment">// 添加RenderContext状态</span></span><br><span class="line">        <span class="keyword">let</span> prevDispatcher = ReactCurrentDispatcher.current;</span><br><span class="line">        <span class="keyword">if</span> (prevDispatcher === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// The React isomorphic package does not include a default dispatcher.</span></span><br><span class="line">            <span class="comment">// Instead the first renderer will lazily attach one, in order to give</span></span><br><span class="line">            <span class="comment">// nicer error messages.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ContextOnlyDispatcher错误提示对象函数</span></span><br><span class="line">            <span class="comment">// hooks报错函数对象</span></span><br><span class="line">            prevDispatcher = ContextOnlyDispatcher;</span><br><span class="line">        &#125;</span><br><span class="line">        ReactCurrentDispatcher.current = ContextOnlyDispatcher;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isSync) &#123;</span><br><span class="line">                    <span class="comment">// 进这</span></span><br><span class="line">                    workLoopSync();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    workLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        executionContext = prevExecutionContext;</span><br><span class="line">        resetContextDependencies(); <span class="comment">// 重置context相关</span></span><br><span class="line">        ReactCurrentDispatcher.current = prevDispatcher;</span><br><span class="line">        <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">            __interactionsRef.current = ((prevInteractions: any): <span class="built_in">Set</span>&lt;Interaction&gt;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// There&#x27;s still work left over. Return a continuation.</span></span><br><span class="line">            stopInterruptedWorkLoopTimer();</span><br><span class="line">            <span class="keyword">if</span> (expirationTime !== Sync) &#123;</span><br><span class="line">                startRequestCallbackTimer();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, expirationTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// debugger;</span></span><br><span class="line">    <span class="comment">// We now have a consistent tree. The next step is either to commit it, or, if</span></span><br><span class="line">    <span class="comment">// something suspended, wait to commit it after a timeout.</span></span><br><span class="line">    stopFinishedWorkLoopTimer(); <span class="comment">// __DEV__ ?</span></span><br><span class="line"></span><br><span class="line">    root.finishedWork = root.current.alternate;</span><br><span class="line">    root.finishedExpirationTime = expirationTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> isLocked = resolveLocksOnRoot(root, expirationTime);</span><br><span class="line">    <span class="keyword">if</span> (isLocked) &#123;</span><br><span class="line">        <span class="comment">// This root has a lock that prevents it from committing. Exit. If we begin</span></span><br><span class="line">        <span class="comment">// work on the root again, without any intervening updates, it will finish</span></span><br><span class="line">        <span class="comment">// without doing additional work.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set this to null to indicate there&#x27;s no in-progress render.</span></span><br><span class="line">    workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (workInProgressRootExitStatus) &#123;</span><br><span class="line">        <span class="keyword">case</span> RootIncomplete: &#123;</span><br><span class="line">            invariant(<span class="literal">false</span>, <span class="string">&#x27;Should have a work-in-progress.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Flow knows about invariant, so it compains if I add a break statement,</span></span><br><span class="line">        <span class="comment">// but eslint doesn&#x27;t know about invariant, so it complains if I do.</span></span><br><span class="line">        <span class="comment">// eslint-disable-next-line no-fallthrough</span></span><br><span class="line">        <span class="keyword">case</span> RootErrored: &#123;</span><br><span class="line">            <span class="comment">// An error was thrown. First check if there is lower priority work</span></span><br><span class="line">            <span class="comment">// scheduled on this root.</span></span><br><span class="line">            <span class="keyword">const</span> lastPendingTime = root.lastPendingTime;</span><br><span class="line">            <span class="keyword">if</span> (lastPendingTime &lt; expirationTime) &#123;</span><br><span class="line">                <span class="comment">// There&#x27;s lower priority work. Before raising the error, try rendering</span></span><br><span class="line">                <span class="comment">// at the lower priority to see if it fixes it. Use a continuation to</span></span><br><span class="line">                <span class="comment">// maintain the existing priority and position in the queue.</span></span><br><span class="line">                <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, lastPendingTime);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!isSync) &#123;</span><br><span class="line">                <span class="comment">// If we&#x27;re rendering asynchronously, it&#x27;s possible the error was</span></span><br><span class="line">                <span class="comment">// caused by tearing due to a mutation during an event. Try rendering</span></span><br><span class="line">                <span class="comment">// one more time without yiedling to events.</span></span><br><span class="line">                prepareFreshStack(root, expirationTime);</span><br><span class="line">                scheduleSyncCallback(renderRoot.bind(<span class="literal">null</span>, root, expirationTime));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If we&#x27;re already rendering synchronously, commit the root in its</span></span><br><span class="line">            <span class="comment">// errored state.</span></span><br><span class="line">            <span class="keyword">return</span> commitRoot.bind(<span class="literal">null</span>, root);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> RootSuspended: &#123;</span><br><span class="line">            <span class="comment">// We have an acceptable loading state. We need to figure out if we should</span></span><br><span class="line">            <span class="comment">// immediately commit it or wait a bit.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we have processed new updates during this render, we may now have a</span></span><br><span class="line">            <span class="comment">// new loading state ready. We want to ensure that we commit that as soon as</span></span><br><span class="line">            <span class="comment">// possible.</span></span><br><span class="line">            <span class="keyword">const</span> hasNotProcessedNewUpdates =</span><br><span class="line">                workInProgressRootLatestProcessedExpirationTime === Sync;</span><br><span class="line">            <span class="keyword">if</span> (hasNotProcessedNewUpdates &amp;&amp; !isSync) &#123;</span><br><span class="line">                <span class="comment">// If we have not processed any new updates during this pass, then this is</span></span><br><span class="line">                <span class="comment">// either a retry of an existing fallback state or a hidden tree.</span></span><br><span class="line">                <span class="comment">// Hidden trees shouldn&#x27;t be batched with other work and after that&#x27;s</span></span><br><span class="line">                <span class="comment">// fixed it can only be a retry.</span></span><br><span class="line">                <span class="comment">// We&#x27;re going to throttle committing retries so that we don&#x27;t show too</span></span><br><span class="line">                <span class="comment">// many loading states too quickly.</span></span><br><span class="line">                <span class="keyword">let</span> msUntilTimeout = globalMostRecentFallbackTime + FALLBACK_THROTTLE_MS - now();</span><br><span class="line">                <span class="comment">// Don&#x27;t bother with a very short suspense time.</span></span><br><span class="line">                <span class="keyword">if</span> (msUntilTimeout &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (workInProgressRootHasPendingPing) &#123;</span><br><span class="line">                        <span class="comment">// This render was pinged but we didn&#x27;t get to restart earlier so try</span></span><br><span class="line">                        <span class="comment">// restarting now instead.</span></span><br><span class="line">                        prepareFreshStack(root, expirationTime);</span><br><span class="line">                        <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, expirationTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">const</span> lastPendingTime = root.lastPendingTime;</span><br><span class="line">                    <span class="keyword">if</span> (lastPendingTime &lt; expirationTime) &#123;</span><br><span class="line">                        <span class="comment">// There&#x27;s lower priority work. It might be unsuspended. Try rendering</span></span><br><span class="line">                        <span class="comment">// at that level.</span></span><br><span class="line">                        <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, lastPendingTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// The render is suspended, it hasn&#x27;t timed out, and there&#x27;s no lower</span></span><br><span class="line">                    <span class="comment">// priority work to do. Instead of committing the fallback</span></span><br><span class="line">                    <span class="comment">// immediately, wait for more data to arrive.</span></span><br><span class="line">                    root.timeoutHandle = scheduleTimeout(</span><br><span class="line">                        commitRoot.bind(<span class="literal">null</span>, root),</span><br><span class="line">                        msUntilTimeout,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// The work expired. Commit immediately.</span></span><br><span class="line">            <span class="keyword">return</span> commitRoot.bind(<span class="literal">null</span>, root);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> RootSuspendedWithDelay: &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isSync) &#123;</span><br><span class="line">                <span class="comment">// We&#x27;re suspended in a state that should be avoided. We&#x27;ll try to avoid committing</span></span><br><span class="line">                <span class="comment">// it for as long as the timeouts let us.</span></span><br><span class="line">                <span class="keyword">if</span> (workInProgressRootHasPendingPing) &#123;</span><br><span class="line">                    <span class="comment">// This render was pinged but we didn&#x27;t get to restart earlier so try</span></span><br><span class="line">                    <span class="comment">// restarting now instead.</span></span><br><span class="line">                    prepareFreshStack(root, expirationTime);</span><br><span class="line">                    <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, expirationTime);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">const</span> lastPendingTime = root.lastPendingTime;</span><br><span class="line">                <span class="keyword">if</span> (lastPendingTime &lt; expirationTime) &#123;</span><br><span class="line">                    <span class="comment">// There&#x27;s lower priority work. It might be unsuspended. Try rendering</span></span><br><span class="line">                    <span class="comment">// at that level immediately.</span></span><br><span class="line">                    <span class="keyword">return</span> renderRoot.bind(<span class="literal">null</span>, root, lastPendingTime);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> msUntilTimeout;</span><br><span class="line">                <span class="keyword">if</span> (workInProgressRootLatestSuspenseTimeout !== Sync) &#123;</span><br><span class="line">                    <span class="comment">// We have processed a suspense config whose expiration time we can use as</span></span><br><span class="line">                    <span class="comment">// the timeout.</span></span><br><span class="line">                    msUntilTimeout =</span><br><span class="line">                        expirationTimeToMs(workInProgressRootLatestSuspenseTimeout) - now();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workInProgressRootLatestProcessedExpirationTime === Sync) &#123;</span><br><span class="line">                    <span class="comment">// This should never normally happen because only new updates cause</span></span><br><span class="line">                    <span class="comment">// delayed states, so we should have processed something. However,</span></span><br><span class="line">                    <span class="comment">// this could also happen in an offscreen tree.</span></span><br><span class="line">                    msUntilTimeout = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// If we don&#x27;t have a suspense config, we&#x27;re going to use a heuristic to</span></span><br><span class="line">                    <span class="comment">// determine how long we can suspend.</span></span><br><span class="line">                    <span class="keyword">const</span> eventTimeMs: number = inferTimeFromExpirationTime(</span><br><span class="line">                        workInProgressRootLatestProcessedExpirationTime,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">const</span> currentTimeMs = now();</span><br><span class="line">                    <span class="keyword">const</span> timeUntilExpirationMs =</span><br><span class="line">                        expirationTimeToMs(expirationTime) - currentTimeMs;</span><br><span class="line">                    <span class="keyword">let</span> timeElapsed = currentTimeMs - eventTimeMs;</span><br><span class="line">                    <span class="keyword">if</span> (timeElapsed &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// We get this wrong some time since we estimate the time.</span></span><br><span class="line">                        timeElapsed = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    msUntilTimeout = jnd(timeElapsed) - timeElapsed;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Clamp the timeout to the expiration time.</span></span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Once the event time is exact instead of inferred from expiration time</span></span><br><span class="line">                    <span class="comment">// we don&#x27;t need this.</span></span><br><span class="line">                    <span class="keyword">if</span> (timeUntilExpirationMs &lt; msUntilTimeout) &#123;</span><br><span class="line">                        msUntilTimeout = timeUntilExpirationMs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Don&#x27;t bother with a very short suspense time.</span></span><br><span class="line">                <span class="keyword">if</span> (msUntilTimeout &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                    <span class="comment">// The render is suspended, it hasn&#x27;t timed out, and there&#x27;s no lower</span></span><br><span class="line">                    <span class="comment">// priority work to do. Instead of committing the fallback</span></span><br><span class="line">                    <span class="comment">// immediately, wait for more data to arrive.</span></span><br><span class="line">                    root.timeoutHandle = scheduleTimeout(</span><br><span class="line">                        commitRoot.bind(<span class="literal">null</span>, root),</span><br><span class="line">                        msUntilTimeout,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// The work expired. Commit immediately.</span></span><br><span class="line">            <span class="keyword">return</span> commitRoot.bind(<span class="literal">null</span>, root);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> RootCompleted: &#123;</span><br><span class="line">            <span class="comment">// The work completed. Ready to commit.</span></span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                !isSync &amp;&amp;</span><br><span class="line">                workInProgressRootLatestProcessedExpirationTime !== Sync &amp;&amp;</span><br><span class="line">                workInProgressRootCanSuspendUsingConfig !== <span class="literal">null</span></span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// If we have exceeded the minimum loading delay, which probably</span></span><br><span class="line">                <span class="comment">// means we have shown a spinner already, we might have to suspend</span></span><br><span class="line">                <span class="comment">// a bit longer to ensure that the spinner is shown for enough time.</span></span><br><span class="line">                <span class="keyword">const</span> msUntilTimeout = computeMsUntilSuspenseLoadingDelay(</span><br><span class="line">                    workInProgressRootLatestProcessedExpirationTime,</span><br><span class="line">                    expirationTime,</span><br><span class="line">                    workInProgressRootCanSuspendUsingConfig,</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">if</span> (msUntilTimeout &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                    root.timeoutHandle = scheduleTimeout(</span><br><span class="line">                        commitRoot.bind(<span class="literal">null</span>, root),</span><br><span class="line">                        msUntilTimeout,</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> commitRoot.bind(<span class="literal">null</span>, root);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            invariant(<span class="literal">false</span>, <span class="string">&#x27;Unknown root exit status.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="先进入workLoopSync"><a href="#先进入workLoopSync" class="headerlink" title="先进入workLoopSync"></a>先进入<code>workLoopSync</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoopSync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// debugger;</span></span><br><span class="line">    <span class="comment">// 遍历</span></span><br><span class="line">    <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">    <span class="comment">// 构建fiber树</span></span><br><span class="line">    <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 每次都返回他的子节点生层的fiber, 给workInProgress添加child的fiber</span></span><br><span class="line">        <span class="comment">// debugger</span></span><br><span class="line">        workInProgress = performUnitOfWork(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// debugger;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>workInProgress</code>是 current.alternate</p>
<h3 id="performUnitOfWork"><a href="#performUnitOfWork" class="headerlink" title="performUnitOfWork"></a>performUnitOfWork</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The current, flushed, state of this fiber is the alternate. Ideally</span></span><br><span class="line">    <span class="comment">// nothing should rely on this, but relying on it here means that we don&#x27;t</span></span><br><span class="line">    <span class="comment">// need an additional field on the work in progress.</span></span><br><span class="line">    <span class="keyword">const</span> current = unitOfWork.alternate; <span class="comment">// unitOfWork是备份，current是本体</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> next;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        next = beginWork(current, unitOfWork, renderExpirationTime); <span class="comment">// 返回了当前子节点的fiber</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    unitOfWork.memoizedProps = unitOfWork.pendingProps; <span class="comment">// 记住props</span></span><br><span class="line">    <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 没有子节点了,就找兄弟节点，都没有，返回父节点的兄弟节点</span></span><br><span class="line">        <span class="comment">// If this doesn&#x27;t spawn new work, complete the current work.</span></span><br><span class="line">        next = completeUnitOfWork(unitOfWork);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ReactCurrentOwner.current = <span class="literal">null</span>; <span class="comment">// 重置</span></span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a>beginWork</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null, <span class="regexp">//</span> 本体 （old）</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber, <span class="regexp">//</span> 备份 （new）</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> updateExpirationTime = workInProgress.expirationTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before entering the begin phase, clear the expiration time.</span></span><br><span class="line">    <span class="comment">// 清除到期时间</span></span><br><span class="line">    workInProgress.expirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 按照tag的执行不同的方法</span></span><br><span class="line">    <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> IndeterminateComponent: &#123;</span><br><span class="line">            <span class="comment">// 2 function类型组件是这个tag</span></span><br><span class="line">            <span class="keyword">return</span> mountIndeterminateComponent(</span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                workInProgress.type,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">            <span class="comment">// 从这里开始和上一步不一样了</span></span><br><span class="line">            <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">            <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">            <span class="comment">// 是否一样，不一样则合并defaultProps属性并返回结果</span></span><br><span class="line">            <span class="keyword">const</span> resolvedProps =</span><br><span class="line">                workInProgress.elementType === Component</span><br><span class="line">                    ? unresolvedProps</span><br><span class="line">                    : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">            <span class="keyword">return</span> updateClassComponent(</span><br><span class="line">                <span class="comment">// 返回child fiber</span></span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                Component,</span><br><span class="line">                resolvedProps,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 第一次执行的这个</span></span><br><span class="line">        <span class="keyword">case</span> HostRoot: <span class="comment">// 3 根节点</span></span><br><span class="line">            <span class="keyword">return</span> updateHostRoot(current, workInProgress, renderExpirationTime);</span><br><span class="line">        <span class="keyword">case</span> HostComponent: <span class="comment">// 5 子组件的根节点(最外层节点)</span></span><br><span class="line">            <span class="keyword">return</span> updateHostComponent(current, workInProgress, renderExpirationTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateHostRoot"><a href="#updateHostRoot" class="headerlink" title="updateHostRoot"></a>updateHostRoot</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHostRoot</span>(<span class="params">current, workInProgress, renderExpirationTime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 把一些变量入栈了，放在了文件全局变量中,意义不明</span></span><br><span class="line">    pushHostRootContext(workInProgress);</span><br><span class="line">    <span class="comment">// 跟新队列</span></span><br><span class="line">    <span class="keyword">const</span> updateQueue = workInProgress.updateQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从变量名得知意思</span></span><br><span class="line">    <span class="keyword">const</span> nextProps = workInProgress.pendingProps;</span><br><span class="line">    <span class="keyword">const</span> prevState = workInProgress.memoizedState;</span><br><span class="line">    <span class="keyword">const</span> prevChildren = prevState !== <span class="literal">null</span> ? prevState.element : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以理解为初始化赋值一些数据，如workInProgress.memoizedState等</span></span><br><span class="line">    processUpdateQueue(workInProgress, updateQueue, nextProps, <span class="literal">null</span>, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> nextState = workInProgress.memoizedState; <span class="comment">// 是一个ReactNode</span></span><br><span class="line">    <span class="comment">// Caution: React DevTools currently depends on this property</span></span><br><span class="line">    <span class="comment">// being called &quot;element&quot;.</span></span><br><span class="line">    <span class="keyword">const</span> nextChildren = nextState.element;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> root: FiberRoot = workInProgress.stateNode;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        (current === <span class="literal">null</span> || current.child === <span class="literal">null</span>) &amp;&amp;</span><br><span class="line">        root.hydrate &amp;&amp;</span><br><span class="line">        enterHydrationState(workInProgress)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Otherwise reset hydration state in case we aborted and resumed another</span></span><br><span class="line">        <span class="comment">// root.</span></span><br><span class="line">        <span class="comment">// 给workInProgress添加了child属性</span></span><br><span class="line">        reconcileChildren(current, workInProgress, nextChildren, renderExpirationTime);</span><br><span class="line">        resetHydrationState(); <span class="comment">// 重置了一些属性,目前意义未知</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 到这里就走完了一个循环，然后看child再来一个流程</span></span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="processUpdateQueue"><a href="#processUpdateQueue" class="headerlink" title="processUpdateQueue"></a>processUpdateQueue</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">processUpdateQueue</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    queue: UpdateQueue&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    props: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    instance: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    hasForceUpdate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 克隆了queue(部分属性),执行后queue === workInProgress.updateQueue，好像并没有什么变化</span></span><br><span class="line">    queue = ensureWorkInProgressQueueIsAClone(workInProgress, queue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// These values may change as we process the queue.</span></span><br><span class="line">    <span class="keyword">let</span> newBaseState = queue.baseState;</span><br><span class="line">    <span class="keyword">let</span> newFirstUpdate = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> newExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Iterate through the list of updates to compute the result.</span></span><br><span class="line">    <span class="keyword">let</span> update = queue.firstUpdate;</span><br><span class="line">    <span class="keyword">let</span> resultState = newBaseState;</span><br><span class="line">    <span class="keyword">while</span> (update !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> updateExpirationTime = update.expirationTime;</span><br><span class="line">        <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This update does have sufficient priority.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Mark the event time of this update as relevant to this render pass.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> This should ideally use the true event time of this update rather than</span></span><br><span class="line">            <span class="comment">// its priority which is a derived and not reverseable value.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> We should skip this update if it was already committed but currently</span></span><br><span class="line">            <span class="comment">// we have no way of detecting the difference between a committed and suspended</span></span><br><span class="line">            <span class="comment">// update here.</span></span><br><span class="line">            <span class="comment">// 不知道做了什么，因为第一次初始化时大部分都是null，仅仅是一些变量的初始化处理，下面也都是这样</span></span><br><span class="line">            markRenderEventTimeAndConfig(updateExpirationTime, update.suspenseConfig);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process it and compute a new result.</span></span><br><span class="line">            <span class="comment">// 更新组件state</span></span><br><span class="line">            resultState = getStateFromUpdate(</span><br><span class="line">                workInProgress,</span><br><span class="line">                queue,</span><br><span class="line">                update,</span><br><span class="line">                resultState,</span><br><span class="line">                props,</span><br><span class="line">                instance,</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">const</span> callback = update.callback;</span><br><span class="line">            <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">                workInProgress.effectTag |= Callback;</span><br><span class="line">                <span class="comment">// Set this to null, in case it was mutated during an aborted render.</span></span><br><span class="line">                update.nextEffect = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (queue.lastEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">                    queue.firstEffect = queue.lastEffect = update;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    queue.lastEffect.nextEffect = update;</span><br><span class="line">                    queue.lastEffect = update;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Continue to the next update.</span></span><br><span class="line">        update = update.next; <span class="comment">// 下一个更新</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newFirstUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">        queue.lastUpdate = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newFirstCapturedUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">        queue.lastCapturedUpdate = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        workInProgress.effectTag |= Callback;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newFirstUpdate === <span class="literal">null</span> &amp;&amp; newFirstCapturedUpdate === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We processed every update, without skipping. That means the new base</span></span><br><span class="line">        <span class="comment">// state is the same as the result state.</span></span><br><span class="line">        newBaseState = resultState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    queue.baseState = newBaseState;</span><br><span class="line">    queue.firstUpdate = newFirstUpdate;</span><br><span class="line">    queue.firstCapturedUpdate = newFirstCapturedUpdate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the remaining expiration time to be whatever is remaining in the queue.</span></span><br><span class="line">    <span class="comment">// This should be fine because the only two other things that contribute to</span></span><br><span class="line">    <span class="comment">// expiration time are props and context. We&#x27;re already in the middle of the</span></span><br><span class="line">    <span class="comment">// begin phase by the time we start processing the queue, so we&#x27;ve already</span></span><br><span class="line">    <span class="comment">// dealt with the props. Context in components that specify</span></span><br><span class="line">    <span class="comment">// shouldComponentUpdate is tricky; but we&#x27;ll have to account for</span></span><br><span class="line">    <span class="comment">// that regardless.</span></span><br><span class="line">    workInProgress.expirationTime = newExpirationTime; <span class="comment">// 剩余到期时间？</span></span><br><span class="line">    workInProgress.memoizedState = resultState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reconcileChildren-gt-reconcileChildFibers"><a href="#reconcileChildren-gt-reconcileChildFibers" class="headerlink" title="reconcileChildren -&gt; reconcileChildFibers"></a>reconcileChildren -&gt; reconcileChildFibers</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">workInProgress.child = reconcileChildFibers(</span><br><span class="line">    workInProgress,</span><br><span class="line">    current.child,</span><br><span class="line">    nextChildren,</span><br><span class="line">    renderExpirationTime,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> key = element.key;</span><br><span class="line">    <span class="keyword">let</span> child = currentFirstChild;</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (element.type === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// created是一个fiber</span></span><br><span class="line">        <span class="comment">// 更具element创建fiber</span></span><br><span class="line">        <span class="keyword">const</span> created = createFiberFromElement(element, returnFiber.mode, expirationTime);</span><br><span class="line">        created.ref = coerceRef(returnFiber, currentFirstChild, element); <span class="comment">// 处理ref,因为例子上没，先不看</span></span><br><span class="line">        created.return = returnFiber; <span class="comment">// 父节点</span></span><br><span class="line">        <span class="keyword">return</span> created;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">placeSingleChild</span>(<span class="params">newFiber: Fiber</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This is simpler for the single child case. We only need to do a</span></span><br><span class="line">    <span class="comment">// placement for inserting new children.</span></span><br><span class="line">    <span class="comment">// shouldTrackSideEffects是直接传参为true（运行时）</span></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects &amp;&amp; newFiber.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">        newFiber.effectTag = Placement; <span class="comment">// 0 -&gt; 2</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newFiber;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This API will tag the children with the side-effect of the reconciliation</span></span><br><span class="line"><span class="comment">// itself. They will be added to the side-effect list as we pass through the</span></span><br><span class="line"><span class="comment">// children and the parent.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function is not recursive.</span></span><br><span class="line">    <span class="comment">// If the top level item is an array, we treat it as a set of children,</span></span><br><span class="line">    <span class="comment">// not as a fragment. Nested arrays on the other hand will be treated as</span></span><br><span class="line">    <span class="comment">// fragment nodes. Recursion happens at the normal flow.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle top level unkeyed fragments as if they were arrays.</span></span><br><span class="line">    <span class="comment">// This leads to an ambiguity between &lt;&gt;&#123;[...]&#125;&lt;/&gt; and &lt;&gt;...&lt;/&gt;.</span></span><br><span class="line">    <span class="comment">// We treat the ambiguous cases above the same.</span></span><br><span class="line">    <span class="comment">// 是否fragment</span></span><br><span class="line">    <span class="keyword">const</span> isUnkeyedTopLevelFragment =</span><br><span class="line">        <span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">        newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">        newChild.key === <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">        newChild = newChild.props.children; <span class="comment">// 如果是fragment取他的子节点</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle object types</span></span><br><span class="line">    <span class="comment">// newChild可能是一个children</span></span><br><span class="line">    <span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (</span><br><span class="line">            newChild.$$typeof <span class="comment">// 子节点是单一的</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">                <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">                    reconcileSingleElement(</span><br><span class="line">                        returnFiber,</span><br><span class="line">                        currentFirstChild,</span><br><span class="line">                        newChild,</span><br><span class="line">                        expirationTime,</span><br><span class="line">                    ),</span><br><span class="line">                );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateClassComponent"><a href="#updateClassComponent" class="headerlink" title="updateClassComponent"></a>updateClassComponent</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    Component: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    nextProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Push context providers early to prevent context stack mismatches.</span></span><br><span class="line">    <span class="comment">// During mounting we don&#x27;t know the child context yet as the instance doesn&#x27;t exist.</span></span><br><span class="line">    <span class="comment">// We will invalidate the child context in finishClassComponent() right after rendering.</span></span><br><span class="line">    <span class="comment">// 是否有context</span></span><br><span class="line">    <span class="keyword">let</span> hasContext;</span><br><span class="line">    <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">        hasContext = <span class="literal">true</span>;</span><br><span class="line">        pushLegacyContextProvider(workInProgress);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        hasContext = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// context相关,先不管</span></span><br><span class="line">    prepareToReadContext(workInProgress, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.stateNode;</span><br><span class="line">    <span class="keyword">let</span> shouldUpdate;</span><br><span class="line">    <span class="keyword">if</span> (instance === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// An class component without an instance only mounts if it suspended</span></span><br><span class="line">            <span class="comment">// inside a non- concurrent tree, in an inconsistent state. We want to</span></span><br><span class="line">            <span class="comment">// tree it like a new mount, even though an empty version of it already</span></span><br><span class="line">            <span class="comment">// committed. Disconnect the alternate pointers.</span></span><br><span class="line">            current.alternate = <span class="literal">null</span>;</span><br><span class="line">            workInProgress.alternate = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">            workInProgress.effectTag |= Placement;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// In the initial pass we might need to construct the instance.</span></span><br><span class="line">        <span class="comment">// 构造实例</span></span><br><span class="line">        constructClassInstance(workInProgress, Component, nextProps, renderExpirationTime);</span><br><span class="line">        <span class="comment">// 执行渲染前的生命周期</span></span><br><span class="line">        mountClassInstance(workInProgress, Component, nextProps, renderExpirationTime);</span><br><span class="line">        shouldUpdate = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> nextUnitOfWork = finishClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        shouldUpdate,</span><br><span class="line">        hasContext,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nextUnitOfWork;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="constructClassInstance"><a href="#constructClassInstance" class="headerlink" title="constructClassInstance"></a>constructClassInstance</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">constructClassInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    ctor: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    props: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> isLegacyContextConsumer = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> unmaskedContext = emptyContextObject;</span><br><span class="line">    <span class="keyword">let</span> context = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> contextType = ctor.contextType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 到这 前景：从root -&gt; LocaleProvider,一层层下去</span></span><br><span class="line">    <span class="comment">// debugger</span></span><br><span class="line">    <span class="comment">// 获取context ? context相关，先不看</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">&#x27;object&#x27;</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">        context = readContext((contextType: any));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        unmaskedContext = getUnmaskedContext(workInProgress, ctor, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">const</span> contextTypes = ctor.contextTypes;</span><br><span class="line">        isLegacyContextConsumer = contextTypes !== <span class="literal">null</span> &amp;&amp; contextTypes !== <span class="literal">undefined</span>;</span><br><span class="line">        context = isLegacyContextConsumer</span><br><span class="line">            ? getMaskedContext(workInProgress, unmaskedContext)</span><br><span class="line">            : emptyContextObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new 当前组件（class）,获得实例</span></span><br><span class="line">    <span class="keyword">const</span> instance = <span class="keyword">new</span> ctor(props, context);</span><br><span class="line">    <span class="keyword">const</span> state = (workInProgress.memoizedState =</span><br><span class="line">        instance.state !== <span class="literal">null</span> &amp;&amp; instance.state !== <span class="literal">undefined</span> ? instance.state : <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// workInProgress和instance互相添加为属性，stateNode和_reactInternalFiber，能够让双方互相找到</span></span><br><span class="line">    <span class="comment">// 更新了instance的updater方法（直接被替换了一个新的）</span></span><br><span class="line">    adoptClassInstance(workInProgress, instance);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cache unmasked context so we can avoid recreating masked context unless necessary.</span></span><br><span class="line">    <span class="comment">// ReactFiberContext usually updates this cache but can&#x27;t for newly-created instances.</span></span><br><span class="line">    <span class="comment">// 在contextType有数据时是true</span></span><br><span class="line">    <span class="keyword">if</span> (isLegacyContextConsumer) &#123;</span><br><span class="line">        cacheContext(workInProgress, unmaskedContext, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mountClassInstance"><a href="#mountClassInstance" class="headerlink" title="mountClassInstance"></a>mountClassInstance</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Invokes the mount life-cycles on a previously never rendered instance.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountClassInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    ctor: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    newProps: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 更新state等数据</span></span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.stateNode;</span><br><span class="line">    instance.props = newProps;</span><br><span class="line">    instance.state = workInProgress.memoizedState;</span><br><span class="line">    instance.refs = emptyRefsObject;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> contextType = ctor.contextType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// context</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">&#x27;object&#x27;</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">        instance.context = readContext(contextType);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> unmaskedContext = getUnmaskedContext(workInProgress, ctor, <span class="literal">true</span>);</span><br><span class="line">        instance.context = getMaskedContext(workInProgress, unmaskedContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> updateQueue = workInProgress.updateQueue;</span><br><span class="line">    <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">        processUpdateQueue(workInProgress, updateQueue, newProps, instance, renderExpirationTime);</span><br><span class="line">        instance.state = workInProgress.memoizedState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理getDerivedStateFromProps，第一个看到的生命周期处理</span></span><br><span class="line">    <span class="comment">// getDerivedStateFromProps 有返回值，做Object.assign处理，否则返回原state</span></span><br><span class="line">    <span class="comment">// workInProgress.memoizedState被更新了</span></span><br><span class="line">    <span class="comment">// 现在还处于渲染前</span></span><br><span class="line">    <span class="keyword">const</span> getDerivedStateFromProps = ctor.getDerivedStateFromProps;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        applyDerivedStateFromProps(workInProgress, ctor, getDerivedStateFromProps, newProps);</span><br><span class="line">        instance.state = workInProgress.memoizedState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// In order to support react-lifecycles-compat polyfilled components,</span></span><br><span class="line">    <span class="comment">// Unsafe lifecycles should not be invoked for components using the new APIs.</span></span><br><span class="line">    <span class="comment">// 如果使用了新的生命周期函数，就不调用老的不安全的生命周期函数componentWillMount</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="keyword">typeof</span> ctor.getDerivedStateFromProps !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> instance.getSnapshotBeforeUpdate !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">        (<span class="keyword">typeof</span> instance.UNSAFE_componentWillMount === <span class="string">&#x27;function&#x27;</span> ||</span><br><span class="line">            <span class="keyword">typeof</span> instance.componentWillMount === <span class="string">&#x27;function&#x27;</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// 调用componentWillMount、UNSAFE_componentWillMount</span></span><br><span class="line">        callComponentWillMount(workInProgress, instance);</span><br><span class="line">        <span class="comment">// If we had additional state updates during this life-cycle, let&#x27;s</span></span><br><span class="line">        <span class="comment">// process them now.</span></span><br><span class="line">        updateQueue = workInProgress.updateQueue;</span><br><span class="line">        <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">            processUpdateQueue(</span><br><span class="line">                workInProgress,</span><br><span class="line">                updateQueue,</span><br><span class="line">                newProps,</span><br><span class="line">                instance,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">            );</span><br><span class="line">            instance.state = workInProgress.memoizedState;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.componentDidMount === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        workInProgress.effectTag |= Update; <span class="comment">// effectTag添加Update</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="finishClassComponent"><a href="#finishClassComponent" class="headerlink" title="finishClassComponent"></a>finishClassComponent</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finishClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    Component: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    shouldUpdate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">    hasContext: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Refs should update even if shouldComponentUpdate returns false</span></span><br><span class="line">    <span class="comment">// 标记ref,表示workInProgress上存在ref属性，通过effectTag</span></span><br><span class="line">    <span class="comment">// debugger</span></span><br><span class="line">    markRef(current, workInProgress);</span><br><span class="line">    <span class="comment">//  是否包含DidCapture标记</span></span><br><span class="line">    <span class="keyword">const</span> didCaptureError = (workInProgress.effectTag &amp; DidCapture) !== NoEffect;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!shouldUpdate &amp;&amp; !didCaptureError) &#123;</span><br><span class="line">        <span class="comment">// Context providers should defer to sCU for rendering</span></span><br><span class="line">        <span class="keyword">if</span> (hasContext) &#123;</span><br><span class="line">            invalidateContextProvider(workInProgress, Component, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(current, workInProgress, renderExpirationTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.stateNode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rerender</span></span><br><span class="line">    ReactCurrentOwner.current = workInProgress;</span><br><span class="line">    <span class="keyword">let</span> nextChildren;</span><br><span class="line">    <span class="comment">// 包含DidCapture标记 &amp;&amp; getDerivedStateFromError不是函数</span></span><br><span class="line">    <span class="keyword">if</span> (didCaptureError &amp;&amp; <span class="keyword">typeof</span> Component.getDerivedStateFromError !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// If we captured an error, but getDerivedStateFrom catch is not defined,</span></span><br><span class="line">        <span class="comment">// unmount all the children. componentDidCatch will schedule an update to</span></span><br><span class="line">        <span class="comment">// re-render a fallback. This is temporary until we migrate everyone to</span></span><br><span class="line">        <span class="comment">// the new API.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Warn in a future release.</span></span><br><span class="line">        nextChildren = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">            stopProfilerTimerIfRunning(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 正常渲染</span></span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// debugger</span></span><br><span class="line">            <span class="comment">// 执行render, 即React.createElement</span></span><br><span class="line">            <span class="comment">// 把es6模板转成React.createElement应该是loader完成的,具体怎么转的就先不管了</span></span><br><span class="line">            <span class="comment">// 见createElement.md</span></span><br><span class="line">            nextChildren = instance.render();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// React DevTools reads this flag.</span></span><br><span class="line">    <span class="comment">// React DevTools需要</span></span><br><span class="line">    workInProgress.effectTag |= PerformedWork;</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; didCaptureError) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 和reconcileChildFibers代码一样，唯一区别是调用时shouldTrackSideEffects为false</span></span><br><span class="line">        reconcileChildren(current, workInProgress, nextChildren, renderExpirationTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Memoize state using the values we just used to render.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Restructure so we never read values from the instance.</span></span><br><span class="line">    <span class="comment">// 记住state, 这个是preState?</span></span><br><span class="line">    workInProgress.memoizedState = instance.state;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The context might have changed so we need to recalculate it.</span></span><br><span class="line">    <span class="keyword">if</span> (hasContext) &#123;</span><br><span class="line">        invalidateContextProvider(workInProgress, Component, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reconcileChildFibers-和-mountChildFibers"><a href="#reconcileChildFibers-和-mountChildFibers" class="headerlink" title="reconcileChildFibers 和 mountChildFibers"></a>reconcileChildFibers 和 mountChildFibers</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reconcileChildFibers = ChildReconciler(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mountChildFibers = ChildReconciler(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    nextChildren: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If this is a fresh new component that hasn&#x27;t been rendered yet, we</span></span><br><span class="line">        <span class="comment">// won&#x27;t update its child set by applying minimal side-effects. Instead,</span></span><br><span class="line">        <span class="comment">// we will add them all to the child before it gets rendered. That means</span></span><br><span class="line">        <span class="comment">// we can optimize this reconciliation pass by not tracking side-effects.</span></span><br><span class="line">        workInProgress.child = mountChildFibers(</span><br><span class="line">            workInProgress,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            nextChildren,</span><br><span class="line">            renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If the current child is the same as the work in progress, it means that</span></span><br><span class="line">        <span class="comment">// we haven&#x27;t yet started any work on these children. Therefore, we use</span></span><br><span class="line">        <span class="comment">// the clone algorithm to create a copy of all the current children.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we had any progressed work already, that is invalid at this point so</span></span><br><span class="line">        <span class="comment">// let&#x27;s throw it out.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把子节点转换成一个fiber</span></span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        workInProgress.child = reconcileChildFibers(</span><br><span class="line">            workInProgress,</span><br><span class="line">            current.child,</span><br><span class="line">            nextChildren,</span><br><span class="line">            renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateHostComponent"><a href="#updateHostComponent" class="headerlink" title="updateHostComponent"></a>updateHostComponent</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHostComponent</span>(<span class="params">current, workInProgress, renderExpirationTime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// debugger</span></span><br><span class="line">    pushHostContext(workInProgress);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">        tryToClaimNextHydratableInstance(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line">    <span class="keyword">const</span> nextProps = workInProgress.pendingProps;</span><br><span class="line">    <span class="keyword">const</span> prevProps = current !== <span class="literal">null</span> ? current.memoizedProps : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> nextChildren = nextProps.children;</span><br><span class="line">    <span class="keyword">const</span> isDirectTextChild = shouldSetTextContent(type, nextProps); <span class="comment">// 子节点是文本节点</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isDirectTextChild) &#123;</span><br><span class="line">        <span class="comment">// 如果是文本节点</span></span><br><span class="line">        <span class="comment">// We special case a direct text child of a host node. This is a common</span></span><br><span class="line">        <span class="comment">// case. We won&#x27;t handle it as a reified child. We will instead handle</span></span><br><span class="line">        <span class="comment">// this in the host environment that also have access to this prop. That</span></span><br><span class="line">        <span class="comment">// avoids allocating another HostText fiber and traversing it.</span></span><br><span class="line">        nextChildren = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevProps !== <span class="literal">null</span> &amp;&amp; shouldSetTextContent(type, prevProps)) &#123;</span><br><span class="line">        <span class="comment">// If we&#x27;re switching from a direct text child to a normal child, or to</span></span><br><span class="line">        <span class="comment">// empty, we need to schedule the text content to be reset.</span></span><br><span class="line">        workInProgress.effectTag |= ContentReset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    markRef(current, workInProgress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the host config to see if the children are offscreen/hidden.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        workInProgress.mode &amp; ConcurrentMode &amp;&amp;</span><br><span class="line">        renderExpirationTime !== Never &amp;&amp;</span><br><span class="line">        shouldDeprioritizeSubtree(type, nextProps)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reconcileChildren(current, workInProgress, nextChildren, renderExpirationTime);</span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reconcileChildFibers（详细）"><a href="#reconcileChildFibers（详细）" class="headerlink" title="reconcileChildFibers（详细）"></a>reconcileChildFibers（详细）</h3><p>见 reconcileChildFibers.md</p>
<h3 id="completeUnitOfWork"><a href="#completeUnitOfWork" class="headerlink" title="completeUnitOfWork"></a>completeUnitOfWork</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Attempt to complete the current unit of work, then move to the next</span></span><br><span class="line">    <span class="comment">// sibling. If there are no more siblings, return to the parent fiber.</span></span><br><span class="line">    <span class="comment">// 翻译：结束当前的工作单元，然后移动到下一个兄弟。如果没有，返回父fiber</span></span><br><span class="line">    workInProgress = unitOfWork;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// The current, flushed, state of this fiber is the alternate. Ideally</span></span><br><span class="line">        <span class="comment">// nothing should rely on this, but relying on it here means that we don&#x27;t</span></span><br><span class="line">        <span class="comment">// need an additional field on the work in progress.</span></span><br><span class="line">        <span class="keyword">const</span> current = workInProgress.alternate;</span><br><span class="line">        <span class="keyword">const</span> returnFiber = workInProgress.return;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if the work completed or if something threw.</span></span><br><span class="line">        <span class="keyword">if</span> ((workInProgress.effectTag &amp; Incomplete) === NoEffect) &#123;</span><br><span class="line">            <span class="keyword">let</span> next;</span><br><span class="line">            <span class="keyword">if</span> (!enableProfilerTimer || (workInProgress.mode &amp; ProfileMode) === NoMode) &#123;</span><br><span class="line">                next = completeWork(current, workInProgress, renderExpirationTime);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                startProfilerTimer(workInProgress);</span><br><span class="line">                next = completeWork(current, workInProgress, renderExpirationTime);</span><br><span class="line">                <span class="comment">// Update render duration assuming we didn&#x27;t error.</span></span><br><span class="line">                stopProfilerTimerIfRunningAndRecordDelta(workInProgress, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            resetChildExpirationTime(workInProgress); <span class="comment">// 重置时间</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Completing this fiber spawned new work. Work on that next.</span></span><br><span class="line">                <span class="keyword">return</span> next;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                returnFiber !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                <span class="comment">// Do not append effects to parents if a sibling failed to complete</span></span><br><span class="line">                (returnFiber.effectTag &amp; Incomplete) === NoEffect</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// Append all the effects of the subtree and this fiber onto the effect</span></span><br><span class="line">                <span class="comment">// list of the parent. The completion order of the children affects the</span></span><br><span class="line">                <span class="comment">// side-effect order.</span></span><br><span class="line">                <span class="keyword">if</span> (returnFiber.firstEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">                    returnFiber.firstEffect = workInProgress.firstEffect;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (workInProgress.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (returnFiber.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">                        returnFiber.lastEffect.nextEffect = workInProgress.firstEffect;</span><br><span class="line">                    &#125;</span><br><span class="line">                    returnFiber.lastEffect = workInProgress.lastEffect;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If this fiber had side-effects, we append it AFTER the children&#x27;s</span></span><br><span class="line">                <span class="comment">// side-effects. We can perform certain side-effects earlier if needed,</span></span><br><span class="line">                <span class="comment">// by doing multiple passes over the effect list. We don&#x27;t want to</span></span><br><span class="line">                <span class="comment">// schedule our own side-effect on our own list because if end up</span></span><br><span class="line">                <span class="comment">// reusing children we&#x27;ll schedule this effect onto itself since we&#x27;re</span></span><br><span class="line">                <span class="comment">// at the end.</span></span><br><span class="line">                <span class="keyword">const</span> effectTag = workInProgress.effectTag;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Skip both NoWork and PerformedWork tags when creating the effect</span></span><br><span class="line">                <span class="comment">// list. PerformedWork effect is read by React DevTools but shouldn&#x27;t be</span></span><br><span class="line">                <span class="comment">// committed.</span></span><br><span class="line">                <span class="comment">// debugger</span></span><br><span class="line">                <span class="comment">// effect添加，</span></span><br><span class="line">                <span class="keyword">if</span> (effectTag &gt; PerformedWork) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (returnFiber.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">                        returnFiber.lastEffect.nextEffect = workInProgress;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        returnFiber.firstEffect = workInProgress;</span><br><span class="line">                    &#125;</span><br><span class="line">                    returnFiber.lastEffect = workInProgress;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This fiber did not complete because something threw. Pop values off</span></span><br><span class="line">            <span class="comment">// the stack without entering the complete phase. If this is a boundary,</span></span><br><span class="line">            <span class="comment">// capture values if possible.</span></span><br><span class="line">            <span class="keyword">const</span> next = unwindWork(workInProgress, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Because this fiber did not complete, don&#x27;t reset its expiration time.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; (workInProgress.mode &amp; ProfileMode) !== NoMode) &#123;</span><br><span class="line">                <span class="comment">// Record the render duration for the fiber that errored.</span></span><br><span class="line">                stopProfilerTimerIfRunningAndRecordDelta(workInProgress, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Include the time spent working on failed children before continuing.</span></span><br><span class="line">                <span class="keyword">let</span> actualDuration = workInProgress.actualDuration;</span><br><span class="line">                <span class="keyword">let</span> child = workInProgress.child;</span><br><span class="line">                <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    actualDuration += child.actualDuration;</span><br><span class="line">                    child = child.sibling;</span><br><span class="line">                &#125;</span><br><span class="line">                workInProgress.actualDuration = actualDuration;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// If completing this work spawned new work, do that next. We&#x27;ll come</span></span><br><span class="line">                <span class="comment">// back here again.</span></span><br><span class="line">                <span class="comment">// Since we&#x27;re restarting, remove anything that is not a host effect</span></span><br><span class="line">                <span class="comment">// from the effect tag.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> The name stopFailedWorkTimer is misleading because Suspense</span></span><br><span class="line">                <span class="comment">// also captures and restarts.</span></span><br><span class="line">                stopFailedWorkTimer(workInProgress);</span><br><span class="line">                next.effectTag &amp;= HostEffectMask;</span><br><span class="line">                <span class="keyword">return</span> next;</span><br><span class="line">            &#125;</span><br><span class="line">            stopWorkTimer(workInProgress);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Mark the parent fiber as incomplete and clear its effect list.</span></span><br><span class="line">                returnFiber.firstEffect = returnFiber.lastEffect = <span class="literal">null</span>;</span><br><span class="line">                returnFiber.effectTag |= Incomplete;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> siblingFiber = workInProgress.sibling; <span class="comment">// 返回相邻节点</span></span><br><span class="line">        <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">            <span class="keyword">return</span> siblingFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Otherwise, return to the parent 没有就从父节点中找相邻节点</span></span><br><span class="line">        workInProgress = returnFiber;</span><br><span class="line">    &#125; <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We&#x27;ve reached the root.</span></span><br><span class="line">    <span class="keyword">if</span> (workInProgressRootExitStatus === RootIncomplete) &#123;</span><br><span class="line">        workInProgressRootExitStatus = RootCompleted;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/react%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag"># react源码解析</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/09/08/react/%E5%90%84%E7%A7%8D%E5%AF%B9%E8%B1%A1/" rel="prev" title="一些对象定义">
      <i class="fa fa-chevron-left"></i> 一些对象定义
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/09/08/react/fiber/" rel="next" title="fiber">
      fiber <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%84%B6%E5%90%8E%E6%98%AFrenderRoot"><span class="nav-number">1.</span> <span class="nav-text">然后是renderRoot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%88%E8%BF%9B%E5%85%A5workLoopSync"><span class="nav-number">2.</span> <span class="nav-text">先进入workLoopSync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#performUnitOfWork"><span class="nav-number">3.</span> <span class="nav-text">performUnitOfWork</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beginWork"><span class="nav-number">4.</span> <span class="nav-text">beginWork</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#updateHostRoot"><span class="nav-number">5.</span> <span class="nav-text">updateHostRoot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#processUpdateQueue"><span class="nav-number">6.</span> <span class="nav-text">processUpdateQueue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reconcileChildren-gt-reconcileChildFibers"><span class="nav-number">7.</span> <span class="nav-text">reconcileChildren -&gt; reconcileChildFibers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#updateClassComponent"><span class="nav-number">8.</span> <span class="nav-text">updateClassComponent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#constructClassInstance"><span class="nav-number">9.</span> <span class="nav-text">constructClassInstance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mountClassInstance"><span class="nav-number">10.</span> <span class="nav-text">mountClassInstance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#finishClassComponent"><span class="nav-number">11.</span> <span class="nav-text">finishClassComponent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reconcileChildFibers-%E5%92%8C-mountChildFibers"><span class="nav-number">12.</span> <span class="nav-text">reconcileChildFibers 和 mountChildFibers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#updateHostComponent"><span class="nav-number">13.</span> <span class="nav-text">updateHostComponent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reconcileChildFibers%EF%BC%88%E8%AF%A6%E7%BB%86%EF%BC%89"><span class="nav-number">14.</span> <span class="nav-text">reconcileChildFibers（详细）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#completeUnitOfWork"><span class="nav-number">15.</span> <span class="nav-text">completeUnitOfWork</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">lokve</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lokve</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
