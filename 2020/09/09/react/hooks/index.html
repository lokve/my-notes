<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/my-notes/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/my-notes/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/my-notes/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/my-notes/images/logo.svg" color="#222">

<link rel="stylesheet" href="/my-notes/css/main.css">


<link rel="stylesheet" href="/my-notes/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/my-notes/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="在renderWithHooks中添加了方法,调用的 mount 或者 uodate 的 hooks 方法 123456789if (__DEV__) &amp;#123;    &#x2F;&#x2F; ...&amp;#125; else &amp;#123;    ReactCurrentDispatcher.current &#x3D;        nextCurrentHook &#x3D;&#x3D;&#x3D; null ? HooksDispatcherOnMo">
<meta property="og:type" content="article">
<meta property="og:title" content="hooks">
<meta property="og:url" content="http://example.com/2020/09/09/react/hooks/index.html">
<meta property="og:site_name" content="学习笔记">
<meta property="og:description" content="在renderWithHooks中添加了方法,调用的 mount 或者 uodate 的 hooks 方法 123456789if (__DEV__) &amp;#123;    &#x2F;&#x2F; ...&amp;#125; else &amp;#123;    ReactCurrentDispatcher.current &#x3D;        nextCurrentHook &#x3D;&#x3D;&#x3D; null ? HooksDispatcherOnMo">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-09-09T06:00:00.000Z">
<meta property="article:modified_time" content="2020-09-15T04:15:42.802Z">
<meta property="article:author" content="lokve">
<meta property="article:tag" content="react源码解析">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2020/09/09/react/hooks/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>hooks | 学习笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/my-notes/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">学习笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/my-notes/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/my-notes/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/my-notes/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/my-notes/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/09/react/hooks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/my-notes/images/avatar.gif">
      <meta itemprop="name" content="lokve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="学习笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          hooks
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-09 14:00:00" itemprop="dateCreated datePublished" datetime="2020-09-09T14:00:00+08:00">2020-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-15 12:15:42" itemprop="dateModified" datetime="2020-09-15T12:15:42+08:00">2020-09-15</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>在<code>renderWithHooks</code>中添加了方法,调用的 mount 或者 uodate 的 hooks 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ReactCurrentDispatcher.current =</span><br><span class="line">        nextCurrentHook === <span class="literal">null</span> ? HooksDispatcherOnMount : HooksDispatcherOnUpdate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行函数，得到children</span></span><br><span class="line"><span class="keyword">let</span> children = Component(props, refOrContext);</span><br></pre></td></tr></table></figure>

<h2 id="公共"><a href="#公共" class="headerlink" title="公共"></a>公共</h2><h3 id="mountWorkInProgressHook"><a href="#mountWorkInProgressHook" class="headerlink" title="mountWorkInProgressHook"></a>mountWorkInProgressHook</h3><p>基于这个方法，所有的 hooks 都在一条链上</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountWorkInProgressHook</span>(<span class="params"></span>): <span class="title">Hook</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> hook: Hook = &#123;</span><br><span class="line">        memoizedState: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">        baseState: <span class="literal">null</span>,</span><br><span class="line">        queue: <span class="literal">null</span>,</span><br><span class="line">        baseUpdate: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">        next: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// This is the first hook in the list</span></span><br><span class="line">        firstWorkInProgressHook = workInProgressHook = hook;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Append to the end of the list</span></span><br><span class="line">        workInProgressHook = workInProgressHook.next = hook;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateWorkInProgressHook"><a href="#updateWorkInProgressHook" class="headerlink" title="updateWorkInProgressHook"></a>updateWorkInProgressHook</h3><p>在跟新时都有用到，用来记录当前工作的 hook 和 next hook</p>
<p>并返回一个 clone hook</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateWorkInProgressHook</span>(<span class="params"></span>): <span class="title">Hook</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function is used both for updates and for re-renders triggered by a</span></span><br><span class="line">    <span class="comment">// render phase update. It assumes there is either a current hook we can</span></span><br><span class="line">    <span class="comment">// clone, or a work-in-progress hook from a previous render pass that we can</span></span><br><span class="line">    <span class="comment">// use as a base. When we reach the end of the base list, we must switch to</span></span><br><span class="line">    <span class="comment">// the dispatcher used for mounts.</span></span><br><span class="line">    <span class="keyword">if</span> (nextWorkInProgressHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// There&#x27;s already a work-in-progress. Reuse it.</span></span><br><span class="line">        workInProgressHook = nextWorkInProgressHook;</span><br><span class="line">        nextWorkInProgressHook = workInProgressHook.next;</span><br><span class="line"></span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line">        nextCurrentHook = currentHook !== <span class="literal">null</span> ? currentHook.next : <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Clone from the current hook.</span></span><br><span class="line">        invariant(nextCurrentHook !== <span class="literal">null</span>, <span class="string">&#x27;Rendered more hooks than during the previous render.&#x27;</span>);</span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> newHook: Hook = &#123;</span><br><span class="line">            memoizedState: currentHook.memoizedState,</span><br><span class="line"></span><br><span class="line">            baseState: currentHook.baseState,</span><br><span class="line">            queue: currentHook.queue,</span><br><span class="line">            baseUpdate: currentHook.baseUpdate,</span><br><span class="line"></span><br><span class="line">            next: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is the first hook in the list.</span></span><br><span class="line">            workInProgressHook = firstWorkInProgressHook = newHook;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Append to the end of the list.</span></span><br><span class="line">            workInProgressHook = workInProgressHook.next = newHook;</span><br><span class="line">        &#125;</span><br><span class="line">        nextCurrentHook = currentHook.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="方法绑定"><a href="#方法绑定" class="headerlink" title="方法绑定"></a>方法绑定</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 应该是错误处理</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ContextOnlyDispatcher: Dispatcher = &#123;</span><br><span class="line">    readContext,</span><br><span class="line"></span><br><span class="line">    useCallback: throwInvalidHookError,</span><br><span class="line">    useContext: throwInvalidHookError,</span><br><span class="line">    useEffect: throwInvalidHookError,</span><br><span class="line">    useImperativeHandle: throwInvalidHookError,</span><br><span class="line">    useLayoutEffect: throwInvalidHookError,</span><br><span class="line">    useMemo: throwInvalidHookError,</span><br><span class="line">    useReducer: throwInvalidHookError,</span><br><span class="line">    useRef: throwInvalidHookError,</span><br><span class="line">    useState: throwInvalidHookError,</span><br><span class="line">    useDebugValue: throwInvalidHookError,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化用</span></span><br><span class="line"><span class="keyword">const</span> HooksDispatcherOnMount: Dispatcher = &#123;</span><br><span class="line">    readContext,</span><br><span class="line"></span><br><span class="line">    useCallback: mountCallback,</span><br><span class="line">    useContext: readContext,</span><br><span class="line">    useEffect: mountEffect,</span><br><span class="line">    useImperativeHandle: mountImperativeHandle,</span><br><span class="line">    useLayoutEffect: mountLayoutEffect,</span><br><span class="line">    useMemo: mountMemo,</span><br><span class="line">    useReducer: mountReducer,</span><br><span class="line">    useRef: mountRef,</span><br><span class="line">    useState: mountState,</span><br><span class="line">    useDebugValue: mountDebugValue,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跟新用</span></span><br><span class="line"><span class="keyword">const</span> HooksDispatcherOnUpdate: Dispatcher = &#123;</span><br><span class="line">    readContext,</span><br><span class="line"></span><br><span class="line">    useCallback: updateCallback,</span><br><span class="line">    useContext: readContext,</span><br><span class="line">    useEffect: updateEffect,</span><br><span class="line">    useImperativeHandle: updateImperativeHandle,</span><br><span class="line">    useLayoutEffect: updateLayoutEffect,</span><br><span class="line">    useMemo: updateMemo,</span><br><span class="line">    useReducer: updateReducer,</span><br><span class="line">    useRef: updateRef,</span><br><span class="line">    useState: updateState,</span><br><span class="line">    useDebugValue: updateDebugValue,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="useRef"><a href="#useRef" class="headerlink" title="useRef"></a>useRef</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useRef</span>(<span class="params">initialValue</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> dispatcher = resolveDispatcher();</span><br><span class="line">    <span class="keyword">return</span> dispatcher.useRef(initialValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveDispatcher</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> dispatcher = ReactCurrentDispatcher.current;</span><br><span class="line">    !(dispatcher !== <span class="literal">null</span>)</span><br><span class="line">        ? invariant(</span><br><span class="line">              <span class="literal">false</span>,</span><br><span class="line">              <span class="string">&#x27;Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for one of the following reasons:\n1. You might have mismatching versions of React and the renderer (such as React DOM)\n2. You might be breaking the Rules of Hooks\n3. You might have more than one copy of React in the same app\nSee https://fb.me/react-invalid-hook-call for tips about how to debug and fix this problem.&#x27;</span>,</span><br><span class="line">          )</span><br><span class="line">        : <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> dispatcher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>然后进入<code>dispatcher.useRef</code>即<code>mountRef</code></p>
<h4 id="mountRef"><a href="#mountRef" class="headerlink" title="mountRef"></a>mountRef</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountRef</span>&lt;<span class="title">T</span>&gt;(<span class="params">initialValue: T</span>): </span>&#123;current: T&#125; &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line">    <span class="keyword">const</span> ref = &#123;<span class="attr">current</span>: initialValue&#125;;</span><br><span class="line">    hook.memoizedState = ref;</span><br><span class="line">    <span class="keyword">return</span> ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useState</span>(<span class="params">initialState</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> dispatcher = resolveDispatcher();</span><br><span class="line">    <span class="keyword">return</span> dispatcher.useState(initialState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h3><p>开始都差不多，进入 <code>dispatcher.useState</code>即<code>mountState</code></p>
<h4 id="mountState"><a href="#mountState" class="headerlink" title="mountState"></a>mountState</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">basicStateReducer</span>&lt;<span class="title">S</span>&gt;(<span class="params">state: S, action: BasicStateAction&lt;S&gt;</span>): <span class="title">S</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span> ? action(state) : action;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mountState&lt;S&gt;(initialState: (() =&gt; S) | S): [S, Dispatch&lt;BasicStateAction&lt;S&gt;&gt;] &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        initialState = initialState();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// memoizedState 最新结果</span></span><br><span class="line">    hook.memoizedState = hook.baseState = initialState;</span><br><span class="line">    <span class="keyword">const</span> queue = (hook.queue = &#123;</span><br><span class="line">        last: <span class="literal">null</span>,</span><br><span class="line">        dispatch: <span class="literal">null</span>,</span><br><span class="line">        lastRenderedReducer: basicStateReducer,</span><br><span class="line">        lastRenderedState: (initialState: any),</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 跟新方法</span></span><br><span class="line">    <span class="keyword">const</span> dispatch: Dispatch&lt;BasicStateAction&lt;S&gt;&gt; = (queue.dispatch = (dispatchAction.bind(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="comment">// Flow doesn&#x27;t know this is non-null, but we do.</span></span><br><span class="line">        ((currentlyRenderingFiber: any): Fiber),</span><br><span class="line">        queue,</span><br><span class="line">    ): any));</span><br><span class="line">    <span class="keyword">return</span> [hook.memoizedState, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><h4 id="dispatchAction"><a href="#dispatchAction" class="headerlink" title="dispatchAction"></a>dispatchAction</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Object.is polyfill</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is</span>(<span class="params">x: any, y: any</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        (x === y &amp;&amp; (x !== <span class="number">0</span> || <span class="number">1</span> / x === <span class="number">1</span> / y)) || (x !== x &amp;&amp; y !== y) <span class="comment">// eslint-disable-line no-self-compare</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// action 已经计算好的值，即setXXX的传参,</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchAction</span>&lt;<span class="title">S</span>, <span class="title">A</span>&gt;(<span class="params">fiber: Fiber, queue: UpdateQueue&lt;S, A&gt;, action: A</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> alternate = fiber.alternate;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        fiber === currentlyRenderingFiber ||</span><br><span class="line">        (alternate !== <span class="literal">null</span> &amp;&amp; alternate === currentlyRenderingFiber)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">// This is a render phase update. Stash it in a lazily-created map of</span></span><br><span class="line">        <span class="comment">// queue -&gt; linked list of updates. After this render pass, we&#x27;ll restart</span></span><br><span class="line">        <span class="comment">// and apply the stashed updates on top of the work-in-progress hook.</span></span><br><span class="line">        didScheduleRenderPhaseUpdate = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">const</span> update: Update&lt;S, A&gt; = &#123;</span><br><span class="line">            expirationTime: renderExpirationTime,</span><br><span class="line">            suspenseConfig: <span class="literal">null</span>,</span><br><span class="line">            action,</span><br><span class="line">            eagerReducer: <span class="literal">null</span>,</span><br><span class="line">            eagerState: <span class="literal">null</span>,</span><br><span class="line">            next: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (renderPhaseUpdates === <span class="literal">null</span>) &#123;</span><br><span class="line">            renderPhaseUpdates = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> firstRenderPhaseUpdate = renderPhaseUpdates.get(queue);</span><br><span class="line">        <span class="keyword">if</span> (firstRenderPhaseUpdate === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            renderPhaseUpdates.set(queue, update);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Append the update to the end of the list.</span></span><br><span class="line">            <span class="keyword">let</span> lastRenderPhaseUpdate = firstRenderPhaseUpdate;</span><br><span class="line">            <span class="keyword">while</span> (lastRenderPhaseUpdate.next !== <span class="literal">null</span>) &#123;</span><br><span class="line">                lastRenderPhaseUpdate = lastRenderPhaseUpdate.next;</span><br><span class="line">            &#125;</span><br><span class="line">            lastRenderPhaseUpdate.next = update;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (revertPassiveEffectsChange) &#123;</span><br><span class="line">            flushPassiveEffects();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> currentTime = requestCurrentTime();</span><br><span class="line">        <span class="keyword">const</span> suspenseConfig = requestCurrentSuspenseConfig();</span><br><span class="line">        <span class="keyword">const</span> expirationTime = computeExpirationForFiber(currentTime, fiber, suspenseConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> update: Update&lt;S, A&gt; = &#123;</span><br><span class="line">            expirationTime,</span><br><span class="line">            suspenseConfig,</span><br><span class="line">            action,</span><br><span class="line">            eagerReducer: <span class="literal">null</span>,</span><br><span class="line">            eagerState: <span class="literal">null</span>,</span><br><span class="line">            next: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Append the update to the end of the list.</span></span><br><span class="line">        <span class="keyword">const</span> last = queue.last;</span><br><span class="line">        <span class="keyword">if</span> (last === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is the first update. Create a circular list.</span></span><br><span class="line">            update.next = update;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> first = last.next;</span><br><span class="line">            <span class="keyword">if</span> (first !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Still circular.</span></span><br><span class="line">                update.next = first;</span><br><span class="line">            &#125;</span><br><span class="line">            last.next = update;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// queue里放着就数据，last是新数据</span></span><br><span class="line">        queue.last = update;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            fiber.expirationTime === NoWork &amp;&amp;</span><br><span class="line">            (alternate === <span class="literal">null</span> || alternate.expirationTime === NoWork)</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// The queue is currently empty, which means we can eagerly compute the</span></span><br><span class="line">            <span class="comment">// next state before entering the render phase. If the new state is the</span></span><br><span class="line">            <span class="comment">// same as the current state, we may be able to bail out entirely.</span></span><br><span class="line">            <span class="keyword">const</span> lastRenderedReducer = queue.lastRenderedReducer;</span><br><span class="line">            <span class="keyword">if</span> (lastRenderedReducer !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> prevDispatcher;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 上一个值</span></span><br><span class="line">                    <span class="keyword">const</span> currentState: S = (queue.lastRenderedState: any);</span><br><span class="line">                    <span class="comment">// 最新值</span></span><br><span class="line">                    <span class="keyword">const</span> eagerState = lastRenderedReducer(currentState, action);</span><br><span class="line">                    <span class="comment">// Stash the eagerly computed state, and the reducer used to compute</span></span><br><span class="line">                    <span class="comment">// it, on the update object. If the reducer hasn&#x27;t changed by the</span></span><br><span class="line">                    <span class="comment">// time we enter the render phase, then the eager state can be used</span></span><br><span class="line">                    <span class="comment">// without calling the reducer again.</span></span><br><span class="line">                    update.eagerReducer = lastRenderedReducer;</span><br><span class="line">                    update.eagerState = eagerState;</span><br><span class="line">                    <span class="comment">// 即Object.is,相同就return</span></span><br><span class="line">                    <span class="keyword">if</span> (is(eagerState, currentState)) &#123;</span><br><span class="line">                        <span class="comment">// Fast path. We can bail out without scheduling React to re-render.</span></span><br><span class="line">                        <span class="comment">// It&#x27;s still possible that we&#x27;ll need to rebase this update later,</span></span><br><span class="line">                        <span class="comment">// if the component re-renders for a different reason and by that</span></span><br><span class="line">                        <span class="comment">// time the reducer has changed.</span></span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="comment">// Suppress the error. It will throw again in the render phase.</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">                        ReactCurrentDispatcher.current = prevDispatcher;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 有跟新，就去scheduleWork</span></span><br><span class="line">        scheduleWork(fiber, expirationTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="scheduleWork"><a href="#scheduleWork" class="headerlink" title="scheduleWork"></a>scheduleWork</h4><p>见 schedule.md</p>
<h3 id="跟新"><a href="#跟新" class="headerlink" title="跟新"></a>跟新</h3><p>跟新时 <code>dispatcher.useState</code> = <code>updateState</code></p>
<h4 id="updateState"><a href="#updateState" class="headerlink" title="updateState"></a>updateState</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">function updateState&lt;S&gt;(initialState: (() =&gt; S) | S): [S, Dispatch&lt;BasicStateAction&lt;S&gt;&gt;] &#123;</span><br><span class="line">    <span class="keyword">return</span> updateReducer(basicStateReducer, (initialState: any));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateReducer</span>&lt;<span class="title">S</span>, <span class="title">I</span>, <span class="title">A</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    reducer: (S, A) =&gt; S,</span></span></span><br><span class="line"><span class="function"><span class="params">    initialArg: I,</span></span></span><br><span class="line"><span class="function"><span class="params">    init?: (I) =&gt; S,</span></span></span><br><span class="line">): [S, Dispatch&lt;A&gt;] &#123;</span><br><span class="line">    <span class="keyword">const</span> hook = updateWorkInProgressHook();</span><br><span class="line">    <span class="keyword">const</span> queue = hook.queue;</span><br><span class="line">    invariant(</span><br><span class="line">        queue !== <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&#x27;Should have a queue. This is likely a bug in React. Please file an issue.&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    queue.lastRenderedReducer = reducer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (numberOfReRenders &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// This is a re-render. Apply the new render phase updates to the previous</span></span><br><span class="line">        <span class="comment">// work-in-progress hook.</span></span><br><span class="line">        <span class="keyword">const</span> dispatch: Dispatch&lt;A&gt; = (queue.dispatch: any);</span><br><span class="line">        <span class="keyword">if</span> (renderPhaseUpdates !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Render phase updates are stored in a map of queue -&gt; linked list</span></span><br><span class="line">            <span class="keyword">const</span> firstRenderPhaseUpdate = renderPhaseUpdates.get(queue);</span><br><span class="line">            <span class="keyword">if</span> (firstRenderPhaseUpdate !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                renderPhaseUpdates.delete(queue);</span><br><span class="line">                <span class="keyword">let</span> newState = hook.memoizedState;</span><br><span class="line">                <span class="keyword">let</span> update = firstRenderPhaseUpdate;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="comment">// Process this render phase update. We don&#x27;t have to check the</span></span><br><span class="line">                    <span class="comment">// priority because it will always be the same as the current</span></span><br><span class="line">                    <span class="comment">// render&#x27;s.</span></span><br><span class="line">                    <span class="keyword">const</span> action = update.action;</span><br><span class="line">                    newState = reducer(newState, action);</span><br><span class="line">                    update = update.next;</span><br><span class="line">                &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Mark that the fiber performed work, but only if the new state is</span></span><br><span class="line">                <span class="comment">// different from the current state.</span></span><br><span class="line">                <span class="keyword">if</span> (!is(newState, hook.memoizedState)) &#123;</span><br><span class="line">                    markWorkInProgressReceivedUpdate();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                hook.memoizedState = newState;</span><br><span class="line">                <span class="comment">// Don&#x27;t persist the state accumlated from the render phase updates to</span></span><br><span class="line">                <span class="comment">// the base state unless the queue is empty.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Not sure if this is the desired semantics, but it&#x27;s what we</span></span><br><span class="line">                <span class="comment">// do for gDSFP. I can&#x27;t remember why.</span></span><br><span class="line">                <span class="keyword">if</span> (hook.baseUpdate === queue.last) &#123;</span><br><span class="line">                    hook.baseState = newState;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                queue.lastRenderedState = newState;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> [newState, dispatch];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [hook.memoizedState, dispatch];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The last update in the entire queue</span></span><br><span class="line">    <span class="keyword">const</span> last = queue.last;</span><br><span class="line">    <span class="comment">// The last update that is part of the base state.</span></span><br><span class="line">    <span class="keyword">const</span> baseUpdate = hook.baseUpdate;</span><br><span class="line">    <span class="keyword">const</span> baseState = hook.baseState;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the first unprocessed update.</span></span><br><span class="line">    <span class="keyword">let</span> first;</span><br><span class="line">    <span class="keyword">if</span> (baseUpdate !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (last !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// For the first update, the queue is a circular linked list where</span></span><br><span class="line">            <span class="comment">// `queue.last.next = queue.first`. Once the first update commits, and</span></span><br><span class="line">            <span class="comment">// the `baseUpdate` is no longer empty, we can unravel the list.</span></span><br><span class="line">            last.next = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        first = baseUpdate.next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        first = last !== <span class="literal">null</span> ? last.next : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (first !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 新 state 数据</span></span><br><span class="line">        <span class="keyword">let</span> newState = baseState;</span><br><span class="line">        <span class="keyword">let</span> newBaseState = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> newBaseUpdate = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> prevUpdate = baseUpdate;</span><br><span class="line">        <span class="keyword">let</span> update = first;</span><br><span class="line">        <span class="keyword">let</span> didSkip = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> updateExpirationTime = update.expirationTime;</span><br><span class="line">            <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">                <span class="comment">// Priority is insufficient. Skip this update. If this is the first</span></span><br><span class="line">                <span class="comment">// skipped update, the previous update/state is the new base</span></span><br><span class="line">                <span class="comment">// update/state.</span></span><br><span class="line">                <span class="keyword">if</span> (!didSkip) &#123;</span><br><span class="line">                    didSkip = <span class="literal">true</span>;</span><br><span class="line">                    newBaseUpdate = prevUpdate;</span><br><span class="line">                    newBaseState = newState;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Update the remaining priority in the queue.</span></span><br><span class="line">                <span class="keyword">if</span> (updateExpirationTime &gt; remainingExpirationTime) &#123;</span><br><span class="line">                    remainingExpirationTime = updateExpirationTime;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// This update does have sufficient priority.</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Mark the event time of this update as relevant to this render pass.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> This should ideally use the true event time of this update rather than</span></span><br><span class="line">                <span class="comment">// its priority which is a derived and not reverseable value.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> We should skip this update if it was already committed but currently</span></span><br><span class="line">                <span class="comment">// we have no way of detecting the difference between a committed and suspended</span></span><br><span class="line">                <span class="comment">// update here.</span></span><br><span class="line">                markRenderEventTimeAndConfig(updateExpirationTime, update.suspenseConfig);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Process this update.</span></span><br><span class="line">                <span class="keyword">if</span> (update.eagerReducer === reducer) &#123;</span><br><span class="line">                    <span class="comment">// If this update was processed eagerly, and its reducer matches the</span></span><br><span class="line">                    <span class="comment">// current reducer, we can use the eagerly computed state.</span></span><br><span class="line">                    newState = ((update.eagerState: any): S);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> action = update.action;</span><br><span class="line">                    newState = reducer(newState, action);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            prevUpdate = update;</span><br><span class="line">            update = update.next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span> &amp;&amp; update !== first);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!didSkip) &#123;</span><br><span class="line">            newBaseUpdate = prevUpdate;</span><br><span class="line">            newBaseState = newState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mark that the fiber performed work, but only if the new state is</span></span><br><span class="line">        <span class="comment">// different from the current state.</span></span><br><span class="line">        <span class="comment">// 标记fiber已完成工作，前提是新旧数据不同，通过Object.is</span></span><br><span class="line">        <span class="keyword">if</span> (!is(newState, hook.memoizedState)) &#123;</span><br><span class="line">            markWorkInProgressReceivedUpdate();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hook.memoizedState = newState;</span><br><span class="line">        hook.baseUpdate = newBaseUpdate;</span><br><span class="line">        hook.baseState = newBaseState;</span><br><span class="line"></span><br><span class="line">        queue.lastRenderedState = newState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dispatch: Dispatch&lt;A&gt; = (queue.dispatch: any);</span><br><span class="line">    <span class="keyword">return</span> [hook.memoizedState, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="updateWorkInProgressHook-1"><a href="#updateWorkInProgressHook-1" class="headerlink" title="updateWorkInProgressHook"></a>updateWorkInProgressHook</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateWorkInProgressHook</span>(<span class="params"></span>): <span class="title">Hook</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function is used both for updates and for re-renders triggered by a</span></span><br><span class="line">    <span class="comment">// render phase update. It assumes there is either a current hook we can</span></span><br><span class="line">    <span class="comment">// clone, or a work-in-progress hook from a previous render pass that we can</span></span><br><span class="line">    <span class="comment">// use as a base. When we reach the end of the base list, we must switch to</span></span><br><span class="line">    <span class="comment">// the dispatcher used for mounts.</span></span><br><span class="line">    <span class="keyword">if</span> (nextWorkInProgressHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// There&#x27;s already a work-in-progress. Reuse it.</span></span><br><span class="line">        workInProgressHook = nextWorkInProgressHook;</span><br><span class="line">        nextWorkInProgressHook = workInProgressHook.next;</span><br><span class="line"></span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line">        nextCurrentHook = currentHook !== <span class="literal">null</span> ? currentHook.next : <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Clone from the current hook.</span></span><br><span class="line">        invariant(nextCurrentHook !== <span class="literal">null</span>, <span class="string">&#x27;Rendered more hooks than during the previous render.&#x27;</span>);</span><br><span class="line">        currentHook = nextCurrentHook;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clone 当前 hook</span></span><br><span class="line">        <span class="keyword">const</span> newHook: Hook = &#123;</span><br><span class="line">            memoizedState: currentHook.memoizedState,</span><br><span class="line"></span><br><span class="line">            baseState: currentHook.baseState,</span><br><span class="line">            queue: currentHook.queue,</span><br><span class="line">            baseUpdate: currentHook.baseUpdate,</span><br><span class="line"></span><br><span class="line">            next: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is the first hook in the list.</span></span><br><span class="line">            workInProgressHook = firstWorkInProgressHook = newHook;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Append to the end of the list.</span></span><br><span class="line">            workInProgressHook = workInProgressHook.next = newHook;</span><br><span class="line">        &#125;</span><br><span class="line">        nextCurrentHook = currentHook.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h2><h3 id="初始化-2"><a href="#初始化-2" class="headerlink" title="初始化"></a>初始化</h3><h4 id="mountEffect-和-mountEffectImpl"><a href="#mountEffect-和-mountEffectImpl" class="headerlink" title="mountEffect 和 mountEffectImpl"></a>mountEffect 和 mountEffectImpl</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountEffect</span>(<span class="params">create: () =&gt; (() =&gt; void) | void, deps: Array&lt;mixed&gt; | void | null</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mountEffectImpl(</span><br><span class="line">        UpdateEffect | PassiveEffect, <span class="comment">// 有这两种effect处理</span></span><br><span class="line">        UnmountPassive | MountPassive, <span class="comment">// 192</span></span><br><span class="line">        create,</span><br><span class="line">        deps,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountEffectImpl</span>(<span class="params">fiberEffectTag, hookEffectTag, create, deps</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line">    <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">    sideEffectTag |= fiberEffectTag;</span><br><span class="line">    hook.memoizedState = pushEffect(hookEffectTag, create, <span class="literal">undefined</span>, nextDeps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="pushEffect"><a href="#pushEffect" class="headerlink" title="pushEffect"></a>pushEffect</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushEffect</span>(<span class="params">tag, create, destroy, deps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> effect: Effect = &#123;</span><br><span class="line">        tag,</span><br><span class="line">        create,</span><br><span class="line">        destroy,</span><br><span class="line">        deps,</span><br><span class="line">        <span class="comment">// Circular</span></span><br><span class="line">        next: (<span class="literal">null</span>: any),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (componentUpdateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">        componentUpdateQueue = createFunctionComponentUpdateQueue();</span><br><span class="line">        componentUpdateQueue.lastEffect = effect.next = effect;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> lastEffect = componentUpdateQueue.lastEffect;</span><br><span class="line">        <span class="keyword">if</span> (lastEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">            componentUpdateQueue.lastEffect = effect.next = effect;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> firstEffect = lastEffect.next;</span><br><span class="line">            lastEffect.next = effect;</span><br><span class="line">            effect.next = firstEffect;</span><br><span class="line">            componentUpdateQueue.lastEffect = effect;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> effect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行-1"><a href="#执行-1" class="headerlink" title="执行"></a>执行</h3><p>从 <code>commitRoot</code>开始</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRoot</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 开始渲染流程</span></span><br><span class="line">    <span class="comment">// debugger;</span></span><br><span class="line">    <span class="comment">// 优先级相关，最后还是运行commitRootImpl</span></span><br><span class="line">    runWithPriority(ImmediatePriority, commitRootImpl.bind(<span class="literal">null</span>, root)); <span class="comment">// 渲染并执行componentDidMount</span></span><br><span class="line">    <span class="comment">// If there are passive effects, schedule a callback to flush them. This goes</span></span><br><span class="line">    <span class="comment">// outside commitRootImpl so that it inherits the priority of the render.</span></span><br><span class="line">    <span class="keyword">if</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// debugger;</span></span><br><span class="line">        <span class="comment">// 这里是调度管理，先不看，直接进里面</span></span><br><span class="line">        <span class="keyword">const</span> priorityLevel = getCurrentPriorityLevel();</span><br><span class="line">        scheduleCallback(priorityLevel, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// hooks的useEffect在这里执行,不过是在RequestAnimationFrame里,不好一步追踪到这，只能打断点反追</span></span><br><span class="line">            flushPassiveEffects();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="flushPassiveEffects"><a href="#flushPassiveEffects" class="headerlink" title="flushPassiveEffects"></a>flushPassiveEffects</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">flushPassiveEffects</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rootWithPendingPassiveEffects === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> root = rootWithPendingPassiveEffects;</span><br><span class="line">    <span class="keyword">const</span> expirationTime = pendingPassiveEffectsExpirationTime;</span><br><span class="line">    rootWithPendingPassiveEffects = <span class="literal">null</span>;</span><br><span class="line">    pendingPassiveEffectsExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> prevInteractions: <span class="built_in">Set</span>&lt;Interaction&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= CommitContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note: This currently assumes there are no passive effects on the root</span></span><br><span class="line">    <span class="comment">// fiber, because the root is not part of its own effect list. This could</span></span><br><span class="line">    <span class="comment">// change in the future.</span></span><br><span class="line">    <span class="keyword">let</span> effect = root.current.firstEffect;</span><br><span class="line">    <span class="keyword">while</span> (effect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                commitPassiveHookEffects(effect);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                invariant(effect !== <span class="literal">null</span>, <span class="string">&#x27;Should be working on an effect.&#x27;</span>);</span><br><span class="line">                captureCommitPhaseError(effect, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        effect = effect.nextEffect;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line">    flushSyncCallbackQueue();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If additional passive effects were scheduled, increment a counter. If this</span></span><br><span class="line">    <span class="comment">// exceeds the limit, we&#x27;ll fire a warning.</span></span><br><span class="line">    nestedPassiveUpdateCount =</span><br><span class="line">        rootWithPendingPassiveEffects === <span class="literal">null</span> ? <span class="number">0</span> : nestedPassiveUpdateCount + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="commitPassiveHookEffects"><a href="#commitPassiveHookEffects" class="headerlink" title="commitPassiveHookEffects"></a>commitPassiveHookEffects</h4><p>先执行卸载的<code>return</code>,在执行本体</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">commitPassiveHookEffects</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    commitHookEffectList(UnmountPassive, NoHookEffect, finishedWork);</span><br><span class="line">    commitHookEffectList(NoHookEffect, MountPassive, finishedWork);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="commitHookEffectList"><a href="#commitHookEffectList" class="headerlink" title="commitHookEffectList"></a>commitHookEffectList</h4><p>这个方法在很多地方都有用到，目前已知的从<code>commitPassiveHookEffects</code>过来的是<code>useEffect</code>,其他未知</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitHookEffectList</span>(<span class="params">unmountTag: number, mountTag: number, finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> updateQueue: FunctionComponentUpdateQueue | <span class="literal">null</span> = (finishedWork.updateQueue: any);</span><br><span class="line">    <span class="keyword">let</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.lastEffect : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> firstEffect = lastEffect.next;</span><br><span class="line">        <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((effect.tag &amp; unmountTag) !== NoHookEffect) &#123;</span><br><span class="line">                <span class="comment">// Unmount</span></span><br><span class="line">                <span class="keyword">const</span> destroy = effect.destroy;</span><br><span class="line">                effect.destroy = <span class="literal">undefined</span>;</span><br><span class="line">                <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    destroy();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((effect.tag &amp; mountTag) !== NoHookEffect) &#123;</span><br><span class="line">                <span class="comment">// Mount</span></span><br><span class="line">                <span class="keyword">const</span> create = effect.create;</span><br><span class="line">                <span class="comment">// return就是destroy</span></span><br><span class="line">                effect.destroy = create();</span><br><span class="line">            &#125;</span><br><span class="line">            effect = effect.next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><h4 id="updateEffect"><a href="#updateEffect" class="headerlink" title="updateEffect"></a>updateEffect</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateEffect</span>(<span class="params">create: () =&gt; (() =&gt; void) | void, deps: Array&lt;mixed&gt; | void | null</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> updateEffectImpl(</span><br><span class="line">        UpdateEffect | PassiveEffect,</span><br><span class="line">        UnmountPassive | MountPassive,</span><br><span class="line">        create,</span><br><span class="line">        deps,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateEffectImpl</span>(<span class="params">fiberEffectTag, hookEffectTag, create, deps</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> hook = updateWorkInProgressHook();</span><br><span class="line">    <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">    <span class="keyword">let</span> destroy = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> prevEffect = currentHook.memoizedState;</span><br><span class="line">        destroy = prevEffect.destroy;</span><br><span class="line">        <span class="comment">// 判断依赖是否有变，</span></span><br><span class="line">        <span class="keyword">if</span> (nextDeps !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> prevDeps = prevEffect.deps;</span><br><span class="line">            <span class="comment">//  循环依赖，用Object.is</span></span><br><span class="line">            <span class="keyword">if</span> (areHookInputsEqual(nextDeps, prevDeps)) &#123;</span><br><span class="line">                <span class="comment">// 依赖不变，是NoHookEffect，所以useEffect不执行destroy和create</span></span><br><span class="line">                pushEffect(NoHookEffect, create, destroy, nextDeps);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 只有依赖有变或者没依赖才有fiberEffectTag标记，不过没发现有什么用</span></span><br><span class="line">    sideEffectTag |= fiberEffectTag;</span><br><span class="line">    hook.memoizedState = pushEffect(hookEffectTag, create, destroy, nextDeps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="useContext"><a href="#useContext" class="headerlink" title="useContext"></a>useContext</h2><p>context 见 context.md</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/my-notes/tags/react%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag"># react源码解析</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/my-notes/2020/09/09/react/commitRoot/" rel="prev" title="commitRoot">
      <i class="fa fa-chevron-left"></i> commitRoot
    </a></div>
      <div class="post-nav-item">
    <a href="/my-notes/2020/09/09/react/reconcileChildFibers/" rel="next" title="reconcileChildFibers">
      reconcileChildFibers <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AC%E5%85%B1"><span class="nav-number">1.</span> <span class="nav-text">公共</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mountWorkInProgressHook"><span class="nav-number">1.1.</span> <span class="nav-text">mountWorkInProgressHook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#updateWorkInProgressHook"><span class="nav-number">1.2.</span> <span class="nav-text">updateWorkInProgressHook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E7%BB%91%E5%AE%9A"><span class="nav-number">1.3.</span> <span class="nav-text">方法绑定</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#useRef"><span class="nav-number">2.</span> <span class="nav-text">useRef</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.1.</span> <span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mountRef"><span class="nav-number">2.1.1.</span> <span class="nav-text">mountRef</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#useState"><span class="nav-number">3.</span> <span class="nav-text">useState</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-1"><span class="nav-number">3.1.</span> <span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mountState"><span class="nav-number">3.1.1.</span> <span class="nav-text">mountState</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C"><span class="nav-number">3.2.</span> <span class="nav-text">执行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatchAction"><span class="nav-number">3.2.1.</span> <span class="nav-text">dispatchAction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#scheduleWork"><span class="nav-number">3.2.2.</span> <span class="nav-text">scheduleWork</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%9F%E6%96%B0"><span class="nav-number">3.3.</span> <span class="nav-text">跟新</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#updateState"><span class="nav-number">3.3.1.</span> <span class="nav-text">updateState</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#updateWorkInProgressHook-1"><span class="nav-number">3.3.2.</span> <span class="nav-text">updateWorkInProgressHook</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#useEffect"><span class="nav-number">4.</span> <span class="nav-text">useEffect</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-2"><span class="nav-number">4.1.</span> <span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mountEffect-%E5%92%8C-mountEffectImpl"><span class="nav-number">4.1.1.</span> <span class="nav-text">mountEffect 和 mountEffectImpl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pushEffect"><span class="nav-number">4.1.2.</span> <span class="nav-text">pushEffect</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C-1"><span class="nav-number">4.2.</span> <span class="nav-text">执行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#flushPassiveEffects"><span class="nav-number">4.2.1.</span> <span class="nav-text">flushPassiveEffects</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#commitPassiveHookEffects"><span class="nav-number">4.2.2.</span> <span class="nav-text">commitPassiveHookEffects</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#commitHookEffectList"><span class="nav-number">4.2.3.</span> <span class="nav-text">commitHookEffectList</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0"><span class="nav-number">4.3.</span> <span class="nav-text">更新</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#updateEffect"><span class="nav-number">4.3.1.</span> <span class="nav-text">updateEffect</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#useContext"><span class="nav-number">5.</span> <span class="nav-text">useContext</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">lokve</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/my-notes/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/my-notes/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lokve</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/my-notes/lib/anime.min.js"></script>
  <script src="/my-notes/lib/velocity/velocity.min.js"></script>
  <script src="/my-notes/lib/velocity/velocity.ui.min.js"></script>

<script src="/my-notes/js/utils.js"></script>

<script src="/my-notes/js/motion.js"></script>


<script src="/my-notes/js/schemes/pisces.js"></script>


<script src="/my-notes/js/next-boot.js"></script>




  




  
<script src="/my-notes/js/local-search.js"></script>













  

  

</body>
</html>
